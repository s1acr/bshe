var e=Object.defineProperty,t=(t,i,n)=>((t,i,n)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n)(t,"symbol"!=typeof i?i+"":i,n);import{aN as i,r as n,c as s,f as a,l as o,q as r,U as l,x as c,y as u,z as d,J as h,P as m,C as p,aa as g,H as v,X as y,O as f,ac as C,M as w,u as b,aO as _,ay as S,o as A,Z as E,D as x,G as T,K as P,L,Y as k,aP as M,aK as I,aQ as D,aR as O}from"./vendor_vue.DRRxD5oO.js";import{E as R,m as N,v as B,l as U,s as V,o as z,a as H,c as F,b as W,d as G,e as Y,f as j,g as $,h as X,i as Q,j as K,k as q,n as J,p as Z,q as ee,r as te,t as ie,u as ne,w as se,x as ae,y as oe,z as re,A as le,B as ce,C as ue,D as de,F as he,G as me,H as pe,I as ge,J as ve,K as ye,L as fe,M as Ce,N as we}from"./vendor_element.DBejmVKF.js";import{O as be,P as _e,Q as Se,R as Ae,U as Ee,V as xe}from"./vendor.BUlUsozX.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class Te{constructor(e){t(this,"sources"),t(this,"show"),t(this,"_sources"),t(this,"_command"),t(this,"_cubeMap"),t(this,"_attributeLocations"),t(this,"_useHdr"),this.sources=e.sources,this._sources=void 0,this.show=void 0===e.show||e.show,this._command=new window.Cesium.DrawCommand({modelMatrix:window.Cesium.Matrix4.clone(window.Cesium.Matrix4.IDENTITY),owner:this}),this._cubeMap=void 0,this._attributeLocations=void 0,this._useHdr=void 0}update(e,t){const i=window.Cesium,n=this;if(!this.show)return;if(e.mode!==i.SceneMode.SCENE3D&&e.mode!==i.SceneMode.MORPHING)return;if(!e.passes.render)return;const s=e.context,a=new i.Matrix3;if(this._sources!==this.sources){this._sources=this.sources;const e=this.sources;if(!(e.positiveX&&e.negativeX&&e.positiveY&&e.negativeY&&e.positiveZ&&e.negativeZ))return;if(typeof e.positiveX!=typeof e.negativeX||typeof e.positiveX!=typeof e.positiveY||typeof e.positiveX!=typeof e.negativeY||typeof e.positiveX!=typeof e.positiveZ||typeof e.positiveX!=typeof e.negativeZ)return;"string"==typeof e.positiveX?i.loadCubeMap(s,this._sources).then((function(e){n._cubeMap=n._cubeMap&&n._cubeMap.destroy(),n._cubeMap=e})):(this._cubeMap=this._cubeMap&&this._cubeMap.destroy(),this._cubeMap=new i.CubeMap({context:s,source:e}))}const o=this._command;if(o.modelMatrix=i.Transforms.eastNorthUpToFixedFrame(e.camera._positionWC),!o.vertexArray){o.uniformMap={u_cubeMap:function(){return n._cubeMap},u_rotateMatrix:function(){return(i.Matrix4.getRotation||i.Matrix4.getMatrix3)(o.modelMatrix,a)}};const e=i.BoxGeometry.createGeometry(i.BoxGeometry.fromDimensions({dimensions:new i.Cartesian3(2,2,2),vertexFormat:i.VertexFormat.POSITION_ONLY}));this._attributeLocations=i.GeometryPipeline.createAttributeLocations(e),o.vertexArray=i.VertexArray.fromGeometry({context:s,geometry:e,attributeLocations:this._attributeLocations,bufferUsage:i.BufferUsage.STATIC_DRAW}),o.renderState=i.RenderState.fromCache({blending:i.BlendingState.ALPHA_BLEND})}if(!o.shaderProgram||this._useHdr!==t){const e=new i.ShaderSource({defines:[t?"HDR":""],sources:["uniform samplerCube u_cubeMap;\nin vec3 v_texCoord;\nout vec4 fragColor;\nvoid main() {\n  vec4 color = texture(u_cubeMap, normalize(v_texCoord));\n  fragColor = vec4(czm_gammaCorrect(color).rgb, czm_morphTime);\n}"]});o.shaderProgram=i.ShaderProgram.fromCache({context:s,vertexShaderSource:"\nout vec3 v_texCoord;\nin vec3 position;\nuniform mat3 u_rotateMatrix;\nvoid main() {\n  vec3 p = czm_viewRotation * u_rotateMatrix * (czm_temeToPseudoFixed * (czm_entireFrustum.y * position));\n  gl_Position = czm_projection * vec4(p, 1.0);\n  v_texCoord = position.xyz;\n}",fragmentShaderSource:e,attributeLocations:this._attributeLocations}),this._useHdr=t}return this._cubeMap?o:void 0}isDestroyed(){return!1}destroy(){const e=window.Cesium,t=this._command;return t.vertexArray=t.vertexArray&&t.vertexArray.destroy(),t.shaderProgram=t.shaderProgram&&t.shaderProgram.destroy(),this._cubeMap=this._cubeMap&&this._cubeMap.destroy(),e.destroyObject(this)}setSkyBox(e,t=24e4,i=!1){const n=e.scene.skyBox;e.scene.skyAtmosphere.show=i,e.scene.preUpdate.addEventListener((()=>{const s=e.scene.camera.position;window.Cesium.Cartographic.fromCartesian(s).height<t?(e.scene.skyBox=this,e.scene.skyAtmosphere.show=i):(e.scene.skyBox=n,e.scene.skyAtmosphere.show=i)}))}}const Pe="/assets/favicon2.LGJEmLE3.png",Le={WGS84ToGCJ02:function(e,t){const i=3.141592653589793,n=6378245,s=.006693421622965943;if(this.out_of_china(e,t))return[e,t];let a=this.transformLng(e-105,t-35),o=this.transformLat(e-105,t-35);const r=t/180*i;let l=Math.sin(r);l=1-s*l*l;const c=Math.sqrt(l);return a=180*a/(n/c*Math.cos(r)*i),o=180*o/(n*(1-s)/(l*c)*i),[e+a,t+o]},GCJ02ToWGS84:function(e,t){if(this.out_of_china(e,t))return[e,t];let i=this.transformLng(e-105,t-35),n=this.transformLat(e-105,t-35);const s=t/180*Math.PI;let a=Math.sin(s);a=1-.006693421622965943*a*a;const o=Math.sqrt(a);i=180*i/(6378245/o*Math.cos(s)*Math.PI),n=180*n/(6335552.717000426/(a*o)*Math.PI);return[2*e-(e+i),2*t-(t+n)]},transformLat:function(e,t){const i=3.141592653589793;let n=2*e-100+3*t+.2*t*t+.1*e*t+.2*Math.sqrt(Math.abs(e));return n+=2*(20*Math.sin(6*e*i)+20*Math.sin(2*e*i))/3,n+=2*(20*Math.sin(t*i)+40*Math.sin(t/3*i))/3,n+=2*(160*Math.sin(t/12*i)+320*Math.sin(t*i/30))/3,n},transformLng:function(e,t){const i=3.141592653589793;let n=300+e+2*t+.1*e*e+.1*e*t+.1*Math.sqrt(Math.abs(e));return n+=2*(20*Math.sin(6*e*i)+20*Math.sin(2*e*i))/3,n+=2*(20*Math.sin(e*i)+40*Math.sin(e/3*i))/3,n+=2*(150*Math.sin(e/12*i)+300*Math.sin(e/30*i))/3,n},out_of_china:function(e,t){return!(e>73.66&&e<135.05&&t>3.86&&t<53.55)}};class ke extends Cesium.WebMercatorTilingScheme{constructor(e={}){super(e);const t=new Cesium.WebMercatorProjection;this._projection.project=(e,i)=>{const n=Le.WGS84ToGCJ02(Cesium.Math.toDegrees(e.longitude),Cesium.Math.toDegrees(e.latitude));return i=t.project(new Cesium.Cartographic(Cesium.Math.toRadians(n[0]),Cesium.Math.toRadians(n[1]))),new Cesium.Cartesian2(i.x,i.y)},this._projection.unproject=(e,i)=>{const n=t.unproject(e),s=Le.GCJ02ToWGS84(Cesium.Math.toDegrees(n.longitude),Cesium.Math.toDegrees(n.latitude));return new Cesium.Cartographic(Cesium.Math.toRadians(s[0]),Cesium.Math.toRadians(s[1]))}}}Cesium.WebMercatorTilingScheme;class Me extends Cesium.UrlTemplateImageryProvider{constructor(e={}){const t=e.style||2;let i,n=e.maximumLevel||18;switch(t){case 1:i="https://rt1.map.gtimg.com/tile?z={z}&x={x}&y={reverseY}&styleid=1&version=297";break;case 4:i="https://p3.map.gtimg.com/sateTiles/{z}/{sx}/{sy}/{x}_{reverseY}.jpg?version=229&styleid=4";break;default:i="https://p2.map.gtimg.com/sateTiles/{z}/{sx}/{sy}/{x}_{reverseY}.jpg?version=229"}super({url:i,minimumLevel:3,maximumLevel:n,credit:"腾讯地图",tilingScheme:new ke({ellipsoid:Cesium.Ellipsoid.WGS84,numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1}),customTags:{sx:(e,t,i,n)=>Math.floor(t/16),sy:(e,t,i,n)=>Math.floor(((1<<n)-i-1)/16),reverseY:(e,t,i,n)=>(1<<n)-i-1,x:(e,t,i,n)=>t%16}}),4===t&&(this.defaultBrightness=.6,this.defaultContrast=1.8,this.defaultGamma=1.2,this.defaultSaturation=1.5,this.defaultHue=0)}requestImage(e,t,i){try{return super.requestImage(e,t,i)}catch(n){const e=document.createElement("canvas");return e.width=256,e.height=256,Promise.resolve(e)}}}class Ie extends Cesium.UrlTemplateImageryProvider{constructor(e={}){const t=e.style||"elec";let i;const n=e.maximumLevel||18,s={img:"https://wprd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=1&style=6",elec:"https://wprd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=2&style=7",cva:"https://wprd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=1&style=8"};i=s[t]||s.elec;super({url:i,subdomains:"1234",tilingScheme:new ke({}),minimumLevel:3,maximumLevel:n,credit:"高德地图",customTags:{s:(e,t,i,n)=>Math.abs(t+i)%4},tileWidth:256,tileHeight:256,hasAlphaChannel:!0,enablePickFeatures:!1})}requestImage(e,t,i){try{return super.requestImage(e,t,i).catch((e=>{const t=document.createElement("canvas");return t.width=256,t.height=256,t}))}catch(n){const e=document.createElement("canvas");return e.width=256,e.height=256,Promise.resolve(e)}}}class De extends Cesium.UrlTemplateImageryProvider{constructor(e={}){const t=e.style||"elec";let i;const n=e.maximumLevel||20;switch(t){case"img":i="https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}";break;case"ter":i="https://mt{s}.google.com/vt/lyrs=t&x={x}&y={y}&z={z}";break;case"cva":i="https://mt{s}.google.com/vt/lyrs=h&x={x}&y={y}&z={z}";break;case"img_cva":i="https://mt{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}";break;default:i="https://mt{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}"}super({url:i,subdomains:"0123",minimumLevel:3,maximumLevel:n,credit:"Google Maps"})}requestImage(e,t,i){try{return super.requestImage(e,t,i).catch((e=>{const t=document.createElement("canvas");return t.width=256,t.height=256,t}))}catch(n){const e=document.createElement("canvas");return e.width=256,e.height=256,Promise.resolve(e)}}}const Oe="2cafc3c616f0dc8ed8d97f7c979bf556";class Re extends Cesium.UrlTemplateImageryProvider{constructor(e={}){const i=e.style||"vec",n=!1!==e.addLabels,s=e.maximumLevel||18,a={vec:{layer:"vec_w",labelLayer:"cva_w"},img:{layer:"img_w",labelLayer:"cia_w"},ter:{layer:"ter_w",labelLayer:"cta_w"}};super({url:`https://t{s}.tianditu.gov.cn/DataServer?T=${(a[i]||a.vec).layer}&x={x}&y={y}&l={z}&tk=${Oe}`,subdomains:"01234567",tilingScheme:new Cesium.WebMercatorTilingScheme,minimumLevel:0,maximumLevel:s,credit:"天地图",customTags:{s:(e,t,i,n)=>Math.abs(t+i)%8},tileWidth:256,tileHeight:256,hasAlphaChannel:!0,enablePickFeatures:!1,headers:{Accept:"image/webp,image/*,*/*;q=0.8","Accept-Language":"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2","Cache-Control":"max-age=0"}}),t(this,"_hasLabels"),t(this,"_labelProvider"),t(this,"_mapStyle"),t(this,"_viewer"),this._hasLabels=n,this._mapStyle=i}setViewer(e){this._viewer=e,this._hasLabels&&this._viewer&&this._addLabelLayer()}_addLabelLayer(){var e;if(!this._viewer)return;let t;switch(this._mapStyle){case"vec":default:t="cva_w";break;case"img":t="cia_w";break;case"ter":t="cta_w"}const i=`https://t{s}.tianditu.gov.cn/DataServer?T=${t}&x={x}&y={y}&l={z}&tk=${Oe}`,n=(null==(e=this._imageryProvider)?void 0:e.maximumLevel)||18;this._labelProvider=new Cesium.UrlTemplateImageryProvider({url:i,subdomains:"01234567",tilingScheme:new Cesium.WebMercatorTilingScheme,minimumLevel:0,maximumLevel:n,credit:"天地图注记",customTags:{s:(e,t,i,n)=>Math.abs(t+i)%8},tileWidth:256,tileHeight:256,hasAlphaChannel:!0,enablePickFeatures:!1,headers:{Accept:"image/webp,image/*,*/*;q=0.8","Accept-Language":"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2","Cache-Control":"max-age=0"}}),this._viewer.imageryLayers.addImageryProvider(this._labelProvider,{show:!0,alpha:1,zIndex:999})}requestImage(e,t,i){try{return super.requestImage(e,t,i).catch((e=>{const t=document.createElement("canvas");return t.width=256,t.height=256,t}))}catch(n){const e=document.createElement("canvas");return e.width=256,e.height=256,Promise.resolve(e)}}}class Ne extends Cesium.UrlTemplateImageryProvider{constructor(e={}){super({url:"https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_Black_Marble/default/2016-01-01/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png",credit:new Cesium.Credit("NASA Earth Observatory"),tilingScheme:new Cesium.WebMercatorTilingScheme,minimumLevel:1,maximumLevel:8,enablePickFeatures:!1}),this.defaultBrightness=1,this.defaultContrast=1.5,this.defaultGamma=1.3,this.defaultSaturation=1.2,this.defaultHue=0}requestImage(e,t,i){try{return super.requestImage(e,t,i)}catch(n){const e=document.createElement("canvas");e.width=256,e.height=256;const t=e.getContext("2d");return t&&(t.fillStyle="#000",t.fillRect(0,0,256,256)),Promise.resolve(e)}}}const Be="LRO_LOLA_ClrShade_Global_128ppd_v04",Ue="LRO_WAC_Mosaic_Global_303ppd_v02",Ve="Mars_MGS_MOLA_ClrShade_merge_global_463m",ze="Mars_Viking_MDIM21_ClrMosaic_global_232m",He="Mercury_MESSENGER_MDIS_Basemap_LOI_Mosaic_Global_166m",Fe="Mercury_MESSENGER_MDIS_Basemap_EnhancedColor_Mosaic_Global_665m",We="Moon",Ge="Mars",Ye="Mercury";class je{constructor(e={}){const t=e.body||We;let i=e.layer;i||(t===We?i=Be:t===Ge?i=Ve:t===Ye&&(i=He));const n=`https://trek.nasa.gov/tiles/${t}/EQ/${i}/1.0.0/default/default028mm/{TileMatrix}/{TileRow}/{TileCol}.${t===We?"png":"jpg"}`;return new Cesium.WebMapTileServiceImageryProvider({url:n,layer:i,style:"default",format:t===We?"image/png":"image/jpeg",tileMatrixSetID:"default028mm",maximumLevel:8,tilingScheme:new Cesium.GeographicTilingScheme,credit:new Cesium.Credit(`NASA ${t===We?"月球":t===Ge?"火星":"水星"}数据`)})}}const $e=2e3,Xe=106.613794,Qe=29.541216,Ke={"重邮":{name:"重邮",longitude:106.613794,latitude:29.541216},"天安门":{name:"天安门",longitude:116.397428,latitude:39.909187},"东方明珠":{name:"东方明珠",longitude:121.499741,latitude:31.239702},"广州塔":{name:"广州塔",longitude:113.319656,latitude:23.113335}};var qe=(e=>(e.SCENE3D="3D",e.COLUMBUS_VIEW="2.5D",e.SCENE2D="2D",e))(qe||{});const Je={"无底图":{name:"无底图",provider:"none",style:"none",description:"什么都没有"},"腾讯卫星":{name:"腾讯卫星",provider:"tencent",style:2,description:"腾讯卫星影像图，覆盖全国各地区"},"腾讯夜景":{name:"腾讯夜景",provider:"tencent",style:4,description:"腾讯夜间模式地图，展示城市夜景效果"},"腾讯矢量":{name:"腾讯矢量",provider:"tencent",style:1,description:"腾讯标准矢量地图，清晰展示道路和区域"},"高德电子":{name:"高德电子",provider:"amap",style:"elec",description:"高德电子地图，提供细致的道路网络"},"高德卫星":{name:"高德卫星",provider:"amap",style:"img",description:"高德卫星影像图，覆盖全国各地区"},"谷歌电子":{name:"谷歌电子",provider:"google",style:"elec",description:"谷歌地图， 若无法加载， 请使用代理或VPN"},"谷歌卫星":{name:"谷歌卫星",provider:"google",style:"img",description:"谷歌卫星影像，全球高清卫星图像"},"谷歌混合":{name:"谷歌混合",provider:"google",style:"img_cva",description:"推荐使用，全球卫星影像与道路标签结合的混合视图"},"谷歌地形":{name:"谷歌地形",provider:"google",style:"ter",description:"展示地形高度和自然特征的地形图"},"天地图矢量":{name:"天地图矢量",provider:"tdt",style:"vec",description:"国家级权威矢量地图，精确地理信息"},"天地图影像":{name:"天地图影像",provider:"tdt",style:"img",description:"高分辨率卫星遥感影像，覆盖全国"},"天地图地形":{name:"天地图地形",provider:"tdt",style:"ter",description:"展示地形起伏与地貌特征的地形图"},"NASA夜景":{name:"NASA夜景",provider:"nasa",style:"BLACK_MARBLE",description:"NASA黑色大理石夜景图，展示地球夜间灯光"},"NASA月球地形阴影":{name:"NASA月球地形阴影",provider:"nasa_planetary",style:{body:We,layer:Be},description:"NASA月球地形阴影图，展示月球表面地貌"},"NASA月球WAC影像":{name:"NASA月球WAC影像",provider:"nasa_planetary",style:{body:We,layer:Ue},description:"月球广角相机影像，高清月球表面细节"},"NASA火星MOLA地形":{name:"NASA火星MOLA地形",provider:"nasa_planetary",style:{body:Ge,layer:Ve},description:"火星轨道激光高度计地形图，火星表面地貌"},"NASA火星Viking影像":{name:"NASA火星Viking影像",provider:"nasa_planetary",style:{body:Ge,layer:ze},description:"海盗号探测器拍摄的火星表面影像"},"NASA水星MDIS基础图":{name:"NASA水星MDIS基础图",provider:"nasa_planetary",style:{body:Ye,layer:He},description:"水星双成像系统拍摄的水星基础地图"},"NASA水星增强色彩图":{name:"NASA水星增强色彩图",provider:"nasa_planetary",style:{body:Ye,layer:Fe},description:"色彩增强处理的水星表面影像图"}},Ze={"无地形":{name:"无地形",type:"none"},"Cesium全球地形":{name:"Cesium全球地形",type:"cesium"}},et=i("scene",(()=>{const e=n("重邮"),t=n("腾讯卫星"),i=n("无地形"),a=n(!1),o=n(!1),r=n(!0),l=n(!1),c=n(!1),u=n(!1),d=n(!1),h=n(!1),m=n(!0),p=n(!1),g=n($e),v=n(-45),y=n(0),f=n(Xe),C=n(Qe),w=s((()=>Math.round(g.value).toString())),b=s((()=>Math.round(v.value).toString())),_=s((()=>Math.round(y.value).toString())),S=s((()=>f.value.toFixed(6))),A=s((()=>C.value.toFixed(6)));return{selectedLocation:e,mapProvider:t,terrainProvider:i,showGrid:a,showRoadNetworkLayer:o,showTdtLabelLayer:r,showTdtBoundaryLayer:l,showOceanLayer:c,showTerrainWireframeLayer:u,showCloudLayer:d,enableLocationAnimation:p,enableLighting:h,atmosphereEnabled:m,height:g,pitch:v,heading:y,longitude:f,latitude:C,formattedHeight:w,formattedPitch:b,formattedHeading:_,formattedLongitude:S,formattedLatitude:A,setHeight:function(e){g.value=Number(e)},setPitch:function(e){v.value=Number(e)},setHeading:function(e){360===e?y.value=360:Math.abs(e)<1e-5?y.value=0:Math.abs(e-360)<1e-5?Math.abs(y.value-360)<1e-5?y.value=360:Math.abs(y.value)<1e-5?y.value=0:y.value=360:y.value=Number(e)},setPosition:function(e,t){f.value=Number(e),C.value=Number(t)},setSelectedLocation:function(t){e.value=t;const i=Ke[t];f.value=i.longitude,C.value=i.latitude},setMapProvider:function(e){t.value=e},reset:function(){g.value=$e,v.value=-45,y.value=0,f.value=Xe,C.value=Qe,e.value="重邮"},resetViewAngle:function(){g.value=$e,v.value=-45,y.value=0},resetPosition:function(){f.value=Xe,C.value=Qe,e.value="重邮"},setTerrainProvider:function(e){i.value=e},setShowGrid:function(e){a.value=e},setShowRoadNetworkLayer:function(e){o.value=e},setShowTdtLabelLayer:function(e){r.value=e},setShowTdtBoundaryLayer:function(e){l.value=e},setShowOceanLayer:function(e){c.value=e},setShowTerrainWireframeLayer:function(e){u.value=e},setShowCloudLayer:function(e){d.value=e},setEnableLocationAnimation:function(e){p.value=e},setEnableLighting:function(e){h.value=e},setAtmosphereEnabled:function(e){m.value=e}}}),{persist:!0});let tt=[],it=null,nt=null,st=performance.now(),at=0,ot=null,rt=null,lt=null,ct=!1,ut=[];const dt=n(!1);function ht(){if(rt&&(rt.disconnect(),rt=null),lt&&(clearInterval(lt),lt=null),window.PerformanceObserver)try{rt=new PerformanceObserver((e=>{const t=e.getEntries().filter((e=>"resource"===e.entryType&&e.transferSize>0));t.length>0&&(ut=[...ut,...t],ut.length>100&&(ut=ut.slice(-100)))})),rt.observe({entryTypes:["resource","navigation"]})}catch(e){}!function(){lt&&clearInterval(lt);lt=window.setInterval((()=>{ct||mt()}),1e4),mt()}()}function mt(){if(ct)return;ct=!0;const e=`https://www.cloudflare.com/cdn-cgi/trace?t=${Date.now()}`,t=performance.now();let i=0;fetch(e).then((e=>{const t=e.headers.get("content-length");return t&&(i=parseInt(t)),e.text()})).then((e=>{i||(i=new Blob([e]).size);const n=(performance.now()-t)/1e3;if(n>0&&i>0){at=i/1024/n,nt&&nt.update(at,1e3)}})).catch((e=>{})).finally((()=>{ct=!1}))}function pt(){if(!nt)return;const e=performance.now();if(e-st<1e3)return;const t=e-5e3,i=ut.filter((e=>e.startTime>=t));let n=0;if(i.length>0?(i.forEach((e=>{e.transferSize&&(n+=e.transferSize)})),n>0&&(at=n/1024/5)):ct||(at*=.8,at<1&&!ct&&mt()),"connection"in navigator&&navigator.connection&&navigator.connection.downlink){const e=128*navigator.connection.downlink;at<.1&&e>0&&(at=e)}nt.update(at,1e3),st=e}function gt(){it=document.createElement("div"),it.style.cssText="position:fixed;bottom:40px;right:10px;width:160px;height:100px;z-index:10000;opacity:0.95;display:none;background: rgba(38, 38, 38, 0.8);backdrop-filter: blur(3px);padding:2px;box-shadow:0 0 10px rgba(0,0,0,0.5);",it.style.display="none";const e=["position:absolute;top:0;left:0;width:80px;height:50px;overflow:hidden;","position:absolute;top:0;right:0;width:80px;height:50px;background:overflow:hidden;","position:absolute;bottom:0;left:0;width:80px;height:50px;background:overflow:hidden;","position:absolute;bottom:0;right:0;width:80px;height:50px;background:overflow:hidden;"];try{const t=vt(0,"FPS","#0ff","#002");t.dom.style.cssText=e[0],it.appendChild(t.dom),tt.push(t);const i=vt(1,"MS","#0f0","#020");i.dom.style.cssText=e[1],it.appendChild(i.dom),tt.push(i);const n=vt(2,"MB","#f0f","#202");n.dom.style.cssText=e[2],it.appendChild(n.dom),tt.push(n);const s=new be;nt=new be.Panel("KB/S","#0f0","#020"),s.addPanel(nt),s.showPanel(3),s.dom.style.cssText=e[3],yt(s.dom),it.appendChild(s.dom),tt.push(s),function(e){let t=0,i=0,n=0,s=0,a=!1;const o=document.createElement("div");function r(e){a&&(e.preventDefault(),t=n-e.clientX,i=s-e.clientY,n=e.clientX,s=e.clientY,c())}function l(e){a&&1===e.touches.length&&(t=n-e.touches[0].clientX,i=s-e.touches[0].clientY,n=e.touches[0].clientX,s=e.touches[0].clientY,c())}function c(){const n=window.innerWidth,s=window.innerHeight;let a=e.offsetTop-i,o=e.offsetLeft-t;a=Math.max(0,Math.min(a,s-e.offsetHeight)),o=Math.max(0,Math.min(o,n-e.offsetWidth)),e.style.top=a+"px",e.style.left=o+"px"}function u(){a=!1,document.onmouseup=null,document.onmousemove=null,document.ontouchend=null,document.ontouchmove=null,o.style.cursor="grab"}o.style.cssText="position:absolute;top:-25px;left:0;width:100%;height:25px;background:rgba(38, 38, 38, 0.8);backdrop-filter:blur(3px);cursor:grab;display:flex;justify-content:center;align-items:center;box-shadow:0 -2px 5px rgba(0,0,0,0.3);",o.innerHTML='<span style="color:#fff;font-size:12px;font-weight:bold;font-family:Arial;text-shadow:1px 1px 2px rgba(0,0,0,0.7);">性能监控</span>',e.appendChild(o),o.onmousedown=function(e){e.preventDefault(),a=!0,n=e.clientX,s=e.clientY,document.onmouseup=u,document.onmousemove=r,o.style.cursor="grabbing"},o.ontouchstart=function(e){1===e.touches.length&&(a=!0,n=e.touches[0].clientX,s=e.touches[0].clientY,document.ontouchend=u,document.ontouchmove=l,o.style.cursor="grabbing")}}(it),document.body.appendChild(it)}catch(t){}}function vt(e,t,i,n){const s=new be;for(;s.dom.firstChild;)s.dom.removeChild(s.dom.firstChild);let a;switch(e){case 0:a=new be.Panel(t,i,n),s.addPanel(a);let e=performance.now(),o=0,r=0;s.update=function(){o++;const t=performance.now();t>=e+1e3&&(r=Math.round(1e3*o/(t-e)),e=t,o=0),a.update(r,100)};break;case 1:a=new be.Panel(t,i,n),s.addPanel(a);let l=performance.now();s.update=function(){const e=performance.now();a.update(e-l,200),l=e};break;case 2:a=new be.Panel(t,i,n),s.addPanel(a),s.update=function(){const e=window.performance;e&&e.memory&&a.update(Math.round(e.memory.usedJSHeapSize/1048576),Math.round(e.memory.jsHeapSizeLimit/1048576))};break;default:a=new be.Panel(t,i,n),s.addPanel(a)}return yt(s.dom),s}function yt(e){e.style.pointerEvents="none";e.querySelectorAll("canvas").forEach((e=>{e.style.pointerEvents="none"})),e.addEventListener("click",(function(e){return e.preventDefault(),e.stopPropagation(),!1}),!0)}function ft(){!function(){if(ot&&(clearInterval(ot),ot=null),lt&&(clearInterval(lt),lt=null),rt&&(rt.disconnect(),rt=null),dt.value=!1,st=performance.now(),at=0,nt=null,ct=!1,ut=[],tt=[],it){try{it.parentNode?it.parentNode.removeChild(it):document.body.contains(it)&&document.body.removeChild(it)}catch(e){}it=null}}(),gt(),it&&(it.style.display="block",dt.value=!0,ht(),requestAnimationFrame(wt),ot=window.setInterval(pt,1e3))}function Ct(){it&&(it.style.display="none",dt.value=!1,ot&&(clearInterval(ot),ot=null))}function wt(){if(it&&"none"!==it.style.display&&dt.value){for(let e=0;e<tt.length;e++)tt[e]&&"function"==typeof tt[e].update&&tt[e].update();requestAnimationFrame(wt)}}function bt(){const e=navigator.userAgent||navigator.vendor||window.opera;return/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(e.toLowerCase())}const _t=(e,t,i,n)=>{switch(e){case"grid":i.setShowGrid(t),n("toggleGridLayer",t);break;case"roadNetwork":i.setShowRoadNetworkLayer(t),n("toggleRoadNetworkLayer",t);break;case"tdtLabel":i.setShowTdtLabelLayer(t),n("toggleTdtLabelLayer",t);break;case"tdtBoundary":i.setShowTdtBoundaryLayer(t),n("toggleTdtBoundaryLayer",t);break;case"ocean":i.setShowOceanLayer(t),n("toggleOceanLayer",t);break;case"terrainWireframe":i.setShowTerrainWireframeLayer(t),n("toggleTerrainWireframeLayer",t);break;case"cloud":i.setShowCloudLayer(t),n("toggleCloudLayer",t)}};class St{constructor(e){t(this,"sources"),t(this,"show"),t(this,"_sources"),t(this,"_command"),t(this,"_cubeMap"),t(this,"_attributeLocations"),t(this,"_useHdr"),t(this,"_noiseTexture"),t(this,"viewer"),this.sources=e.sources,this._sources=void 0,this.viewer=e.viewer,this.show=void 0===e.show||e.show,this._command=new window.Cesium.DrawCommand({modelMatrix:window.Cesium.Matrix4.clone(window.Cesium.Matrix4.IDENTITY),owner:this}),this._cubeMap=void 0,this._attributeLocations=void 0,this._useHdr=void 0,this.init()}init(){this.viewer&&this.viewer.scene&&(this.viewer.scene.skyAtmosphere.show=!1),this.loadNoiseTexture()}loadNoiseTexture(){const e=window.Cesium;e.Resource.fetchImage("/assets/iChannel2.png").then((t=>{this._noiseTexture=new e.Texture({context:this.viewer.scene.context,source:t})})).catch((e=>{}))}update(e,t){const i=window.Cesium,n=this;if(!this.show)return;if(e.mode!==i.SceneMode.SCENE3D&&e.mode!==i.SceneMode.MORPHING)return;if(!e.passes.render)return;const s=e.context,a=new i.Matrix3,o=this._command;if(o.modelMatrix=i.Transforms.eastNorthUpToFixedFrame(e.camera._positionWC),!o.vertexArray){o.uniformMap={u_rotateMatrix:function(){return(i.Matrix4.getRotation||i.Matrix4.getMatrix3)(o.modelMatrix,a)},iChannel0:function(){return n._noiseTexture||s.defaultTexture}};const e=i.BoxGeometry.createGeometry(i.BoxGeometry.fromDimensions({dimensions:new i.Cartesian3(2,2,2),vertexFormat:i.VertexFormat.POSITION_ONLY}));this._attributeLocations=i.GeometryPipeline.createAttributeLocations(e),o.vertexArray=i.VertexArray.fromGeometry({context:s,geometry:e,attributeLocations:this._attributeLocations,bufferUsage:i.BufferUsage.STATIC_DRAW}),o.renderState=i.RenderState.fromCache({blending:i.BlendingState.ALPHA_BLEND})}if(!o.shaderProgram||this._useHdr!==t){const e=new i.ShaderSource({defines:[t?"HDR":""],sources:["\nuniform sampler2D iChannel0; \n// 声明输出变量\nout vec4 fragColor;\n\n// 宏定义区域 - 保持与GLSL兼容\n#define PI 3.14159265359\n#define _in(T) T\n#define _inout(T) inout T\n#define _out(T) out T\n#define _begin(type) type(\n#define _end )\n#define _mutable(T) T\n#define _constant(T) const T\n#define mul(a, b) (a) * (b)\n\n// 使用Cesium提供的uniform变量\n#define u_res czm_viewport.zw\n#define u_time czm_frameNumber / 200.0\n#define u_mouse czm_viewport.zw / 2\n\nstruct ray_t {\n\tvec3 origin;\n\tvec3 direction;\n};\n#define BIAS 1e-4 // small offset to avoid self-intersections\n\nstruct sphere_t {\n\tvec3 origin;\n\tfloat radius;\n\tint material;\n};\n\nstruct plane_t {\n\tvec3 direction;\n\tfloat distance;\n\tint material;\n};\n\nstruct hit_t {\n\tfloat t;\n\tint material_id;\n\tvec3 normal;\n\tvec3 origin;\n};\n#define max_dist 1e8\n_constant(hit_t) no_hit = _begin(hit_t)\n\tfloat(max_dist + 1e1), // 'infinite' distance\n\t-1, // material id\n\tvec3(0., 0., 0.), // normal\n\tvec3(0., 0., 0.) // origin\n_end;\n\nray_t get_primary_ray(\n\t_in(vec3) cam_local_point,\n\t_inout(vec3) cam_origin,\n\t_inout(vec3) cam_look_at\n){\n\tvec3 fwd = normalize(cam_look_at - cam_origin);\n\tvec3 up = vec3(0, 1, 0);\n\tvec3 right = cross(up, fwd);\n\tup = cross(fwd, right);\n\n\tray_t r = _begin(ray_t)\n\t\tcam_origin,\n\t\tnormalize(fwd + up * cam_local_point.y + right * cam_local_point.x)\n\t_end;\n\treturn r;\n}\n\n_constant(mat3) mat3_ident = mat3(1, 0, 0, 0, 1, 0, 0, 0, 1);\n\nmat2 rotate_2d(\n\t_in(float) angle_degrees\n){\n\tfloat angle = radians(angle_degrees);\n\tfloat _sin = sin(angle);\n\tfloat _cos = cos(angle);\n\treturn mat2(_cos, -_sin, _sin, _cos);\n}\n\nmat3 rotate_around_z(\n\t_in(float) angle_degrees\n){\n\tfloat angle = radians(angle_degrees);\n\tfloat _sin = sin(angle);\n\tfloat _cos = cos(angle);\n\treturn mat3(_cos, -_sin, 0, _sin, _cos, 0, 0, 0, 1);\n}\n\nmat3 rotate_around_y(\n\t_in(float) angle_degrees\n){\n\tfloat angle = radians(angle_degrees);\n\tfloat _sin = sin(angle);\n\tfloat _cos = cos(angle);\n\treturn mat3(_cos, 0, _sin, 0, 1, 0, -_sin, 0, _cos);\n}\n\nmat3 rotate_around_x(\n\t_in(float) angle_degrees\n){\n\tfloat angle = radians(angle_degrees);\n\tfloat _sin = sin(angle);\n\tfloat _cos = cos(angle);\n\treturn mat3(1, 0, 0, 0, _cos, -_sin, 0, _sin, _cos);\n}\n\nvec3 linear_to_srgb(\n\t_in(vec3) color\n){\n\tconst float p = 1. / 2.2;\n\treturn vec3(pow(color.r, p), pow(color.g, p), pow(color.b, p));\n}\nvec3 srgb_to_linear(\n\t_in(vec3) color\n){\n\tconst float p = 2.2;\n\treturn vec3(pow(color.r, p), pow(color.g, p), pow(color.b, p));\n}\n\nfloat checkboard_pattern(\n\t_in(vec2) pos,\n\t_in(float) scale\n){\n\tvec2 pattern = floor(pos * scale);\n\treturn mod(pattern.x + pattern.y, 2.0);\n}\n\nfloat band (\n\t_in(float) start,\n\t_in(float) peak,\n\t_in(float) end,\n\t_in(float) t\n){\n\treturn\n\tsmoothstep (start, peak, t) *\n\t(1. - smoothstep (peak, end, t));\n}\nvoid fast_orthonormal_basis(\n\t_in(vec3) n,\n\t_out(vec3) f,\n\t_out(vec3) r\n){\n\tfloat a = 1. / (1. + n.z);\n\tfloat b = -n.x*n.y*a;\n\tf = vec3(1. - n.x*n.x*a, b, -n.x);\n\tr = vec3(b, 1. - n.y*n.y*a, -n.y);\n}\n\nvoid intersect_sphere(\n\t_in(ray_t) ray,\n\t_in(sphere_t) sphere,\n\t_inout(hit_t) hit\n){\n\tvec3 rc = sphere.origin - ray.origin;\n\tfloat radius2 = sphere.radius * sphere.radius;\n\tfloat tca = dot(rc, ray.direction);\n\tif (tca < 0.) return;\n\n\tfloat d2 = dot(rc, rc) - tca * tca;\n\tif (d2 > radius2) return;\n\n\tfloat thc = sqrt(radius2 - d2);\n\tfloat t0 = tca - thc;\n\tfloat t1 = tca + thc;\n\n\tif (t0 < 0.) t0 = t1;\n\tif (t0 > hit.t) return;\n\n\tvec3 impact = ray.origin + ray.direction * t0;\n\n\thit.t = t0;\n\thit.material_id = sphere.material;\n\thit.origin = impact;\n\thit.normal = (impact - sphere.origin) / sphere.radius;\n}\nvoid intersect_plane(\n\t_in(ray_t) ray,\n\t_in(plane_t) p,\n\t_inout(hit_t) hit\n){\n\tfloat denom = dot(p.direction, ray.direction);\n\tif (denom < 1e-6) return;\n\n\tvec3 P0 = vec3(p.distance, p.distance, p.distance);\n\tfloat t = dot(P0 - ray.origin, p.direction) / denom;\n\tif (t < 0. || t > hit.t) return;\n\t\n\thit.t = t;\n\thit.material_id = p.material;\n\thit.origin = ray.origin + ray.direction * t;\n\thit.normal = faceforward(p.direction, ray.direction, p.direction);\n}\n\n// ----------------------------------------------------------------------------\n// Volumetric utilities\n// ----------------------------------------------------------------------------\n\nfloat isotropic_phase_func(float mu)\n{\n\treturn 1. / 4. * PI;\n}\n\nfloat rayleigh_phase_func(float mu)\n{\n\treturn 3. * (1. + mu*mu) / (16. * PI);\n}\n\nfloat henyey_greenstein_phase_func(float mu)\n{\n\tconst float g = 0.76;\n\n\treturn (1. - g*g) / ((4. + PI) * pow(1. + g*g - 2.*g*mu, 1.5));\n}\n\nfloat schlick_phase_func(float mu)\n{\n\tconst float g = 0.76;\n\tconst float k = 1.55*g - 0.55 * (g*g*g);\n\n\treturn (1. - k*k) / (4. * PI * (1. + k*mu) * (1. + k*mu));\n}\n\nstruct volume_sampler_t {\n\tvec3 origin; // start of ray\n\tvec3 pos; // current pos of acccumulation ray\n\tfloat height;\n\n\tfloat coeff_absorb;\n\tfloat T; // transmitance\n\n\tvec3 C; // color\n\tfloat alpha;\n};\n\nvolume_sampler_t begin_volume(\n\t_in(vec3) origin,\n\t_in(float) coeff_absorb\n){\n\tvolume_sampler_t v = _begin(volume_sampler_t)\n\t\torigin, origin, 0.,\n\t\tcoeff_absorb, 1.,\n\t\tvec3(0., 0., 0.), 0.\n\t_end;\n\treturn v;\n}\n\nfloat illuminate_volume(\n\t_inout(volume_sampler_t) vol,\n\t_in(vec3) V,\n\t_in(vec3) L\n);\n\nvoid integrate_volume(\n\t_inout(volume_sampler_t) vol,\n\t_in(vec3) V,\n\t_in(vec3) L,\n\t_in(float) density,\n\t_in(float) dt\n){\n\t// change in transmittance (follows Beer-Lambert law)\n\tfloat T_i = exp(-vol.coeff_absorb * density * dt);\n\t// Update accumulated transmittance\n\tvol.T *= T_i;\n\t// integrate output radiance (here essentially color)\n\tvol.C += vol.T * illuminate_volume(vol, V, L) * density * dt;\n\t// accumulate opacity\n\tvol.alpha += (1. - T_i) * (1. - vol.alpha);\n}\n\n\n#define cld_march_steps (50)\n#define cld_coverage (.3125)\n#define cld_thick (90.)\n#define cld_absorb_coeff (1.)\n#define cld_wind_dir vec3(0, 0, -u_time * .2)\n#define cld_sun_dir normalize(vec3(0, 0/*abs(sin(u_time * .3))*/, -1))\n_mutable(float) coverage_map;\n\n\nfloat hash(\n\t_in(float) n\n){\n\treturn fract(sin(n)*753.5453123);\n}\n\nfloat noise_iq(\n\t_in(vec3) x\n){\n\tvec3 p = floor(x);\n\tvec3 f = fract(x);\n\tf = f*f*(3.0 - 2.0*f);\n\n    vec2 uv = (p.xy + vec2(37.0, 17.0)*p.z) + f.xy;\n\t// 修改texture2D为texture\n\tvec2 rg = texture(iChannel0, (uv+.5)/256.0).xy;\n\treturn mix(rg.x, rg.y, f.z);\n}\n\n#define gnoise(x) noise_iq(x)\n\nvec3 mod289(vec3 x) {\n  return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec4 mod289(vec4 x) {\n  return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec4 permute(vec4 x) {\n     return mod289(((x*34.0)+1.0)*x);\n}\n\nvec4 taylorInvSqrt(vec4 r)\n{\n  return 1.79284291400159 - 0.85373472095314 * r;\n}\n\nfloat snoise(vec3 v)\n  { \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  vec3 x1 = x0 - i1 + C.xxx;\n  vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n  vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y\n\n// Permutations\n  i = mod289(i); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n  float n_ = 0.142857142857; // 1.0/7.0\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0, 0, 0, 0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), \n                                dot(p2,x2), dot(p3,x3) ) );\n  }\n#define noise(x) snoise(x)\n\n#define DECL_FBM_FUNC(_name, _octaves, _basis) float _name(_in(vec3) pos, _in(float) lacunarity, _in(float) init_gain, _in(float) gain) { vec3 p = pos; float H = init_gain; float t = 0.; for (int i = 0; i < _octaves; i++) { t += _basis * H; p *= lacunarity; H *= gain; } return t; }\n\nDECL_FBM_FUNC(fbm, 4, noise(p))\nDECL_FBM_FUNC(fbm_clouds, 5, abs(noise(p)))\n\nvec3 render_sky_color(\n\t_in(vec3) eye_dir\n){\n\t_constant(vec3) sun_color = vec3(1., .7, .55);\n\tfloat sun_amount = max(dot(eye_dir, cld_sun_dir), 0.);\n\n\tvec3 sky = mix(vec3(.0, .1, .4), vec3(.3, .6, .8), 1.0 - eye_dir.y);\n\tsky += sun_color * min(pow(sun_amount, 1500.0) * 5.0, 1.0);\n\tsky += sun_color * min(pow(sun_amount, 10.0) * .6, 1.0);\n\n\treturn sky;\n}\n\nfloat density_func(\n\t_in(vec3) pos,\n\t_in(float) h\n){\n\tvec3 p = pos * .001 + cld_wind_dir;\n\tfloat dens = fbm_clouds(p * 2.032, 2.6434, .5, .5);\n\t\n\tdens *= smoothstep (cld_coverage, cld_coverage + .035, dens);\n\n\treturn dens;\n}\n\nfloat illuminate_volume(\n\t_inout(volume_sampler_t) cloud,\n\t_in(vec3) V,\n\t_in(vec3) L\n){\n\treturn exp(cloud.height) / 1.95;\n}\n\nvec4 render_clouds(\n\t_in(ray_t) eye\n){\n\tconst int steps = cld_march_steps;\n\tconst float march_step = cld_thick / float(steps);\n\n\tvec3 projection = eye.direction / eye.direction.y;\n\tvec3 iter = projection * march_step;\n\n\tfloat cutoff = dot(eye.direction, vec3(0, 1, 0));\n\n\tvolume_sampler_t cloud = begin_volume(\n\t\teye.origin + projection * 100.,\n\t\tcld_absorb_coeff);\n\n\n\tfor (int i = 0; i < steps; i++) {\n\t\tcloud.height = (cloud.pos.y - cloud.origin.y)\n\t\t\t/ cld_thick;\n\t\tfloat dens = density_func(cloud.pos, cloud.height);\n\n\t\tintegrate_volume(\n\t\t\tcloud,\n\t\t\teye.direction, cld_sun_dir,\n\t\t\tdens, march_step);\n\n\t\tcloud.pos += iter;\n\n\t\tif (cloud.alpha > .999) break;\n\t}\n\n\treturn vec4(cloud.C, cloud.alpha * smoothstep(.0, .2, cutoff));\n}\n\nvoid setup_camera(\n\t_inout(vec3) eye,\n\t_inout(vec3) look_at\n){\n\teye = vec3(0, 1., 0);\n\tlook_at = vec3(0, 1.6, -1);\n}\n\nvoid setup_scene()\n{\n}\n\nvec3 render(\n\t_in(ray_t) eye_ray,\n\t_in(vec3) point_cam\n){\n\tvec3 sky = render_sky_color(eye_ray.direction);\n\tif (dot(eye_ray.direction, vec3(0, 1, 0)) < 0.05) return sky;\n\n\tvec4 cld = render_clouds(eye_ray);\n\tvec3 col = mix(sky, cld.rgb, cld.a);\n\n\treturn col;\n}\n\n#define FOV 3.1 // 45 degrees\n\nvoid main(){\n\tvec2 aspect_ratio = vec2(u_res.x / u_res.y, 1);\n\n\tvec3 color = vec3(0, 0, 0);\n\n\tvec3 eye, look_at;\n\tsetup_camera(eye, look_at);\n\n\tsetup_scene();\n\n\tvec2 point_ndc = gl_FragCoord.xy / u_res.xy;\n\n\tvec3 point_cam = vec3(\n\t\t(2.0 * point_ndc - 1.0) * aspect_ratio * FOV,\n\t\t-1.0);\n\n\tray_t ray = get_primary_ray(point_cam, eye, look_at);\n\n\tcolor += render(ray, point_cam);\n\n\t// 使用fragColor而不是gl_FragColor\n\tfragColor = vec4(linear_to_srgb(color), 1.0);\n}\n"]});o.shaderProgram=i.ShaderProgram.fromCache({context:s,vertexShaderSource:"\nout vec3 v_texCoord;\nin vec3 position;\nuniform mat3 u_rotateMatrix;\nvoid main() {\n  vec3 p = czm_viewRotation * u_rotateMatrix * (czm_temeToPseudoFixed * (czm_entireFrustum.y * position));\n  gl_Position = czm_projection * vec4(p, 1.0);\n  v_texCoord = position.xyz;\n}",fragmentShaderSource:e,attributeLocations:this._attributeLocations}),this._useHdr=t}return o}isDestroyed(){return!1}destroy(){const e=window.Cesium,t=this._command;return t.vertexArray=t.vertexArray&&t.vertexArray.destroy(),t.shaderProgram=t.shaderProgram&&t.shaderProgram.destroy(),this._noiseTexture&&this._noiseTexture.destroy(),e.destroyObject(this)}}const At="assets/skybox",Et="assets/skybox-outer-space",xt=[{id:"default",name:"默认星空",description:"Cesium默认的星空天空盒",enabled:!0,type:"space"},{id:"qingtian",name:"晴朗天空",description:"晴朗的蓝天白云",enabled:!0,type:"ground"},{id:"epic_bluesunset",name:"史诗日落",description:"壮丽的蓝色日落景观",enabled:!0,type:"ground"},{id:"wanxia",name:"绚丽晚霞",description:"美丽的晚霞景色",enabled:!0,type:"ground"},{id:"lantian",name:"清澈蓝天",description:"清澈的蓝天",enabled:!0,type:"ground"},{id:"cold_night",name:"寒冷夜晚",description:"冬季寒冷的夜晚",enabled:!0,type:"ground"},{id:"cold_sunset",name:"寒冷日落",description:"北方寒冷的日落景色",enabled:!0,type:"ground"},{id:"deep_dusk",name:"深沉暮色",description:"深邃的夕阳暮色",enabled:!0,type:"ground"},{id:"epic_gloriouspink",name:"绚丽粉红",description:"绚丽的粉红色天空",enabled:!0,type:"ground"},{id:"night_moonburst",name:"月光夜空",description:"月光照耀的夜空",enabled:!0,type:"ground"},{id:"overcast_low",name:"阴云密布",description:"低空阴云密布的天空",enabled:!0,type:"ground"},{id:"space_anotherplanet",name:"异星空间",description:"其他星球上的太空景观",enabled:!0,type:"ground"},{id:"space_1",name:"太空星空 1",description:"璀璨星空太空效果 - 样式1",enabled:!0,type:"space"},{id:"space_2",name:"太空星空 2",description:"璀璨星空太空效果 - 样式2",enabled:!0,type:"space"},{id:"space_3",name:"太空星空 3",description:"璀璨星空太空效果 - 样式3",enabled:!0,type:"space"},{id:"space_4",name:"太空星空 4",description:"璀璨星空太空效果 - 样式4",enabled:!0,type:"space"},{id:"space_5",name:"太空星空 5",description:"璀璨星空太空效果 - 样式5",enabled:!0,type:"space"},{id:"space_6",name:"太空星空 6",description:"璀璨星空太空效果 - 样式6",enabled:!0,type:"space"},{id:"volumetric_clouds",name:"体积云天空",description:"动态渲染的体积云效果",enabled:!0,type:"volumetric"}];class Tt{constructor(e){t(this,"viewer"),t(this,"enabled",!1),t(this,"defaultSkybox",null),t(this,"currentSkybox",null),t(this,"skyboxType","epic_bluesunset"),t(this,"spaceSkyboxType","default"),t(this,"heightThreshold",24e4),t(this,"preUpdateListener",null),t(this,"skyboxesInitialized",!1),t(this,"sceneOriginalProperties",{}),t(this,"skyboxes",{}),t(this,"isAboveThreshold",!1),t(this,"atmosphereEnabled",!1),this.viewer=e,this.viewer&&this.viewer.scene&&(this.saveOriginalSceneSettings(),this.defaultSkybox=this.viewer.scene.skyBox,this.skyboxes={},this.skyboxes.default=this.defaultSkybox,this.initialize())}saveOriginalSceneSettings(){if(!this.viewer||!this.viewer.scene)return;const e=this.viewer.scene;this.sceneOriginalProperties={skyBox:e.skyBox,skyAtmosphere:{show:e.skyAtmosphere.show},globe:{showGroundAtmosphere:e.globe.showGroundAtmosphere,enableLighting:e.globe.enableLighting},fog:{enabled:e.fog.enabled,density:e.fog.density},backgroundColor:e.backgroundColor.clone()},this.atmosphereEnabled=e.skyAtmosphere.show}restoreOriginalSceneSettings(){if(!this.viewer||!this.viewer.scene||!this.sceneOriginalProperties)return;const e=this.viewer.scene,t=this.sceneOriginalProperties;t.globe&&(e.globe.showGroundAtmosphere=t.globe.showGroundAtmosphere,e.globe.enableLighting=t.globe.enableLighting,e.globe.depthTestAgainstTerrain=t.globe.depthTestAgainstTerrain),t.fog&&(e.fog.enabled=t.fog.enabled,e.fog.density=t.fog.density),t.skyAtmosphere&&(e.skyAtmosphere.show=t.skyAtmosphere.show),t.backgroundColor&&(e.backgroundColor=t.backgroundColor)}initialize(){this.viewer&&(this.createSkyboxes(),this.setSkyboxType("epic_bluesunset"),this.spaceSkyboxType="default",this.skyboxesInitialized=!0)}createSkyboxes(){try{const t=window.Cesium;if(!t)return;if(!this.viewer||!this.viewer.scene)return;this.skyboxes||(this.skyboxes={}),this.skyboxes.default||(this.skyboxes.default=this.defaultSkybox);try{this.skyboxes.qingtian=new Te({sources:{positiveX:`${At}/qingtian/rightav9.jpg`,negativeX:`${At}/qingtian/leftav9.jpg`,positiveY:`${At}/qingtian/frontav9.jpg`,negativeY:`${At}/qingtian/backav9.jpg`,positiveZ:`${At}/qingtian/topav9.jpg`,negativeZ:`${At}/qingtian/bottomav9.jpg`}}),this.skyboxes.qingtian.name="晴朗天空"}catch(e){}try{this.skyboxes.epic_bluesunset=new Te({sources:{positiveX:`${At}/Epic_BlueSunset/Epic_BlueSunset_Cam_3_Right-X.png`,negativeX:`${At}/Epic_BlueSunset/Epic_BlueSunset_Cam_2_Left+X.png`,positiveY:`${At}/Epic_BlueSunset/Epic_BlueSunset_Cam_1_Back-Z.png`,negativeY:`${At}/Epic_BlueSunset/Epic_BlueSunset_Cam_0_Front+Z.png`,positiveZ:`${At}/Epic_BlueSunset/Epic_BlueSunset_Cam_4_Up+Y.png`,negativeZ:`${At}/Epic_BlueSunset/Epic_BlueSunset_Cam_5_Down-Y.png`},show:!0}),this.skyboxes.epic_bluesunset.name="史诗日落"}catch(e){}try{this.skyboxes.wanxia=new Te({sources:{positiveX:`${At}/wanxia/SunSetRight.png`,negativeX:`${At}/wanxia/SunSetLeft.png`,positiveY:`${At}/wanxia/SunSetFront.png`,negativeY:`${At}/wanxia/SunSetBack.png`,positiveZ:`${At}/wanxia/SunSetUp.png`,negativeZ:`${At}/wanxia/SunSetDown.png`},show:!0}),this.skyboxes.wanxia.name="绚丽晚霞"}catch(e){}try{this.skyboxes.lantian=new Te({sources:{positiveX:`${At}/lantian/Right.jpg`,negativeX:`${At}/lantian/Left.jpg`,positiveY:`${At}/lantian/Front.jpg`,negativeY:`${At}/lantian/Back.jpg`,positiveZ:`${At}/lantian/Up.jpg`,negativeZ:`${At}/lantian/Down.jpg`},show:!0}),this.skyboxes.lantian.name="清澈蓝天"}catch(e){}try{this.skyboxes.cold_night=new Te({sources:{positiveX:`${At}/Cold Night/Cold Night__Cam_3_Right-X.png`,negativeX:`${At}/Cold Night/Cold Night__Cam_2_Left+X.png`,positiveY:`${At}/Cold Night/Cold Night__Cam_1_Back-Z.png`,negativeY:`${At}/Cold Night/Cold Night__Cam_0_Front+Z.png`,positiveZ:`${At}/Cold Night/Cold Night__Cam_4_Up+Y.png`,negativeZ:`${At}/Cold Night/Cold Night__Cam_5_Down-Y.png`},show:!0}),this.skyboxes.cold_night.name="寒冷夜晚"}catch(e){}try{this.skyboxes.cold_sunset=new Te({sources:{positiveX:`${At}/Cold Sunset/Cold Sunset__Cam_3_Right-X.png`,negativeX:`${At}/Cold Sunset/Cold Sunset__Cam_2_Left+X.png`,positiveY:`${At}/Cold Sunset/Cold Sunset__Cam_1_Back-Z.png`,negativeY:`${At}/Cold Sunset/Cold Sunset__Cam_0_Front+Z.png`,positiveZ:`${At}/Cold Sunset/Cold Sunset__Cam_4_Up+Y.png`,negativeZ:`${At}/Cold Sunset/Cold Sunset__Cam_5_Down-Y.png`},show:!0}),this.skyboxes.cold_sunset.name="寒冷日落"}catch(e){}try{this.skyboxes.deep_dusk=new Te({sources:{positiveX:`${At}/Deep Dusk/Deep Dusk__Cam_3_Right-X.png`,negativeX:`${At}/Deep Dusk/Deep Dusk__Cam_2_Left+X.png`,positiveY:`${At}/Deep Dusk/Deep Dusk__Cam_1_Back-Z.png`,negativeY:`${At}/Deep Dusk/Deep Dusk__Cam_0_Front+Z.png`,positiveZ:`${At}/Deep Dusk/Deep Dusk__Cam_4_Up+Y.png`,negativeZ:`${At}/Deep Dusk/Deep Dusk__Cam_5_Down-Y.png`},show:!0}),this.skyboxes.deep_dusk.name="深沉暮色"}catch(e){}try{this.skyboxes.epic_gloriouspink=new Te({sources:{positiveX:`${At}/Epic_GloriousPink/Epic_GloriousPink_Cam_3_Right-X.png`,negativeX:`${At}/Epic_GloriousPink/Epic_GloriousPink_Cam_2_Left+X.png`,positiveY:`${At}/Epic_GloriousPink/Epic_GloriousPink_Cam_1_Back-Z.png`,negativeY:`${At}/Epic_GloriousPink/Epic_GloriousPink_Cam_0_Front+Z.png`,positiveZ:`${At}/Epic_GloriousPink/Epic_GloriousPink_Cam_4_Up+Y.png`,negativeZ:`${At}/Epic_GloriousPink/Epic_GloriousPink_Cam_5_Down-Y.png`},show:!0}),this.skyboxes.epic_gloriouspink.name="绚丽粉红"}catch(e){}try{this.skyboxes.night_moonburst=new Te({sources:{positiveX:`${At}/Night MoonBurst/Night Moon Burst_Cam_3_Right-X.png`,negativeX:`${At}/Night MoonBurst/Night Moon Burst_Cam_2_Left+X.png`,positiveY:`${At}/Night MoonBurst/Night Moon Burst_Cam_1_Back-Z.png`,negativeY:`${At}/Night MoonBurst/Night Moon Burst_Cam_0_Front+Z.png`,positiveZ:`${At}/Night MoonBurst/Night Moon Burst_Cam_4_Up+Y.png`,negativeZ:`${At}/Night MoonBurst/Night Moon Burst_Cam_5_Down-Y.png`},show:!0}),this.skyboxes.night_moonburst.name="月光夜空"}catch(e){}try{this.skyboxes.overcast_low=new Te({sources:{positiveX:`${At}/Overcast Low/Sky_AllSky_Overcast4_Low_Cam_3_Right-X.png`,negativeX:`${At}/Overcast Low/Sky_AllSky_Overcast4_Low_Cam_2_Left+X.png`,positiveY:`${At}/Overcast Low/Sky_AllSky_Overcast4_Low_Cam_1_Back-Z.png`,negativeY:`${At}/Overcast Low/Sky_AllSky_Overcast4_Low_Cam_0_Front+Z.png`,positiveZ:`${At}/Overcast Low/Sky_AllSky_Overcast4_Low_Cam_4_Up+Y.png`,negativeZ:`${At}/Overcast Low/Sky_AllSky_Overcast4_Low_Cam_5_Down-Y.png`},show:!0}),this.skyboxes.overcast_low.name="阴云密布"}catch(e){}try{this.skyboxes.space_anotherplanet=new Te({sources:{positiveX:`${At}/Space_AnotherPlanet/AllSky_Space_AnotherPlanet_Cam_3_Right-X.png`,negativeX:`${At}/Space_AnotherPlanet/AllSky_Space_AnotherPlanet_Cam_2_Left+X.png`,positiveY:`${At}/Space_AnotherPlanet/AllSky_Space_AnotherPlanet_Cam_1_Back-Z.png`,negativeY:`${At}/Space_AnotherPlanet/AllSky_Space_AnotherPlanet_Cam_0_Front+Z.png`,positiveZ:`${At}/Space_AnotherPlanet/AllSky_Space_AnotherPlanet_Cam_4_Up+Y.png`,negativeZ:`${At}/Space_AnotherPlanet/AllSky_Space_AnotherPlanet_Cam_5_Down-Y.png`},show:!0}),this.skyboxes.space_anotherplanet.name="异星空间"}catch(e){}this.skyboxes.space_1=new t.SkyBox({sources:{positiveX:`${Et}/1/tycho2t3_80_px.jpg`,negativeX:`${Et}/1/tycho2t3_80_mx.jpg`,positiveY:`${Et}/1/tycho2t3_80_py.jpg`,negativeY:`${Et}/1/tycho2t3_80_my.jpg`,positiveZ:`${Et}/1/tycho2t3_80_pz.jpg`,negativeZ:`${Et}/1/tycho2t3_80_mz.jpg`}}),this.skyboxes.space_2=new t.SkyBox({sources:{positiveX:`${Et}/2/tycho2t3_80_px.jpg`,negativeX:`${Et}/2/tycho2t3_80_mx.jpg`,positiveY:`${Et}/2/tycho2t3_80_py.jpg`,negativeY:`${Et}/2/tycho2t3_80_my.jpg`,positiveZ:`${Et}/2/tycho2t3_80_pz.jpg`,negativeZ:`${Et}/2/tycho2t3_80_mz.jpg`}}),this.skyboxes.space_3=new t.SkyBox({sources:{positiveX:`${Et}/3/tycho2t3_80_px.jpg`,negativeX:`${Et}/3/tycho2t3_80_mx.jpg`,positiveY:`${Et}/3/tycho2t3_80_py.jpg`,negativeY:`${Et}/3/tycho2t3_80_my.jpg`,positiveZ:`${Et}/3/tycho2t3_80_pz.jpg`,negativeZ:`${Et}/3/tycho2t3_80_mz.jpg`}}),this.skyboxes.space_4=new t.SkyBox({sources:{positiveX:`${Et}/4/tycho2t3_80_px.jpg`,negativeX:`${Et}/4/tycho2t3_80_mx.jpg`,positiveY:`${Et}/4/tycho2t3_80_py.jpg`,negativeY:`${Et}/4/tycho2t3_80_my.jpg`,positiveZ:`${Et}/4/tycho2t3_80_pz.jpg`,negativeZ:`${Et}/4/tycho2t3_80_mz.jpg`}}),this.skyboxes.space_5=new t.SkyBox({sources:{positiveX:`${Et}/5/tycho2t3_80_px.jpg`,negativeX:`${Et}/5/tycho2t3_80_mx.jpg`,positiveY:`${Et}/5/tycho2t3_80_py.jpg`,negativeY:`${Et}/5/tycho2t3_80_my.jpg`,positiveZ:`${Et}/5/tycho2t3_80_pz.jpg`,negativeZ:`${Et}/5/tycho2t3_80_mz.jpg`}}),this.skyboxes.space_6=new t.SkyBox({sources:{positiveX:`${Et}/6/tycho2t3_80_px.jpg`,negativeX:`${Et}/6/tycho2t3_80_mx.jpg`,positiveY:`${Et}/6/tycho2t3_80_py.jpg`,negativeY:`${Et}/6/tycho2t3_80_my.jpg`,positiveZ:`${Et}/6/tycho2t3_80_pz.jpg`,negativeZ:`${Et}/6/tycho2t3_80_mz.jpg`}});try{this.skyboxes.volumetric_clouds=new St({viewer:this.viewer,show:!0}),this.skyboxes.volumetric_clouds.name="体积云天空"}catch(e){}}catch(e){}}enable(){this.enabled||(this.enabled=!0,this.skyboxesInitialized||this.initialize(),this.setupHeightMonitor(),this.currentSkybox&&this.updateSkyboxByHeight(this.currentSkybox,!0))}disable(){this.enabled&&(this.enabled=!1,this.removeHeightMonitor(),this.viewer&&this.viewer.scene&&(this.viewer.scene.skyBox=this.defaultSkybox,this.restoreOriginalSceneSettings()))}setSkyboxType(e){if(!this.skyboxes[e]&&"default"!==e)return;"volumetric_clouds"===e?(this.skyboxType=e,this.viewer&&this.viewer.scene&&(this.viewer.scene.skyAtmosphere.show=!1)):"default"===e||e.startsWith("space_")?this.setSpaceSkyboxType(e):this.setGroundSkyboxType(e)}setGroundSkyboxType(e){this.skyboxes[e]&&(this.skyboxType=e,this.enabled&&!this.isAboveThreshold&&this.updateSkyboxByHeight(this.skyboxes[e],!0))}setSpaceSkyboxType(e){this.skyboxes[e]&&(this.spaceSkyboxType=e,this.enabled&&this.isAboveThreshold&&this.updateSkyboxByHeight(this.skyboxes[e],!0))}setHeightThreshold(e){this.heightThreshold=e}setupHeightMonitor(){this.preUpdateListener||(this.preUpdateListener=this.viewer.scene.preUpdate.addEventListener((()=>{this.updateSkyboxByHeight(this.currentSkybox)})))}removeHeightMonitor(){this.preUpdateListener&&(this.preUpdateListener(),this.preUpdateListener=null)}getSkyboxName(e){return e?e.name?e.name:e===this.defaultSkybox?"默认星空":e===this.skyboxes.qingtian?"晴朗天空":e===this.skyboxes.epic_bluesunset?"史诗日落":e===this.skyboxes.wanxia?"绚丽晚霞":e===this.skyboxes.lantian?"清澈蓝天":e===this.skyboxes.cold_night?"寒冷夜晚":e===this.skyboxes.cold_sunset?"寒冷日落":e===this.skyboxes.deep_dusk?"深沉暮色":e===this.skyboxes.epic_gloriouspink?"绚丽粉红":e===this.skyboxes.night_moonburst?"月光夜空":e===this.skyboxes.overcast_low?"阴云密布":e===this.skyboxes.space_anotherplanet?"异星空间":"自定义天空盒":"未知"}adjustSceneForSkybox(e){if(!this.viewer||!this.viewer.scene)return;const t=this.viewer.scene;if(e.startsWith("space_")&&"space_anotherplanet"!==e)t.fog.enabled=!1,t.globe.showGroundAtmosphere=!1,t.skyAtmosphere.show=this.atmosphereEnabled,t.backgroundColor=new window.Cesium.Color(0,0,0,1);else switch(t.skyAtmosphere.show=this.atmosphereEnabled,e){case"qingtian":t.fog.enabled=!0,t.fog.density=9e-5,t.globe.showGroundAtmosphere=!0,t.backgroundColor=new window.Cesium.Color(.8,.9,1,1);break;case"epic_bluesunset":case"wanxia":break;case"lantian":case"epic_gloriouspink":t.globe&&(t.globe.globeAlpha=1);break;case"cold_night":case"night_moonburst":t.globe&&(t.globe.globeAlpha=.85);break;case"cold_sunset":case"overcast_low":t.globe&&(t.globe.globeAlpha=.95);break;case"deep_dusk":case"space_anotherplanet":t.globe&&(t.globe.globeAlpha=.9);break;default:t.fog.enabled=!0,t.fog.density=1e-4,t.globe.showGroundAtmosphere=!0,t.backgroundColor=new window.Cesium.Color(.3,.4,.5,1)}}updateSkyboxByHeight(e,t=!1){if(!this.enabled||!this.skyboxesInitialized)return;const i=this.viewer.camera.positionCartographic.height,n=this.isAboveThreshold;this.isAboveThreshold=i>=this.heightThreshold;const s=n!==this.isAboveThreshold;if(this.viewer&&this.viewer.scene&&(s||t))if(this.isAboveThreshold){this.viewer.scene.skyAtmosphere.show=!0,this.atmosphereEnabled=!0;try{et().setAtmosphereEnabled(!0)}catch(a){}}else{this.viewer.scene.skyAtmosphere.show=!1,this.atmosphereEnabled=!1;try{et().setAtmosphereEnabled(!1)}catch(a){}}if(t)if(this.isAboveThreshold){const e=this.skyboxes[this.spaceSkyboxType];this.viewer.scene.skyBox!==e&&(this.viewer.scene.skyBox=e,this.currentSkybox=e,this.adjustSceneForSkybox(this.spaceSkyboxType))}else{const e=this.skyboxes[this.skyboxType];this.viewer.scene.skyBox!==e&&(this.viewer.scene.skyBox=e,this.currentSkybox=e,this.adjustSceneForSkybox(this.skyboxType))}else if(s||!this.currentSkybox)if(this.isAboveThreshold){const e=this.skyboxes[this.spaceSkyboxType];this.viewer.scene.skyBox!==e&&(this.viewer.scene.skyBox=e,this.currentSkybox=e,this.adjustSceneForSkybox(this.spaceSkyboxType))}else{const e=this.skyboxes[this.skyboxType];e&&this.viewer.scene.skyBox!==e&&(this.viewer.scene.skyBox=e,this.currentSkybox=e,this.adjustSceneForSkybox(this.skyboxType))}}setAtmosphereEnabled(e){this.viewer&&this.viewer.scene&&(this.atmosphereEnabled=e,this.viewer.scene.skyAtmosphere.show=e)}isAtmosphereEnabled(){return this.atmosphereEnabled}isInitialized(){return this.skyboxesInitialized}}var Pt=(e=>(e.RAIN="rain",e.SNOW="snow",e.FOG="fog",e))(Pt||{});class Lt{constructor(e){t(this,"viewer"),t(this,"rainStage",null),t(this,"snowStage",null),t(this,"fogStage",null),t(this,"lightningStage",null),this.viewer=e}initRain(){this.rainStage=new Cesium.PostProcessStage({name:"Rain",fragmentShader:"\n            uniform sampler2D colorTexture;\n            uniform float size;\n            uniform float speed;\n            uniform float direction;\n            \n            in vec2 v_textureCoordinates;\n            out vec4 fragColor;\n            \n            float hash(float x){\n                return fract(sin(x * 133.3) * 13.13);\n            }\n            \n            void main() {\n                float time = czm_frameNumber / 60.0 * speed;\n                vec2 resolution = czm_viewport.zw;\n                vec2 uv = (gl_FragCoord.xy * 2.0 - resolution) / min(resolution.x, resolution.y);\n                vec3 c = vec3(0.6, 0.7, 0.8);\n                \n                float a = direction / 100.0;\n                float si = sin(a), co = cos(a);\n                uv *= mat2(co, -si, si, co);\n                uv *= length(uv + vec2(0.0, 4.9)) * 0.3 + 1.0;\n                \n                float v = 1.0 - sin(hash(floor(uv.x * 100.0)) * 2.0);\n                float b = clamp(abs(sin(20.0 * time * v + uv.y * (5.0 / (2.0 + v)))) - 0.95, 0.0, 1.0) * 20.0;\n                c *= v * b * size;\n                \n                vec4 origColor = texture(colorTexture, v_textureCoordinates);\n                fragColor = mix(origColor, vec4(c, 1.0), 0.5);\n            }\n        ",uniforms:{size:.5,speed:.2,direction:-10}})}initLightning(){this.lightningStage=new Cesium.PostProcessStage({name:"Lightning",fragmentShader:"\n            float hash(float x)\n            {\n                return fract(21654.6512 * sin(385.51 * x));\n            }\n            float hash(vec2 p)\n            {\n                return fract(1654.65157 * sin(15.5134763 * p.x + 45.5173247 * p.y + 5.21789));\n            }\n            vec2 hash2(vec2 p)\n            {\n                return vec2(hash(p * .754), hash(1.5743 * p + 4.5476351));\n            }\n            vec2 add = vec2(1.0, 0.0);\n            vec2 noise2(vec2 x)\n            {\n                vec2 p = floor(x);\n                vec2 f = fract(x);\n                f = f * f * (3.0 - 2.0 * f);\n                vec2 res = mix(mix(hash2(p),\n                hash2(p + add.xy), f.x),\n                mix(hash2(p + add.yx), hash2(p + add.xx), f.x), f.y);\n                return res;\n            }\n            vec2 fbm2(vec2 x)\n            {\n                vec2 r = vec2(0.0);\n                float a = 1.0;\n                for (int i = 0; i < 8; i++)\n                {\n                    r += noise2(x) * a;\n                    x *= 2.;\n                    a *= .5;\n                }\n                return r;\n            }\n            float dseg(vec2 ba, vec2 pa)\n            {\n                float h = clamp(dot(pa, ba) / dot(ba, ba), -0.2, 1.);\n                return length(pa - ba * h);\n            }\n            \n            uniform sampler2D colorTexture; \n            uniform float fall_interval; \n            uniform float mix_factor; \n            \n            in vec2 v_textureCoordinates;\n            out vec4 fragColor;\n            \n            void main(void){\n                vec2 uv = gl_FragCoord.xy; \n                float iTime = czm_frameNumber * fall_interval * clamp(fall_interval * 0.1, 0.01, 0.1); \n                vec2 p = uv / czm_viewport.zw; \n                vec2 d; \n                vec2 tgt = vec2(1., -1.); \n                float c = 0.; \n                \n                if (p.y >= 0.) \n                    c = (1. - (fbm2((p + .2) * p.y + .1 * iTime)).x) * p.y; \n                else                                \n                    c = (1. - (fbm2(p + .2 + .1 * iTime)).x) * p.y * p.y; \n                \n                vec3 col = vec3(0.); \n                vec3 col1 = c * vec3(.3, .5, 1.); \n                float mdist = 100000.; \n                float t = hash(floor(5. * iTime)); \n                tgt += 4. * hash2(tgt + t) - 1.5; \n                \n                if (hash(t + 2.3) > .6) \n                    for (int i = 0; i < 100; i++) {\n                        vec2 dtgt = tgt - p; \n                        d = .05 * (vec2(-.5, -1.) + hash2(vec2(float(i), t))); \n                        float dist = dseg(d, dtgt); \n                        mdist = min(mdist, dist); \n                        tgt -= d; \n                        c = exp(-1.2 * dist) + exp(-55. * mdist); \n                        col = c * vec3(.7, .8, 1.); \n                    } \n                    \n                col += col1; \n                vec4 origColor = texture(colorTexture, v_textureCoordinates);\n                fragColor = mix(origColor, vec4(col, 0.0), mix_factor); \n            } \n        ",uniforms:{mix_factor:.35,fall_interval:.8}})}initSnow(){this.snowStage=new Cesium.PostProcessStage({name:"Snow",fragmentShader:"\n            uniform sampler2D colorTexture;\n            uniform float size;\n            uniform float speed;\n            uniform float direction;\n            \n            in vec2 v_textureCoordinates;\n            out vec4 fragColor;\n            \n            float snow(vec2 uv, float scale) {\n                float time = float(czm_frameNumber) / 60.0 * speed;\n                float w = smoothstep(1.0, 0.0, -uv.y * (scale / 10.0));\n                if (w < 0.1) return 0.0;\n                \n                // 使用direction参数调整雪的下落方向\n                float a = direction / 100.0;\n                float si = sin(a), co = cos(a);\n                uv *= mat2(co, -si, si, co);\n                \n                uv += time / scale;\n                uv.y += time * 2.0 / scale;\n                uv.x += sin(uv.y + time * 0.5) / scale;\n                uv *= scale;\n                vec2 s = floor(uv), f = fract(uv), p;\n                float k = 3.0, d;\n                p = 0.5 + 0.35 * sin(11.0 * fract(sin((s + p + scale) * mat2(7, 3, 6, 5)) * 5.0)) - f;\n                d = length(p);\n                k = min(d, k);\n                k = smoothstep(0.0, k, sin(f.x + f.y) * 0.01);\n                return k * w;\n            }\n            \n            void main() {\n                vec2 resolution = czm_viewport.zw;\n                vec2 uv = (gl_FragCoord.xy * 2.0 - resolution.xy) / min(resolution.x, resolution.y);\n                vec3 finalColor = vec3(0.0);\n                float c = 0.0;\n                \n                c += snow(uv, 30.0) * 0.0;\n                c += snow(uv, 20.0) * 0.0;\n                c += snow(uv, 15.0) * 0.0;\n                c += snow(uv, 10.0) * size;\n                c += snow(uv, 8.0) * size;\n                c += snow(uv, 6.0) * size;\n                c += snow(uv, 5.0) * size;\n                \n                finalColor = vec3(c);\n                // 调整亮度\n                finalColor = finalColor * 1.2;\n                \n                vec4 origColor = texture(colorTexture, v_textureCoordinates);\n                fragColor = mix(origColor, vec4(finalColor, 1.0), 0.2);\n            }\n        ",uniforms:{size:1,speed:1,direction:0}})}initFog(){this.fogStage=new Cesium.PostProcessStage({name:"Fog",fragmentShader:"\n\t\t\tfloat getDistance(sampler2D depthTexture, vec2 texCoords) \n\t\t\t{ \n\t\t\t\tfloat depth = czm_unpackDepth(texture(depthTexture, texCoords)); \n\t\t\t\tif (depth == 0.0) { \n\t\t\t\t\treturn czm_infinity; \n\t\t\t\t} \n\t\t\t\tvec4 eyeCoordinate = czm_windowToEyeCoordinates(gl_FragCoord.xy, depth); \n\t\t\t\treturn -eyeCoordinate.z / eyeCoordinate.w; \n\t\t\t} \n\t\t\t\n\t\t\tfloat interpolateByDistance(vec4 nearFarScalar, float distance) \n\t\t\t{ \n\t\t\t\tfloat startDistance = nearFarScalar.x;\n\t\t\t\tfloat startValue = nearFarScalar.y;\n\t\t\t\tfloat endDistance = nearFarScalar.z;\n\t\t\t\tfloat endValue = nearFarScalar.w; \n\t\t\t\tfloat t = clamp((distance - startDistance) / (endDistance - startDistance), 0.0, 1.0); \n\t\t\t\treturn mix(startValue, endValue, t); \n\t\t\t} \n\t\t\t\n\t\t\tvec4 alphaBlend(vec4 sourceColor, vec4 destinationColor) \n\t\t\t{ \n\t\t\t\treturn sourceColor * vec4(sourceColor.aaa, 1.0) + destinationColor * (1.0 - sourceColor.a); \n\t\t\t} \n\t\t\t\n\t\t\tuniform sampler2D colorTexture; \n\t\t\tuniform sampler2D depthTexture; \n\t\t\tuniform vec4 fogByDistance; \n\t\t\tuniform vec4 fogColor; \n\t\t\t\n\t\t\tin vec2 v_textureCoordinates; \n\t\t\tout vec4 fragColor; \n\t\t\t\n\t\t\tvoid main(void) \n\t\t\t{ \n\t\t\t\tfloat distance = getDistance(depthTexture, v_textureCoordinates);\n\t\t\t\tvec4 sceneColor = texture(colorTexture, v_textureCoordinates);\n\t\t\t\tfloat blendAmount = interpolateByDistance(fogByDistance, distance); \n\t\t\t\tvec4 finalFogColor = vec4(fogColor.rgb, fogColor.a * blendAmount); \n\t\t\t\tfragColor = alphaBlend(finalFogColor, sceneColor); \n\t\t\t}\n\t\t",uniforms:{fogByDistance:new Cesium.Cartesian4(10,0,200,1),fogColor:new Cesium.Color(.8,.8,.8,.5)}})}enableRain(e){this.rainStage||this.initRain(),this.rainStage&&(void 0!==e.size&&(this.rainStage.uniforms.size=e.size),void 0!==e.speed&&(this.rainStage.uniforms.speed=e.speed),void 0!==e.direction&&(this.rainStage.uniforms.direction=e.direction),e.enabled?this.viewer.scene.postProcessStages.contains(this.rainStage)||this.viewer.scene.postProcessStages.add(this.rainStage):this.disableRain(),e.lightning?(this.lightningStage||this.initLightning(),this.lightningStage&&(void 0!==e.lightningIntensity&&(this.lightningStage.uniforms.mix_factor=e.lightningIntensity),this.viewer.scene.postProcessStages.contains(this.lightningStage)||this.viewer.scene.postProcessStages.add(this.lightningStage))):this.disableLightning())}disableRain(){this.rainStage&&this.viewer.scene.postProcessStages.contains(this.rainStage)&&(this.viewer.scene.postProcessStages.remove(this.rainStage),this.rainStage=null),this.disableLightning()}disableLightning(){this.lightningStage&&this.viewer.scene.postProcessStages.contains(this.lightningStage)&&(this.viewer.scene.postProcessStages.remove(this.lightningStage),this.lightningStage=null)}enableSnow(e){this.snowStage||this.initSnow(),this.snowStage&&(void 0!==e.size&&(this.snowStage.uniforms.size=e.size),void 0!==e.speed&&(this.snowStage.uniforms.speed=e.speed),void 0!==e.direction&&(this.snowStage.uniforms.direction=e.direction),e.enabled?this.viewer.scene.postProcessStages.contains(this.snowStage)||this.viewer.scene.postProcessStages.add(this.snowStage):this.disableSnow())}disableSnow(){this.snowStage&&this.viewer.scene.postProcessStages.contains(this.snowStage)&&(this.viewer.scene.postProcessStages.remove(this.snowStage),this.snowStage=null)}enableFog(e){if(this.fogStage||this.initFog(),this.fogStage){void 0!==e.color&&(this.fogStage.uniforms.fogColor=e.color);const t=void 0!==e.startDistance?e.startDistance:10,i=0,n=void 0!==e.endDistance?e.endDistance:200,s=void 0!==e.maximumAlpha?e.maximumAlpha:void 0!==e.density?.5*e.density:1;this.fogStage.uniforms.fogByDistance=new Cesium.Cartesian4(t,i,n,s),e.enabled?this.viewer.scene.postProcessStages.contains(this.fogStage)||this.viewer.scene.postProcessStages.add(this.fogStage):this.disableFog()}}disableFog(){this.fogStage&&this.viewer.scene.postProcessStages.contains(this.fogStage)&&(this.viewer.scene.postProcessStages.remove(this.fogStage),this.fogStage=null)}disableAll(){this.disableRain(),this.disableSnow(),this.disableFog(),this.disableLightning()}}class kt{constructor(e){t(this,"viewer"),t(this,"enabled",!1),t(this,"atmosphereShader",null),t(this,"atmospherePostProcess",null),t(this,"atmosphereOptions",{enabled:!1,intensity:3,rayleighCoefficient:3,mieCoefficient:3,timeEnabled:!0}),t(this,"preUpdateEventRemovalCallback",null),t(this,"_sunPositionCallCount",0),t(this,"_lastLogTime",0),t(this,"_lastMatrixWarningTime",0),this.viewer=e}enable(e={}){this.atmosphereOptions={...this.atmosphereOptions,...e,enabled:!0},this.enabled?this.updateParameters():(this.enabled=!0,this.initAtmospherePostProcess())}disable(){this.enabled&&(this.enabled=!1,this.atmosphereOptions.enabled=!1,this.removeAtmospherePostProcess())}updateParameters(){if(!this.atmospherePostProcess||!this.enabled)return;const e=this.atmospherePostProcess.uniforms;e.intensity=this.atmosphereOptions.intensity,e.rayleighCoefficient=this.atmosphereOptions.rayleighCoefficient,e.mieCoefficient=this.atmosphereOptions.mieCoefficient,e.timeEnabled=this.atmosphereOptions.timeEnabled}initAtmospherePostProcess(){if(this.viewer&&this.viewer.scene){this.removeAtmospherePostProcess();try{const e=this.getSunPosition()||new Cesium.Cartesian3(0,1e7,1e7),t=this.viewer.scene.globe.ellipsoid.radii.x,i=new Cesium.PostProcessStage({name:"AtmosphericScattering",fragmentShader:this.getAtmosphereShader(),uniforms:{intensity:this.atmosphereOptions.intensity,rayleighCoefficient:this.atmosphereOptions.rayleighCoefficient,mieCoefficient:this.atmosphereOptions.mieCoefficient,sunPosition:()=>this.atmosphereOptions.sunPosition?this.atmosphereOptions.sunPosition:this.getSunPosition()||e,iTime:0,timeEnabled:this.atmosphereOptions.timeEnabled,cameraPosition:()=>this.viewer.camera.positionWC,cameraToWorldMatrix:()=>this.getCameraToWorldMatrix(),earthRadius:t,atmosphereRatio:1.025}});this.atmosphereShader=i,this.atmospherePostProcess=this.viewer.scene.postProcessStages.add(i),this.setupTimeUpdateEvent()}catch(e){}}}getCameraToWorldMatrix(){if(!this.viewer||!this.viewer.camera)return new Float32Array(16);try{const e=this.viewer.camera.viewMatrix,t=Cesium.Matrix4.inverse(e,new Cesium.Matrix4),i=[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]];return new Float32Array(i)}catch(e){return new Float32Array(16)}}setupTimeUpdateEvent(){if(!this.viewer||!this.viewer.scene)return;this.preUpdateEventRemovalCallback&&(this.preUpdateEventRemovalCallback(),this.preUpdateEventRemovalCallback=null);let e=0;this.preUpdateEventRemovalCallback=this.viewer.scene.preUpdate.addEventListener((()=>{if(!this.enabled||!this.atmosphereShader)return;const t=Date.now();if(t-e>500&&(e=t,this.atmosphereOptions.timeEnabled&&!this.atmosphereOptions.sunPosition&&t-this._lastLogTime>5e3&&(this._lastLogTime=t)),this.atmosphereOptions.timeEnabled){const e=this.viewer.clock.currentTime,t=Cesium.JulianDate.toDate(e);this.atmosphereShader.uniforms.iTime=t.getTime()/1e3}}))}getSunPosition(){if(this.viewer&&this.viewer.scene)try{if(this.atmosphereOptions.sunPosition)return this.atmosphereOptions.sunPosition;const e=this.viewer.clock.currentTime,t=Cesium.Simon1994PlanetaryPositions.computeSunPositionInEarthInertialFrame(e),i=Cesium.Transforms.computeTemeToPseudoFixedMatrix(e);if(!i)return this.getSunPositionFromCamera();const n=new Cesium.Cartesian3;return Cesium.Matrix3.multiplyByVector(i,t,n),this._sunPositionCallCount,this._sunPositionCallCount++,n}catch(e){return this.getSunPositionFromCamera()}}getSunPositionFromCamera(){const e=this.viewer.camera.position,t=Cesium.Cartesian3.normalize(this.viewer.scene.globe.ellipsoid.geodeticSurfaceNormal(e,new Cesium.Cartesian3),new Cesium.Cartesian3);Cesium.Cartesian3.normalize(new Cesium.Cartesian3(1,1,0),new Cesium.Cartesian3);const i=Cesium.Matrix3.fromRotationZ(.3),n=new Cesium.Cartesian3;return Cesium.Matrix3.multiplyByVector(i,t,n),Cesium.Cartesian3.add(e,Cesium.Cartesian3.multiplyByScalar(n,1e10,new Cesium.Cartesian3),new Cesium.Cartesian3)}removeAtmospherePostProcess(){this.atmospherePostProcess&&this.viewer&&this.viewer.scene&&(this.viewer.scene.postProcessStages.remove(this.atmospherePostProcess),this.atmospherePostProcess=null,this.atmosphereShader=null),this.preUpdateEventRemovalCallback&&(this.preUpdateEventRemovalCallback(),this.preUpdateEventRemovalCallback=null)}getAtmosphereShader(){return"\n            uniform sampler2D colorTexture;\n            uniform float intensity;\n            uniform float rayleighCoefficient;\n            uniform float mieCoefficient;\n            uniform vec3 sunPosition;\n            uniform float iTime;\n            uniform bool timeEnabled;\n            uniform vec3 cameraPosition; // 相机世界坐标\n            uniform mat4 cameraToWorldMatrix; // 相机到世界坐标的变换矩阵\n            uniform float earthRadius; // 地球半径参数\n            uniform float atmosphereRatio; // 大气层高度比例，默认1.025表示大气层厚度为地球半径的2.5%\n            \n            in vec2 v_textureCoordinates;\n            out vec4 fragColor;\n            \n            // 物理常量\n            const float PI = 3.14159265359;\n            \n            // 散射系数\n            const vec3 rayleighBase = vec3(5.8e-6, 13.5e-6, 33.1e-6); // 瑞利散射RGB系数\n            const float mieBase = 2.0e-5; // 米氏散射系数\n            const float g = 0.76; // 米氏散射不对称因子\n            \n            // 大气密度计算\n            float densityAtHeight(float height, float atmosphereHeight) {\n                return exp(-height / (atmosphereHeight * 0.25));\n            }\n            \n            // 计算两点间的光学深度\n            float opticalDepth(vec3 start, vec3 end, float steps, float atmosphereHeight) {\n                vec3 dir = end - start;\n                float stepSize = length(dir) / steps;\n                dir = normalize(dir);\n                \n                float depth = 0.0;\n                vec3 pos = start;\n                \n                for(float i = 0.0; i < steps; i += 1.0) {\n                    float height = length(pos) - earthRadius;\n                    depth += densityAtHeight(height, atmosphereHeight) * stepSize;\n                    pos += dir * stepSize;\n                }\n                \n                return depth;\n            }\n            \n            // 计算视线与大气层的交点\n            bool rayAtmosphereIntersection(vec3 rayOrigin, vec3 rayDir, float atmRadius, out float t0, out float t1) {\n                // 解析解大气层球体求交\n                float a = dot(rayDir, rayDir);\n                float b = 2.0 * dot(rayDir, rayOrigin);\n                float c = dot(rayOrigin, rayOrigin) - atmRadius * atmRadius;\n                float discriminant = b * b - 4.0 * a * c;\n                \n                if(discriminant < 0.0) return false;\n                \n                discriminant = sqrt(discriminant);\n                t0 = (-b - discriminant) / (2.0 * a);\n                t1 = (-b + discriminant) / (2.0 * a);\n                \n                if(t0 > t1) {\n                    float temp = t0;\n                    t0 = t1;\n                    t1 = temp;\n                }\n                \n                // 检查地球相交\n                float b_earth = 2.0 * dot(rayDir, rayOrigin);\n                float c_earth = dot(rayOrigin, rayOrigin) - earthRadius * earthRadius;\n                float d_earth = b_earth * b_earth - 4.0 * a * c_earth;\n                \n                if(d_earth > 0.0) {\n                    float t_earth = (-b_earth - sqrt(d_earth)) / (2.0 * a);\n                    if(t_earth > 0.0 && t_earth < t1) {\n                        t1 = t_earth;\n                    }\n                }\n                \n                return t1 > 0.0;\n            }\n            \n            // 计算大气散射\n            vec3 calculateScattering(vec3 startPosition, vec3 viewDir, vec3 sunDir, float intensity, float atmosphereHeight) {\n                // 采样配置 - 减少样本数量，提高性能\n                const int primarySamples = 8;\n                const int secondarySamples = 4;\n                \n                float cosTheta = dot(viewDir, sunDir);\n                \n                // 计算米氏相位函数\n                float g2 = g * g;\n                float miePhase = (3.0 * (1.0 - g2) * (1.0 + cosTheta * cosTheta)) / \n                    (8.0 * PI * (2.0 + g2) * pow(1.0 + g2 - 2.0 * g * cosTheta, 1.5));\n                \n                // 计算瑞利相位函数\n                float rayleighPhase = (3.0 / (16.0 * PI)) * (1.0 + cosTheta * cosTheta);\n                \n                // 初始化散射累积值\n                vec3 totalRayleigh = vec3(0.0);\n                vec3 totalMie = vec3(0.0);\n                \n                // 计算大气层半径\n                float atmRadius = earthRadius * atmosphereRatio;\n                \n                // 检查视线与大气层的交点\n                float t0, t1;\n                if(!rayAtmosphereIntersection(startPosition, viewDir, atmRadius, t0, t1)) {\n                    return vec3(0.0);\n                }\n                \n                // 确保起点在大气层内部或者从大气层外部进入\n                t0 = max(0.0, t0);\n                \n                // 计算采样步长\n                float stepSize = (t1 - t0) / float(primarySamples);\n                vec3 samplePoint = startPosition + viewDir * (t0 + stepSize * 0.5);\n                \n                // 沿视线进行采样\n                for(int i = 0; i < primarySamples; i++) {\n                    float sampleHeight = length(samplePoint) - earthRadius;\n                    \n                    // 跳过地球内部的点\n                    if(sampleHeight < 0.0) {\n                        samplePoint += viewDir * stepSize;\n                        continue;\n                    }\n                    \n                    // 计算当前点的大气密度\n                    float density = densityAtHeight(sampleHeight, atmosphereHeight);\n                    \n                    // 计算从当前点到太阳的光学深度\n                    float lightDepth = opticalDepth(samplePoint, samplePoint + sunDir * atmosphereHeight, float(secondarySamples), atmosphereHeight);\n                    \n                    // 计算从当前点到视点的光学深度\n                    float viewDepth = opticalDepth(samplePoint, startPosition, float(secondarySamples), atmosphereHeight);\n                    \n                    // 计算总衰减\n                    vec3 rayleighExtinction = rayleighBase * density * rayleighCoefficient;\n                    float mieExtinction = mieBase * density * mieCoefficient;\n                    \n                    // 计算透射率\n                    vec3 transmittance = exp(-(rayleighExtinction + mieExtinction) * (lightDepth + viewDepth));\n                    \n                    // 累积散射\n                    totalRayleigh += density * rayleighExtinction * transmittance * stepSize;\n                    totalMie += density * mieExtinction * transmittance * stepSize;\n                    \n                    // 移动到下一个采样点\n                    samplePoint += viewDir * stepSize;\n                }\n                \n                // 组合最终散射结果\n                return (totalRayleigh * rayleighPhase + totalMie * miePhase) * intensity * 5.0;\n            }\n            \n            // 从屏幕坐标计算世界空间视线方向\n            vec3 getWorldSpaceRay(vec2 texCoord) {\n                // 将纹理坐标转换为NDC坐标 [-1, 1]\n                vec2 ndc = texCoord * 2.0 - 1.0;\n                \n                // 构建NDC下的射线方向 (x, y, -1)，-1表示前向\n                vec4 rayDir = vec4(ndc, -1.0, 0.0);\n                \n                // 使用相机到世界坐标变换矩阵转换射线方向到世界空间\n                vec4 worldRayDir = cameraToWorldMatrix * rayDir;\n                \n                // 返回归一化的世界空间射线方向\n                return normalize(worldRayDir.xyz);\n            }\n            \n            // 主函数\n            void main() {\n                // 获取原始颜色\n                vec4 originalColor = texture(colorTexture, v_textureCoordinates);\n                \n                // 计算世界空间中的视线方向\n                vec3 viewDir = getWorldSpaceRay(v_textureCoordinates);\n                \n                // 获取太阳方向 - 从相机到太阳的方向\n                vec3 sunDir = normalize(sunPosition - cameraPosition);\n                \n                // 使用实际相机位置\n                vec3 actualCameraPos = cameraPosition;\n                \n                // 计算大气层高度 (地球半径的2.5%)\n                float atmosphereHeight = earthRadius * 0.025;\n                \n                // 计算大气散射\n                vec3 scattering = calculateScattering(actualCameraPos, viewDir, sunDir, intensity, atmosphereHeight);\n                \n                // 添加基于视线与地平面夹角的调整\n                float horizonDot = dot(normalize(actualCameraPos), viewDir);\n                float horizonFade = smoothstep(-0.1, 0.2, horizonDot);\n                \n                // 添加基于相机距离的衰减\n                float cameraDistance = length(actualCameraPos);\n                float distanceFade = 1.0 - smoothstep(earthRadius * 2.0, earthRadius * 6.0, cameraDistance);\n                \n                // 综合两种衰减因素\n                scattering *= horizonFade * distanceFade;\n                \n                // 应用色调映射，避免过曝\n                scattering = scattering / (1.0 + length(scattering) * 0.5);\n                \n                // 混合原始颜色和散射效果，平滑过渡\n                vec3 skyColor = originalColor.rgb + scattering;\n                vec3 finalColor = mix(originalColor.rgb, skyColor, 0.85);\n                \n                // 输出最终颜色\n                fragColor = vec4(finalColor, originalColor.a);\n            }\n        "}destroy(){this.disable()}}var Mt=(e=>(e.SKYBOX="skybox",e.WEATHER="weather",e.ATMOSPHERE="atmosphere",e))(Mt||{});class It{constructor(e){t(this,"viewer"),t(this,"skyboxController",null),t(this,"weatherController",null),t(this,"atmosphereController",null),this.viewer=e}initialize(){var e;this.skyboxController=(e=this.viewer,new Tt(e)),this.weatherController=(e=>new Lt(e))(this.viewer),this.atmosphereController=function(e){return new kt(e)}(this.viewer)}getSkyboxController(){return this.skyboxController}getWeatherController(){return this.weatherController}getAtmosphereController(){return this.atmosphereController}enableEffect(e,t){switch(e){case"skybox":if(this.skyboxController)if((null==t?void 0:t.skipInitIfInitialized)&&this.skyboxController.isInitialized()){if((null==t?void 0:t.heightThreshold)&&this.skyboxController.setHeightThreshold(t.heightThreshold),null==t?void 0:t.type){"space"===t.skyboxType||t.type.startsWith("space_")&&"space_anotherplanet"!==t.type||"default"===t.type?this.skyboxController.setSpaceSkyboxType(t.type):this.skyboxController.setGroundSkyboxType(t.type)}}else if(this.skyboxController.enable(),(null==t?void 0:t.heightThreshold)&&this.skyboxController.setHeightThreshold(t.heightThreshold),null==t?void 0:t.type){"space"===t.skyboxType||t.type.startsWith("space_")&&"space_anotherplanet"!==t.type||"default"===t.type?this.skyboxController.setSpaceSkyboxType(t.type):this.skyboxController.setGroundSkyboxType(t.type)}break;case"weather":this.weatherController&&((null==t?void 0:t.weatherType)===Pt.RAIN?this.weatherController.enableRain({enabled:t.enabled,size:t.size,speed:t.speed,direction:t.direction,lightning:t.lightning,lightningIntensity:t.lightningIntensity}):(null==t?void 0:t.weatherType)===Pt.SNOW?this.weatherController.enableSnow({enabled:t.enabled,size:t.size,speed:t.speed,direction:t.direction}):(null==t?void 0:t.weatherType)===Pt.FOG&&this.weatherController.enableFog({enabled:t.enabled,density:t.density,color:t.color}));break;case"atmosphere":this.atmosphereController&&this.atmosphereController.enable({enabled:t.enabled,intensity:t.intensity,rayleighCoefficient:t.rayleighCoefficient,mieCoefficient:t.mieCoefficient,sunPosition:t.sunPosition,timeEnabled:t.timeEnabled})}}disableEffect(e,t){switch(e){case"skybox":this.skyboxController&&this.skyboxController.disable();break;case"weather":this.weatherController&&(t===Pt.RAIN?this.weatherController.disableRain():t===Pt.SNOW?this.weatherController.disableSnow():t===Pt.FOG?this.weatherController.disableFog():this.weatherController.disableAll());break;case"atmosphere":this.atmosphereController&&this.atmosphereController.disable()}}destroy(){this.skyboxController&&(this.skyboxController=null),this.weatherController&&(this.weatherController=null),this.atmosphereController&&(this.atmosphereController.destroy(),this.atmosphereController=null)}}const Dt=e=>{const t=new It(e);return t.initialize(),t},Ot={},Rt=Cesium.Math.toRadians(1),Nt=Cesium.Math.toRadians(.5),Bt=Cesium.Math.toRadians(1);let Ut=null,Vt=null,zt=null;function Ht(e){Ut=t=>{if(t.repeat)return;const i=t.key.toLowerCase();if(Ot[i]=!0," "===i)e.toggleCameraView();t.preventDefault(),t.stopPropagation()},Vt=e=>{const t=e.key.toLowerCase();Ot[t]=!1,e.preventDefault(),e.stopPropagation()};for(const t in Ot)Ot[t]=!1;document.addEventListener("keydown",Ut,!0),document.addEventListener("keyup",Vt,!0),window.addEventListener("keydown",Ut,!0),window.addEventListener("keyup",Vt,!0),zt=window.requestAnimationFrame((()=>Ft(e)))}function Ft(e){if(!e.getState().active)return;const t=!0===window.disableVKey,i=!0===window.disableFKey,n=!0===Ot.shift?5:.5;Ot.w&&e.updateSpeed(n),Ot.s&&e.updateSpeed(-n),Ot.a&&e.updateHeading(-Rt),Ot.d&&e.updateHeading(Rt),Ot.q&&e.updatePitch(Nt),Ot.e&&e.updatePitch(-Nt),Ot.c?(window.isPressingCKey=!0,e.updateRoll(-Bt)):window.isPressingCKey=!1,Ot.v&&!t?e.updateRoll(Bt):Ot.v,Ot.r&&e.updateAltitude(5),Ot.f&&!i?e.updateAltitude(-5):Ot.f,zt=window.requestAnimationFrame((()=>Ft(e)))}const Wt="flight-info-panel";function Gt(e,t=!1){const i=document.createElement("div");i.className="collapsible-section",i.style.borderBottom="1px solid rgba(255, 255, 255, 0.1)";const n=document.createElement("div");n.className="collapsible-header",n.style.padding="8px 10px",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.cursor="pointer",n.style.backgroundColor="rgba(0, 0, 0, 0.1)";const s=document.createElement("span");s.textContent=e,s.style.fontWeight="bold";const a=document.createElement("span");a.textContent=t?"▼":"▶",a.style.transition="transform 0.3s",n.appendChild(s),n.appendChild(a),i.appendChild(n);const o=document.createElement("div");return o.className="collapsible-content",o.style.maxHeight=t?"500px":"0",o.style.overflow="hidden",o.style.transition="max-height 0.3s ease-out",i.appendChild(o),n.addEventListener("click",(()=>{"0px"!==o.style.maxHeight&&""!==o.style.maxHeight?(o.style.maxHeight="0",a.textContent="▶"):(o.style.maxHeight="500px",a.textContent="▼")})),{container:i,header:n,content:o}}const Yt=[{id:"daher_tbm_930",name:"Daher TBM 930",description:"单引擎涡轮螺旋桨公务机",modelPath:"assets/model/daher_tbm_930/scene.gltf",scale:5,initialAltitude:1e3,maxSpeed:120,headingOffset:Math.PI,pitchOffset:0,rollOffset:0,cameraDistance:100,cameraHeight:50,cockpitPositionX:1,cockpitPositionY:0,cockpitPositionZ:0},{id:"boeing737",name:"Boeing 737",description:"中型双引擎喷气式客机",modelPath:"assets/model/boeing737/scene.gltf",scale:15,initialAltitude:1e3,maxSpeed:250,headingOffset:Math.PI,pitchOffset:0,rollOffset:0,cameraDistance:700,cameraHeight:300,cockpitPositionX:230,cockpitPositionY:-5,cockpitPositionZ:20},{id:"atr72",name:"ATR-72",description:"双引擎涡轮螺旋桨支线客机",modelPath:"assets/model/geofs_official_atr-72_utair_livery/scene.gltf",scale:10,initialAltitude:1e3,maxSpeed:150,headingOffset:0,pitchOffset:0,rollOffset:0,cameraDistance:400,cameraHeight:200,cockpitPositionX:150,cockpitPositionY:0,cockpitPositionZ:-30},{id:"crow",name:"黑色的乌鸦",description:"灵活的飞行鸟类",modelPath:"assets/model/crow_fly/scene.gltf",scale:3,initialAltitude:500,maxSpeed:80,headingOffset:Math.PI/2,pitchOffset:0,rollOffset:0,cameraDistance:500,cameraHeight:200,cockpitPositionX:70,cockpitPositionY:0,cockpitPositionZ:10}],jt=()=>({active:!1,aircraftEntity:null,selectedAircraftModel:null,position:new Cesium.Cartesian3,heading:0,pitch:0,roll:0,speed:0,altitude:0,firstPersonView:!1,preFlightCamera:null});class $t{constructor(e){t(this,"viewer"),t(this,"state"),t(this,"lastInLowAltitude"),this.viewer=e,this.state=jt(),this.lastInLowAltitude=!1}init(e){const t=Yt.find((t=>t.id===e));t&&(this.state.selectedAircraftModel=t,this.startFlight())}startFlight(){if(!this.state.selectedAircraftModel)return;this.saveCurrentCameraState();const e=this.viewer.camera.position,t=Cesium.Cartographic.fromCartesian(e),i=this.viewer.camera.heading,n=this.state.selectedAircraftModel.initialAltitude,s=i,a=111e3,o=1e3*Math.cos(s)/a,r=1e3*Math.sin(s)/(a*Math.cos(t.latitude)),l=t.longitude+Cesium.Math.toRadians(r),c=t.latitude+Cesium.Math.toRadians(o),u=Math.max(0+n,n),d=Cesium.Cartesian3.fromRadians(l,c,u);this.state.position=d,this.state.altitude=u;const h=this.state.selectedAircraftModel.id;this.state.heading="daher_tbm_930"===h||"boeing737"===h?Cesium.Math.zeroToTwoPi(i+Math.PI):"crow"===h?Cesium.Math.zeroToTwoPi(i+Math.PI/2):i,this.state.pitch=0,this.state.roll=0;const m=10/3.6,p=Math.max(m,.1*this.state.selectedAircraftModel.maxSpeed);this.state.speed=p,this.createAircraftEntity(),Ht(this),function(){var e;const t=document.getElementById(Wt);t&&(null==(e=t.parentNode)||e.removeChild(t));const i=document.createElement("div");i.id=Wt,i.className="flight-info-panel",i.style.cssText="",Object.assign(i.style,{position:"fixed",right:"20px",top:"20px",left:"auto",bottom:"auto",width:"280px",backgroundColor:"rgba(38, 38, 38, 0.8)",color:"white",padding:"0",borderRadius:"0",fontFamily:"monospace",fontSize:"14px",zIndex:"1000",boxSizing:"border-box",boxShadow:"0 0 10px rgba(0, 0, 0, 0.5)",backdropFilter:"blur(3px)",cursor:"default",margin:"0",display:"block",overflow:"hidden"});const n=document.createElement("div");n.textContent="飞行控制",n.style.fontWeight="bold",n.style.padding="10px",n.style.textAlign="center",n.style.fontSize="15px",n.style.borderBottom="1px solid rgba(255, 255, 255, 0.1)",n.style.backgroundColor="rgba(0, 0, 0, 0.2)",n.style.cursor="grab",n.style.userSelect="none";let s=!1,a=0,o=0;function r(e,t){const n=window.innerWidth-i.offsetWidth,s=window.innerHeight-i.offsetHeight,a=Math.max(0,Math.min(e,n)),o=Math.max(0,Math.min(t,s));i.style.position="fixed",i.style.left=`${a}px`,i.style.top=`${o}px`,i.style.right="auto",i.style.bottom="auto",i.style.width="280px"}n.addEventListener("mousedown",(e=>{s=!0,a=e.clientX-i.getBoundingClientRect().left,o=e.clientY-i.getBoundingClientRect().top,n.style.cursor="grabbing",e.preventDefault()})),n.addEventListener("touchstart",(e=>{1===e.touches.length&&(s=!0,a=e.touches[0].clientX-i.getBoundingClientRect().left,o=e.touches[0].clientY-i.getBoundingClientRect().top,n.style.cursor="grabbing")}),{passive:!0}),document.addEventListener("mousemove",(e=>{s&&r(e.clientX-a,e.clientY-o)})),document.addEventListener("touchmove",(e=>{if(!s||1!==e.touches.length)return;const t=e.touches[0];r(t.clientX-a,t.clientY-o)}),{passive:!0}),document.addEventListener("mouseup",(()=>{s&&(s=!1,n.style.cursor="grab")})),document.addEventListener("touchend",(()=>{s&&(s=!1,n.style.cursor="grab")}),{passive:!0}),document.addEventListener("touchcancel",(()=>{s&&(s=!1,n.style.cursor="grab")}),{passive:!0}),i.appendChild(n);const l=document.createElement("div");l.style.padding="10px",l.style.backgroundColor="rgba(0, 0, 0, 0.15)",l.style.borderBottom="1px solid rgba(255, 255, 255, 0.1)",l.style.textAlign="center";const c=document.createElement("button");c.textContent="停止飞行",c.style.backgroundColor="#cc3333",c.style.color="white",c.style.border="none",c.style.padding="8px 15px",c.style.width="100%",c.style.cursor="pointer",c.style.fontSize="14px",c.style.fontWeight="bold",c.style.borderRadius="0",c.addEventListener("mouseover",(()=>{c.style.backgroundColor="#aa2222"})),c.addEventListener("mouseout",(()=>{c.style.backgroundColor="#cc3333"})),c.addEventListener("click",(()=>{try{const e=new CustomEvent("stopFlight");window.dispatchEvent(e)}catch(e){if(window.flightSimulator)try{window.flightSimulator.stopFlight(),window.flightSimulator=null}catch(t){}}})),l.appendChild(c),i.appendChild(l);const u=Gt("飞行参数",!0);i.appendChild(u.container);const d=document.createElement("div");d.style.padding="10px",u.content.appendChild(d),[{id:"speed",label:"速度"},{id:"altitude",label:"高度"},{id:"heading",label:"航向(A/D键)"},{id:"pitch",label:"俯仰角(C/V键)"},{id:"roll",label:"翻转角(Q/E键)"},{id:"climb-rate",label:"爬升率"},{id:"position",label:"位置"}].forEach((e=>{const t=document.createElement("div");t.className="flight-info-item",t.style.display="flex",t.style.justifyContent="space-between",t.style.margin="3px 0";const i=document.createElement("span");i.className="flight-info-label",i.textContent=`${e.label}:`,i.style.marginRight="10px";const n=document.createElement("span");n.className="flight-info-value",n.id=`flight-info-${e.id}`,n.textContent="--",n.style.fontWeight="bold",n.style.color="#64B5F6",t.appendChild(i),t.appendChild(n),d.appendChild(t)}));const h=Gt("操作说明",!0);i.appendChild(h.container);const m=document.createElement("div");m.style.padding="10px",h.content.appendChild(m);const p=document.createElement("table");p.style.width="100%",p.style.borderCollapse="collapse",p.style.fontSize="12px",[{key:"W / S",action:"加速 / 减速"},{key:"A / D",action:"左转 / 右转"},{key:"Q / E",action:"360度翻转"},{key:"C / V",action:"抬头 / 低头"},{key:"R / F",action:"上升 / 下降"},{key:"空格",action:"切换视角"},{key:"Shift",action:"加速模式"}].forEach((e=>{const t=document.createElement("tr");t.style.borderBottom="1px solid rgba(255, 255, 255, 0.1)";const i=document.createElement("td");i.textContent=e.key,i.style.padding="4px",i.style.color="#64B5F6",i.style.fontWeight="bold",i.style.width="50%";const n=document.createElement("td");n.textContent=e.action,n.style.padding="4px",t.appendChild(i),t.appendChild(n),p.appendChild(t)})),m.appendChild(p),document.body.appendChild(i)}(),this.viewer.scene.preUpdate.addEventListener(this.onFrameUpdate,this),this.state.active=!0,this.state.firstPersonView=!1,this.setThirdPersonCamera(),setTimeout((()=>{if(this.state.active&&this.state.selectedAircraftModel){this.state.pitch=0,this.state.roll=0;const e=this.state.selectedAircraftModel.id;if("daher_tbm_930"===e||"boeing737"===e){const e=this.viewer.camera.heading;this.state.heading=Cesium.Math.zeroToTwoPi(e+Math.PI)}this.setThirdPersonCamera()}}),1e3),setTimeout((()=>{this.state.active&&this.setThirdPersonCamera()}),2e3)}stopFlight(){this.state.active&&(!function(){Ut&&(document.removeEventListener("keydown",Ut,!0),window.removeEventListener("keydown",Ut,!0),Ut=null),Vt&&(document.removeEventListener("keyup",Vt,!0),window.removeEventListener("keyup",Vt,!0),Vt=null),null!==zt&&(window.cancelAnimationFrame(zt),zt=null);for(const e in Ot)Ot[e]=!1}(),function(){var e;const t=document.getElementById(Wt);t&&(null==(e=t.parentNode)||e.removeChild(t))}(),this.viewer.scene.preUpdate.removeEventListener(this.onFrameUpdate,this),this.state.aircraftEntity&&(this.viewer.entities.remove(this.state.aircraftEntity),this.state.aircraftEntity=null),this.restoreCameraState(),this.state=jt())}saveCurrentCameraState(){this.state.preFlightCamera={position:this.viewer.camera.position.clone(),heading:this.viewer.camera.heading,pitch:this.viewer.camera.pitch,roll:this.viewer.camera.roll}}restoreCameraState(){const e=this.state.position;if(!e)return;const t=Cesium.Cartographic.fromCartesian(e),i=Cesium.Math.toDegrees(t.longitude),n=Cesium.Math.toDegrees(t.latitude),s=t.height+200,a=this.state.heading;this.viewer.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(i,n,s),orientation:{heading:a,pitch:Cesium.Math.toRadians(-30),roll:0},duration:1})}createAircraftEntity(){if(!this.state.selectedAircraftModel)return;const e=this.state.selectedAircraftModel.id;let t=0,i=1;"daher_tbm_930"===e||"boeing737"===e?(t=Math.PI,i=-1):"crow"===e&&(t=Math.PI/2);const n={uri:this.state.selectedAircraftModel.modelPath,scale:this.state.selectedAircraftModel.scale,minimumPixelSize:64,colorBlendAmount:0,silhouetteSize:0,runAnimations:!0};this.state.aircraftEntity=this.viewer.entities.add({position:new Cesium.ConstantPositionProperty(this.state.position),orientation:new Cesium.CallbackProperty((()=>{let n=this.state.pitch,s=this.state.roll;"crow"===e?(n=-this.state.roll,s=this.state.pitch):s=this.state.roll*i;const a=new Cesium.HeadingPitchRoll(this.state.heading+t,n,s);return Cesium.Transforms.headingPitchRollQuaternion(this.state.position,a)}),!1),model:n}),this.setThirdPersonCamera()}onFrameUpdate(){this.state.active&&this.state.aircraftEntity&&(this.updateAircraftPosition(),this.state.firstPersonView?this.setFirstPersonCamera():this.setThirdPersonCamera(),this.updateFlightInfo())}updateAircraftPosition(){var e;if(!this.state.aircraftEntity)return;const t=150,i=Cesium.Cartographic.fromCartesian(this.state.position),n=i.height;if(window.isLowAltitudeSafety=n<t,n<t){null==(e=this.state.selectedAircraftModel)||e.id,window.isLowAltitudeSafety=!0,window.disableVKey=!0,window.disableFKey=!0;if(!(!0===window.isPressingCKey)){0!==this.state.roll&&(this.state.roll=0)}if(this.lastInLowAltitude=!0,n<75){const e=.5*Math.max(1,75-n),t=Cesium.Cartesian3.fromRadians(i.longitude,i.latitude,i.height+e);this.state.position=t}}else window.isLowAltitudeSafety=!1,window.disableVKey=!1,window.disableFKey=!1,this.lastInLowAltitude=!1;const s=this.state.heading,a=this.state.pitch,o=this.state.speed,r=new Cesium.Cartesian3,l=new Cesium.HeadingPitchRoll(s,a,this.state.roll),c=Cesium.Transforms.headingPitchRollToFixedFrame(this.state.position,l,Cesium.Ellipsoid.WGS84,Cesium.Transforms.eastNorthUpToFixedFrame,new Cesium.Matrix4),u=new Cesium.Cartesian3(0,1,0),d=new Cesium.Cartesian3;Cesium.Matrix4.multiplyByPointAsVector(c,u,d),Cesium.Cartesian3.normalize(d,d),Cesium.Cartesian3.multiplyByScalar(d,o/60,r),Cesium.Cartesian3.add(this.state.position,r,this.state.position),this.state.aircraftEntity&&this.state.aircraftEntity.position&&(this.state.aircraftEntity.position=new Cesium.ConstantPositionProperty(this.state.position));const h=Cesium.Cartographic.fromCartesian(this.state.position);if(this.state.altitude=h.height,this.state.altitude<10){const e=Cesium.Cartesian3.fromRadians(h.longitude,h.latitude,100);this.state.position=e}}setFirstPersonCamera(){if(!this.state.aircraftEntity||!this.state.selectedAircraftModel)return;const e=this.state.position,t=new Cesium.HeadingPitchRoll(this.state.heading,this.state.pitch,this.state.roll),i=this.state.selectedAircraftModel.cockpitPositionX||0,n=this.state.selectedAircraftModel.cockpitPositionY||0,s=this.state.selectedAircraftModel.cockpitPositionZ||0,a=Cesium.Transforms.headingPitchRollToFixedFrame(e,t,Cesium.Ellipsoid.WGS84,Cesium.Transforms.eastNorthUpToFixedFrame,new Cesium.Matrix4),o=new Cesium.Cartesian3(n,i,s),r=new Cesium.Cartesian3;Cesium.Matrix4.multiplyByPoint(a,o,r),this.viewer.camera.setView({destination:r,orientation:{heading:t.heading,pitch:t.pitch,roll:t.roll}})}setThirdPersonCamera(){if(!this.state.aircraftEntity||!this.state.selectedAircraftModel)return;const e=this.state.selectedAircraftModel.cameraDistance,t=this.state.selectedAircraftModel.cameraHeight,i=Math.min(this.state.speed/50,2),n=e*(1+.3*i),s=t*(1+.2*i),a=Cesium.Transforms.eastNorthUpToFixedFrame(this.state.position,Cesium.Ellipsoid.WGS84,new Cesium.Matrix4),o=this.state.heading,r=-Math.sin(o)*n,l=-Math.cos(o)*n,c=s,u=new Cesium.Cartesian3(r,l,c),d=new Cesium.Cartesian3;Cesium.Matrix4.multiplyByPoint(a,u,d);const h=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(this.state.position,d,h),Cesium.Cartesian3.normalize(h,h);const m=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(this.state.position,m),this.viewer.camera.setView({destination:d,orientation:{direction:h,up:m}})}toggleCameraView(){this.state.firstPersonView=!this.state.firstPersonView}updateFlightInfo(){if(!this.state.active)return;const e=Cesium.Cartographic.fromCartesian(this.state.position),t=Cesium.Math.toDegrees(e.longitude),i=Cesium.Math.toDegrees(e.latitude),n=e.height,s=Cesium.Math.toDegrees(this.state.heading)%360,a=Cesium.Math.toDegrees(this.state.pitch),o=Cesium.Math.toDegrees(this.state.roll),r=this.state.speed*Math.sin(this.state.roll);!function(e){if(!document.getElementById(Wt))return;const t=document.getElementById("flight-info-speed");if(t){const i=1e3;e.speed>=i-1?(t.textContent=`${Math.round(e.speed)} km/h MAX`,t.style.color="#ff4d4d"):(t.textContent=`${Math.round(e.speed)} km/h`,t.style.color="#64B5F6")}const i=document.getElementById("flight-info-altitude");i&&(i.textContent=`${Math.round(e.altitude)} m`);const n=document.getElementById("flight-info-heading");n&&(n.textContent=`${Math.round(e.heading)}°`);const s=document.getElementById("flight-info-pitch");s&&(s.textContent=`${Math.round(e.pitch)}°`);const a=document.getElementById("flight-info-roll");a&&(a.textContent=`${Math.round(e.roll)}°`);const o=document.getElementById("flight-info-climb-rate");o&&(o.textContent=`${Math.round(e.climbRate)} m/s`);const r=document.getElementById("flight-info-position");if(r){const t=e.latitude.toFixed(6),i=e.longitude.toFixed(6);r.textContent=`${t}°, ${i}°`}}({speed:3.6*this.state.speed,altitude:n,longitude:t,latitude:i,pitch:o,heading:s<0?s+360:s,roll:a,climbRate:r})}getState(){return this.state}setState(e){this.state={...this.state,...e}}updateSpeed(e){if(!this.state.selectedAircraftModel)return;const t=10/3.6,i=1e3/3.6;let n=this.state.speed,s=1;e>0?s=1-Math.min(n,i)/i*.9:e<0&&(s=.1+Math.max(n-t,0)/i*.9);let a=n+e*s;a=Math.max(t,Math.min(i,a)),this.state.speed=a}updateHeading(e){let t=this.state.heading+e;for(;t>2*Math.PI;)t-=2*Math.PI;for(;t<0;)t+=2*Math.PI;this.state.heading=t}updatePitch(e){let t=this.state.pitch+e;for(;t>2*Math.PI;)t-=2*Math.PI;for(;t<0;)t+=2*Math.PI;this.state.pitch=t}updateRoll(e){const t=Cesium.Math.toRadians(80),i=Cesium.Math.toRadians(-80);let n=this.state.roll-e;n=Math.max(i,Math.min(t,n)),this.state.roll=n}updateAltitude(e){const t=Cesium.Cartographic.fromCartesian(this.state.position);t.height=Math.max(0,t.height+e),this.state.position=Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,t.height),this.state.altitude=t.height}}const Xt={},Qt=function(e,t,i){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),i=(null==e?void 0:e.nonce)||(null==e?void 0:e.getAttribute("nonce"));n=Promise.allSettled(t.map((e=>{if((e=function(e){return"/"+e}(e))in Xt)return;Xt[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,i&&s.setAttribute("nonce",i),document.head.appendChild(s),t?new Promise(((t,i)=>{s.addEventListener("load",t),s.addEventListener("error",(()=>i(new Error(`Unable to preload CSS for ${e}`))))})):void 0})))}function s(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then((t=>{for(const e of t||[])"rejected"===e.status&&s(e.reason);return e().catch(s)}))},Kt="/assets/amap.BJ4cjARr.png",qt="/assets/tencent.BNVf55GS.webp",Jt="/assets/cesium.CT_mNEBO.png",Zt=n(!1),ei=n(!1),ti=n(null),ii=e=>Zt.value?Promise.resolve():ei.value?new Promise(((e,t)=>{const i=setInterval((()=>{Zt.value&&(clearInterval(i),e()),ti.value&&(clearInterval(i),t(ti.value))}),100)})):(ei.value=!0,new Promise(((t,i)=>{const n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=`https://webapi.amap.com/maps?v=2.0&key=${e}&plugin=AMap.PlaceSearch`,n.onload=()=>{Zt.value=!0,ei.value=!1,t()},n.onerror=e=>{ti.value="加载高德地图API失败",ei.value=!1,i(e)},document.head.appendChild(n)}))),ni=async(e,t="全国",i=10,n=1)=>{if(!e.trim())return{status:"no-result",results:[],message:"请输入搜索关键词"};try{const s="https://restapi.amap.com/v3/place/text",a=window.AMAP_API_KEY;if(!a)return{status:"error",results:[],message:"高德地图API密钥未设置"};const o={key:a,keywords:e,city:t,offset:i.toString(),page:n.toString(),extensions:"all"},r=Object.entries(o).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&"),l=await fetch(`${s}?${r}`),c=await l.json();if("1"===c.status){const e=c.pois||[];if(0===e.length)return{status:"no-result",results:[],message:"未找到相关地点",total:0,pageIndex:n,pageSize:i};const t=e.map((e=>{const[t,i]=e.location.split(",").map(parseFloat);return{id:e.id,name:e.name,address:e.address||"",location:{longitude:t,latitude:i},distance:e.distance?parseFloat(e.distance):void 0,category:e.type}}));return{status:"success",results:t,total:parseInt(c.count)||t.length,pageIndex:n,pageSize:i}}return{status:"no-result",results:[],message:c.info||"搜索不到该地点，请更换关键词"}}catch(s){return{status:"error",results:[],message:"搜索过程中发生错误"}}},si=Object.freeze(Object.defineProperty({__proto__:null,getLocationFromResult:e=>({longitude:e.location.longitude,latitude:e.location.latitude}),loadAmapApi:ii,searchLocation:ni,useAmapApiStatus:()=>({apiLoaded:Zt,apiLoading:ei,apiError:ti})},Symbol.toStringTag,{value:"Module"})),ai=n(!1),oi=n(!1),ri=n(null);let li=null;const ci=async e=>{if(ai.value)return Promise.resolve();oi.value=!0,ri.value=null;try{return window.Cesium?(window.Cesium.Ion.defaultAccessToken=e,li=new window.Cesium.IonGeocoderService,ai.value=!0,Promise.resolve()):(ri.value="Cesium未加载，无法使用Geocoder服务",Promise.reject(new Error("Cesium未加载")))}catch(t){return ri.value=`加载Cesium Ion Geocoder服务失败: ${t}`,Promise.reject(t)}finally{oi.value=!1}},ui=async(e,t="",i=10,n=1)=>{if(!ai.value)return{status:"error",results:[],message:"Cesium Ion API未加载"};if(!e.trim())return{status:"no-result",results:[],message:"请输入搜索关键词"};try{if(!li)return{status:"error",results:[],message:"Cesium Ion Geocoder服务未初始化"};const t=await li.geocode(e);if(!t||0===t.length)return{status:"no-result",results:[],message:"未找到相关地点",total:0,pageIndex:n,pageSize:i};return{status:"success",results:t.map(((e,t)=>{let i,n;if(e.destination&&void 0!==e.destination.west){const t=e.destination;i=(window.Cesium.Math.toDegrees(t.west)+window.Cesium.Math.toDegrees(t.east))/2,n=(window.Cesium.Math.toDegrees(t.south)+window.Cesium.Math.toDegrees(t.north))/2}else if(e.position){const t=window.Cesium.Cartographic.fromCartesian(e.position);i=window.Cesium.Math.toDegrees(t.longitude),n=window.Cesium.Math.toDegrees(t.latitude)}else if(e.destination){const t=window.Cesium.Cartographic.fromCartesian(e.destination);i=window.Cesium.Math.toDegrees(t.longitude),n=window.Cesium.Math.toDegrees(t.latitude)}else i=0,n=0;let s="";if(e.destinationName?s=e.destinationName:e.displayName&&(s=`${e.displayName}`),e.region||e.country||e.administrativeArea){const t=[];e.administrativeArea&&t.push(e.administrativeArea),e.region&&t.push(e.region),e.country&&t.push(e.country),s?t.length>0&&(s=`${s}, ${t.join(", ")}`):s=t.join(", ")}return s||0===i||0===n||(s=`${n.toFixed(4)}°N, ${i.toFixed(4)}°E`),s||(s=`位于 ${e.displayName||"未知区域"}`),{id:e.id||`cesium_result_${t}`,name:e.displayName||"未知地点",address:s,location:{longitude:i,latitude:n},category:e.type||""}})),total:t.length,pageIndex:n,pageSize:i}}catch(s){return{status:"error",results:[],message:`搜索过程中发生错误: ${s}`}}},di=Object.freeze(Object.defineProperty({__proto__:null,getLocationFromResult:e=>({longitude:e.location.longitude,latitude:e.location.latitude}),loadCesiumIonApi:ci,searchLocation:ui,useCesiumIonApiStatus:()=>({apiLoaded:ai,apiLoading:oi,apiError:ri})},Symbol.toStringTag,{value:"Module"})),hi=n(!1),mi=n(!1),pi=n(null),gi=e=>(hi.value=!0,window.TENCENT_MAP_KEY=e,Promise.resolve()),vi=e=>new Promise((t=>{const i=`jsonp_tencent_map_${Date.now()}_${Math.floor(1e6*Math.random())}`,n={...e,callback:i};window[i]=e=>{document.body.removeChild(a),delete window[i],t(e)};const s=Object.entries(n).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&"),a=document.createElement("script");a.src=`https://apis.map.qq.com/ws/place/v1/search?${s}`,a.onerror=()=>{document.body.removeChild(a),delete window[i],t({status:-1,message:"请求失败，请检查网络连接"})},document.body.appendChild(a)})),yi=e=>e.map((e=>({id:e.id||`tencent_${Math.random().toString(36).substring(2,10)}`,name:e.title,address:e.address||"",location:{longitude:e.location.lng,latitude:e.location.lat},distance:e._distance,category:e.category}))),fi=async(e,t="",i=10,n=1)=>{if(!e.trim())return{status:"no-result",results:[],message:"请输入搜索关键词"};try{const s=window.TENCENT_MAP_KEY;if(!s)return{status:"error",results:[],message:"腾讯地图API密钥未设置"};const a={key:s,keyword:e,page_size:i.toString(),page_index:n.toString(),output:"jsonp"};let o="region",r="全国",l="0";const c=t.match(/^([\d.-]+),([\d.-]+),(\d+)$/);if(c){const[,e,t,i]=c;o="nearby",r=`${e},${t},${i}`,l="1"}else t&&"全国"!==t&&(r=t);let u=`${o}(${r},${l})`;const d=await vi({...a,boundary:u});if(0!==d.status)return{status:"error",results:[],message:d.message||"搜索失败，请稍后重试"};if(0===d.count&&d.cluster&&d.cluster.length>0){const e=[...d.cluster].sort(((e,t)=>t.count-e.count)),t=e[0].title,s=await vi({...a,boundary:`region(${t},0)`});if(0===s.status&&s.count>0){const e=yi(s.data||[]);return{status:"success",results:e,total:s.count||e.length,pageIndex:n,pageSize:i,message:`在${t}找到 ${s.count} 个结果`}}if(0===s.status)for(let o=1;o<Math.min(3,e.length);o++){const t=e[o].title,s=await vi({...a,boundary:`region(${t},0)`});if(0===s.status&&s.count>0){const e=yi(s.data||[]);return{status:"success",results:e,total:s.count||e.length,pageIndex:n,pageSize:i,message:`在${t}找到 ${s.count} 个结果`}}}return{status:"no-result",results:[],message:`找到${d.cluster.length}个区域共${d.cluster.reduce(((e,t)=>e+t.count),0)}个结果，请缩小搜索范围`}}if(d.count>0&&d.data){const e=yi(d.data);return{status:"success",results:e,total:d.count||e.length,pageIndex:n,pageSize:i}}return{status:"no-result",results:[],message:"未找到相关地点",total:0,pageIndex:n,pageSize:i}}catch(s){return{status:"error",results:[],message:"搜索过程中发生错误"}}},Ci=Object.freeze(Object.defineProperty({__proto__:null,getLocationFromResult:e=>({longitude:e.location.longitude,latitude:e.location.latitude}),loadTencentMapApi:gi,searchLocation:fi,useTencentMapApiStatus:()=>({apiLoaded:hi,apiLoading:mi,apiError:pi})},Symbol.toStringTag,{value:"Module"})),wi=si,bi=Ci,_i=di;var Si=(e=>(e.AMAP="amap",e.TENCENT_MAP="tencentMap",e.CESIUM_ION="cesiumIon",e))(Si||{});const Ai=[{name:"高德地图",key:"amap",icon:"amap-icon"},{name:"腾讯地图",key:"tencentMap",icon:"tencent-icon"},{name:"Cesium Ion",key:"cesiumIon",icon:"cesium-icon"}],Ei=n("amap"),xi=()=>Ei.value,Ti=e=>(Ei.value=e,Ei.value),Pi=async(e,t="",i=10,n=1)=>{switch(Ei.value){case"amap":default:return await ni(e,t,i,n);case"tencentMap":return await fi(e,t,i,n);case"cesiumIon":return await ui(e,t,i,n)}},Li=Object.freeze(Object.defineProperty({__proto__:null,SearchProvider:Si,amap:wi,cesiumIon:_i,getCurrentProvider:xi,getSearchProvider:(e=Ei.value)=>{switch(e){case"amap":default:return si;case"tencentMap":return Ci;case"cesiumIon":return di}},initSearch:async(e,t=Ei.value)=>{switch(t){case"amap":return await ii(e);case"tencentMap":return await gi(e);case"cesiumIon":return await ci(e);default:throw new Error(`不支持的搜索提供商: ${t}`)}},searchLocation:Pi,searchProviders:Ai,setCurrentProvider:Ti,tencentMap:bi},Symbol.toStringTag,{value:"Module"})),ki={class:"location-search"},Mi={class:"search-input-container"},Ii={key:0,src:Kt,class:"provider-img",alt:"高德地图"},Di={key:1,src:qt,class:"provider-img",alt:"腾讯地图"},Oi={key:2,src:Jt,class:"provider-img",alt:"Cesium Ion"},Ri={key:0,class:"loading-spinner"},Ni={key:1,class:"cesium-svgPath-svg",width:"20",height:"20",viewBox:"0 0 32 32"},Bi={key:0,class:"provider-menu"},Ui=["onClick"],Vi={key:0,src:Kt,class:"provider-img",alt:"高德地图"},zi={key:1,src:qt,class:"provider-img",alt:"腾讯地图"},Hi={key:2,src:Jt,class:"provider-img",alt:"Cesium Ion"},Fi={class:"provider-name"},Wi={key:1,class:"search-results"},Gi=["onClick"],Yi={class:"result-name"},ji={class:"result-address"},$i={key:2,class:"search-status"},Xi="cae9957a553cf290e2620dc101a4f723",Qi="UELBZ-33D33-MFN3G-ONZ7D-6GBGH-35BEX",Ki="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiODU4MzQxNC0wNmQ3LTRiMjUtYjIwMy1lNDAxODkxOTY1YjAiLCJpZCI6MjkyMDc1LCJpYXQiOjE3NDQxMjIyNzh9.pQuhqLOFa4gp8mCbgIHMOx7hvPSFnL6a6L0XPwIEJsI",qi=(e,t)=>{const i=e.__vccOpts||e;for(const[n,s]of t)i[n]=s;return i},Ji=qi(o({__name:"LocationSearch",props:{city:{type:String,default:"全国"}},emits:["select-result","search-start","search-end","api-error","provider-change"],setup(e,{expose:t,emit:i}){const s=e,a=i,o=Ai,_=n(xi()),S=n(!1),A=n(""),E=n(!1),x=n(!1),T=n(!1),P=n(!1),L=n([]),k=n(null),M=n(null),I=()=>{S.value=!S.value,S.value&&(P.value=!1)},D=async()=>{if(A.value.trim()){E.value=!0,x.value=!0,P.value=!0,T.value=!0,M.value=null,a("search-start",A.value);try{const e=await Pi(A.value,s.city,10,1);"success"===e.status?(L.value=e.results.map((e=>({id:e.id,name:e.name,address:e.address||"",location:{lng:e.location.longitude,lat:e.location.latitude},district:e.category||"",adcode:"",citycode:""}))),_.value,Si.CESIUM_ION,P.value=!0):(L.value=[],M.value=e.message||"搜索无结果",P.value=!0),k.value=null}catch(e){L.value=[],M.value=`请求错误: ${e.message}`,P.value=!0}finally{E.value=!1,x.value=!1,a("search-end",L.value)}}},O=e=>{k.value=e,P.value=!1,a("select-result",e)},N=()=>{P.value=!1,S.value=!1},B=e=>{const t=e.target;t.closest(".location-search")&&(t.closest(".cesium-geocoder-searchButton")&&!E.value||t.closest(".search-provider-selector"))||N()};return r((()=>{document.addEventListener("click",B),window.AMAP_API_KEY=Xi,window.TENCENT_MAP_KEY=Qi,_.value===Si.AMAP?Qt((()=>Promise.resolve().then((()=>Li))),void 0).then((e=>{e.initSearch(Xi,Si.AMAP)})):_.value===Si.TENCENT_MAP?Qt((()=>Promise.resolve().then((()=>Li))),void 0).then((e=>{e.initSearch(Qi,Si.TENCENT_MAP)})):_.value===Si.CESIUM_ION&&Qt((()=>Promise.resolve().then((()=>Li))),void 0).then((e=>{e.initSearch(Ki,Si.CESIUM_ION)}))})),l((()=>{document.removeEventListener("click",B)})),t({search:D,selectResult:O,closeDropdowns:N}),(e,t)=>{const i=R;return u(),c("div",ki,[d("div",Mi,[d("div",{class:"search-provider-selector",onClick:I},[d("div",{class:p(["provider-icon",_.value])},["amap"===_.value?(u(),c("img",Ii)):"tencentMap"===_.value?(u(),c("img",Di)):(u(),c("img",Oi))],2)]),m(i,{modelValue:A.value,"onUpdate:modelValue":t[0]||(t[0]=e=>A.value=e),placeholder:"搜索地点...",clearable:"",size:"default",class:"search-input cesium-geocoder-input",onKeyup:g(D,["enter"])},{append:v((()=>[d("div",{class:"cesium-geocoder-searchButton",onClick:y(D,["stop"])},[E.value?(u(),c("div",Ri)):(u(),c("svg",Ni,t[1]||(t[1]=[d("path",{d:"M29.772,26.433l-7.126-7.126c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127L29.772,26.433zM7.203,13.885c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486c-0.007,3.58-2.905,6.476-6.484,6.484C10.106,20.361,7.209,17.465,7.203,13.885z"},null,-1)])))])])),_:1},8,["modelValue"])]),S.value?(u(),c("div",Bi,[(u(!0),c(f,null,C(b(o),(e=>(u(),c("div",{key:e.key,class:p(["provider-item",{active:_.value===e.key}]),onClick:t=>{var i;(i=e.key)!==_.value?(_.value=i,Ti(i),S.value=!1,L.value=[],P.value=!1,M.value=null,i===Si.AMAP?(window.AMAP_API_KEY=Xi,Qt((()=>Promise.resolve().then((()=>Li))),void 0).then((e=>{e.initSearch(Xi,Si.AMAP)}))):i===Si.TENCENT_MAP?(window.TENCENT_MAP_KEY=Qi,Qt((()=>Promise.resolve().then((()=>Li))),void 0).then((e=>{e.initSearch(Qi,Si.TENCENT_MAP)}))):i===Si.CESIUM_ION&&Qt((()=>Promise.resolve().then((()=>Li))),void 0).then((e=>{e.initSearch(Ki,Si.CESIUM_ION)})),a("provider-change",i)):S.value=!1}},[d("div",{class:p(["provider-icon",e.key])},["amap"===e.key?(u(),c("img",Vi)):"tencentMap"===e.key?(u(),c("img",zi)):(u(),c("img",Hi))],2),d("span",Fi,w(e.name),1)],10,Ui)))),128))])):h("",!0),P.value&&L.value.length>0?(u(),c("div",Wi,[(u(!0),c(f,null,C(L.value,(e=>(u(),c("div",{key:e.id,class:p(["search-result-item",{active:k.value&&k.value.id===e.id}]),onClick:t=>O(e)},[d("div",Yi,w(e.name),1),d("div",ji,w(e.address||"无地址信息"),1)],10,Gi)))),128))])):h("",!0),P.value&&0===L.value.length&&!E.value&&T.value||M.value?(u(),c("div",$i,w(M.value||"没有找到相关地点，请更换关键词"),1)):h("",!0)])}}}),[["__scopeId","data-v-84b256a2"]]),Zi={class:"control-panel"},en=["onClick"],tn={class:"control-panel-tooltip"},nn={key:0,class:"panel"},sn={class:"panel-header"},an={class:"panel-title"},on={key:0,class:"panel-content"},rn={class:"panel-section"},ln={class:"map-style-cards"},cn=["onClick"],un={class:"map-style-card-name"},dn={class:"map-style-card-desc"},hn={class:"panel-section"},mn={class:"control-item-row"},pn={class:"control-wrapper"},gn={class:"control-item-row"},vn={class:"control-wrapper"},yn={class:"control-item-row"},fn={class:"control-wrapper"},Cn={class:"control-item-row"},wn={class:"control-wrapper"},bn={class:"control-item-row"},_n={class:"control-wrapper"},Sn={class:"control-item-row"},An={class:"control-wrapper"},En={class:"control-item-row"},xn={class:"control-wrapper"},Tn={class:"control-item-row"},Pn={class:"control-wrapper"},Ln={key:1,class:"panel-content"},kn={class:"panel-section"},Mn={class:"control-item"},In={class:"control-header"},Dn={class:"control-slider"},On={key:0,class:"control-item"},Rn={class:"control-header"},Nn={class:"control-slider"},Bn={key:1,class:"control-item"},Un={class:"control-header"},Vn={class:"control-slider"},zn={class:"control-item-row",style:{"justify-content":"flex-start"}},Hn={class:"panel-section"},Fn={class:"search-section"},Wn={class:"control-item-row"},Gn={class:"control-wrapper"},Yn={class:"preset-locations-cards"},jn=["onClick"],$n={class:"location-card-name"},Xn={class:"location-card-coords"},Qn=["onClick"],Kn={class:"control-item"},qn={class:"control-header"},Jn={class:"control-slider"},Zn={class:"control-item"},es={class:"control-header"},ts={class:"control-slider"},is={class:"control-item-row",style:{"justify-content":"flex-start"}},ns={class:"dialog-footer"},ss={key:2,class:"panel-content"},as={class:"panel-section"},os={class:"control-item-row"},rs={class:"control-wrapper"},ls={key:0,class:"skybox-info"},cs={key:1,class:"select-row"},us={class:"skybox-type-tabs"},ds={key:0,class:"skybox-options"},hs={class:"skybox-cards"},ms=["onClick"],ps={class:"skybox-card-name"},gs={class:"skybox-card-desc"},vs={key:1,class:"skybox-options"},ys={class:"skybox-cards"},fs=["onClick"],Cs={class:"skybox-card-name"},ws={class:"skybox-card-desc"},bs={key:2,class:"skybox-options"},_s={class:"skybox-cards"},Ss=["onClick"],As={class:"skybox-card-name"},Es={class:"skybox-card-desc"},xs={key:2,class:"control-item"},Ts={class:"control-header"},Ps={class:"control-slider"},Ls={class:"panel-section"},ks={class:"skybox-type-tabs"},Ms={key:0},Is={class:"control-item-row"},Ds={class:"control-wrapper"},Os={key:0},Rs={class:"control-item"},Ns={class:"control-header"},Bs={class:"control-slider"},Us={class:"control-item"},Vs={class:"control-header"},zs={class:"control-slider"},Hs={class:"control-item"},Fs={class:"control-header"},Ws={class:"control-slider"},Gs={class:"control-item-row"},Ys={class:"control-wrapper"},js={key:0,class:"control-item"},$s={class:"control-header"},Xs={class:"control-slider"},Qs={key:1},Ks={class:"control-item-row"},qs={class:"control-wrapper"},Js={key:0},Zs={class:"control-item"},ea={class:"control-header"},ta={class:"control-slider"},ia={class:"control-item"},na={class:"control-header"},sa={class:"control-slider"},aa={class:"control-item"},oa={class:"control-header"},ra={class:"control-slider"},la={key:2},ca={class:"control-item-row"},ua={class:"control-wrapper"},da={key:0},ha={class:"control-item"},ma={class:"control-header"},pa={class:"control-slider"},ga={class:"control-item"},va={class:"control-header"},ya={class:"control-slider"},fa={class:"control-item"},Ca={class:"control-header"},wa={class:"control-slider"},ba={class:"control-item-row"},_a={class:"panel-section"},Sa={class:"control-item-row"},Aa={class:"control-wrapper"},Ea={key:0},xa={class:"control-item"},Ta={class:"control-header"},Pa={class:"control-slider"},La={class:"control-item"},ka={class:"control-header"},Ma={class:"control-slider"},Ia={class:"control-item"},Da={class:"control-header"},Oa={class:"control-slider"},Ra={class:"control-item-row"},Na={class:"control-wrapper"},Ba={key:3,class:"panel-content"},Ua={class:"panel-section"},Va={class:"panel-section-content"},za={class:"control-item"},Ha={class:"control-item-row"},Fa={class:"control-wrapper"},Wa={key:4,class:"panel-content"},Ga={class:"panel-section"},Ya={class:"control-item-row"},ja={class:"control-wrapper"},$a={key:0,style:{"text-align":"center",margin:"10px 0"}},Xa={key:1},Qa={class:"control-item-row"},Ka={class:"control-wrapper"},qa={key:2,style:{"text-align":"center",margin:"10px 0"}},Ja={class:"panel-section"},Za={class:"control-item-row"},eo={class:"control-wrapper"},to={key:0,class:"skybox-info",style:{color:"#ff9900"}},io={key:1,class:"control-item"},no={class:"aircraft-cards"},so=["onClick"],ao={class:"aircraft-card-name"},oo={class:"aircraft-card-desc"},ro=qi(o({__name:"ControlPanel",props:{initialHeight:{},initialPitch:{},initialHeading:{},roadNetworkLayerState:{type:Boolean},tdtLabelLayerState:{type:Boolean},tdtBoundaryLayerState:{type:Boolean},oceanLayerState:{type:Boolean},cloudLayerState:{type:Boolean},layerLoadingStates:{},sceneMode:{}},emits:["adjustCamera","updatePosition","changeMapProvider","toggleGridLayer","toggleTerrain","toggleRoadNetworkLayer","toggleTdtLabelLayer","toggleTdtBoundaryLayer","toggleOceanLayer","toggleTerrainWireframeLayer","toggleCloudLayer","toggleEffect"],setup(e,{emit:t}){const i=e,o=t,g=et(),{height:k,pitch:M,heading:I,longitude:D,latitude:O,selectedLocation:ee,mapProvider:te,terrainProvider:ie,showGrid:ne,showRoadNetworkLayer:se,showTdtLabelLayer:ae,showTdtBoundaryLayer:oe,showOceanLayer:re,showTerrainWireframeLayer:le,enableLocationAnimation:ce,showCloudLayer:ue}=_(g),de=s((()=>{const e=[{id:"mapStyle",label:"地图样式",icon:S(N)},{id:"sceneControl",label:"场景控制",icon:S(B)},{id:"effectsControl",label:"特效控制",icon:S(U)},{id:"preferences",label:"偏好设置",icon:S(V)}];return i.sceneMode===qe.SCENE3D&&e.splice(3,0,{id:"modelControl",label:"模型控制",icon:S(z)}),e})),{activeTab:he,getActiveTabLabel:me,toggleTab:pe,closePanel:ge}=(e=>{const t=n(null),i=a(e)?e:n(e);return{activeTab:t,getActiveTabLabel:()=>{const e=i.value.find((e=>e.id===t.value));return e?e.label:""},toggleTab:e=>{t.value===e?t.value=null:t.value=e},closePanel:()=>{t.value=null}}})(de),{heightRange:ve,pitchRange:ye,pitchRange25D:fe,headingRange:Ce,longitudeRange:we,latitudeRange:be}={heightRange:{min:100,max:25e6,step:100},pitchRange:{min:-90,max:90,step:1},pitchRange25D:{min:-60,max:-20,step:1},headingRange:{min:0,max:360,step:1},longitudeRange:{min:-180,max:180,step:1e-6},latitudeRange:{min:-90,max:90,step:1e-6}},_e=n("Cesium全球地形"===ie.value);A(ie,(e=>{_e.value="Cesium全球地形"===e}),{immediate:!0});const Se=s((()=>i.sceneMode===qe.COLUMBUS_VIEW?fe:ye)),{convertSliderToExponentialHeight:Ae,convertExponentialHeightToSlider:Ee}=(e=>({convertSliderToExponentialHeight:t=>{const i=e.min,n=e.max,s=(t-i)/(n-i),a=i+Math.pow(s,3)*(n-i);return Math.min(Math.max(a,i),n)},convertExponentialHeightToSlider:t=>{const i=e.min,n=e.max,s=(t-i)/(n-i),a=i+Math.pow(s,1/3)*(n-i);return Math.min(Math.max(a,i),n)}}))(ve),xe=s({get:()=>Math.round(k.value),set:e=>{g.setHeight(e)}}),Te=s({get:()=>Ee(k.value),set:e=>{}}),Le=(e,t)=>{"pitch"===e?g.setPitch(t):g.setHeading(t),o("adjustCamera",e,t)},ke=()=>{const e=2e3;if(i.sceneMode===qe.SCENE2D){g.setHeight(e);const t=D.value,i=O.value;o("updatePosition",t,i,!0)}else g.setHeight(e),g.setPitch(-45),g.setHeading(0),o("adjustCamera","height",e),o("adjustCamera","pitch",-45),o("adjustCamera","heading",0)},Me=()=>{((e,t,i,n,s,a,o,r=!1)=>{const l=106.613794,c=29.541216;i.value=l,n.value=c,e.setPosition(l,c),e.setSelectedLocation("重邮"),r?setTimeout((()=>{t("adjustCamera","preset",{height:s.value,heading:null==a?void 0:a.value,pitch:null==o?void 0:o.value,useAnimation:!0})}),100):t("updatePosition",l,c,!0,r)})(g,o,D,O,k,I,M,ce.value)};A((()=>i.initialHeight),(e=>{void 0!==e&&g.setHeight(e)}),{immediate:!0}),A((()=>i.initialPitch),(e=>{void 0!==e&&g.setPitch(e)}),{immediate:!0}),A((()=>i.initialHeading),(e=>{void 0!==e&&g.setHeading(e)}),{immediate:!0}),A((()=>i.roadNetworkLayerState),(e=>{void 0!==e&&e!==g.showRoadNetworkLayer&&g.setShowRoadNetworkLayer(e)}),{immediate:!0}),A((()=>i.tdtLabelLayerState),(e=>{void 0!==e&&e!==g.showTdtLabelLayer&&g.setShowTdtLabelLayer(e)}),{immediate:!0}),A((()=>i.tdtBoundaryLayerState),(e=>{void 0!==e&&e!==g.showTdtBoundaryLayer&&g.setShowTdtBoundaryLayer(e)}),{immediate:!0}),A((()=>i.oceanLayerState),(e=>{void 0!==e&&e!==g.showOceanLayer&&g.setShowOceanLayer(e)}),{immediate:!0}),A((()=>i.cloudLayerState),(e=>{void 0!==e&&e!==g.showCloudLayer&&g.setShowCloudLayer(e)}),{immediate:!0});const Ie=n(!0),De=n("epic_bluesunset"),Oe=n(24e4),Re=n("ground"),Ne=s((()=>xt.filter((e=>"ground"===e.type)))),Be=s((()=>xt.filter((e=>"space"===e.type)))),Ue=s((()=>xt.filter((e=>"volumetric"===e.type))));A(Re,(e=>{"space"===e&&(Ne.value.some((e=>e.id===De.value))||Ue.value.some((e=>e.id===De.value)))?(De.value="default",He(De.value)):"ground"===e&&(Be.value.some((e=>e.id===De.value))||Ue.value.some((e=>e.id===De.value)))?(De.value="epic_bluesunset",He(De.value)):"volumetric"===e&&(Be.value.some((e=>e.id===De.value))||Ne.value.some((e=>e.id===De.value)))&&(De.value="volumetric_clouds",He(De.value))}));const Ve=n(!1);n(!1),n(1),n(1);const ze=e=>{gi.value=!0,e?o("toggleEffect","skybox",!0,{type:De.value,heightThreshold:Oe.value}):o("toggleEffect","skybox",!1),setTimeout((()=>{gi.value=!1}),800)},He=e=>{if(De.value=e,Ie.value){let t="ground";e.startsWith("space_")&&"space_anotherplanet"!==e||"default"===e?t="space":"volumetric_clouds"===e&&(t="volumetric"),Re.value=t,o("toggleEffect",Mt.SKYBOX,!0,{type:e,skyboxType:t,heightThreshold:Oe.value})}},Fe=e=>{Oe.value=e,Ie.value&&o("toggleEffect","skybox",!0,{type:De.value,heightThreshold:e})},We=e=>{pi.grid=!0,_t("grid",e,g,o),setTimeout((()=>{pi.grid=!1}),500)},Ge=e=>{pi.terrain=!0,((e,t,i)=>{t.setTerrainProvider(e),i("toggleTerrain","Cesium全球地形"===e)})(e?"Cesium全球地形":"无地形",g,o),setTimeout((()=>{pi.terrain=!1}),1e3)},Ye=e=>{pi.roadNetwork=!0,_t("roadNetwork",e,g,o),setTimeout((()=>{pi.roadNetwork=!1}),800)},je=e=>{pi.tdtLabel=!0,_t("tdtLabel",e,g,o),setTimeout((()=>{pi.tdtLabel=!1}),700)},$e=e=>{pi.tdtBoundary=!0,_t("tdtBoundary",e,g,o),setTimeout((()=>{pi.tdtBoundary=!1}),700)},Xe=e=>{pi.ocean=!0,_t("ocean",e,g,o),setTimeout((()=>{pi.ocean=!1}),600)},Qe=e=>{pi.terrainWireframe=!0,_t("terrainWireframe",e,g,o),setTimeout((()=>{pi.terrainWireframe=!1}),500)},Ze=e=>{pi.cloud=!0,_t("cloud",e,g,o),setTimeout((()=>{pi.cloud=!1}),1e3)},tt=s((()=>{switch(i.sceneMode||qe.SCENE3D){case qe.SCENE2D:return"2d";case qe.COLUMBUS_VIEW:return"25d";case qe.SCENE3D:default:return"3d"}})),it=(e,t)=>{((e,t,i,n,s,a,o,r,l,c=!1)=>{"longitude"===e?s.value=t:a.value=t;const u="longitude"===e?t:s.value,d="latitude"===e?t:a.value;i.setPosition(u,d),c?setTimeout((()=>{n("adjustCamera","preset",{height:o.value,heading:null==r?void 0:r.value,pitch:null==l?void 0:l.value,useAnimation:!0})}),100):n("updatePosition",u,d,!1,c)})(e,t,g,o,D,O,k,I,M,ce.value)},nt=e=>{((e,t,i)=>{t.setMapProvider(e),i("changeMapProvider",e,Je[e].style||0)})(e,g,o)};function st(e,t){if(e&&"number"==typeof e.longitude&&"number"==typeof e.latitude)if(ee.value=t,ce.value&&(at.value=!0,setTimeout((()=>{at.value=!1}),1500)),wt(t)){O.value=e.latitude,D.value=e.longitude,g.setPosition(e.longitude,e.latitude);const t=2e3;g.setHeight(t),k.value=t,ce.value?setTimeout((()=>{o("adjustCamera","preset",{height:t,heading:I.value,pitch:M.value,useAnimation:!0})}),100):o("updatePosition",e.longitude,e.latitude,!0)}else((e,t,i,n,s,a,o,r,l,c=!1)=>{a.value=e.latitude,s.value=e.longitude,i.setPosition(e.longitude,e.latitude),i.setSelectedLocation(t);const u=2e3;i.setHeight(u),o.value=u,c?setTimeout((()=>{n("adjustCamera","preset",{height:u,heading:null==r?void 0:r.value,pitch:null==l?void 0:l.value,useAnimation:!0})}),100):n("updatePosition",e.longitude,e.latitude,!0)})(e,t,g,o,D,O,k,I,M,ce.value)}const at=n(!1),ot=n(!1),rt=n(""),lt=n(0),ct=n(0),ut=n({});r((()=>{mt(),window.addEventListener("stopFlight",mi),ai.value=bt(),ai.value&&(oi.value=!1)}));const ht=s((()=>({...Ke,...ut.value})));function mt(){try{const e=localStorage.getItem("customLocations");e&&(ut.value=JSON.parse(e))}catch(e){}}function pt(){try{localStorage.setItem("customLocations",JSON.stringify(ut.value))}catch(e){}}function vt(){lt.value=D.value,ct.value=O.value}function yt(){if(!rt.value.trim())return void J.warning("请输入位置名称");const e=`custom_${Date.now()}`;ut.value[e]={name:rt.value,longitude:lt.value,latitude:ct.value},pt(),rt.value="",ot.value=!1,J.success("自定义位置已保存")}function wt(e){return e.startsWith("custom_")}function St(e){return`${e.longitude.toFixed(4)}°, ${e.latitude.toFixed(4)}°`}A((()=>ce.value),(e=>{g.setEnableLocationAnimation(e)}),{immediate:!0}),r((()=>{setTimeout((()=>{Ie.value&&o("toggleEffect","skybox",!0,{type:De.value,heightThreshold:Oe.value})}),500)}));const At=n("rain"),Et=n(!1),Tt=n(.5),Lt=n(.2),kt=n(-10),It=n(!1),Dt=n(.5),Ot=n(!1),Rt=n(1),Nt=n(1),Bt=n(0),Ut=n(!1),Vt=n(1),zt=n("rgba(204, 204, 204, 0.5)"),Ht=n(10),Ft=n(200),Wt=e=>{yi.rain=!0,e?(Ot.value=!1,Ut.value=!1,o("toggleEffect","weather",!0,{weatherType:Pt.RAIN,enabled:!0,size:Tt.value,speed:Lt.value,direction:kt.value,lightning:It.value,lightningIntensity:Dt.value})):o("toggleEffect","weather",!1,{weatherType:Pt.RAIN,enabled:!1}),setTimeout((()=>{yi.rain=!1}),700)},Gt=()=>{Et.value&&o("toggleEffect","weather",!0,{weatherType:Pt.RAIN,enabled:!0,size:Tt.value,speed:Lt.value,direction:kt.value,lightning:It.value,lightningIntensity:Dt.value})},jt=e=>{yi.snow=!0,e?(Et.value=!1,Ut.value=!1,o("toggleEffect","weather",!0,{weatherType:Pt.SNOW,enabled:!0,size:Rt.value,speed:Nt.value,direction:Bt.value})):o("toggleEffect","weather",!1,{weatherType:Pt.SNOW,enabled:!1}),setTimeout((()=>{yi.snow=!1}),700)},Xt=()=>{Ot.value&&o("toggleEffect","weather",!0,{weatherType:Pt.SNOW,enabled:!0,size:Rt.value,speed:Nt.value,direction:Bt.value})},Qt=e=>{yi.fog=!0,e?(Et.value=!1,Ot.value=!1,o("toggleEffect","weather",!0,{weatherType:Pt.FOG,enabled:!0,density:Vt.value,color:Jt(zt.value),startDistance:Ht.value,endDistance:Ft.value})):o("toggleEffect","weather",!1,{weatherType:Pt.FOG,enabled:!1}),setTimeout((()=>{yi.fog=!1}),600)},Kt=()=>{Ut.value&&(clearTimeout(qt),qt=setTimeout((()=>{Ft.value<=Ht.value&&(Ft.value=Ht.value+100),o("toggleEffect","weather",!0,{weatherType:Pt.FOG,enabled:!0,density:Vt.value,color:Jt(zt.value),startDistance:Ht.value,endDistance:Ft.value})}),100))};let qt=null;const Jt=e=>{const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([.\d]+)\)/);if(t)return new Cesium.Color(parseInt(t[1])/255,parseInt(t[2])/255,parseInt(t[3])/255,parseFloat(t[4]));if(e.startsWith("#")&&9===e.length){const t=parseInt(e.slice(1,3),16)/255,i=parseInt(e.slice(3,5),16)/255,n=parseInt(e.slice(5,7),16)/255,s=parseInt(e.slice(7,9),16)/255;return new Cesium.Color(t,i,n,s)}if(e.startsWith("#")&&7===e.length){const t=parseInt(e.slice(1,3),16)/255,i=parseInt(e.slice(3,5),16)/255,n=parseInt(e.slice(5,7),16)/255;return new Cesium.Color(t,i,n,.5)}return new Cesium.Color(.8,.8,.8,.5)},Zt=e=>{vi.value=!0,Ve.value=e,e?o("toggleEffect","atmosphere",!0,{enabled:!0,intensity:ti.value,rayleighCoefficient:ii.value,mieCoefficient:ni.value,timeEnabled:si.value}):o("toggleEffect","atmosphere",!1),setTimeout((()=>{vi.value=!1}),800)},ei=()=>{Ve.value&&o("toggleEffect","atmosphere",!0,{enabled:!0,intensity:ti.value,rayleighCoefficient:ii.value,mieCoefficient:ni.value,timeEnabled:si.value})},ti=n(3),ii=n(3),ni=n(3),si=n(!0),ai=n(bt()),oi=n(!1),ri=n(!1),li=n("daher_tbm_930"),ci=n(Yt);let ui=null;const di=e=>{var t;if(ai.value)oi.value=!1;else if(e)if(ri.value=!0,window.viewer)try{t=window.viewer,ui=new $t(t),window.flightSimulator=ui;const e=document.getElementById("cesiumContainer");e&&e.focus(),setTimeout((()=>{try{ui.init(li.value),ri.value=!1,oi.value=!0,setTimeout((()=>{}),100)}catch(e){ri.value=!1,oi.value=!1}}),1e3)}catch(i){ri.value=!1,oi.value=!1}else ri.value=!1,oi.value=!1;else hi()},hi=()=>{ui&&(ui.stopFlight(),ui=null,window.flightSimulator=null),oi.value=!1},mi=()=>{hi()};r((()=>{window.addEventListener("stopFlight",mi)})),l((()=>{window.removeEventListener("stopFlight",mi)})),n("");const pi=E({buildingLayer:!1,imageLayer:!1,modelLayer:!1,terrainLayer:!1,tdtLabel:!1,tdtBoundary:!1,grid:!1,roadNetwork:!1,ocean:!1,terrainWireframe:!1,cloud:!1,terrain:!1}),gi=n(!1),vi=n(!1),yi=E({rain:!1,snow:!1,fog:!1,lightning:!1});A((()=>i.layerLoadingStates),(e=>{e&&Object.keys(e).forEach((t=>{t in pi&&(pi[t]=e[t])}))}),{immediate:!0,deep:!0});const fi=n(!1),Ci=n(!1),wi=n(!1),bi=n(!1),_i=e=>{e?(Ci.value=!0,wi.value&&(wi.value=!1,o("toggleEffect","osmBuildings",!1)),fi.value=!0,o("toggleEffect","googleTileset",!0,{enabled:!0}),setTimeout((()=>{Ci.value=!1}),3e3)):(fi.value=!1,o("toggleEffect","googleTileset",!1))},Si=e=>{e?(bi.value=!0,_e.value||(_e.value=!0,Ge(!0)),fi.value&&(fi.value=!1,o("toggleEffect","googleTileset",!1)),wi.value=!0,o("toggleEffect","osmBuildings",!0,{enabled:!0}),setTimeout((()=>{bi.value=!1}),3e3)):(wi.value=!1,o("toggleEffect","osmBuildings",!1))},Ai=e=>{const{longitude:t,latitude:i}=e.location;"number"==typeof t&&"number"==typeof i&&(D.value=t,O.value=i,g.setPosition(t,i),g.setSelectedLocation(e.name),ce.value?setTimeout((()=>{o("adjustCamera","preset",{height:k.value,pitch:M.value,heading:I.value,useAnimation:!0})}),100):o("updatePosition",t,i,!0))},Ei=E({mapStyle:!1,layers:!1,camera:!1,location:!1,skybox:!1,weather:!1,atmosphere:!1,googleTiles:!1,osmBuildings:!1,flight:!1}),xi=n(null),Ti=n(null),Pi=n(null),Li=n(null),ki=n(null),Mi=n(null),Ii=n(null),Di=n(null),Oi=n(null),Ri=n(null),Ni=e=>{Ei[e]=!Ei[e],x((()=>{Bi(e)}))},Bi=e=>{const t={mapStyle:xi,layers:Ti,camera:Pi,location:Li,skybox:ki,weather:Mi,atmosphere:Ii,googleTiles:Di,osmBuildings:Oi,flight:Ri}[e];if(t.value&&!Ei[e]){const e=t.value.scrollHeight;t.value.style.maxHeight=`${e}px`}},Ui=()=>{Object.keys(Ei).forEach((e=>{Ei[e]=!1})),x((()=>{Object.keys(Ei).forEach((e=>{Bi(e)}))}))};r((()=>{mt(),setTimeout((()=>{Ui()}),500)}));const{isMonitorEnabled:Vi,startPerformanceMonitor:zi,stopPerformanceMonitor:Hi}={isMonitorEnabled:dt,startPerformanceMonitor:ft,stopPerformanceMonitor:Ct};function Fi(e){e?zi():Hi()}return n(((e,t,i,n=2)=>{const s=(e-t)/(i-t),a=t+Math.pow(s,1/n)*(i-t);return Math.min(Math.max(a,t),i)})(i.initialHeight||k.value,ve.min,ve.max)),n(i.initialPitch||M.value),n(i.initialHeading||I.value),r((()=>{mt(),setTimeout((()=>{Ui()}),500),x((()=>{Ve.value&&ei()})),gt()})),A((()=>i.sceneMode),(e=>{e!==qe.SCENE3D&&"modelControl"===he.value&&ge()})),n(!1),(e,t)=>{const n=H,s=W,r=G,l=Y,_=j,S=R,A=Q,E=X,x=$,N=K;return u(),c("div",{class:p(["control-panel-container",`mode-${tt.value}`])},[d("div",Zi,[(u(!0),c(f,null,C(de.value,((e,t)=>(u(),c("div",{key:t,class:p(["control-panel-item",{active:b(he)===e.id}]),onClick:t=>b(pe)(e.id)},[m(n,null,{default:v((()=>[(u(),T(P(e.icon)))])),_:2},1024),d("div",tn,w(e.label),1)],10,en)))),128))]),null!==b(he)?(u(),c("div",nn,[d("div",sn,[d("div",an,w(b(me)()),1),t[90]||(t[90]=d("div",{class:"logo-container"},[d("img",{src:Pe,alt:"FlyAnti Logo",class:"logo-image"}),d("span",{class:"logo-text"},"FlyAnti")],-1)),m(n,{class:"panel-close",onClick:b(ge)},{default:v((()=>[m(b(F))])),_:1},8,["onClick"])]),"mapStyle"===b(he)?(u(),c("div",on,[d("div",rn,[d("div",{class:"panel-section-title",onClick:t[0]||(t[0]=e=>Ni("mapStyle"))},[t[91]||(t[91]=d("span",null,"底图样式",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.mapStyle}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.mapStyle}]),ref_key:"mapStyleSection",ref:xi},[d("div",ln,[(u(!0),c(f,null,C(b(Je),((e,t)=>(u(),c("div",{key:t,class:p(["map-style-card",{active:b(te)===t}]),onClick:e=>nt(t)},[d("div",un,w(e.name),1),d("div",dn,w(e.description||"标准地图样式"),1)],10,cn)))),128))])],2)]),d("div",hn,[d("div",{class:"panel-section-title",onClick:t[1]||(t[1]=e=>Ni("layers"))},[t[92]||(t[92]=d("span",null,"图层控制",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.layers}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.layers}]),ref_key:"layersSection",ref:Ti},[d("div",mn,[t[93]||(t[93]=d("span",{class:"control-label"},"经纬度网格",-1)),d("div",pn,[m(s,{modelValue:b(ne),"onUpdate:modelValue":t[2]||(t[2]=e=>a(ne)?ne.value=e:null),onChange:We,disabled:null==pi?void 0:pi.grid,loading:null==pi?void 0:pi.grid},null,8,["modelValue","disabled","loading"])])]),d("div",gn,[t[94]||(t[94]=d("span",{class:"control-label"},"地形显示",-1)),d("div",vn,[m(s,{modelValue:_e.value,"onUpdate:modelValue":t[3]||(t[3]=e=>_e.value=e),onChange:Ge,disabled:null==pi?void 0:pi.terrain,loading:null==pi?void 0:pi.terrain},null,8,["modelValue","disabled","loading"])])]),d("div",yn,[t[95]||(t[95]=d("span",{class:"control-label"},"地形三角网",-1)),d("div",fn,[m(s,{modelValue:b(le),"onUpdate:modelValue":t[4]||(t[4]=e=>a(le)?le.value=e:null),onChange:Qe,disabled:null==pi?void 0:pi.terrainWireframe,loading:null==pi?void 0:pi.terrainWireframe},null,8,["modelValue","disabled","loading"])])]),d("div",Cn,[t[96]||(t[96]=d("span",{class:"control-label"},"高德路网",-1)),d("div",wn,[m(s,{modelValue:b(se),"onUpdate:modelValue":t[5]||(t[5]=e=>a(se)?se.value=e:null),onChange:Ye,disabled:null==pi?void 0:pi.roadNetwork,loading:null==pi?void 0:pi.roadNetwork},null,8,["modelValue","disabled","loading"])])]),d("div",bn,[t[97]||(t[97]=d("span",{class:"control-label"},"天地图注记",-1)),d("div",_n,[m(s,{modelValue:b(ae),"onUpdate:modelValue":t[6]||(t[6]=e=>a(ae)?ae.value=e:null),onChange:je,disabled:null==pi?void 0:pi.tdtLabel,loading:null==pi?void 0:pi.tdtLabel},null,8,["modelValue","disabled","loading"])])]),d("div",Sn,[t[98]||(t[98]=d("span",{class:"control-label"},"全球境界",-1)),d("div",An,[m(s,{modelValue:b(oe),"onUpdate:modelValue":t[7]||(t[7]=e=>a(oe)?oe.value=e:null),onChange:$e,disabled:null==pi?void 0:pi.tdtBoundary,loading:null==pi?void 0:pi.tdtBoundary},null,8,["modelValue","disabled","loading"])])]),d("div",En,[t[99]||(t[99]=d("span",{class:"control-label"},"ArcGIS海洋注记",-1)),d("div",xn,[m(s,{modelValue:b(re),"onUpdate:modelValue":t[8]||(t[8]=e=>a(re)?re.value=e:null),onChange:Xe,disabled:null==pi?void 0:pi.ocean},null,8,["modelValue","disabled"])])]),d("div",Tn,[t[100]||(t[100]=d("span",{class:"control-label"},"大气云层",-1)),d("div",Pn,[m(s,{modelValue:b(ue),"onUpdate:modelValue":t[9]||(t[9]=e=>a(ue)?ue.value=e:null),onChange:Ze,disabled:(null==pi?void 0:pi.cloud)||i.sceneMode!==b(qe).SCENE3D,loading:null==pi?void 0:pi.cloud},null,8,["modelValue","disabled","loading"])])])],2)])])):h("",!0),"sceneControl"===b(he)?(u(),c("div",Ln,[d("div",kn,[d("div",{class:"panel-section-title",onClick:t[10]||(t[10]=e=>Ni("camera"))},[t[101]||(t[101]=d("span",null,"相机控制",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.camera}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.camera}]),ref_key:"cameraSection",ref:Pi},[d("div",Mn,[d("div",In,[t[102]||(t[102]=d("span",null,"高度",-1)),m(r,{modelValue:xe.value,"onUpdate:modelValue":t[11]||(t[11]=e=>xe.value=e),min:b(ve).min,max:b(ve).max,step:b(ve).step,size:"small","controls-position":"right",onChange:t[12]||(t[12]=e=>(e=>{g.setHeight(e),o("adjustCamera","height",e)})(e))},null,8,["modelValue","min","max","step"])]),d("div",Dn,[m(l,{modelValue:Te.value,"onUpdate:modelValue":t[13]||(t[13]=e=>Te.value=e),min:b(ve).min,max:b(ve).max,step:b(ve).step,onInput:t[14]||(t[14]=e=>(e=>{const t=Ae(e);g.setHeight(t),o("adjustCamera","height",t)})(e))},null,8,["modelValue","min","max","step"])])]),i.sceneMode===b(qe).SCENE3D||i.sceneMode===b(qe).COLUMBUS_VIEW?(u(),c("div",On,[d("div",Rn,[t[103]||(t[103]=d("span",null,"俯仰角",-1)),m(r,{modelValue:b(M),"onUpdate:modelValue":t[15]||(t[15]=e=>a(M)?M.value=e:null),min:Se.value.min,max:Se.value.max,step:Se.value.step,size:"small","controls-position":"right",onChange:t[16]||(t[16]=e=>Le("pitch",e))},null,8,["modelValue","min","max","step"])]),d("div",Nn,[m(l,{modelValue:b(M),"onUpdate:modelValue":t[17]||(t[17]=e=>a(M)?M.value=e:null),min:Se.value.min,max:Se.value.max,step:Se.value.step,onInput:t[18]||(t[18]=e=>Le("pitch",e))},null,8,["modelValue","min","max","step"])])])):h("",!0),i.sceneMode===b(qe).SCENE3D||i.sceneMode===b(qe).COLUMBUS_VIEW?(u(),c("div",Bn,[d("div",Un,[t[104]||(t[104]=d("span",null,"方向",-1)),m(r,{modelValue:b(I),"onUpdate:modelValue":t[19]||(t[19]=e=>a(I)?I.value=e:null),min:b(Ce).min,max:b(Ce).max,step:b(Ce).step,size:"small","controls-position":"right",onChange:t[20]||(t[20]=e=>Le("heading",e))},null,8,["modelValue","min","max","step"])]),d("div",Vn,[m(l,{modelValue:b(I),"onUpdate:modelValue":t[21]||(t[21]=e=>a(I)?I.value=e:null),min:b(Ce).min,max:b(Ce).max,step:b(Ce).step,onInput:t[22]||(t[22]=e=>Le("heading",e))},null,8,["modelValue","min","max","step"])])])):h("",!0),d("div",zn,[m(_,{type:"primary",size:"small",onClick:ke},{default:v((()=>t[105]||(t[105]=[L(" 重置相机 ")]))),_:1})])],2)]),d("div",Hn,[d("div",{class:"panel-section-title",onClick:t[23]||(t[23]=e=>Ni("location"))},[t[106]||(t[106]=d("span",null,"位置控制",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.location}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.location}]),ref_key:"locationSection",ref:Li},[d("div",Fn,[m(Ji,{onSelectResult:Ai,city:"全国"})]),d("div",Wn,[t[107]||(t[107]=d("span",{class:"control-label"},"跳转动画",-1)),d("div",Gn,[m(s,{modelValue:b(ce),"onUpdate:modelValue":t[24]||(t[24]=e=>a(ce)?ce.value=e:null),loading:at.value},null,8,["modelValue","loading"])])]),t[113]||(t[113]=d("div",{class:"sub-section-title"},"预设位置",-1)),d("div",Yn,[d("div",{class:"location-card add-location",onClick:t[25]||(t[25]=e=>ot.value=!0)},t[108]||(t[108]=[d("div",{class:"location-card-name"},"添加自定义位置",-1),d("div",{class:"location-card-desc"},"保存当前位置或输入坐标",-1),d("div",{class:"add-icon"},"+",-1)])),(u(!0),c(f,null,C(ht.value,((e,i)=>(u(),c("div",{key:i,class:p(["location-card",{active:b(ee)===i}]),onClick:t=>st(e,i)},[d("div",$n,w(e.name),1),d("div",Xn,w(St(e)),1),wt(i)?(u(),c("div",{key:0,class:"location-delete",onClick:y((e=>{return t=i,void Z.confirm(`确定要删除位置 "${null==(n=ut.value[t])?void 0:n.name}" 吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{if(delete ut.value[t],pt(),ee.value===t){ee.value="重邮";const e=Ke["重邮"];D.value=e.longitude,O.value=e.latitude,g.setPosition(e.longitude,e.latitude),ce.value?setTimeout((()=>{o("adjustCamera","preset",{height:k.value,heading:I.value,pitch:M.value,useAnimation:!0})}),100):o("updatePosition",e.longitude,e.latitude,!0)}J.success("位置已删除")})).catch((()=>{}));var t,n}),["stop"])},t[109]||(t[109]=[d("i",{class:"el-icon-close"},null,-1)]),8,Qn)):h("",!0)],10,jn)))),128))]),d("div",Kn,[d("div",qn,[t[110]||(t[110]=d("span",null,"经度",-1)),m(r,{modelValue:b(D),"onUpdate:modelValue":t[26]||(t[26]=e=>a(D)?D.value=e:null),min:b(we).min,max:b(we).max,step:b(we).step,size:"small","controls-position":"right",precision:6,onChange:t[27]||(t[27]=e=>it("longitude",e))},null,8,["modelValue","min","max","step"])]),d("div",Jn,[m(l,{modelValue:b(D),"onUpdate:modelValue":t[28]||(t[28]=e=>a(D)?D.value=e:null),min:b(we).min,max:b(we).max,step:b(we).step,onInput:t[29]||(t[29]=e=>it("longitude",e))},null,8,["modelValue","min","max","step"])])]),d("div",Zn,[d("div",es,[t[111]||(t[111]=d("span",null,"纬度",-1)),m(r,{modelValue:b(O),"onUpdate:modelValue":t[30]||(t[30]=e=>a(O)?O.value=e:null),min:b(be).min,max:b(be).max,step:b(be).step,size:"small","controls-position":"right",precision:6,onChange:t[31]||(t[31]=e=>it("latitude",e))},null,8,["modelValue","min","max","step"])]),d("div",ts,[m(l,{modelValue:b(O),"onUpdate:modelValue":t[32]||(t[32]=e=>a(O)?O.value=e:null),min:b(be).min,max:b(be).max,step:b(be).step,onInput:t[33]||(t[33]=e=>it("latitude",e))},null,8,["modelValue","min","max","step"])])]),d("div",is,[m(_,{type:"primary",size:"small",onClick:Me},{default:v((()=>t[112]||(t[112]=[L(" 重置位置 ")]))),_:1})])],2)]),m(x,{modelValue:ot.value,"onUpdate:modelValue":t[38]||(t[38]=e=>ot.value=e),title:"添加自定义位置",width:"300px","custom-class":"dark-dialog",modal:!0,"close-on-click-modal":!1,"append-to-body":!0,"show-close":!0,"destroy-on-close":!1,center:""},{footer:v((()=>[d("span",ns,[m(_,{size:"default",onClick:vt},{default:v((()=>t[114]||(t[114]=[L("使用当前位置")]))),_:1}),m(_,{size:"default",onClick:t[37]||(t[37]=e=>ot.value=!1)},{default:v((()=>t[115]||(t[115]=[L("取消")]))),_:1}),m(_,{size:"default",type:"primary",style:{background:"rgb(68, 136, 187)"},onClick:yt},{default:v((()=>t[116]||(t[116]=[L("保存")]))),_:1})])])),default:v((()=>[m(E,{"label-position":"top"},{default:v((()=>[m(A,{label:"位置名称"},{default:v((()=>[m(S,{modelValue:rt.value,"onUpdate:modelValue":t[34]||(t[34]=e=>rt.value=e),placeholder:"输入地点名称"},null,8,["modelValue"])])),_:1}),m(A,{label:"经度"},{default:v((()=>[m(r,{modelValue:lt.value,"onUpdate:modelValue":t[35]||(t[35]=e=>lt.value=e),precision:6,step:1e-6,max:180,min:-180,style:{width:"100%"}},null,8,["modelValue"])])),_:1}),m(A,{label:"纬度"},{default:v((()=>[m(r,{modelValue:ct.value,"onUpdate:modelValue":t[36]||(t[36]=e=>ct.value=e),precision:6,step:1e-6,max:90,min:-90,style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])):h("",!0),"effectsControl"===b(he)?(u(),c("div",ss,[d("div",as,[d("div",{class:"panel-section-title",onClick:t[39]||(t[39]=e=>Ni("skybox"))},[t[117]||(t[117]=d("span",null,"天空盒设置",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.skybox}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.skybox}]),ref_key:"skyboxSection",ref:ki},[d("div",os,[t[118]||(t[118]=d("span",{class:"control-label"},"启用天空盒",-1)),d("div",rs,[m(s,{modelValue:Ie.value,"onUpdate:modelValue":t[40]||(t[40]=e=>Ie.value=e),onChange:ze,loading:gi.value},null,8,["modelValue","loading"])])]),Ie.value?(u(),c("div",ls," 高度阈值：低于显示近地天空盒，高于显示太空天空盒 ")):h("",!0),Ie.value?(u(),c("div",cs,[t[119]||(t[119]=d("div",{class:"sub-section-title"},"选择天空盒类型：",-1)),d("div",us,[d("div",{class:p(["skybox-type-tab",{active:"ground"===Re.value}]),onClick:t[41]||(t[41]=e=>Re.value="ground")}," 近地天空盒 ",2),d("div",{class:p(["skybox-type-tab",{active:"space"===Re.value}]),onClick:t[42]||(t[42]=e=>Re.value="space")}," 太空天空盒 ",2),d("div",{class:p(["skybox-type-tab",{active:"volumetric"===Re.value}]),onClick:t[43]||(t[43]=e=>Re.value="volumetric")}," 体积云天空盒 ",2)]),"ground"===Re.value?(u(),c("div",ds,[d("div",hs,[(u(!0),c(f,null,C(Ne.value,(e=>(u(),c("div",{key:e.id,class:p(["skybox-card",{active:De.value===e.id}]),onClick:t=>He(e.id)},[d("div",ps,w(e.name),1),d("div",gs,w(e.description),1)],10,ms)))),128))])])):h("",!0),"space"===Re.value?(u(),c("div",vs,[d("div",ys,[(u(!0),c(f,null,C(Be.value,(e=>(u(),c("div",{key:e.id,class:p(["skybox-card",{active:De.value===e.id}]),onClick:t=>He(e.id)},[d("div",Cs,w(e.name),1),d("div",ws,w(e.description),1)],10,fs)))),128))])])):h("",!0),"volumetric"===Re.value?(u(),c("div",bs,[d("div",_s,[(u(!0),c(f,null,C(Ue.value,(e=>(u(),c("div",{key:e.id,class:p(["skybox-card",{active:De.value===e.id}]),onClick:t=>He(e.id)},[d("div",As,w(e.name),1),d("div",Es,w(e.description),1)],10,Ss)))),128))])])):h("",!0)])):h("",!0),Ie.value?(u(),c("div",xs,[d("div",Ts,[t[120]||(t[120]=d("span",null,"高度阈值",-1)),m(r,{modelValue:Oe.value,"onUpdate:modelValue":t[44]||(t[44]=e=>Oe.value=e),min:5e4,max:5e5,step:1e4,size:"small","controls-position":"right",onChange:Fe},null,8,["modelValue"])]),d("div",Ps,[m(l,{modelValue:Oe.value,"onUpdate:modelValue":t[45]||(t[45]=e=>Oe.value=e),min:5e4,max:5e5,step:1e4,onInput:Fe},null,8,["modelValue"])])])):h("",!0)],2)]),d("div",Ls,[d("div",{class:"panel-section-title",onClick:t[46]||(t[46]=e=>Ni("weather"))},[t[121]||(t[121]=d("span",null,"天气特效",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.weather}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.weather}]),ref_key:"weatherSection",ref:Mi},[d("div",ks,[d("div",{class:p(["skybox-type-tab",{active:"rain"===At.value}]),onClick:t[47]||(t[47]=e=>At.value="rain")}," 雨 ",2),d("div",{class:p(["skybox-type-tab",{active:"snow"===At.value}]),onClick:t[48]||(t[48]=e=>At.value="snow")}," 雪 ",2),d("div",{class:p(["skybox-type-tab",{active:"fog"===At.value}]),onClick:t[49]||(t[49]=e=>At.value="fog")}," 雾 ",2)]),"rain"===At.value?(u(),c("div",Ms,[d("div",Is,[t[122]||(t[122]=d("span",{class:"control-label"},"启用雨效果",-1)),d("div",Ds,[m(s,{modelValue:Et.value,"onUpdate:modelValue":t[50]||(t[50]=e=>Et.value=e),onChange:Wt,loading:null==yi?void 0:yi.rain},null,8,["modelValue","loading"])])]),Et.value?(u(),c("div",Os,[d("div",Rs,[d("div",Ns,[t[123]||(t[123]=d("span",null,"雨滴大小",-1)),m(r,{modelValue:Tt.value,"onUpdate:modelValue":t[51]||(t[51]=e=>Tt.value=e),min:.1,max:1.5,step:.1,size:"small","controls-position":"right",onChange:Gt},null,8,["modelValue"])]),d("div",Bs,[m(l,{modelValue:Tt.value,"onUpdate:modelValue":t[52]||(t[52]=e=>Tt.value=e),min:.1,max:1.5,step:.1,onInput:Gt},null,8,["modelValue"])])]),d("div",Us,[d("div",Vs,[t[124]||(t[124]=d("span",null,"下雨速度",-1)),m(r,{modelValue:Lt.value,"onUpdate:modelValue":t[53]||(t[53]=e=>Lt.value=e),min:.1,max:1.5,step:.1,size:"small","controls-position":"right",onChange:Gt},null,8,["modelValue"])]),d("div",zs,[m(l,{modelValue:Lt.value,"onUpdate:modelValue":t[54]||(t[54]=e=>Lt.value=e),min:.1,max:1.5,step:.1,onInput:Gt},null,8,["modelValue"])])]),d("div",Hs,[d("div",Fs,[t[125]||(t[125]=d("span",null,"雨滴方向",-1)),m(r,{modelValue:kt.value,"onUpdate:modelValue":t[55]||(t[55]=e=>kt.value=e),min:-45,max:0,step:5,size:"small","controls-position":"right",onChange:Gt},null,8,["modelValue"])]),d("div",Ws,[m(l,{modelValue:kt.value,"onUpdate:modelValue":t[56]||(t[56]=e=>kt.value=e),min:-45,max:0,step:5,onInput:Gt},null,8,["modelValue"])])]),d("div",Gs,[t[126]||(t[126]=d("span",{class:"control-label"},"启用闪电",-1)),d("div",Ys,[m(s,{modelValue:It.value,"onUpdate:modelValue":t[57]||(t[57]=e=>It.value=e),onChange:Gt,loading:null==yi?void 0:yi.lightning},null,8,["modelValue","loading"])])]),It.value?(u(),c("div",js,[d("div",$s,[t[127]||(t[127]=d("span",null,"闪电强度",-1)),m(r,{modelValue:Dt.value,"onUpdate:modelValue":t[58]||(t[58]=e=>Dt.value=e),min:.1,max:1,step:.05,precision:2,size:"small","controls-position":"right",onChange:Gt},null,8,["modelValue"])]),d("div",Xs,[m(l,{modelValue:Dt.value,"onUpdate:modelValue":t[59]||(t[59]=e=>Dt.value=e),min:.1,max:1,step:.05,onInput:Gt},null,8,["modelValue"])])])):h("",!0)])):h("",!0)])):h("",!0),"snow"===At.value?(u(),c("div",Qs,[d("div",Ks,[t[128]||(t[128]=d("span",{class:"control-label"},"启用雪效果",-1)),d("div",qs,[m(s,{modelValue:Ot.value,"onUpdate:modelValue":t[60]||(t[60]=e=>Ot.value=e),onChange:jt,loading:null==yi?void 0:yi.snow},null,8,["modelValue","loading"])])]),Ot.value?(u(),c("div",Js,[d("div",Zs,[d("div",ea,[t[129]||(t[129]=d("span",null,"雪花大小",-1)),m(r,{modelValue:Rt.value,"onUpdate:modelValue":t[61]||(t[61]=e=>Rt.value=e),min:.5,max:2,step:.1,size:"small","controls-position":"right",onChange:Xt},null,8,["modelValue"])]),d("div",ta,[m(l,{modelValue:Rt.value,"onUpdate:modelValue":t[62]||(t[62]=e=>Rt.value=e),min:.5,max:2,step:.1,onInput:Xt},null,8,["modelValue"])])]),d("div",ia,[d("div",na,[t[130]||(t[130]=d("span",null,"下雪速度",-1)),m(r,{modelValue:Nt.value,"onUpdate:modelValue":t[63]||(t[63]=e=>Nt.value=e),min:.5,max:2,step:.1,size:"small","controls-position":"right",onChange:Xt},null,8,["modelValue"])]),d("div",sa,[m(l,{modelValue:Nt.value,"onUpdate:modelValue":t[64]||(t[64]=e=>Nt.value=e),min:.5,max:2,step:.1,onInput:Xt},null,8,["modelValue"])])]),d("div",aa,[d("div",oa,[t[131]||(t[131]=d("span",null,"雪花方向",-1)),m(r,{modelValue:Bt.value,"onUpdate:modelValue":t[65]||(t[65]=e=>Bt.value=e),min:-60,max:60,step:5,size:"small","controls-position":"right",onChange:Xt},null,8,["modelValue"])]),d("div",ra,[m(l,{modelValue:Bt.value,"onUpdate:modelValue":t[66]||(t[66]=e=>Bt.value=e),min:-60,max:60,step:5,onInput:Xt},null,8,["modelValue"])])])])):h("",!0)])):h("",!0),"fog"===At.value?(u(),c("div",la,[d("div",ca,[t[132]||(t[132]=d("span",{class:"control-label"},"启用雾效果",-1)),d("div",ua,[m(s,{modelValue:Ut.value,"onUpdate:modelValue":t[67]||(t[67]=e=>Ut.value=e),onChange:Qt,loading:null==yi?void 0:yi.fog},null,8,["modelValue","loading"])])]),Ut.value?(u(),c("div",da,[d("div",ha,[d("div",ma,[t[133]||(t[133]=d("span",null,"雾密度",-1)),m(r,{modelValue:Vt.value,"onUpdate:modelValue":t[68]||(t[68]=e=>Vt.value=e),min:.1,max:2,step:.1,precision:1,size:"small","controls-position":"right",onChange:Kt},null,8,["modelValue"])]),d("div",pa,[m(l,{modelValue:Vt.value,"onUpdate:modelValue":t[69]||(t[69]=e=>Vt.value=e),min:.1,max:2,step:.1,onInput:Kt},null,8,["modelValue"])])]),d("div",ga,[d("div",va,[t[134]||(t[134]=d("span",null,"开始距离(米)",-1)),m(r,{modelValue:Ht.value,"onUpdate:modelValue":t[70]||(t[70]=e=>Ht.value=e),min:10,max:200,step:5,size:"small","controls-position":"right",onChange:Kt},null,8,["modelValue"])]),d("div",ya,[m(l,{modelValue:Ht.value,"onUpdate:modelValue":t[71]||(t[71]=e=>Ht.value=e),min:10,max:200,step:5,onInput:Kt},null,8,["modelValue"])])]),d("div",fa,[d("div",Ca,[t[135]||(t[135]=d("span",null,"结束距离(米)",-1)),m(r,{modelValue:Ft.value,"onUpdate:modelValue":t[72]||(t[72]=e=>Ft.value=e),min:100,max:1e3,step:50,size:"small","controls-position":"right",onChange:Kt},null,8,["modelValue"])]),d("div",wa,[m(l,{modelValue:Ft.value,"onUpdate:modelValue":t[73]||(t[73]=e=>Ft.value=e),min:100,max:1e3,step:50,onInput:Kt},null,8,["modelValue"])])]),d("div",ba,[t[136]||(t[136]=d("span",{class:"control-label"},"雾颜色",-1)),m(N,{modelValue:zt.value,"onUpdate:modelValue":t[74]||(t[74]=e=>zt.value=e),"show-alpha":"",onChange:Kt},null,8,["modelValue"])])])):h("",!0)])):h("",!0)],2)]),d("div",_a,[d("div",{class:"panel-section-title",onClick:t[75]||(t[75]=e=>Ni("atmosphere"))},[t[137]||(t[137]=d("span",null,"大气散射效果",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.atmosphere}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.atmosphere}]),ref_key:"atmosphereSection",ref:Ii},[d("div",Sa,[t[138]||(t[138]=d("span",{class:"control-label"},"启用大气散射",-1)),d("div",Aa,[m(s,{modelValue:Ve.value,"onUpdate:modelValue":t[76]||(t[76]=e=>Ve.value=e),onChange:Zt,loading:vi.value},null,8,["modelValue","loading"])])]),Ve.value?(u(),c("div",Ea,[d("div",xa,[d("div",Ta,[t[139]||(t[139]=d("span",null,"散射强度",-1)),m(r,{modelValue:ti.value,"onUpdate:modelValue":t[77]||(t[77]=e=>ti.value=e),min:.1,max:5,step:.2,precision:1,size:"small","controls-position":"right",onChange:ei},null,8,["modelValue"])]),d("div",Pa,[m(l,{modelValue:ti.value,"onUpdate:modelValue":t[78]||(t[78]=e=>ti.value=e),min:.1,max:5,step:.2,onInput:ei},null,8,["modelValue"])])]),d("div",La,[d("div",ka,[t[140]||(t[140]=d("span",null,"瑞利散射系数",-1)),m(r,{modelValue:ii.value,"onUpdate:modelValue":t[79]||(t[79]=e=>ii.value=e),min:.1,max:5,step:.2,precision:1,size:"small","controls-position":"right",onChange:ei},null,8,["modelValue"])]),d("div",Ma,[m(l,{modelValue:ii.value,"onUpdate:modelValue":t[80]||(t[80]=e=>ii.value=e),min:.1,max:5,step:.2,onInput:ei},null,8,["modelValue"])])]),d("div",Ia,[d("div",Da,[t[141]||(t[141]=d("span",null,"米氏散射系数",-1)),m(r,{modelValue:ni.value,"onUpdate:modelValue":t[81]||(t[81]=e=>ni.value=e),min:.1,max:5,step:.2,precision:1,size:"small","controls-position":"right",onChange:ei},null,8,["modelValue"])]),d("div",Oa,[m(l,{modelValue:ni.value,"onUpdate:modelValue":t[82]||(t[82]=e=>ni.value=e),min:.1,max:5,step:.2,onInput:ei},null,8,["modelValue"])])]),d("div",Ra,[t[142]||(t[142]=d("span",{class:"control-label"},"随时间变化",-1)),d("div",Na,[m(s,{modelValue:si.value,"onUpdate:modelValue":t[83]||(t[83]=e=>si.value=e),onChange:ei},null,8,["modelValue"])])])])):h("",!0)],2)])])):h("",!0),"preferences"===b(he)?(u(),c("div",Ba,[d("div",Ua,[t[144]||(t[144]=d("div",{class:"panel-section-title"},"系统偏好",-1)),d("div",Va,[d("div",za,[d("div",Ha,[t[143]||(t[143]=d("span",{class:"control-label"},"性能监控",-1)),d("div",Fa,[m(s,{modelValue:b(Vi),"onUpdate:modelValue":t[84]||(t[84]=e=>a(Vi)?Vi.value=e:null),onChange:Fi},null,8,["modelValue"])])])])])])])):h("",!0),"modelControl"===b(he)?(u(),c("div",Wa,[d("div",Ga,[d("div",{class:"panel-section-title",onClick:t[85]||(t[85]=e=>Ni("googleTiles"))},[t[145]||(t[145]=d("span",null,"模型控制",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.googleTiles}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.googleTiles}]),ref_key:"googleTilesSection",ref:Di},[t[150]||(t[150]=d("div",{class:"sub-section-title"},"Google Photorealistic 3D Tiles",-1)),d("div",Ya,[t[146]||(t[146]=d("span",{class:"control-label"},"启用3D Tiles",-1)),d("div",ja,[m(s,{modelValue:fi.value,"onUpdate:modelValue":t[86]||(t[86]=e=>fi.value=e),onChange:_i,disabled:Ci.value,loading:Ci.value},null,8,["modelValue","disabled","loading"])])]),Ci.value?(u(),c("div",$a,[m(n,{class:"is-loading"},{default:v((()=>[m(b(q))])),_:1}),t[147]||(t[147]=d("span",{style:{"margin-left":"5px"}},"正在加载Google 3D Tiles...",-1))])):h("",!0),fi.value?(u(),c("div",Xa)):h("",!0),t[151]||(t[151]=d("div",{class:"info-text",style:{"margin-top":"10px",color:"#909399","font-size":"12px"}},[L(" 首次开启将自动飞行到预定位置(旧金山附近) "),d("br"),d("br"),d("span",{style:{color:"#ff9900"}},"注意："),L("Google Photorealistic 3D Tiles 目前仅覆盖部分国家和地区， "),d("br"),L("包括美国、加拿大、日本、英国、西欧、澳大利亚等地区，其他地区可能无法显示3D瓦片。 ")],-1)),t[152]||(t[152]=d("div",{class:"sub-section-title",style:{"margin-top":"20px"}},"Cesium OSM Buildings",-1)),d("div",Qa,[t[148]||(t[148]=d("span",{class:"control-label"},"启用OSM Buildings",-1)),d("div",Ka,[m(s,{modelValue:wi.value,"onUpdate:modelValue":t[87]||(t[87]=e=>wi.value=e),onChange:Si,disabled:bi.value,loading:bi.value},null,8,["modelValue","disabled","loading"])])]),bi.value?(u(),c("div",qa,[m(n,{class:"is-loading"},{default:v((()=>[m(b(q))])),_:1}),t[149]||(t[149]=d("span",{style:{"margin-left":"5px"}},"正在加载Cesium OSM Buildings...",-1))])):h("",!0),t[153]||(t[153]=d("div",{class:"info-text",style:{"margin-top":"10px",color:"#909399","font-size":"12px"}},[L(" Cesium OSM Buildings基于OpenStreetMap数据，覆盖全球大部分地区。 "),d("br"),L("相比Google服务，其覆盖范围更广，但精细度较低。将自动开启地形显示。 ")],-1))],2)]),d("div",Ja,[d("div",{class:"panel-section-title",onClick:t[88]||(t[88]=e=>Ni("flight"))},[t[154]||(t[154]=d("span",null,"3D漫游",-1)),d("i",{class:p(["panel-section-title-icon",{collapsed:Ei.flight}])},"▼",2)]),d("div",{class:p(["panel-section-content",{collapsed:Ei.flight}]),ref_key:"flightSection",ref:Ri},[d("div",Za,[t[155]||(t[155]=d("span",{class:"control-label"},"启用飞行模拟",-1)),d("div",eo,[m(s,{modelValue:oi.value,"onUpdate:modelValue":t[89]||(t[89]=e=>oi.value=e),onChange:di,loading:ri.value,disabled:ri.value||ai.value},null,8,["modelValue","loading","disabled"])])]),ai.value?(u(),c("div",to," 移动端此功能暂不开放，请在PC端使用以获得良好体验。 ")):h("",!0),oi.value?h("",!0):(u(),c("div",io,[t[156]||(t[156]=d("div",{class:"control-header"},[d("span",null,"飞行器选择")],-1)),d("div",no,[(u(!0),c(f,null,C(ci.value,(e=>(u(),c("div",{key:e.id,class:p(["aircraft-card",{active:li.value===e.id}]),onClick:t=>li.value=e.id},[d("div",ao,w(e.name),1),d("div",oo,w(e.description),1)],10,so)))),128))])])),t[157]||(t[157]=d("div",{class:"info-text",style:{"margin-top":"10px",color:"#909399","font-size":"12px"}},[L(" 飞行模拟器使用键盘控制，启用后会在右上角显示飞行参数。 "),d("br"),L("如果需要更换不同的飞行器，请先停止当前飞行再重新选择。点击右下角全屏体验更佳。 "),d("br"),d("br"),L(),d("span",{style:{color:"#ff9900"}},"注意："),L(" 飞行控制面板可拖拽移动， 键盘控制时请保持光标聚焦在页面 ")],-1))],2)])])):h("",!0)])):h("",!0)],2)}}}),[["__scopeId","data-v-d7e6f39d"]]),lo=o({__name:"CompassControl",props:{viewer:{type:Object,required:!0}},setup(e,{expose:t}){const i=e,s=n(null),a=n(null);return r((()=>{i.viewer&&s.value&&(a.value=new _e(i.viewer,{container:s.value,size:100,theme:{outerCircle:"#3f4854",innerCircle:"#53616f",northIcon:"#fff",compass:{graduated:"#fff",main:"#fff"}},tooltip:{reset:"重置方向",pan:"平移",zoom:"缩放"}}))})),l((()=>{a.value&&(a.value.destroy(),a.value=null)})),t({getCompassInstance:()=>a.value}),(e,t)=>(u(),c("div",{class:"compass-container",ref_key:"compassContainerRef",ref:s},null,512))}}),co={class:"zoom-control"},uo=25e6,ho=qi(o({__name:"ZoomControl",props:{viewer:{type:Object,required:!0}},setup(e){const t=e,i=()=>{if(!t.viewer)return;const e=t.viewer.scene,i=t.viewer.camera,n=e.mode,r=i.positionCartographic.height;let l=.6*r;l=Math.max(l,100),r<=100||(n===Cesium.SceneMode.SCENE2D?a(l):n===Cesium.SceneMode.COLUMBUS_VIEW?o(l):s(l))},n=()=>{if(!t.viewer)return;const e=t.viewer.scene,i=t.viewer.camera,n=e.mode,r=i.positionCartographic.height;let l=1.5*r;l=Math.min(l,uo),r>=uo||(n===Cesium.SceneMode.SCENE2D?a(l):n===Cesium.SceneMode.COLUMBUS_VIEW?o(l):s(l))},s=e=>{const i=t.viewer.camera,n=i.positionCartographic.height,s=r();if(!s)return;const a=i.position,o=Cesium.Cartesian3.subtract(s,a,new Cesium.Cartesian3);Cesium.Cartesian3.normalize(o,o);const l=n-e,c=Cesium.Cartesian3.multiplyByScalar(o,l,new Cesium.Cartesian3),u=Cesium.Cartesian3.add(a,c,new Cesium.Cartesian3);t.viewer.camera.flyTo({destination:u,orientation:{heading:i.heading,pitch:i.pitch,roll:i.roll},duration:.2,easingFunction:Cesium.EasingFunction.LINEAR_NONE})},a=e=>{const i=t.viewer.camera,n=t.viewer.scene,s=new Cesium.Cartesian2(t.viewer.canvas.clientWidth/2,t.viewer.canvas.clientHeight/2),a=i.getPickRay(s),o=n.globe.pick(a,n);let r;r=o?Cesium.Cartographic.fromCartesian(o):new Cesium.Cartographic(i.positionCartographic.longitude,i.positionCartographic.latitude),t.viewer.camera.flyTo({destination:Cesium.Cartesian3.fromRadians(r.longitude,r.latitude,e),duration:.2,easingFunction:Cesium.EasingFunction.LINEAR_NONE})},o=e=>{const i=t.viewer.camera,n=i.positionCartographic.height;try{let t=function(){if(o>=s)return;e<n?i.zoomIn(Math.abs(a)):i.zoomOut(Math.abs(a)),o++,requestAnimationFrame(t)};const s=10,a=(e-n)/s;let o=0;t()}catch(s){e<n?i.zoomIn(.4*n):i.zoomOut(.5*n)}},r=()=>{const e=t.viewer;if(!e)return null;const i=new Cesium.Cartesian2(e.canvas.clientWidth/2,e.canvas.clientHeight/2);let n;try{n=e.scene.globe.pick(e.camera.getPickRay(i),e.scene)}catch(s){try{n=e.scene.camera.pickEllipsoid(i,e.scene.globe.ellipsoid)}catch(a){return null}}if(!n)try{const t=e.camera.positionCartographic;n=Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,0)}catch(s){return null}return n};return(e,t)=>{const s=H;return u(),c("div",co,[d("div",{class:"zoom-button",onClick:i},[m(s,null,{default:v((()=>[m(b(ee))])),_:1})]),d("div",{class:"zoom-button",onClick:n},[m(s,null,{default:v((()=>[m(b(te))])),_:1})])])}}}),[["__scopeId","data-v-fac84bd0"]]);class mo{constructor(e,i){t(this,"_position"),t(this,"_screenPosition",new Cesium.Cartesian2),t(this,"_element"),t(this,"_viewer"),t(this,"_options"),t(this,"_destroyed",!1),t(this,"_offset"),t(this,"_arrow",null),t(this,"setPosition",(()=>{if(this._position&&this._viewer&&this._position){if(this._viewer.scene.mode===Cesium.SceneMode.SCENE3D){const e=this._viewer.scene.camera.position,t=new Cesium.BoundingSphere(new Cesium.Cartesian3(0,0,0),635e4);if(!new Cesium.Occluder(t,e).isPointVisible(this._position))return void this.switchElementShow(!1)}const e=Cesium.SceneTransforms.worldToWindowCoordinates(this._viewer.scene,this._position),{_element:t}=this;if(t&&e){if(this._screenPosition&&this._screenPosition.x===e.x&&this._screenPosition.y===e.y)return;t.parentNode||this._viewer.container.appendChild(t),this.switchElementShow(!0),t.style.display="block",t.style.visibility="visible",t.style.opacity="1";const i=e.x-t.clientWidth/2+this._offset[0],n=e.y-t.clientHeight+this._offset[1];t.style.left=`${i}px`,t.style.top=`${n}px`,this._screenPosition=e}}})),this._viewer=e,this._options=i;const{position:n,element:s,offset:a}=i;if(!s)throw Error("Popup element is required!");const o=document.createElement("div");o.setAttribute("data-popup-arrow","true"),o.style.position="absolute",o.style.bottom="-6px",o.style.left="50%",o.style.marginLeft="-6px",o.style.width="0",o.style.height="0",o.style.borderLeft="6px solid transparent",o.style.borderRight="6px solid transparent",o.style.borderTop="6px solid rgba(38, 38, 38, 0.8)",o.style.zIndex="10000",s.appendChild(o),this._arrow=o,s.style.pointerEvents="auto",s.style.display="none",s.parentNode||this._viewer.container.appendChild(s),this._position=n?Cesium.Cartesian3.fromDegrees(n[0],n[1],n[2]):null,this._element=s,this._offset=[(null==a?void 0:a[0])??0,(null==a?void 0:a[1])??0],this.addMapListener()}set position(e){if(!e)return this.switchElementShow(!1),this._position=null,void(this._options.position=null);this._position=Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2]),this._options.position=e,this.setPosition()}get position(){return this._options.position}get destroyed(){return this._destroyed}get element(){return this._element}switchElementShow(e){this._element&&(this._element.style.display=e?"block":"none",this._element.style.visibility=e?"visible":"hidden")}addMapListener(){var e;null==(e=this._viewer)||e.scene.postRender.addEventListener(this.setPosition)}destroy(){this._viewer.isDestroyed()||this._viewer.scene.postRender.removeEventListener(this.setPosition),this.setPosition=void 0,this._destroyed=!0}setContent(e){this._element&&(this._arrow&&this._arrow.parentNode&&this._arrow.parentNode.removeChild(this._arrow),this._element.innerHTML=e,this._arrow&&(this._arrow.style.borderTop="6px solid rgba(38, 38, 38, 0.8)",this._element.appendChild(this._arrow)))}}var po=(e=>(e.POINT="POINT",e.POLYLINE="POLYLINE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.CIRCLE="CIRCLE",e.TEXT_POPUP="TEXT_POPUP",e))(po||{});class go{constructor(e,i={}){t(this,"viewer"),t(this,"options"),t(this,"drawer"),t(this,"entities",[]),t(this,"drawing",!1),t(this,"currentType",null),t(this,"textPopups",[]),t(this,"editingPopupIndex",-1),t(this,"clickHandler",null),t(this,"touchHandler",null),t(this,"lastTapTime",0),t(this,"lastTapPosition",null),this.viewer=e,this.options=this._mergeOptions(i),this._initializeDrawTool()}_initializeDrawTool(){}_mergeOptions(e){const t={width:3,material:Cesium.Color.YELLOW,clampToGround:!1},i={pixelSize:8,color:Cesium.Color.RED,outlineColor:Cesium.Color.WHITE,outlineWidth:1},n={material:Cesium.Color.BLUE.withAlpha(.5),outlineWidth:2,outlineColor:Cesium.Color.BLUE,outline:!0},s={backgroundColor:"rgba(38, 38, 38, 0.8)",borderColor:"rgba(255, 255, 255, 0.3)",textColor:"white",width:200,placeholder:"双击编辑文本"},a=!1;return{lineStyle:{...t,...e.lineStyle},pointStyle:{...i,...e.pointStyle},polygonStyle:{...n,...e.polygonStyle},textPopupStyle:{...s,...e.textPopupStyle},clampToGround:e.clampToGround??a,onComplete:e.onComplete}}startDrawing(e){const t=document.getElementById("cursor-restoring-flag");t&&t.remove();const i=document.getElementById("default-cursor-style");if(i&&i.remove(),this.drawing&&this.stopDrawing(),this.clickHandler&&(this.clickHandler.destroy(),this.clickHandler=null),this.drawer){try{this.drawer.destroy(!1)}catch(n){}this.drawer=null}this.currentType=e,this.drawing=!0;try{if("TEXT_POPUP"===e)return void this.startTextPopupDrawing();this.drawer=new Se(this.viewer),document.body.style.cursor="crosshair",this.viewer.container&&(this.viewer.container.style.cursor="crosshair"),setTimeout((()=>{if(this.drawing&&this.currentType===e){document.body.style.cursor="crosshair",this.viewer.container&&(this.viewer.container.style.cursor="crosshair");const e=document.createElement("style");e.innerHTML="\n\t\t\t\t\t\tbody, .cesium-viewer-container, .cesium-viewer, .cesium-widget, .cesium-widget canvas {\n\t\t\t\t\t\t\tcursor: crosshair !important;\n\t\t\t\t\t\t}\n\t\t\t\t\t",e.id="drawing-cursor-style";const t=document.getElementById("drawing-cursor-style");t&&t.remove(),document.head.appendChild(e)}}),50);const t=this._createDrawerConfig(e);this.drawer.start(t),this.setupMobileDoubleTapDetection()}catch(s){this.drawing=!1,this.currentType=null,this.resetCursorStyle()}}setupMobileDoubleTapDetection(){(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(navigator.userAgent.toLowerCase())||window.innerWidth<768)&&(this.touchHandler&&(this.touchHandler.destroy(),this.touchHandler=null),this.touchHandler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.lastTapTime=0,this.lastTapPosition=null,this.touchHandler.setInputAction((e=>{const t=(new Date).getTime(),i=t-this.lastTapTime,n=e.position?{x:e.position.x,y:e.position.y}:null;if(i<300&&this.lastTapPosition){const e=Math.abs(((null==n?void 0:n.x)||0)-this.lastTapPosition.x),t=Math.abs(((null==n?void 0:n.y)||0)-this.lastTapPosition.y);if(e<20&&t<20)return this.handleMobileDoubleTap(),this.lastTapTime=0,void(this.lastTapPosition=null)}this.lastTapTime=t,this.lastTapPosition=n}),Cesium.ScreenSpaceEventType.LEFT_CLICK))}handleMobileDoubleTap(){if(this.drawing&&this.drawer)try{Object.getOwnPropertyNames(Object.getPrototypeOf(this.drawer)).filter((e=>"function"==typeof this.drawer[e]));const e=this.drawer,t=(this.currentType,this.viewer.scene.canvas);let i={x:t.clientWidth/2,y:t.clientHeight/2};if(e._action&&e._action._pickedPositions&&e._action._pickedPositions.length>0){const t=e._action._pickedPositions[e._action._pickedPositions.length-1],n=Cesium.SceneTransforms.worldToWindowCoordinates(this.viewer.scene,t);n&&(i.x=n.x,i.y=n.y)}const n=new MouseEvent("dblclick",{bubbles:!0,cancelable:!0,view:window,clientX:i.x,clientY:i.y});let s=[];e.$Instance&&e.$Instance.length>0&&(s=[...e.$Instance]),t.dispatchEvent(n);const a={position:new Cesium.Cartesian2(i.x,i.y)};if(this.drawer&&this.drawer._events){const e=this.drawer._events.filter((e=>e&&e.event===Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK));e.length>0&&e.forEach((e=>{"function"==typeof e.action&&e.action(a)}))}setTimeout((()=>{if(this.drawing){if(this.drawer&&this.drawer.$Instance&&this.drawer.$Instance.length>0){[...this.drawer.$Instance].forEach((e=>{this.entities.push(e),this.options&&"function"==typeof this.options.onComplete&&this.options.onComplete(e,[])}))}else s.length>0&&s.forEach((e=>{this.entities.includes(e)||(this.entities.push(e),this.options&&"function"==typeof this.options.onComplete&&this.options.onComplete(e,[]))}));this.stopDrawing(!1)}}),300)}catch(e){this.stopDrawing()}}startTextPopupDrawing(){this.clickHandler&&(this.clickHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK),this.clickHandler.destroy()),this.clickHandler=new Cesium.ScreenSpaceEventHandler(this.viewer.canvas),document.body.style.cursor="crosshair",this.viewer.container&&(this.viewer.container.style.cursor="crosshair"),setTimeout((()=>{if(this.drawing&&"TEXT_POPUP"===this.currentType){document.body.style.cursor="crosshair",this.viewer.container&&(this.viewer.container.style.cursor="crosshair");const e=document.createElement("style");e.innerHTML="\n\t\t\t\t\tbody, .cesium-viewer-container, .cesium-viewer, .cesium-widget, .cesium-widget canvas {\n\t\t\t\t\t\tcursor: crosshair !important;\n\t\t\t\t\t}\n\t\t\t\t",e.id="drawing-cursor-style";const t=document.getElementById("drawing-cursor-style");t&&t.remove(),document.head.appendChild(e)}}),50);const e=new Ae(this.viewer,{offset:[15,-15]});e.content="点击添加文本标注",e.show(),this.clickHandler.setInputAction((t=>{if(!this.drawing||"TEXT_POPUP"!==this.currentType)return e.hide(),void e.destroy();const i=this.viewer.scene.pickPosition(t.position);i&&(e.hide(),e.destroy(),this.createTextPopup(i),this.stopDrawing())}),Cesium.ScreenSpaceEventType.LEFT_CLICK),this.clickHandler.setInputAction((()=>{if(!this.drawing||"TEXT_POPUP"!==this.currentType)return e.hide(),void e.destroy();e.hide(),e.destroy(),this.stopDrawing()}),Cesium.ScreenSpaceEventType.RIGHT_CLICK)}createPopupElement(){const e=document.createElement("div");return e.style.backgroundColor="rgba(38, 38, 38, 0.8)",e.style.border="1px solid rgba(255, 255, 255, 0.1)",e.style.padding="8px",e.style.borderRadius="0",e.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)",e.style.maxWidth="260px",e.style.minWidth="200px",e.style.position="absolute",e.style.zIndex="9999",e.style.color="white",e.style.fontSize="12px",e.style.pointerEvents="auto",e.style.transform="translate3d(0,0,0)",e.className="location-popup-container",e}createTextPopup(e){const t=this.viewer.entities.add({position:e,point:{pixelSize:10,color:Cesium.Color.RED,outlineColor:Cesium.Color.WHITE,outlineWidth:2,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});this.entities.push(t);const i=this.createPopupElement(),n=Cesium.Cartographic.fromCartesian(e),s=Cesium.Math.toDegrees(n.longitude),a=Cesium.Math.toDegrees(n.latitude),o=n.height+10,r=new mo(this.viewer,{element:i,position:[s,a,o],offset:[0,-15]}),l=this.textPopups.length;this.textPopups.push({popup:r,entity:t,position:e,element:i,text:""}),this.updatePopupContent(l,!0),i.addEventListener("dblclick",(()=>{this.startEditingPopup(l)})),setTimeout((()=>{this.ensurePopupVisible(l)}),200),this.options.onComplete&&this.options.onComplete(t,[e])}ensurePopupVisible(e){const t=this.textPopups[e];if(!t)return;const{element:i,popup:n,position:s}=t;i.style.display="block",i.style.visibility="visible",i.style.zIndex="9999";const a=Cesium.Cartographic.fromCartesian(s),o=Cesium.Math.toDegrees(a.longitude),r=Cesium.Math.toDegrees(a.latitude),l=a.height+10;n&&(n.position=[o,r,l],"function"==typeof n.setPosition&&n.setPosition())}updatePopupContent(e,t=!1){var i;const n=this.textPopups[e];if(!n)return;const{element:s,text:a}=n;let o='\n\t\t\t<div class="location-popup-content" style="font-family: Arial, sans-serif; font-size: 12px;">\n\t\t\t\t<h3 style="margin: 0 0 6px 0; color: #62c9ff; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 4px; font-size: 14px;">文本标注</h3>\n\t\t';a.trim()?o+=`<p style="margin: 3px 0;">${a}</p>`:o+=t?`<p style="margin: 3px 0; color: #aaaaaa;">${(null==(i=this.options.textPopupStyle)?void 0:i.placeholder)||"双击编辑文本"}</p>`:'<p style="margin: 3px 0;"></p>',o+="</div>",s.innerHTML=o,s.style.display="block",s.style.visibility="visible"}startEditingPopup(e){const t=this.textPopups[e];if(!t)return;this.editingPopupIndex=e;const{element:i,text:n}=t;let s=`\n\t\t\t<div class="location-popup-content" style="font-family: Arial, sans-serif; font-size: 12px;">\n\t\t\t\t<h3 style="margin: 0 0 6px 0; color: #62c9ff; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 4px; font-size: 14px;">编辑文本</h3>\n\t\t\t\t<textarea style="width: 100%; min-height: 60px; padding: 4px; margin-bottom: 5px; color: #333; resize: none; outline: none; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; font-size: inherit;">${n}</textarea>\n\t\t\t\t<div style="text-align: right;">\n\t\t\t\t\t<small style="color: #aaaaaa;">按Enter确认，Esc取消</small>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;i.innerHTML=s;const a=i.querySelector("textarea");a&&(a.focus(),a.addEventListener("blur",(()=>{this.finishEditingPopup(a.value)})),a.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey?"Escape"===e.key&&a.blur():(e.preventDefault(),a.blur())})))}finishEditingPopup(e){if(this.editingPopupIndex<0)return;const t=this.textPopups[this.editingPopupIndex];if(t){if(t.text=e.trim(),this.updatePopupContent(this.editingPopupIndex,!t.text),t.popup){const e=Cesium.Cartographic.fromCartesian(t.position),i=Cesium.Math.toDegrees(e.longitude),n=Cesium.Math.toDegrees(e.latitude),s=e.height+10;t.popup.position=[i,n,s]}this.editingPopupIndex=-1}}_createDrawerConfig(e){var t,i,n,s,a,o,r,l,c,u;let d={};switch(e){case"POINT":d={pixelSize:null==(t=this.options.pointStyle)?void 0:t.pixelSize,color:null==(i=this.options.pointStyle)?void 0:i.color,outlineColor:null==(n=this.options.pointStyle)?void 0:n.outlineColor,outlineWidth:null==(s=this.options.pointStyle)?void 0:s.outlineWidth};break;case"POLYLINE":d={width:null==(a=this.options.lineStyle)?void 0:a.width,material:null==(o=this.options.lineStyle)?void 0:o.material,clampToGround:this.options.clampToGround};break;case"POLYGON":case"RECTANGLE":case"CIRCLE":d={material:null==(r=this.options.polygonStyle)?void 0:r.material,outline:null==(l=this.options.polygonStyle)?void 0:l.outline,outlineColor:null==(c=this.options.polygonStyle)?void 0:c.outlineColor,outlineWidth:null==(u=this.options.polygonStyle)?void 0:u.outlineWidth}}const h=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(navigator.userAgent.toLowerCase())||window.innerWidth<768;return{type:e,once:!0,terrain:!0,model:!0,operateType:{START:Cesium.ScreenSpaceEventType.LEFT_CLICK,MOVING:Cesium.ScreenSpaceEventType.MOUSE_MOVE,CANCEL:Cesium.ScreenSpaceEventType.RIGHT_CLICK,END:Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK},tips:{init:"点击开始绘制",start:h?"点击添加点，双击完成绘制":"左键点击添加点，右键取消，双击完成绘制",end:"绘制完成"},finalOptions:d,onEnd:(e,t)=>{e&&this.entities.push(e),this.drawing=!1,this.resetCursorStyle(),this.options.onComplete&&this.options.onComplete(e,t),setTimeout((()=>{this.currentType;this.stopDrawing(),this.resetCursorStyle()}),100),this.drawer=null}}}resetCursorStyle(){document.querySelectorAll("style[id^='drawing-cursor'], style[id^='default-cursor']").forEach((e=>e.remove()));const e=document.createElement("style");e.id="force-default-cursor-style",e.innerHTML="\n            body, html, div, canvas, .cesium-viewer, .cesium-widget, .cesium-widget canvas, \n            .cesium-viewer-container, #cesiumContainer, #cesiumContainer * {\n                cursor: default !important;\n            }\n        ",document.head.appendChild(e),document.body.style.cursor="default",this.viewer&&this.viewer.container&&(this.viewer.container.style.cursor="default"),document.querySelectorAll("canvas").forEach((e=>{e.style.cursor="default"})),setTimeout((()=>{const e=document.getElementById("force-default-cursor-style");e&&e.remove()}),1e3)}stopDrawing(e=!1){if(!this.drawing)return;document.body.style.cursor="default",this.viewer.container&&(this.viewer.container.style.cursor="default");const t=document.getElementById("drawing-cursor-style");t&&t.remove(),this.resetCursorStyle(),this.touchHandler&&(this.touchHandler.destroy(),this.touchHandler=null,this.lastTapTime=0,this.lastTapPosition=null),this.clickHandler&&(this.clickHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK),this.clickHandler.removeInputAction(Cesium.ScreenSpaceEventType.RIGHT_CLICK),this.clickHandler.destroy(),this.clickHandler=null);try{this.drawer&&(this.drawer.destroy(!1),this.drawer=null)}catch(i){}this.drawing=!1,this.currentType=null,e&&this.clear()}clear(){try{this.drawing&&this.stopDrawing(),this.drawer&&(this.drawer=null);this.viewer.entities.values.length;this.entities.map((e=>e.id)).forEach((e=>{try{const t=this.viewer.entities.getById(e);t&&this.viewer.entities.remove(t)}catch(t){}}));const e=[];for(let t=0;t<this.viewer.entities.values.length;t++){const i=this.viewer.entities.values[t];i&&(i.polyline||i.polygon||i.rectangle||i.ellipse||i.point&&i.point.pixelSize)&&e.push(i)}e.forEach((e=>{try{this.viewer.entities.remove(e)}catch(t){}})),this.entities=[],this.textPopups.forEach(((e,t)=>{e.popup&&e.popup.destroy(),e.element&&e.element.parentNode&&e.element.parentNode.removeChild(e.element)})),this.textPopups=[],this.editingPopupIndex=-1}catch(e){}}destroy(){try{this.drawing&&this.stopDrawing(),this.clear(),this.clickHandler&&(this.clickHandler.destroy(),this.clickHandler=null),this.drawer&&(this.drawer=null),this.entities=[],this.drawing=!1,this.currentType=null}catch(e){}}}class vo{constructor(e){t(this,"_viewer"),t(this,"_tooltip"),t(this,"_message",""),t(this,"_visible",!1),this._viewer=e,this._tooltip=new Ae(e,{offset:[10,10]}),this._tooltip.hide(),this._visible=!1}show(e){this._message=e,this._visible=!0,this._tooltip.content=e,this._tooltip.show()}hide(){this._visible=!1,this._tooltip&&this._tooltip.hide()}destroy(){try{this._visible=!1,this._tooltip&&!this._tooltip.destroyed&&(this._tooltip.hide(),this._tooltip.destroy());const e=document.querySelectorAll(".cesium-tool-tip");e&&e.length>0&&e.forEach((e=>{var t;try{null==(t=e.parentNode)||t.removeChild(e)}catch(i){}}))}catch(e){}}}class yo{constructor(e,i={}){if(t(this,"viewer"),t(this,"options"),t(this,"drawLayer"),t(this,"handler"),t(this,"touchHandler"),t(this,"lastTapTime",0),t(this,"entities",[]),t(this,"tooltip"),t(this,"active",!1),t(this,"isMobile",!1),this.viewer=e,this.options=this._mergeOptions(i),this.isMobile=function(){const e=navigator.userAgent||navigator.vendor||window.opera;return/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(e.toLowerCase())||window.innerWidth<768}()||"ontouchstart"in window||navigator.maxTouchPoints>0,!this.viewer||!this.viewer.entities)throw new Error("Cesium viewer未正确初始化");try{this.tooltip=new vo(e)}catch(n){this.tooltip={show:e=>{},hide:()=>{},destroy:()=>{}}}try{const t=e;if(!t.drawLayer){if("function"!=typeof this.viewer.entities.add)throw new Error("viewer.entities.add不是函数");t.drawLayer={entities:this.viewer.entities,name:"Measurement Layer"}}this.drawLayer=t.drawLayer}catch(n){this.drawLayer={entities:this.viewer.entities}}}_mergeOptions(e){const t={width:3,material:Cesium.Color.YELLOW,depthFailMaterial:Cesium.Color.YELLOW.withAlpha(.5),clampToGround:!1},i={pixelSize:8,color:Cesium.Color.RED,outlineColor:Cesium.Color.WHITE,outlineWidth:1,heightReference:Cesium.HeightReference.NONE,disableDepthTestDistance:0},n={font:"14px sans-serif",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:2,style:Cesium.LabelStyle.FILL_AND_OUTLINE,pixelOffset:new Cesium.Cartesian2(0,-10),scale:1,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.7),heightReference:Cesium.HeightReference.NONE,disableDepthTestDistance:0},s={material:Cesium.Color.BLUE.withAlpha(.5),outlineWidth:2,outlineColor:Cesium.Color.BLUE,heightReference:Cesium.HeightReference.NONE,clampToGround:!1},a=!1;return{lineStyle:{...t,...e.lineStyle},pointStyle:{...i,...e.pointStyle},labelStyle:{...n,...e.labelStyle},polygonStyle:{...s,...e.polygonStyle},clampToGround:e.clampToGround??a,onComplete:e.onComplete,splitNum:e.splitNum}}start(){if(this.active)return!1;try{if(this.active=!0,this._setupEventHandlers(),this.tooltip.show("点击开始测量"),document.body.style.cursor="crosshair",this.viewer&&this.viewer.container){this.viewer.container.style.cursor="crosshair"}return setTimeout((()=>{if(document.body.style.cursor="crosshair",this.viewer&&this.viewer.container){this.viewer.container.style.cursor="crosshair"}const e=document.createElement("style");e.innerHTML="\n\t\t\t\t\tbody, .cesium-viewer-container, .cesium-viewer, .cesium-widget, .cesium-widget canvas {\n\t\t\t\t\t\tcursor: crosshair !important;\n\t\t\t\t\t}\n\t\t\t\t",e.id="measuring-cursor-style";const t=document.getElementById("measuring-cursor-style");t&&t.remove(),document.head.appendChild(e)}),50),this.isMobile&&this._setupTouchEventHandlers(),!0}catch(e){return this.active=!1,!1}}stop(){if(!this.active)return;this.active=!1,this._cleanupEventHandlers(),this._cleanupTouchEventHandlers(),this.tooltip.hide();const e=document.getElementById("measuring-cursor-style");e&&e.remove();try{if(document.body.style.cursor="auto",this.viewer&&this.viewer.container){this.viewer.container.style.cursor="default"}setTimeout((()=>{if(document.body.style.cursor="auto",this.viewer&&this.viewer.container){this.viewer.container.style.cursor="default"}}),50)}catch(t){}}clear(){this.entities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.entities=[]}destroy(){this.stop(),this.clear();try{const e=this.viewer;this.drawLayer&&this.drawLayer!==this.viewer.entities&&e.drawLayer===this.drawLayer&&(e.drawLayer=null)}catch(e){}this.tooltip&&this.tooltip.destroy()}_cleanupEventHandlers(){this.handler&&(this.handler.destroy(),this.handler=void 0)}_setupTouchEventHandlers(){if(this.viewer&&this.viewer.scene&&this.viewer.scene.canvas)try{this.touchHandler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.touchHandler.setInputAction((e=>{const t=Date.now();t-this.lastTapTime<300?(this._handleTouchDoubleTap(e),this.lastTapTime=0):this.lastTapTime=t}),Cesium.ScreenSpaceEventType.LEFT_CLICK)}catch(e){}}_handleTouchDoubleTap(e){}_cleanupTouchEventHandlers(){this.touchHandler&&(this.touchHandler.destroy(),this.touchHandler=void 0)}_createPoint(e){var t,i,n,s,a,o;try{if(!this.drawLayer||!this.drawLayer.entities||"function"!=typeof this.drawLayer.entities.add)throw new Error("无效的绘制层");const r=this.drawLayer.entities.add({position:e,point:{color:null==(t=this.options.pointStyle)?void 0:t.color,outlineColor:null==(i=this.options.pointStyle)?void 0:i.outlineColor,outlineWidth:null==(n=this.options.pointStyle)?void 0:n.outlineWidth,pixelSize:null==(s=this.options.pointStyle)?void 0:s.pixelSize,heightReference:this.options.clampToGround?Cesium.HeightReference.CLAMP_TO_GROUND:null==(a=this.options.pointStyle)?void 0:a.heightReference,disableDepthTestDistance:null==(o=this.options.pointStyle)?void 0:o.disableDepthTestDistance}});return r&&this.entities.push(r),r}catch(r){return{}}}_createLabel(e,t){var i,n,s,a,o,r,l,c,u;try{if(!this.drawLayer||!this.drawLayer.entities||"function"!=typeof this.drawLayer.entities.add)throw new Error("无效的绘制层");const d=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);d&&(d.height+=5,e=this.viewer.scene.globe.ellipsoid.cartographicToCartesian(d));const h=this.drawLayer.entities.add({position:e,label:{text:t,font:null==(i=this.options.labelStyle)?void 0:i.font,fillColor:null==(n=this.options.labelStyle)?void 0:n.fillColor,outlineColor:null==(s=this.options.labelStyle)?void 0:s.outlineColor,outlineWidth:null==(a=this.options.labelStyle)?void 0:a.outlineWidth,style:null==(o=this.options.labelStyle)?void 0:o.style,pixelOffset:null==(r=this.options.labelStyle)?void 0:r.pixelOffset,scale:null==(l=this.options.labelStyle)?void 0:l.scale,showBackground:(null==(c=this.options.labelStyle)?void 0:c.showBackground)||!0,backgroundColor:null==(u=this.options.labelStyle)?void 0:u.backgroundColor,disableDepthTestDistance:Number.POSITIVE_INFINITY,verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND,translucencyByDistance:void 0,scaleByDistance:void 0,distanceDisplayCondition:void 0},zIndex:999});return h&&this.entities.push(h),h}catch(d){return{}}}_createPolyline(e){var t,i,n,s,a;try{if(!this.drawLayer||!this.drawLayer.entities||"function"!=typeof this.drawLayer.entities.add)throw new Error("无效的绘制层");const o=e.map((e=>{const t=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);return t?(t.height+=.5,this.viewer.scene.globe.ellipsoid.cartographicToCartesian(t)):e})),r=this.drawLayer.entities.add({polyline:{positions:o,width:null==(t=this.options.lineStyle)?void 0:t.width,material:null==(i=this.options.lineStyle)?void 0:i.material,clampToGround:this.options.clampToGround||(null==(n=this.options.lineStyle)?void 0:n.clampToGround),depthFailMaterial:(null==(s=this.options.lineStyle)?void 0:s.depthFailMaterial)||(null==(a=this.options.lineStyle)?void 0:a.material),disableDepthTestDistance:Number.POSITIVE_INFINITY,classificationType:this.options.clampToGround?2:void 0},zIndex:998});return r&&this.entities.push(r),r}catch(o){return{}}}_createPolygon(e){var t,i,n,s;try{if(!this.drawLayer||!this.drawLayer.entities||"function"!=typeof this.drawLayer.entities.add)throw new Error("无效的绘制层");const a=e.map((e=>{const t=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);return t?(t.height+=.3,this.viewer.scene.globe.ellipsoid.cartographicToCartesian(t)):e})),o=(null==(t=this.options.polygonStyle)?void 0:t.material)||new Cesium.Color(0,1,1,.5);o instanceof Cesium.Color&&o.alpha>.7&&(o.alpha=.5);const r=this.drawLayer.entities.add({polygon:{hierarchy:new Cesium.PolygonHierarchy(a),material:o,outline:!1!==(null==(i=this.options.polygonStyle)?void 0:i.outline),outlineColor:null==(n=this.options.polygonStyle)?void 0:n.outlineColor,outlineWidth:null==(s=this.options.polygonStyle)?void 0:s.outlineWidth,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND,disableDepthTestDistance:Number.POSITIVE_INFINITY,classificationType:2},zIndex:997});return r&&this.entities.push(r),r}catch(a){return{}}}_getCartesianFromScreenPoint(e){if(this.options.clampToGround){const t=this.viewer.camera.getPickRay(e);if(!t)return;return this.viewer.scene.globe.pick(t,this.viewer.scene)}return this.viewer.scene.camera.pickEllipsoid(e,this.viewer.scene.globe.ellipsoid)}}function fo(e,t){return Cesium.Cartesian3.distance(e,t)}function Co(e,t,i,n=Cesium.Ellipsoid.WGS84,s=100){return new Promise((a=>{const o=Cesium.Cartographic.fromCartesian(t,n),r=Cesium.Cartographic.fromCartesian(i,n);if(!s||s<=1){const e=new Cesium.EllipsoidGeodesic(o,r,n);a(e.surfaceDistance)}else try{const t=[];for(let e=0;e<=s;e++){const i=e/s,n=o.longitude*(1-i)+r.longitude*i,a=o.latitude*(1-i)+r.latitude*i;t.push(new Cesium.Cartographic(n,a))}if(e&&e.scene&&e.scene.globe&&e.scene.globe.terrainProvider)e.scene.globe.terrainProvider.readyPromise.then((()=>e.scene.sampleTerrainMostDetailed(t))).then((e=>{let t=0;for(let i=1;i<e.length;i++){const s=e[i-1],a=e[i];t+=new Cesium.EllipsoidGeodesic(s,a,n).surfaceDistance}a(t)})).catch((()=>{const e=new Cesium.EllipsoidGeodesic(o,r,n);a(e.surfaceDistance)}));else{const e=new Cesium.EllipsoidGeodesic(o,r,n);a(e.surfaceDistance)}}catch(l){const e=new Cesium.EllipsoidGeodesic(o,r,n);a(e.surfaceDistance)}}))}function wo(e,t=Cesium.Ellipsoid.WGS84){if(e.length<3)return 0;return function(e){if(e.length<3)return 0;const t=6371e3,i=e.map((e=>({lon:Cesium.Math.toRadians(e.lon),lat:Cesium.Math.toRadians(e.lat)})));let n=0,s=i[i.length-1];for(const a of i)n+=(a.lon-s.lon)*Math.sin(a.lat),s=a;return n=Math.abs(n*t*t*.5),n}(e.map((e=>{const i=Cesium.Cartographic.fromCartesian(e,t);return{lon:Cesium.Math.toDegrees(i.longitude),lat:Cesium.Math.toDegrees(i.latitude)}})))}function bo(e){if(e<1e3)return`${e.toFixed(2)} 米`;return`${(e/1e3).toFixed(2)} 千米`}function _o(e,t){const i=e.scene,n=i.globe;if(!n)return;if(i.pickPositionSupported){const e=i.pickPosition(t);if(e){const t=Cesium.Cartographic.fromCartesian(e);if(t&&!isNaN(t.height))return e}}const s=e.camera.getPickRay(t);return s?n.pick(s,i):void 0}class So extends yo{constructor(e,i={}){super(e,{...{lineStyle:{width:5,material:Cesium.Color.YELLOW.withAlpha(.8),depthFailMaterial:Cesium.Color.YELLOW.withAlpha(.6)},pointStyle:{pixelSize:10,color:Cesium.Color.RED.withAlpha(.8),outlineColor:Cesium.Color.WHITE,outlineWidth:2,disableDepthTestDistance:Number.POSITIVE_INFINITY},labelStyle:{font:"bold 16px Arial",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:2,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.8),disableDepthTestDistance:Number.POSITIVE_INFINITY}},...i}),t(this,"points",[]),t(this,"positions",[]),t(this,"distances",[]),t(this,"totalDistance",0),t(this,"measuring",!1),t(this,"tempPosition",null),t(this,"dynamicEntities",[])}_setupEventHandlers(){try{if(!this.viewer||!this.viewer.scene||!this.viewer.scene.canvas)throw new Error("Canvas不可用");if(this.handler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),!this.handler)throw new Error("无法创建事件处理器");this.handler.setInputAction((e=>{try{const t=_o(this.viewer,e.position);if(!Cesium.defined(t))return;if(this.measuring){if(this.points.push(t),this._createPoint(t),this.points.length>=2){const e=this.points[this.points.length-2],t=this.points[this.points.length-1],i=fo(e,t);this.distances.push(i),this.totalDistance+=i;const n=this._elevatePosition(e,10),s=this._elevatePosition(t,10);this._createPolyline([n,s]);const a=Cesium.Cartesian3.lerp(e,t,.5,new Cesium.Cartesian3),o=this._elevatePosition(a,20),r=bo(i);this._createLabel(o,r)}this.tempPosition=t,this._updateDynamicLine()}else this.points=[t],this._createPoint(t),this.measuring=!0,this.tooltip.show("继续点击添加测量点，双击结束测量，右键取消")}catch(t){}}),Cesium.ScreenSpaceEventType.LEFT_CLICK),this.handler.setInputAction((e=>{if(this.measuring&&this.points.length>=2){const t=_o(this.viewer,e.position);if(Cesium.defined(t)){const e=this.points[this.points.length-1];if(Cesium.Cartesian3.distance(e,t)>.1){this.points.push(t),this._createPoint(t);const i=fo(e,t);this.distances.push(i),this.totalDistance+=i;const n=this._elevatePosition(e,10),s=this._elevatePosition(t,10);this._createPolyline([n,s]);const a=Cesium.Cartesian3.lerp(e,t,.5,new Cesium.Cartesian3),o=this._elevatePosition(a,20),r=bo(i);this._createLabel(o,r)}}this._finishMeasure()}}),Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),this.handler.setInputAction((e=>{if(!this.measuring||0===this.points.length)return;const t=_o(this.viewer,e.endPosition);if(Cesium.defined(t)&&(this.tempPosition=t,this._updateDynamicLine(),this.points.length>=1)){const e=fo(this.points[this.points.length-1],t);let i=this.totalDistance+e;this.distances.length>0?this.tooltip.show(`当前段: ${bo(e)}, 总距离: ${bo(i)}`):this.tooltip.show(`距离: ${bo(e)}`)}}),Cesium.ScreenSpaceEventType.MOUSE_MOVE),this.handler.setInputAction((()=>{this.measuring&&(this.clear(),this.measuring=!1,this.tooltip.show("点击开始新的测量"))}),Cesium.ScreenSpaceEventType.RIGHT_CLICK)}catch(e){throw this._cleanupEventHandlers(),this.active=!1,e}}_updateDynamicLine(){var e,t,i,n,s,a,o,r,l,c,u,d;if(this.dynamicEntities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.dynamicEntities=[],this.points.length>0&&this.tempPosition&&this.measuring){const h=this.points[this.points.length-1],m=this._elevatePosition(h,10),p=this._elevatePosition(this.tempPosition,10),g=this.drawLayer.entities.add({polyline:{positions:[m,p],width:null==(e=this.options.lineStyle)?void 0:e.width,material:null==(t=this.options.lineStyle)?void 0:t.material,depthFailMaterial:(null==(i=this.options.lineStyle)?void 0:i.depthFailMaterial)||(null==(n=this.options.lineStyle)?void 0:n.material),disableDepthTestDistance:Number.POSITIVE_INFINITY,clampToGround:!1},zIndex:9999});this.dynamicEntities.push(g);const v=fo(h,this.tempPosition),y=Cesium.Cartesian3.lerp(h,this.tempPosition,.5,new Cesium.Cartesian3),f=this._elevatePosition(y,20),C=this.drawLayer.entities.add({position:f,label:{text:bo(v),font:null==(s=this.options.labelStyle)?void 0:s.font,fillColor:null==(a=this.options.labelStyle)?void 0:a.fillColor,outlineColor:null==(o=this.options.labelStyle)?void 0:o.outlineColor,outlineWidth:(null==(r=this.options.labelStyle)?void 0:r.outlineWidth)||3,style:null==(l=this.options.labelStyle)?void 0:l.style,pixelOffset:null==(c=this.options.labelStyle)?void 0:c.pixelOffset,showBackground:(null==(u=this.options.labelStyle)?void 0:u.showBackground)||!0,backgroundColor:null==(d=this.options.labelStyle)?void 0:d.backgroundColor,disableDepthTestDistance:Number.POSITIVE_INFINITY,verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,heightReference:Cesium.HeightReference.NONE,translucencyByDistance:void 0,scaleByDistance:void 0,scale:1.2},zIndex:1e4});this.dynamicEntities.push(C)}}_elevatePosition(e,t){const i=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);return i?(i.height+=t,this.viewer.scene.globe.ellipsoid.cartographicToCartesian(i)):e}_handleTouchDoubleTap(e){this.measuring&&this.points.length>=2&&this._finishMeasure()}_finishMeasure(){if(this._clearDynamicEntities(),this.points.length>=2&&this.totalDistance>0){let e=this._calculatePathMidpoint(),t=this._elevatePosition(e,30);const i=this._createLabel(t,`总距离: ${bo(this.totalDistance)}`);this.options.onComplete&&this.options.onComplete(i,{distance:this.totalDistance,points:[...this.points]})}this.positions=[...this.points],this.measuring=!1,this.points=[],this.distances=[],this.totalDistance=0,this.tempPosition=null,this.stop()}clear(){super.clear(),this.points=[],this.distances=[],this.totalDistance=0,this.tempPosition=null,this.dynamicEntities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.dynamicEntities=[]}_clearDynamicEntities(){this.dynamicEntities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.dynamicEntities=[]}_calculatePathMidpoint(){if(0===this.points.length)return new Cesium.Cartesian3;if(1===this.points.length)return this.points[0];let e=0;const t=[];for(let a=0;a<this.points.length-1;a++){const i=fo(this.points[a],this.points[a+1]);t.push(i),e+=i}let i=0,n=0;for(let a=0;a<t.length;a++){if(i+t[a]>=e/2){n=a;break}i+=t[a]}const s=(e/2-i)/t[n];return Cesium.Cartesian3.lerp(this.points[n],this.points[n+1],s,new Cesium.Cartesian3)}}class Ao extends yo{constructor(e,i={}){super(e,{...{lineStyle:{width:5,material:Cesium.Color.YELLOW.withAlpha(.8),depthFailMaterial:Cesium.Color.YELLOW.withAlpha(.6),clampToGround:!0},pointStyle:{pixelSize:10,color:Cesium.Color.RED.withAlpha(.8),outlineColor:Cesium.Color.WHITE,outlineWidth:2,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,disableDepthTestDistance:Number.POSITIVE_INFINITY},labelStyle:{font:"bold 16px Arial",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:2,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.8),heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,disableDepthTestDistance:Number.POSITIVE_INFINITY}},...i,clampToGround:!0}),t(this,"points",[]),t(this,"distances",[]),t(this,"totalDistance",0),t(this,"measuring",!1),t(this,"tempPosition",null),t(this,"dynamicEntities",[]),t(this,"splitNum",100),t(this,"totalDistanceLabel",null),t(this,"positions",[]),void 0!==i.splitNum&&(this.splitNum=i.splitNum)}_setupEventHandlers(){this.handler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.handler.setInputAction((e=>{const t=_o(this.viewer,e.position);if(Cesium.defined(t))if(this.measuring){if(this.points.push(t),this._createPoint(t),this.points.length>=2){const e=this.points[this.points.length-2],t=this.points[this.points.length-1],i=this._createPolyline([e,t]);this.dynamicEntities.push(i),Co(this.viewer,e,t,void 0,this.splitNum).then((n=>{this.drawLayer.entities.remove(i),this.dynamicEntities=this.dynamicEntities.filter((e=>e!==i)),this.distances.push(n),this.totalDistance+=n;const s=this._createSurfacePolyline(e,t);s&&this.entities.push(s);const a=Cesium.Cartesian3.lerp(e,t,.5,new Cesium.Cartesian3),o=this._elevatePosition(a,15),r=bo(n);this._createLabel(o,r)})).catch((e=>{this.dynamicEntities=this.dynamicEntities.filter((e=>e!==i)),this.entities.push(i)}))}this.tempPosition=t,this._updateDynamicLine()}else this.points=[t],this._createPoint(t),this.measuring=!0,this.tooltip.show("继续点击添加测量点，双击结束测量，右键取消")}),Cesium.ScreenSpaceEventType.LEFT_CLICK),this.handler.setInputAction((e=>{if(this.measuring&&this.points.length>=2){const t=_o(this.viewer,e.position);if(Cesium.defined(t)){const e=this.points[this.points.length-1];if(Cesium.Cartesian3.distance(e,t)>.1){this.points.push(t),this._createPoint(t);const i=this._createPolyline([e,t]);this.dynamicEntities.push(i),Co(this.viewer,e,t,void 0,this.splitNum).then((n=>{this.drawLayer.entities.remove(i),this.dynamicEntities=this.dynamicEntities.filter((e=>e!==i)),this.distances.push(n),this.totalDistance+=n;const s=this._createSurfacePolyline(e,t);s&&this.entities.push(s);const a=Cesium.Cartesian3.lerp(e,t,.5,new Cesium.Cartesian3),o=this._elevatePosition(a,15),r=bo(n);this._createLabel(o,r),this._finishMeasureWithTotalDistance()})).catch((e=>{this.dynamicEntities=this.dynamicEntities.filter((e=>e!==i)),this.entities.push(i),this._finishMeasureWithTotalDistance()}))}else this._finishMeasureWithTotalDistance()}else this._finishMeasureWithTotalDistance()}}),Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),this.handler.setInputAction((e=>{if(!this.measuring||0===this.points.length)return;const t=_o(this.viewer,e.endPosition);if(Cesium.defined(t)&&(this.tempPosition=t,this._updateDynamicLine(),this.points.length>=1)){const e=this.points[this.points.length-1];Co(this.viewer,e,this.tempPosition,void 0,this.splitNum).then((e=>{const t=this.totalDistance+e;this.distances.length>0?this.tooltip.show(`当前段: ${bo(e)}, 总距离: ${bo(t)}`):this.tooltip.show(`距离: ${bo(e)}`)}))}}),Cesium.ScreenSpaceEventType.MOUSE_MOVE),this.handler.setInputAction((()=>{this.measuring&&(this.clear(),this.measuring=!1,this.tooltip.show("点击开始新的测量"))}),Cesium.ScreenSpaceEventType.RIGHT_CLICK)}_updateDynamicLine(){var e,t,i,n;if(this.dynamicEntities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.dynamicEntities=[],this.points.length>0&&this.tempPosition&&this.measuring){const s=this.points[this.points.length-1],a=this.drawLayer.entities.add({polyline:{positions:[s,this.tempPosition],width:null==(e=this.options.lineStyle)?void 0:e.width,material:null==(t=this.options.lineStyle)?void 0:t.material,clampToGround:!0,depthFailMaterial:(null==(i=this.options.lineStyle)?void 0:i.depthFailMaterial)||(null==(n=this.options.lineStyle)?void 0:n.material),disableDepthTestDistance:Number.POSITIVE_INFINITY,classificationType:2},zIndex:9999});this.dynamicEntities.push(a),Co(this.viewer,s,this.tempPosition,void 0,this.splitNum).then((e=>{var t,i,n,a,o,r,l,c;if(!this.measuring||!this.tempPosition)return;const u=Cesium.Cartesian3.lerp(s,this.tempPosition,.5,new Cesium.Cartesian3),d=this._elevatePosition(u,15),h=this.drawLayer.entities.add({position:d,label:{text:bo(e),font:null==(t=this.options.labelStyle)?void 0:t.font,fillColor:null==(i=this.options.labelStyle)?void 0:i.fillColor,outlineColor:null==(n=this.options.labelStyle)?void 0:n.outlineColor,outlineWidth:(null==(a=this.options.labelStyle)?void 0:a.outlineWidth)||3,style:null==(o=this.options.labelStyle)?void 0:o.style,pixelOffset:null==(r=this.options.labelStyle)?void 0:r.pixelOffset,showBackground:(null==(l=this.options.labelStyle)?void 0:l.showBackground)||!0,backgroundColor:null==(c=this.options.labelStyle)?void 0:c.backgroundColor,disableDepthTestDistance:Number.POSITIVE_INFINITY,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND,verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,translucencyByDistance:void 0,scaleByDistance:void 0,distanceDisplayCondition:void 0,scale:1.2},zIndex:1e4});this.dynamicEntities.push(h)}))}}_elevatePosition(e,t){const i=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);return i?(i.height+=t,this.viewer.scene.globe.ellipsoid.cartographicToCartesian(i)):e}_handleTouchDoubleTap(e){this.measuring&&this.points.length>=2&&this._finishMeasureWithTotalDistance()}_finishMeasureWithTotalDistance(){if(this.dynamicEntities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.dynamicEntities=[],this.points.length>=2&&this.totalDistance>0){const e=this._calculatePathCenter(),t=this._elevatePosition(e,25);this.totalDistanceLabel=this._createLabel(t,`总距离: ${bo(this.totalDistance)}`),this.options.onComplete&&this.options.onComplete(this.totalDistanceLabel,{distance:this.totalDistance,points:[...this.points]})}this.positions=[...this.points],this.measuring=!1,this.points=[],this.distances=[],this.totalDistance=0,this.tempPosition=null,this.tooltip.show("点击开始测量新的贴地距离"),this.stop()}_calculatePathCenter(){if(0===this.points.length)return new Cesium.Cartesian3;const e=new Cesium.Cartesian3(0,0,0);for(let t=0;t<this.points.length;t++)Cesium.Cartesian3.add(e,this.points[t],e);return Cesium.Cartesian3.divideByScalar(e,this.points.length,e)}clear(){super.clear(),this.points=[],this.distances=[],this.totalDistance=0,this.tempPosition=null,this.dynamicEntities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.dynamicEntities=[]}_createSurfacePolyline(e,t){var i,n,s,a;try{if(!this.drawLayer||!this.drawLayer.entities||"function"!=typeof this.drawLayer.entities.add)throw new Error("无效的绘制层");const o=[],r=this.splitNum;o.push(e);for(let i=1;i<r;i++){const n=i/r,s=Cesium.Cartesian3.lerp(e,t,n,new Cesium.Cartesian3);o.push(s)}o.push(t);return this.drawLayer.entities.add({polyline:{positions:o,width:null==(i=this.options.lineStyle)?void 0:i.width,material:null==(n=this.options.lineStyle)?void 0:n.material,clampToGround:!0,depthFailMaterial:(null==(s=this.options.lineStyle)?void 0:s.depthFailMaterial)||(null==(a=this.options.lineStyle)?void 0:a.material),disableDepthTestDistance:Number.POSITIVE_INFINITY,classificationType:2},zIndex:9980})}catch(o){return null}}_createDistanceLabel(e,t,i,n=!1,s=!1){try{const a=this.drawLayer.entities.add({position:e,label:{text:t,font:n?"14px sans-serif":"12px sans-serif",fillColor:i,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,outlineColor:Cesium.Color.BLACK,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,pixelOffset:new Cesium.Cartesian2(0,n?-10:10),disableDepthTestDistance:1e6,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});return s?this.dynamicEntities.push(a):(this.entities.push(a),n&&(this.totalDistanceLabel=a)),a}catch(a){return{}}}measureEvt(e){}}class Eo extends yo{constructor(e,i={}){super(e,i),t(this,"measuring",!1),t(this,"tempPositions",[]),t(this,"positions",[]),t(this,"area",0),t(this,"polyline",null),t(this,"currentEntities",[])}_setupEventHandlers(){this.handler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.handler.setInputAction((e=>{const t=this._getCartesianFromScreenPoint(e.position);if(Cesium.defined(t))if(this.measuring){this.tempPositions.push(t);const e=this.drawLayer.entities.add({position:t,point:{color:new Cesium.Color(1,0,0,1),outlineColor:Cesium.Color.WHITE,outlineWidth:2,pixelSize:10,disableDepthTestDistance:Number.POSITIVE_INFINITY},zIndex:9999});this.currentEntities.push(e),this.entities.push(e),this._updateMeasure()}else{this.measuring=!0,this.tempPositions=[t],this.currentEntities=[];const e=this.drawLayer.entities.add({position:t,point:{color:new Cesium.Color(1,0,0,1),outlineColor:Cesium.Color.WHITE,outlineWidth:2,pixelSize:10,disableDepthTestDistance:Number.POSITIVE_INFINITY},zIndex:9999});this.currentEntities.push(e),this.entities.push(e),this.tooltip.show("继续点击添加点，右键删除点，双击结束")}}),Cesium.ScreenSpaceEventType.LEFT_CLICK),this.handler.setInputAction((e=>{if(!this.measuring||0===this.tempPositions.length)return;const t=this._getCartesianFromScreenPoint(e.endPosition);Cesium.defined(t)&&this._updateDynamicShape(t)}),Cesium.ScreenSpaceEventType.MOUSE_MOVE),this.handler.setInputAction((()=>{if(this.measuring&&this.tempPositions.length>0){if(this.tempPositions.pop(),this.currentEntities.length>0){const e=this.currentEntities.pop();if(e){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}}this._updateMeasure(),0===this.tempPositions.length&&(this.measuring=!1,this.tooltip.show("点击开始测量面积"))}}),Cesium.ScreenSpaceEventType.RIGHT_CLICK),this.handler.setInputAction((e=>{this.measuring&&this.tempPositions.length>=3&&this._finishMeasure()}),Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK)}_updateDynamicShape(e){var t,i;if(this.tempPositions.length<1)return;let n=[...this.tempPositions,e];if(n.length>=3&&(n=[...n,n[0]]),this.currentEntities.forEach((e=>{if(e.polyline||e.label){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}})),this.currentEntities=this.currentEntities.filter((e=>e.point)),n.length>=4){const e=this.drawLayer.entities.add({polyline:{positions:n,width:(null==(t=this.options.lineStyle)?void 0:t.width)||3,material:new Cesium.Color(1,1,0,1),disableDepthTestDistance:Number.POSITIVE_INFINITY},zIndex:9998});this.currentEntities.push(e),this.entities.push(e);const i=n.slice(0,-1);this.area=wo(i);let s="";s=this.area<1e6?`面积: ${this.area.toFixed(2)}平方米`:`面积: ${(this.area/1e6).toFixed(4)}平方千米`;const a=this._calculateCenter(i),o=this._elevatePosition(a,20),r=this.drawLayer.entities.add({position:o,label:{text:s,font:"16px sans-serif",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:3,style:Cesium.LabelStyle.FILL_AND_OUTLINE,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.8),verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,disableDepthTestDistance:Number.POSITIVE_INFINITY,pixelOffset:new Cesium.Cartesian2(0,0),scale:1.2},zIndex:1e4});this.currentEntities.push(r),this.entities.push(r)}else{const e=this.drawLayer.entities.add({polyline:{positions:n,width:(null==(i=this.options.lineStyle)?void 0:i.width)||3,material:new Cesium.Color(1,1,0,1),disableDepthTestDistance:Number.POSITIVE_INFINITY},zIndex:9998});this.currentEntities.push(e),this.entities.push(e)}}_updateMeasure(){var e,t;if(this.tempPositions.length<3){const t=[...this.tempPositions];if(this.currentEntities.forEach((e=>{if(e.polyline||e.label){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}})),this.currentEntities=this.currentEntities.filter((e=>e.point)),t.length>=2){const i=this.drawLayer.entities.add({polyline:{positions:t,width:(null==(e=this.options.lineStyle)?void 0:e.width)||3,material:new Cesium.Color(1,1,0,1),disableDepthTestDistance:Number.POSITIVE_INFINITY},zIndex:9998});this.currentEntities.push(i),this.entities.push(i)}}else{const e=[...this.tempPositions,this.tempPositions[0]];this.currentEntities.forEach((e=>{if(e.polyline||e.label){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}})),this.currentEntities=this.currentEntities.filter((e=>e.point));const i=this.drawLayer.entities.add({polyline:{positions:e,width:(null==(t=this.options.lineStyle)?void 0:t.width)||3,material:new Cesium.Color(1,1,0,1),disableDepthTestDistance:Number.POSITIVE_INFINITY},zIndex:9998});this.currentEntities.push(i),this.entities.push(i),this.area=wo(this.tempPositions);let n="";n=this.area<1e6?`面积: ${this.area.toFixed(2)}平方米`:`面积: ${(this.area/1e6).toFixed(4)}平方千米`;const s=this._calculateCenter(this.tempPositions),a=this._elevatePosition(s,20),o=this.drawLayer.entities.add({position:a,label:{text:n,font:"16px sans-serif",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:3,style:Cesium.LabelStyle.FILL_AND_OUTLINE,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.8),verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,disableDepthTestDistance:Number.POSITIVE_INFINITY,pixelOffset:new Cesium.Cartesian2(0,0),scale:1.2},zIndex:1e4});this.currentEntities.push(o),this.entities.push(o)}}_handleTouchDoubleTap(e){this.measuring&&this.tempPositions.length>=3&&this._finishMeasure()}_finishMeasure(){this.tempPositions.length<3||(this.area=wo(this.tempPositions),this._updateMeasure(),this.options.onComplete&&this.options.onComplete(this.entities[this.entities.length-1],{area:this.area,positions:[...this.tempPositions]}),this.positions=[...this.tempPositions],this.tempPositions=[],this.measuring=!1,this.currentEntities=[],this.tooltip.show("点击开始新的测量"),this.stop())}clear(){this.entities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.entities=[],this.currentEntities=[],this.tempPositions=[],this.measuring=!1}_calculateCenter(e){if(0===e.length)return new Cesium.Cartesian3;let t=new Cesium.Cartesian3(0,0,0);for(let i=0;i<e.length;i++)Cesium.Cartesian3.add(t,e[i],t);return Cesium.Cartesian3.divideByScalar(t,e.length,t),t}_elevatePosition(e,t){const i=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);return i?(i.height+=t,this.viewer.scene.globe.ellipsoid.cartographicToCartesian(i)):e}}class xo extends yo{constructor(e,i={}){super(e,{clampToGround:!0,...i}),t(this,"measuring",!1),t(this,"tempPositions",[]),t(this,"positions",[]),t(this,"area",0),t(this,"polyline",null),t(this,"currentEntities",[])}_setupEventHandlers(){this.handler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.handler.setInputAction((e=>{const t=this._getCartesianFromScreenPoint(e.position);if(Cesium.defined(t))if(this.measuring){this.tempPositions.push(t);const e=this.drawLayer.entities.add({position:t,point:{color:new Cesium.Color(1,0,0,1),outlineColor:Cesium.Color.WHITE,outlineWidth:2,pixelSize:10,heightReference:this.options.clampToGround?1:0},zIndex:9999});this.currentEntities.push(e),this.entities.push(e),this._updateMeasure()}else{this.measuring=!0,this.tempPositions=[t],this.currentEntities=[];const e=this.drawLayer.entities.add({position:t,point:{color:new Cesium.Color(1,0,0,1),outlineColor:Cesium.Color.WHITE,outlineWidth:2,pixelSize:10,heightReference:this.options.clampToGround?1:0},zIndex:9999});this.currentEntities.push(e),this.entities.push(e),this.tooltip.show("继续点击添加点，右键删除点，双击结束")}}),Cesium.ScreenSpaceEventType.LEFT_CLICK),this.handler.setInputAction((e=>{if(!this.measuring||0===this.tempPositions.length)return;const t=this._getCartesianFromScreenPoint(e.endPosition);Cesium.defined(t)&&this._updateDynamicShape(t)}),Cesium.ScreenSpaceEventType.MOUSE_MOVE),this.handler.setInputAction((()=>{if(this.measuring&&this.tempPositions.length>0){if(this.tempPositions.pop(),this.currentEntities.length>0){const e=this.currentEntities.pop();if(e){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}}this._updateMeasure(),0===this.tempPositions.length&&(this.measuring=!1,this.tooltip.show("点击开始测量面积"))}}),Cesium.ScreenSpaceEventType.RIGHT_CLICK),this.handler.setInputAction((e=>{this.measuring&&this.tempPositions.length>=3&&this._finishMeasure()}),Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK)}_getCartesianFromScreenPoint(e){if(this.options.clampToGround){const t=this.viewer.camera.getPickRay(e);if(!t)return;return this.viewer.scene.globe.pick(t,this.viewer.scene)}return this.viewer.scene.camera.pickEllipsoid(e,this.viewer.scene.globe.ellipsoid)}_updateDynamicShape(e){var t,i;if(this.tempPositions.length<1)return;let n=[...this.tempPositions,e];if(n.length>=3&&(n=[...n,n[0]]),this.currentEntities.forEach((e=>{if(e.polyline||e.label){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}})),this.currentEntities=this.currentEntities.filter((e=>e.point)),n.length>=4){const e=this.drawLayer.entities.add({polyline:{positions:n,width:(null==(t=this.options.lineStyle)?void 0:t.width)||3,material:new Cesium.Color(1,1,0,1),arcType:this.options.clampToGround?Cesium.ArcType.GEODESIC:Cesium.ArcType.NONE,clampToGround:this.options.clampToGround},zIndex:9998});this.currentEntities.push(e),this.entities.push(e);const i=n.slice(0,-1);this.area=wo(i);let s="";s=this.area<1e6?`面积: ${this.area.toFixed(2)}平方米`:`面积: ${(this.area/1e6).toFixed(4)}平方千米`;const a=this._calculateCenter(i),o=this._elevatePosition(a,20),r=this.drawLayer.entities.add({position:o,label:{text:s,font:"16px sans-serif",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:3,style:Cesium.LabelStyle.FILL_AND_OUTLINE,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.8),verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,disableDepthTestDistance:Number.POSITIVE_INFINITY,pixelOffset:new Cesium.Cartesian2(0,0),scale:1.2},zIndex:1e4});this.currentEntities.push(r),this.entities.push(r)}else{const e=this.drawLayer.entities.add({polyline:{positions:n,width:(null==(i=this.options.lineStyle)?void 0:i.width)||3,material:new Cesium.Color(1,1,0,1),arcType:this.options.clampToGround?Cesium.ArcType.GEODESIC:Cesium.ArcType.NONE,clampToGround:this.options.clampToGround},zIndex:9998});this.currentEntities.push(e),this.entities.push(e)}}_updateMeasure(){var e,t;if(this.tempPositions.length<3){const t=[...this.tempPositions];if(this.currentEntities.forEach((e=>{if(e.polyline||e.label){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}})),this.currentEntities=this.currentEntities.filter((e=>e.point)),t.length>=2){const i=this.drawLayer.entities.add({polyline:{positions:t,width:(null==(e=this.options.lineStyle)?void 0:e.width)||3,material:new Cesium.Color(1,1,0,1),arcType:this.options.clampToGround?Cesium.ArcType.GEODESIC:Cesium.ArcType.NONE,clampToGround:this.options.clampToGround},zIndex:9998});this.currentEntities.push(i),this.entities.push(i)}}else{const e=[...this.tempPositions,this.tempPositions[0]];this.currentEntities.forEach((e=>{if(e.polyline||e.label){this.drawLayer.entities.remove(e);const t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}})),this.currentEntities=this.currentEntities.filter((e=>e.point));const i=this.drawLayer.entities.add({polyline:{positions:e,width:(null==(t=this.options.lineStyle)?void 0:t.width)||3,material:new Cesium.Color(1,1,0,1),arcType:this.options.clampToGround?Cesium.ArcType.GEODESIC:Cesium.ArcType.NONE,clampToGround:this.options.clampToGround},zIndex:9998});this.currentEntities.push(i),this.entities.push(i),this.area=wo(this.tempPositions);let n="";n=this.area<1e6?`面积: ${this.area.toFixed(2)}平方米`:`面积: ${(this.area/1e6).toFixed(4)}平方千米`;const s=this._calculateCenter(this.tempPositions),a=this._elevatePosition(s,20),o=this.drawLayer.entities.add({position:a,label:{text:n,font:"16px sans-serif",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:3,style:Cesium.LabelStyle.FILL_AND_OUTLINE,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.8),verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,disableDepthTestDistance:Number.POSITIVE_INFINITY,pixelOffset:new Cesium.Cartesian2(0,0),scale:1.2},zIndex:1e4});this.currentEntities.push(o),this.entities.push(o)}}_handleTouchDoubleTap(e){this.measuring&&this.tempPositions.length>=3&&this._finishMeasure()}_finishMeasure(){this.tempPositions.length<3||(this.area=wo(this.tempPositions),this._updateMeasure(),this.options.onComplete&&this.options.onComplete(this.entities[this.entities.length-1],{area:this.area,positions:[...this.tempPositions]}),this.positions=[...this.tempPositions],this.tempPositions=[],this.measuring=!1,this.currentEntities=[],this.tooltip.show("点击开始新的测量"),this.stop())}clear(){this.entities.forEach((e=>{this.drawLayer.entities.remove(e)})),this.entities=[],this.currentEntities=[],this.tempPositions=[],this.measuring=!1}_calculateCenter(e){if(0===e.length)return new Cesium.Cartesian3;let t=new Cesium.Cartesian3(0,0,0);for(let i=0;i<e.length;i++)Cesium.Cartesian3.add(t,e[i],t);return Cesium.Cartesian3.divideByScalar(t,e.length,t),t}_elevatePosition(e,t){const i=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);return i?(i.height+=t,this.viewer.scene.globe.ellipsoid.cartographicToCartesian(i)):e}}class To{constructor(e,i={}){t(this,"viewer"),t(this,"options"),t(this,"isTracking",!1),t(this,"currentPositionEntity",null),t(this,"trackEntity",null),t(this,"startPositionEntity",null),t(this,"endPositionEntity",null),t(this,"watchId",null),t(this,"popupOverlay",null),t(this,"startPopup",null),t(this,"endPopup",null),t(this,"trackStartTime",0),t(this,"trackRecord",{startTime:0,endTime:0,duration:0,distance:0,positions:[],geolocations:[]}),t(this,"ipAddress","正在获取..."),t(this,"updateTimerId",null),this.viewer=e,this.options=this.mergeDefaultOptions(i),this.initPopup(),this.fetchIPAddress()}async fetchIPAddress(){try{const e=await fetch("https://api.ipify.org?format=json"),t=await e.json();this.ipAddress=t.ip||"未知"}catch(e){this.ipAddress="获取失败"}}mergeDefaultOptions(e){return{currentPositionStyle:{billboard:{image:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDc4ZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0iZmVhdGhlciBmZWF0aGVyLW1hcC1waW4iPjxwYXRoIGQ9Ik0yMSAxMWMwIDctOSAxMy05IDEzcy05LTYtOS0xM2E5IDkgMCAwIDEgMTgtMHoiPjwvcGF0aD48Y2lyY2xlIGN4PSIxMiIgY3k9IjEwIiByPSIzIj48L2NpcmNsZT48L3N2Zz4=",verticalOrigin:Cesium.VerticalOrigin.BOTTOM,scale:.5,color:Cesium.Color.RED},label:{text:"当前位置",font:"14px sans-serif",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:2,style:Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:Cesium.VerticalOrigin.TOP,pixelOffset:new Cesium.Cartesian2(0,-42)}},trackLineStyle:{width:3,material:new Cesium.ColorMaterialProperty(Cesium.Color.BLUE.withAlpha(.7))},popup:{width:250,height:150,contentRenderer:this.defaultPopupRenderer.bind(this)},...e}}createPopupElement(e){const t=document.createElement("div");return t.className="location-popup-container",t.style.backgroundColor="rgba(38, 38, 38, 0.8)",t.style.border="1px solid rgba(255, 255, 255, 0.1)",t.style.padding="8px",t.style.borderRadius="0",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)",t.style.maxWidth="260px",t.style.minWidth="200px",t.style.position="absolute",t.style.zIndex="9999",t.style.color="white",t.style.fontSize="12px",t.style.pointerEvents="auto",t.style.transform="translate3d(0,0,0)",e&&(t.style.borderLeft=`3px solid ${e}`),t}initPopup(){try{const e=this.createPopupElement();this.viewer.container.appendChild(e),this.popupOverlay=new mo(this.viewer,{element:e,position:null,offset:[0,-15]});const t=this.createPopupElement("#4CAF50");this.viewer.container.appendChild(t),this.startPopup=new mo(this.viewer,{element:t,position:null,offset:[0,-15]});const i=this.createPopupElement("#FF5252");this.viewer.container.appendChild(i),this.endPopup=new mo(this.viewer,{element:i,position:null,offset:[0,-15]})}catch(e){}}defaultPopupRenderer(e,t){const{latitude:i,longitude:n,altitude:s}=e.coords,a=new Date(e.timestamp).toLocaleString();let o=`\n      <div class="location-popup-content" style="font-family: Arial, sans-serif; font-size: 12px;">\n        <h3 style="margin: 0 0 6px 0; color: #62c9ff; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 4px; font-size: 14px;">位置信息</h3>\n        <p style="margin: 3px 0;"><strong>纬度:</strong> ${i.toFixed(6)}</p>\n        <p style="margin: 3px 0;"><strong>经度:</strong> ${n.toFixed(6)}</p>\n    `;if(s&&(o+=`<p style="margin: 3px 0;"><strong>海拔:</strong> ${s.toFixed(2)}米</p>`),o+=`<p style="margin: 3px 0;"><strong>时间:</strong> ${a}</p>`,o+=`<p style="margin: 3px 0;"><strong>IP:</strong> ${this.ipAddress}</p>`,t&&this.isTracking){const e=Date.now()-t.startTime;o+=`\n        <h3 style="margin: 6px 0 3px 0; color: #62c9ff; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 4px; font-size: 14px;">轨迹信息</h3>\n        <p style="margin: 3px 0;"><strong>用时:</strong> ${this.formatDuration(e)}</p>\n        <p style="margin: 3px 0;"><strong>距离:</strong> ${t.distance.toFixed(2)}米</p>\n      `}return o+="</div>",o}formatDuration(e){const t=Math.floor(e/1e3),i=Math.floor(t/60);return`${Math.floor(i/60).toString().padStart(2,"0")}:${(i%60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`}calculateDistance(e,t){return Cesium.Cartesian3.distance(e,t)}showPopup(e,t){var i,n;if(this.popupOverlay)try{const s=(null==(n=null==(i=this.options.popup)?void 0:i.contentRenderer)?void 0:n.call(i,e,this.isTracking?this.trackRecord:void 0))||this.defaultPopupRenderer(e,this.isTracking?this.trackRecord:void 0),a=Cesium.Cartographic.fromCartesian(t),o=Cesium.Math.toDegrees(a.longitude),r=Cesium.Math.toDegrees(a.latitude),l=a.height+10;if(this.popupOverlay.element&&(this.popupOverlay.element.style.display="block",this.popupOverlay.element.style.visibility="visible"),this.popupOverlay.setContent)this.popupOverlay.setContent(s);else if(this.popupOverlay.element){this.popupOverlay.element.innerHTML=s;const e=document.createElement("div");e.style.position="absolute",e.style.bottom="-8px",e.style.left="50%",e.style.marginLeft="-8px",e.style.width="0",e.style.height="0",e.style.borderLeft="8px solid transparent",e.style.borderRight="8px solid transparent",e.style.borderTop="8px solid white",e.style.zIndex="10000",this.popupOverlay.element.appendChild(e)}this.popupOverlay.position=[o,r,l],setTimeout((()=>{if(this.popupOverlay&&this.popupOverlay.element){this.popupOverlay.element}}),500)}catch(s){}}hidePopup(){if(this.popupOverlay)try{this.popupOverlay.position=null}catch(e){}}handlePositionUpdate(e){var t,i;const{latitude:n,longitude:s,altitude:a}=e.coords,o=Cesium.Cartesian3.fromDegrees(s,n,a||0);this.updateCurrentPositionEntity(o,e),this.isTracking&&(this.updateTrack(o,e),1===this.trackRecord.positions.length&&this.showStartPopup(e,o)),this.flyToPosition(o),this.showPopup(e,o),null==(i=(t=this.options).onPositionUpdate)||i.call(t,e,o)}updateCurrentPositionEntity(e,t){this.currentPositionEntity?this.currentPositionEntity.position=new Cesium.ConstantPositionProperty(e):this.currentPositionEntity=this.viewer.entities.add({position:e,point:{pixelSize:10,color:Cesium.Color.RED,outlineColor:Cesium.Color.WHITE,outlineWidth:2,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}})}updateTrack(e,t){if(this.trackRecord.positions.push(e),this.trackRecord.geolocations.push(t),this.trackRecord.positions.length>1){const t=this.trackRecord.positions[this.trackRecord.positions.length-2],i=this.calculateDistance(t,e);this.trackRecord.distance+=i}this.updateTrackEntity();const i=Date.now();this.trackRecord.endTime=i,this.trackRecord.duration=i-this.trackRecord.startTime}updateTrackEntity(){var e,t;this.trackRecord.positions.length<2||this.trackEntity||(this.trackEntity=this.viewer.entities.add({polyline:{positions:new Cesium.CallbackProperty((()=>this.trackRecord.positions),!1),width:(null==(e=this.options.trackLineStyle)?void 0:e.width)||3,material:(null==(t=this.options.trackLineStyle)?void 0:t.material)||Cesium.Color.BLUE.withAlpha(.7)}}))}flyToPosition(e){const t=Cesium.Cartographic.fromCartesian(e),i=Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,t.height+500);this.viewer.camera.flyTo({destination:i,orientation:{heading:0,pitch:-Cesium.Math.PI_OVER_TWO,roll:0},duration:2})}locateCurrent(){return new Promise(((e,t)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((t=>{this.handlePositionUpdate(t),e(t)}),(e=>{t(e)}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):t(new Error("Geolocation is not supported by this browser"))}))}startTracking(){var e,t;this.isTracking||(this.isTracking=!0,this.trackStartTime=Date.now(),this.trackRecord={startTime:this.trackStartTime,endTime:this.trackStartTime,duration:0,distance:0,positions:[],geolocations:[]},this.popupOverlay&&this.popupOverlay.element?this.popupOverlay.element.style.display="none":this.initPopup(),navigator.geolocation&&(this.watchId=navigator.geolocation.watchPosition((e=>{this.handlePositionUpdate(e)}),(e=>{}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}),this.updateTimerId=window.setInterval((()=>{if(this.trackRecord.geolocations.length>0){const e=this.trackRecord.geolocations[this.trackRecord.geolocations.length-1],t=this.trackRecord.positions[this.trackRecord.positions.length-1];this.showPopup(e,t)}}),1e3)),null==(t=(e=this.options).onTrackStart)||t.call(e))}stopTracking(){var e,t;if(!this.isTracking)return this.trackRecord;if(this.isTracking=!1,null!==this.watchId&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),null!==this.updateTimerId&&(window.clearInterval(this.updateTimerId),this.updateTimerId=null),this.trackRecord.endTime=Date.now(),this.trackRecord.duration=this.trackRecord.endTime-this.trackRecord.startTime,this.trackRecord.positions.length>0){const e=this.trackRecord.geolocations[this.trackRecord.geolocations.length-1],t=this.trackRecord.positions[this.trackRecord.positions.length-1];if(this.popupOverlay&&this.popupOverlay.element&&(this.popupOverlay.position=null,this.popupOverlay.element.style.display="none"),this.startPopup&&this.startPopup.element&&this.trackRecord.positions.length>0){this.startPopup.element.style.display="block",this.startPopup.element.style.visibility="visible";const e=this.trackRecord.geolocations[0],t=this.trackRecord.positions[0];this.showStartPopup(e,t)}this.showEndPopup(e,t)}return null==(t=(e=this.options).onTrackEnd)||t.call(e,this.trackRecord),this.trackRecord}clearTrack(){var e,t;if(this.trackEntity){try{this.viewer.entities.remove(this.trackEntity)}catch(i){}this.trackEntity=null}if(this.startPositionEntity){try{this.viewer.entities.remove(this.startPositionEntity)}catch(i){}this.startPositionEntity=null}if(this.endPositionEntity){try{this.viewer.entities.remove(this.endPositionEntity)}catch(i){}this.endPositionEntity=null}if(this.currentPositionEntity){try{this.viewer.entities.remove(this.currentPositionEntity)}catch(i){}this.currentPositionEntity=null}try{let i=0;const n=[];for(let s=0;s<this.viewer.entities.values.length;s++){const i=this.viewer.entities.values[s];i&&i.point&&i.point.color&&((null==(e=i.point.color.getValue())?void 0:e.equals(Cesium.Color.RED))||(null==(t=i.point.color.getValue())?void 0:t.equals(Cesium.Color.GREEN)))&&n.push(i)}for(const e of n)this.viewer.entities.remove(e),i++}catch(i){}this.hidePopup(),this.popupOverlay&&this.popupOverlay.element&&(this.popupOverlay.position=null,this.popupOverlay.element.style.display="none"),this.startPopup&&this.startPopup.element&&(this.startPopup.position=null,this.startPopup.element.style.display="none"),this.endPopup&&this.endPopup.element&&(this.endPopup.position=null,this.endPopup.element.style.display="none"),this.trackRecord={startTime:0,endTime:0,duration:0,distance:0,positions:[],geolocations:[]}}destroy(){this.isTracking&&this.stopTracking(),this.currentPositionEntity&&(this.viewer.entities.remove(this.currentPositionEntity),this.currentPositionEntity=null),this.trackEntity&&(this.viewer.entities.remove(this.trackEntity),this.trackEntity=null),this.startPositionEntity&&(this.viewer.entities.remove(this.startPositionEntity),this.startPositionEntity=null),this.endPositionEntity&&(this.viewer.entities.remove(this.endPositionEntity),this.endPositionEntity=null),this.popupOverlay&&(this.hidePopup(),this.popupOverlay.destroy(),this.popupOverlay=null),this.startPopup&&(this.startPopup.destroy(),this.startPopup=null),this.endPopup&&(this.endPopup.destroy(),this.endPopup=null),null!==this.updateTimerId&&(window.clearInterval(this.updateTimerId),this.updateTimerId=null)}showStartPopup(e,t){if(this.startPopup)try{const i=Cesium.Cartographic.fromCartesian(t),n=Cesium.Math.toDegrees(i.longitude),s=Cesium.Math.toDegrees(i.latitude),a=i.height+10;this.startPopup.element&&(this.startPopup.element.style.display="block",this.startPopup.element.style.visibility="visible");const o=`\n\t\t\t\t<div class="location-popup-content" style="font-family: Arial, sans-serif; font-size: 12px;">\n\t\t\t\t\t<h3 style="margin: 0 0 6px 0; color: #4CAF50; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 4px; font-size: 14px;">起点</h3>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>纬度:</strong> ${s.toFixed(6)}</p>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>经度:</strong> ${n.toFixed(6)}</p>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>开始时间:</strong> ${new Date(e.timestamp).toLocaleString()}</p>\n\t\t\t\t</div>\n\t\t\t`;this.startPopup.setContent?this.startPopup.setContent(o):this.startPopup.element&&(this.startPopup.element.innerHTML=o),this.startPopup.position=[n,s,a],this.startPositionEntity=this.viewer.entities.add({position:t,point:{pixelSize:12,color:Cesium.Color.GREEN,outlineColor:Cesium.Color.WHITE,outlineWidth:2,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}})}catch(i){}}showEndPopup(e,t){if(this.endPopup)try{const i=Cesium.Cartographic.fromCartesian(t),n=Cesium.Math.toDegrees(i.longitude),s=Cesium.Math.toDegrees(i.latitude),a=i.height+10;this.endPopup.element&&(this.endPopup.element.style.display="block",this.endPopup.element.style.visibility="visible");const o=this.trackRecord.distance.toFixed(2),r=this.formatDuration(this.trackRecord.duration),l=`\n\t\t\t\t<div class="location-popup-content" style="font-family: Arial, sans-serif; font-size: 12px;">\n\t\t\t\t\t<h3 style="margin: 0 0 6px 0; color: #FF5252; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 4px; font-size: 14px;">终点</h3>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>纬度:</strong> ${s.toFixed(6)}</p>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>经度:</strong> ${n.toFixed(6)}</p>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>结束时间:</strong> ${new Date(e.timestamp).toLocaleString()}</p>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>总用时:</strong> ${r}</p>\n\t\t\t\t\t<p style="margin: 3px 0;"><strong>移动距离:</strong> ${o}米</p>\n\t\t\t\t</div>\n\t\t\t`;this.endPopup.setContent?this.endPopup.setContent(l):this.endPopup.element&&(this.endPopup.element.innerHTML=l),this.endPopup.position=[n,s,a],this.endPositionEntity=this.viewer.entities.add({position:t,point:{pixelSize:12,color:Cesium.Color.RED,outlineColor:Cesium.Color.WHITE,outlineWidth:2,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}})}catch(i){}}}const Po={class:"toolbar-container"},Lo={class:"toolbar"},ko={key:0,class:"submenu"},Mo={key:0,class:"submenu"},Io={key:0,class:"submenu"},Do={key:0,class:"submenu help-panel"},Oo={class:"submenu-title"},Ro={key:0,class:"help-content"},No={key:1,class:"help-content"},Bo={class:"toolbar-item disabled",title:"更多功能开发中"},Uo=o({__name:"ToolBar",props:{viewer:{type:Object,required:!0}},emits:["toolChanged","disableContextMenu","enableContextMenu"],setup(e,{emit:t}){let i=null;const s=e,a=t,o=n(null),l=n("distance"),g=n(null),f=n(!1),C=n(!1),_=n(!1);let S=null,A=null,E=null,x=null,T=null,P=null,L=null;const I=n(!1),D=()=>{I.value=bt()};r((()=>{D(),window.addEventListener("resize",D)})),k((()=>{window.removeEventListener("resize",D)}));const O=()=>{a("disableContextMenu"),document.oncontextmenu&&!i&&(i=document.oncontextmenu),document.oncontextmenu=e=>(e.preventDefault(),e.stopPropagation(),!1)},R=()=>{a("enableContextMenu"),document.oncontextmenu=i||null},N=e=>{if(o.value===e)return q(),o.value=null,void a("toolChanged",null);if(q(),o.value=e,"measure"===e){if(s.viewer&&s.viewer.scene&&s.viewer.scene.canvas&&!s.viewer.entities)return}else if("draw"===e);else if("location"===e&&s.viewer&&s.viewer.scene&&s.viewer.scene.canvas){if(!s.viewer.entities)return;j()}a("toolChanged",e)},B=e=>{if(l.value===e){if(_.value)return}else F();l.value=e,setTimeout((()=>{V()}),0)},U=e=>{g.value===e&&C.value||(W(),g.value=e,C.value=!0,z())},V=()=>{if(s.viewer){F(),O(),_.value=!0;try{if(!(S||A||E||x||Z()))throw new Error("初始化测量工具失败");let e=!1;switch(l.value){case"distance":if(!S&&!Z())throw new Error("初始化距离测量工具失败");if(T=S,S&&!S.start()&&(!Z(!0)||!S||!S.start()))throw new Error("无法启动距离测量工具");e=!0;break;case"distanceSurface":if(!A&&!Z())throw new Error("初始化贴地距离测量工具失败");if(T=A,A&&!A.start()&&(!Z(!0)||!A||!A.start()))throw new Error("无法启动贴地距离测量工具");e=!0;break;case"area":if(!E&&!Z())throw new Error("初始化面积测量工具失败");if(T=E,E&&!E.start()&&(!Z(!0)||!E||!E.start()))throw new Error("无法启动面积测量工具");e=!0;break;case"areaSurface":if(!x&&!Z())throw new Error("初始化贴地面积测量工具失败");if(T=x,x&&!x.start()&&(!Z(!0)||!x||!x.start()))throw new Error("无法启动贴地面积测量工具");e=!0;break;default:throw new Error(`未知的测量类型: ${l.value}`)}}catch(e){_.value=!1,T=null,R()}}},z=()=>{if(s.viewer){O();try{if(!s.viewer.scene)return;if(!s.viewer.entities||"function"!=typeof s.viewer.entities.add)return;if(!P)return;try{if(g.value){const e=g.value;P.startDrawing(po[e])}}catch(e){C.value=!1,g.value=null}}catch(t){o.value=null,C.value=!1,g.value=null}}},F=()=>{if(T){try{T.stop()}catch(e){}_.value=!1,T=null,R()}},W=()=>{if(P)try{P.stopDrawing(),C.value=!1}catch(e){}"draw"!==o.value&&R()},G=()=>{if(F(),S){try{S.destroy()}catch(e){}S=null}if(A){try{A.destroy()}catch(e){}A=null}if(E){try{E.destroy()}catch(e){}E=null}if(x){try{x.destroy()}catch(e){}x=null}_.value=!1,document.body&&(document.body.style.cursor="auto"),s.viewer&&s.viewer.container&&(s.viewer.container.style.cursor="default"),setTimeout((()=>{const e=document.getElementById("measuring-cursor-style");e&&e.remove(),document.body&&(document.body.style.cursor="auto"),s.viewer&&s.viewer.container&&(s.viewer.container.style.cursor="default")}),100)},Y=()=>{if(P)try{P.stopDrawing(),P.clear(),C.value=!1,g.value=null}catch(e){}},j=()=>{if(s.viewer)try{if(!L){const e={onPositionUpdate:(e,t)=>{},onTrackStart:()=>{f.value=!0},onTrackEnd:e=>{f.value=!1}};L=new To(s.viewer,e)}}catch(e){}},$=async()=>{if(L)try{await L.locateCurrent()}catch(e){}},X=()=>{if(L&&!f.value)try{L.startTracking()}catch(e){}},Q=()=>{if(L&&f.value)try{L.stopTracking()}catch(e){}},K=()=>{if(L)try{if(f.value)try{L.stopTracking(),f.value=!1}catch(e){}L.clearTrack(),setTimeout((()=>{f.value&&(f.value=!1)}),100)}catch(e){}},q=()=>{"measure"===o.value?(F(),_.value=!1):"draw"===o.value?(W(),g.value=null,C.value=!1):"location"===o.value&&f.value&&L&&L.stopTracking(),R()},J=()=>{try{const e=s.viewer.canvas;Ee(e).then((e=>{let t=e.toDataURL("image/png");const i=document.createElement("a");i.href=t,i.download="Cesium截屏",i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}))}catch(e){}};k((()=>{q(),S&&(S.destroy(),S=null),A&&(A.destroy(),A=null),E&&(E.destroy(),E=null),x&&(x.destroy(),x=null),P&&(P.destroy(),P=null),L&&(L.destroy(),L=null),R()}));const Z=(e=!1)=>{if(e){if(S){try{S.destroy()}catch(n){}S=null}if(A){try{A.destroy()}catch(n){}A=null}if(E){try{E.destroy()}catch(n){}E=null}if(x){try{x.destroy()}catch(n){}x=null}}if(!s.viewer)return!1;if(!s.viewer.scene||!s.viewer.scene.canvas)return!1;const t={labelStyle:{font:"bold 16px Arial",fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK,outlineWidth:2,style:Cesium.LabelStyle.FILL_AND_OUTLINE,showBackground:!0,backgroundColor:new Cesium.Color(.165,.165,.165,.8)},pointStyle:{color:Cesium.Color.RED,outlineColor:Cesium.Color.WHITE,outlineWidth:2,pixelSize:8},lineStyle:{width:3,material:Cesium.Color.YELLOW.withAlpha(.8)},polygonStyle:{material:Cesium.Color.YELLOW.withAlpha(.3),outline:!0,outlineColor:Cesium.Color.YELLOW},onComplete:(e,t)=>{_.value=!1}};let i=!0;if(!S)try{S=new So(s.viewer,{...t,onComplete:(e,t)=>{_.value=!1}})}catch(n){i=!1}if(!A)try{A=new Ao(s.viewer,{...t,onComplete:(e,t)=>{_.value=!1}})}catch(n){i=!1}if(!E)try{E=new Eo(s.viewer,{...t,onComplete:(e,t)=>{_.value=!1}})}catch(n){i=!1}if(!x)try{x=new xo(s.viewer,{...t,onComplete:(e,t)=>{_.value=!1}})}catch(n){i=!1}return i};return r((()=>{if(s.viewer){Z();const e={lineStyle:{width:3,material:Cesium.Color.YELLOW.withAlpha(.8)},pointStyle:{pixelSize:8,color:Cesium.Color.RED,outlineColor:Cesium.Color.WHITE,outlineWidth:2},polygonStyle:{material:Cesium.Color.CYAN.withAlpha(.5),outline:!0,outlineColor:Cesium.Color.CYAN,outlineWidth:2},onComplete:(e,t)=>{C.value=!1,g.value=null,"draw"===o.value&&R()}};P=new go(s.viewer,e)}})),(e,t)=>{const i=H;return u(),c("div",Po,[d("div",Lo,[d("div",{class:p(["toolbar-item",{active:"measure"===o.value}]),onClick:t[4]||(t[4]=e=>N("measure")),title:"测量工具"},[m(i,null,{default:v((()=>[m(b(ie))])),_:1}),t[21]||(t[21]=d("span",{class:"toolbar-tooltip"},"测量",-1)),"measure"===o.value?(u(),c("div",ko,[t[19]||(t[19]=d("div",{class:"submenu-title"},"测量类型",-1)),d("div",{class:p(["submenu-item",{active:"distance"===l.value&&_.value}]),onClick:t[0]||(t[0]=y((e=>B("distance")),["stop"]))},[m(i,null,{default:v((()=>[m(b(te))])),_:1}),t[14]||(t[14]=d("span",null,"距离测量",-1))],2),d("div",{class:p(["submenu-item",{active:"distanceSurface"===l.value&&_.value}]),onClick:t[1]||(t[1]=y((e=>B("distanceSurface")),["stop"]))},[m(i,null,{default:v((()=>[m(b(ne))])),_:1}),t[15]||(t[15]=d("span",null,"贴地距离测量",-1))],2),d("div",{class:p(["submenu-item",{active:"area"===l.value&&_.value}]),onClick:t[2]||(t[2]=y((e=>B("area")),["stop"]))},[m(i,null,{default:v((()=>[m(b(se))])),_:1}),t[16]||(t[16]=d("span",null,"面积测量",-1))],2),d("div",{class:p(["submenu-item",{active:"areaSurface"===l.value&&_.value}]),onClick:t[3]||(t[3]=y((e=>B("areaSurface")),["stop"]))},[m(i,null,{default:v((()=>[m(b(ae))])),_:1}),t[17]||(t[17]=d("span",null,"贴地面积测量",-1))],2),t[20]||(t[20]=d("div",{class:"submenu-divider"},null,-1)),d("div",{class:"submenu-item clear-item",onClick:y(G,["stop"])},[m(i,null,{default:v((()=>[m(b(oe))])),_:1}),t[18]||(t[18]=d("span",null,"清除测量",-1))])])):h("",!0)],2),d("div",{class:p(["toolbar-item",{active:"draw"===o.value}]),onClick:t[11]||(t[11]=e=>N("draw")),title:"绘制工具"},[m(i,null,{default:v((()=>[m(b(re))])),_:1}),t[31]||(t[31]=d("span",{class:"toolbar-tooltip"},"绘制",-1)),"draw"===o.value?(u(),c("div",Mo,[t[29]||(t[29]=d("div",{class:"submenu-title"},"绘制类型",-1)),d("div",{class:p(["submenu-item",{active:"POINT"===g.value&&C.value}]),onClick:t[5]||(t[5]=y((e=>U("POINT")),["stop"]))},[m(i,null,{default:v((()=>[m(b(le))])),_:1}),t[22]||(t[22]=d("span",null,"点",-1))],2),d("div",{class:p(["submenu-item",{active:"POLYLINE"===g.value&&C.value}]),onClick:t[6]||(t[6]=y((e=>U("POLYLINE")),["stop"]))},[m(i,null,{default:v((()=>[m(b(te))])),_:1}),t[23]||(t[23]=d("span",null,"线",-1))],2),d("div",{class:p(["submenu-item",{active:"POLYGON"===g.value&&C.value}]),onClick:t[7]||(t[7]=y((e=>U("POLYGON")),["stop"]))},[m(i,null,{default:v((()=>[m(b(se))])),_:1}),t[24]||(t[24]=d("span",null,"多边形",-1))],2),d("div",{class:p(["submenu-item",{active:"RECTANGLE"===g.value&&C.value}]),onClick:t[8]||(t[8]=y((e=>U("RECTANGLE")),["stop"]))},[m(i,null,{default:v((()=>[m(b(ce))])),_:1}),t[25]||(t[25]=d("span",null,"矩形",-1))],2),d("div",{class:p(["submenu-item",{active:"CIRCLE"===g.value&&C.value}]),onClick:t[9]||(t[9]=y((e=>U("CIRCLE")),["stop"]))},[m(i,null,{default:v((()=>[m(b(ue))])),_:1}),t[26]||(t[26]=d("span",null,"圆",-1))],2),d("div",{class:p(["submenu-item",{active:"TEXT_POPUP"===g.value&&C.value}]),onClick:t[10]||(t[10]=y((e=>U("TEXT_POPUP")),["stop"]))},[m(i,null,{default:v((()=>[m(b(de))])),_:1}),t[27]||(t[27]=d("span",null,"文本标注",-1))],2),t[30]||(t[30]=d("div",{class:"submenu-divider"},null,-1)),d("div",{class:"submenu-item clear-item",onClick:y(Y,["stop"])},[m(i,null,{default:v((()=>[m(b(oe))])),_:1}),t[28]||(t[28]=d("span",null,"清除绘制",-1))])])):h("",!0)],2),d("div",{class:p(["toolbar-item",{active:"location"===o.value}]),onClick:t[12]||(t[12]=e=>N("location")),title:"定位工具"},[m(i,null,{default:v((()=>[m(b(he))])),_:1}),t[38]||(t[38]=d("span",{class:"toolbar-tooltip"},"定位",-1)),"location"===o.value?(u(),c("div",Io,[t[36]||(t[36]=d("div",{class:"submenu-title"},"定位功能",-1)),d("div",{class:"submenu-item",onClick:y($,["stop"])},[m(i,null,{default:v((()=>[m(b(me))])),_:1}),t[32]||(t[32]=d("span",null,"定位当前位置",-1))]),d("div",{class:p(["submenu-item",{active:f.value,disabled:f.value}]),onClick:y(X,["stop"])},[m(i,null,{default:v((()=>[m(b(pe))])),_:1}),t[33]||(t[33]=d("span",null,"开始位置追踪",-1))],2),d("div",{class:p(["submenu-item",{disabled:!f.value}]),onClick:y(Q,["stop"])},[m(i,null,{default:v((()=>[m(b(ge))])),_:1}),t[34]||(t[34]=d("span",null,"结束位置追踪",-1))],2),t[37]||(t[37]=d("div",{class:"submenu-divider"},null,-1)),d("div",{class:"submenu-item clear-item",onClick:y(K,["stop"])},[m(i,null,{default:v((()=>[m(b(oe))])),_:1}),t[35]||(t[35]=d("span",null,"清除路线",-1))])])):h("",!0)],2),d("div",{class:"toolbar-item",onClick:J,title:"截屏"},[m(i,null,{default:v((()=>[m(b(ve))])),_:1}),t[39]||(t[39]=d("span",{class:"toolbar-tooltip"},"截屏",-1))]),d("div",{class:p(["toolbar-item",{active:"help"===o.value}]),onClick:t[13]||(t[13]=e=>N("help")),title:"使用帮助"},[m(i,null,{default:v((()=>[m(b(ye))])),_:1}),t[42]||(t[42]=d("span",{class:"toolbar-tooltip"},"使用帮助",-1)),"help"===o.value?(u(),c("div",Do,[d("div",Oo,w(I.value?"移动端操作指南":"PC端操作指南"),1),I.value?(u(),c("div",Ro,t[40]||(t[40]=[M('<div><span style="color:#fff;">缩放视图：</span>双指捏合</div><div><span style="color:#fff;">倾斜视图：</span>双指同向拖动</div><div><span style="color:#fff;">旋转视图：</span>双指反向拖动</div><div style="color:rgb(255, 153, 0);margin-top:5px;"><span style="font-weight:bold;">右键菜单：</span>长按地图并保持</div>',4)]))):(u(),c("div",No,t[41]||(t[41]=[M('<div><span style="color:#fff;">平移视图：</span>左键点击 + 拖拽</div><div><span style="color:#fff;">缩放视图：</span>滚轮滚动 / 右键拖拽</div><div><span style="color:#fff;">旋转视图：</span>中键点击 + 拖拽</div><div style="color:rgb(255, 153, 0);margin-top:5px;"><span style="font-weight:bold;">右键菜单：</span>右键点击地图</div>',4)])))])):h("",!0)],2),d("div",Bo,[m(i,null,{default:v((()=>[m(b(fe))])),_:1}),t[43]||(t[43]=d("span",{class:"toolbar-tooltip"},"更多功能",-1))])])])}}}),Vo={class:"about-container"},zo={class:"about-content"},Ho={class:"about-header"},Fo={class:"about-body"},Wo={class:"feature-grid"},Go={class:"feature-image-container"},Yo=["src","alt"],jo={class:"feature-title"},$o=qi(o({__name:"About",props:{},emits:["close"],setup(e,{emit:t}){const i=t,n=()=>{i("close")};return(e,t)=>{const i=H;return u(),c("div",Vo,[d("div",{class:"about-overlay",onClick:n}),d("div",zo,[d("div",Ho,[t[0]||(t[0]=d("div",{class:"logo-container"},[d("img",{src:Pe,alt:"FlyAnti Logo",class:"logo-image"}),d("div",{class:"logo-text"},[d("h1",null,"FlyAnti")])],-1)),d("div",{class:"close-button",onClick:n},[m(i,null,{default:v((()=>[m(b(F))])),_:1})])]),d("div",Fo,[t[1]||(t[1]=M('<div class="section-header" data-v-834e39d3><h2 data-v-834e39d3>项目介绍</h2><div class="contact-icons" data-v-834e39d3><a href="https://github.com/s1acr" target="_blank" class="contact-icon" data-v-834e39d3><img src="https://cdn.jsdelivr.net/gh/s1acr/my_jsDelivr@main/bshe/fluidicon.png" alt="GitHub" class="contact-logo" data-v-834e39d3></a><a href="mailto:2845391871@qq.com" class="contact-icon" data-v-834e39d3><img src="https://cdn.jsdelivr.net/gh/s1acr/my_jsDelivr@main/bshe/favicon.ico" alt="Email" class="contact-logo" data-v-834e39d3></a></div></div><p class="about-description" data-v-834e39d3>         FlyAnti是一款基于Cesium的三维地球可视化平台，提供高精度地形、全球影像、测量、绘制等多种功能，致力于为用户提供沉浸式的地理信息体验。本项目采用Vue 3框架开发，结合最新的Web技术，打造流畅、高效的三维地球交互体验。 </p><h2 data-v-834e39d3>功能展示</h2>',3)),d("div",Wo,[(u(),c(f,null,C(8,(e=>{return d("div",{class:"feature-item",key:e},[d("div",Go,[d("img",{src:`/assets/about/show-${e}.gif`,alt:`功能展示${e}`,class:"feature-image"},null,8,Yo)]),d("div",jo,"功能"+w(e)+": "+w((t=e,["天气控制","天空盒切换","3D飞行","位置搜索","底图切换","标注绘制","场景模式切换","右键菜单"][t-1]||`功能${t}`)),1)]);var t})),64))]),t[2]||(t[2]=M('<div class="project-info" data-v-834e39d3><h2 data-v-834e39d3>技术栈 &amp; 致谢</h2><div class="tech-stack" data-v-834e39d3><p class="about-description" data-v-834e39d3>         校园的上空总能看到不断掠过的飞机，面对广袤的世界，我们每个个体就像一只只渺小的蚂蚁。但仰望天空时，总有一种想要出去看更广阔世界的冲动。只要心向蓝天，就算怎么无法飞行，爬行的蚂蚁也能长出心灵的翅膀。想飞，乘着风，去自由创想，成为fly-ant。 <br data-v-834e39d3><span style="font-size:12px;color:#aaaaaa;text-align:right;display:inline-block;width:100%;" data-v-834e39d3>—— 谨以此毕业设计，作为大学四年的纪念</span></p><a href="https://cesium.com/" target="_blank" class="tech-badge" data-v-834e39d3><img src="https://cdn.jsdelivr.net/gh/s1acr/my_jsDelivr@main/bshe/cesium-logomark-192.png" alt="Cesium" class="tech-logo" data-v-834e39d3><span data-v-834e39d3>Cesium</span></a><a href="https://vuejs.org/" target="_blank" class="tech-badge" data-v-834e39d3><img src="https://vuejs.org/images/logo.png" alt="Vue 3" class="tech-logo" data-v-834e39d3><span data-v-834e39d3>Vue 3</span></a><a href="https://www.typescriptlang.org/" target="_blank" class="tech-badge" data-v-834e39d3><img src="https://upload.wikimedia.org/wikipedia/commons/4/4c/Typescript_logo_2020.svg" alt="TypeScript" class="tech-logo" data-v-834e39d3><span data-v-834e39d3>TypeScript</span></a><a href="https://pinia.vuejs.org/" target="_blank" class="tech-badge" data-v-834e39d3><img src="https://pinia.vuejs.org/logo.svg" alt="Pinia" class="tech-logo" data-v-834e39d3><span data-v-834e39d3>Pinia</span></a><a href="https://extends.opendde.com/" target="_blank" class="tech-badge" data-v-834e39d3><img src="https://extends.opendde.com/logo.svg" alt="cesium-extend" class="tech-logo" data-v-834e39d3><span data-v-834e39d3>cesium-extend</span></a><a href="https://github.com/ElevenIjusee/CesiumContextMenu" target="_blank" class="tech-badge" data-v-834e39d3><div class="menu-icon-placeholder" data-v-834e39d3>CM</div><span data-v-834e39d3>CesiumContextMenu</span></a></div></div>',1))])])])}}}),[["__scopeId","data-v-834e39d3"]]),Xo={class:"about-button-container"},Qo=qi(o({__name:"AboutButton",setup(e){const t=n(!1),i=()=>{t.value=!t.value},s=()=>{t.value=!1};return(e,n)=>{const a=H;return u(),c(f,null,[d("div",Xo,[d("div",{class:"toolbar-item about-button",onClick:i,title:"项目介绍"},[m(a,null,{default:v((()=>[m(b(Ce))])),_:1}),n[0]||(n[0]=d("span",{class:"toolbar-tooltip"},"项目介绍",-1))])]),t.value?(u(),T($o,{key:0,onClose:s})):h("",!0)],64)}}}),[["__scopeId","data-v-82d0cc27"]]);class Ko{constructor(e,i={}){if(t(this,"menu"),t(this,"options"),t(this,"self"),t(this,"num"),t(this,"count",0),t(this,"contextTarget"),this.self=this,this.num=this.count++,this.menu=e,this.contextTarget=null,this.options=i,!(e instanceof Array))throw new Error("Parameter 1 must be of type Array");if(void 0!==i){if("object"!=typeof i)throw new Error("Parameter 2 must be of type object")}else i={};window.addEventListener("resize",(()=>{qo.getProperty(i,"close_on_resize",!0)&&this.hide()})),this.reload()}setOptions(e){if("object"!=typeof e)throw new Error("Parameter 1 must be of type object");this.options=e}changeOption(e,t){if("string"!=typeof e)throw new Error("Parameter 1 must be of type string");if(void 0===t)throw new Error("Parameter 2 must be set");this.options[e]=t}getOptions(){return this.options}reload(){if(null==document.getElementById("cm_"+this.num)){let e=document.createElement("div");e.className="cm_container",e.id="cm_"+this.num,document.body.appendChild(e)}let e=document.getElementById("cm_"+this.num);e.innerHTML="",e.appendChild(this.renderLevel(this.menu))}renderLevel(e){const t=this;let i=document.createElement("ul");return e.forEach((function(e){let n=document.createElement("li");if(n.menu=t.self,void 0===e.type){let i=document.createElement("span");i.className="cm_icon_span",""!=qo.getProperty(e,"icon","")?i.innerHTML=qo.getProperty(e,"icon",""):i.innerHTML=qo.getProperty(t.options,"default_icon","");let s=document.createElement("span");s.className="cm_text",""!=qo.getProperty(e,"text","")?s.innerHTML=qo.getProperty(e,"text",""):s.innerHTML=qo.getProperty(t.options,"default_text","item");let a=document.createElement("span");if(a.className="cm_sub_span",void 0!==e.sub&&(""!=qo.getProperty(t.options,"sub_icon","")?a.innerHTML=qo.getProperty(t.options,"sub_icon",""):a.innerHTML="&#155;"),n.appendChild(i),n.appendChild(s),n.appendChild(a),qo.getProperty(e,"enabled",!0)){if("object"==typeof e.events){let i=Object.keys(e.events);for(let s=0;s<i.length;s++){const a=i[s],o=e.events[a];"click"===a&&void 0===e.sub?n.addEventListener(a,(function(e){o(e),t.hide()})):n.addEventListener(a,e.events[a])}}void 0!==e.sub&&(n.appendChild(t.renderLevel(e.sub)),n.addEventListener("click",(function(e){e.stopPropagation(),e.preventDefault();if(this.querySelector("ul")){const e=document.querySelectorAll(".cm_container li");for(let t=0;t<e.length;t++)e[t]!==this&&e[t].classList.remove("submenu-open");return this.classList.toggle("submenu-open"),!1}})))}else n.setAttribute("disabled","")}else"cm_divider"===e.type&&(n.className="cm_divider");i.appendChild(n)})),i}display(e,t){this.contextTarget=void 0!==t?t:e.target;let i=document.getElementById("cm_"+this.num),n={x:e.clientX,y:e.clientY},s=n.x,a=n.y,o=i.offsetWidth+4,r=i.offsetHeight+4,l=window.innerWidth,c=window.innerHeight,u=parseInt(qo.getProperty(this.options,"mouse_offset",2));i.style.left=l-s<o?l-o+"px":s+u+"px",i.style.top=c-a<r?c-r+"px":a+u+"px";let d=qo.getSizes(i);l-s<d.width?i.classList.add("cm_border_right"):i.classList.remove("cm_border_right"),c-a<d.height?i.classList.add("cm_border_bottom"):i.classList.remove("cm_border_bottom"),i.classList.add("display"),qo.getProperty(this.options,"close_on_click",!0)&&window.addEventListener("click",this.documentClick.bind(this))}hide(){document.getElementById("cm_"+this.num).classList.remove("display"),window.removeEventListener("click",this.documentClick.bind(this))}documentClick(e){var t,i,n;const s=e.target,a=document.getElementById("cm_"+this.num),o=null==(t=s.closest("li"))?void 0:t.querySelector("ul"),r="LI"===(null==(n=null==(i=s.closest("ul"))?void 0:i.parentElement)?void 0:n.tagName),l=s.closest("li");a.contains(s)&&(!l||o||r)||this.hide()}}const qo={getProperty:function(e,t,i){return void 0!==e[t]?e[t]:i},getSizes:function(e){let t=e.getElementsByTagName("li"),i=0,n=0;for(let o=0;o<t.length;o++){let e=t[o];e.offsetWidth>i&&(i=e.offsetWidth),e.offsetHeight>n&&(n=e.offsetHeight)}let s=i,a=n*t.length;for(let o=0;o<t.length;o++){let e=t[o].getElementsByTagName("ul");if(void 0!==e[0]){let t=qo.getSizes(e[0]);i+t.width>s&&(s=i+t.width),n+t.height>a&&(a=n+t.height)}}return{width:s,height:a}}};class Jo{constructor(e,i){t(this,"viewer"),t(this,"rightPosition",[]),t(this,"rotateHeading",0),t(this,"rotatePitch",0),t(this,"rotateRange",0),t(this,"rotateFun"),t(this,"stages"),t(this,"curStage",null),t(this,"domID"),t(this,"Cesium"),this.viewer=e,this.domID=i,this.rotateFun=this.rotate.bind(this),this.stages=this.viewer.scene.postProcessStages,this.Cesium=window.Cesium,this.viewer.scene.postProcessStages.bloom&&(this.viewer.scene.postProcessStages.bloom.uniforms.contrast=128,this.viewer.scene.postProcessStages.bloom.uniforms.brightness=-.2,this.viewer.scene.postProcessStages.bloom.uniforms.delta=1,this.viewer.scene.postProcessStages.bloom.uniforms.sigma=3,this.viewer.scene.postProcessStages.bloom.uniforms.stepSize=5)}init(e){new this.Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas).setInputAction((t=>{if(window.isContextMenuDisabled)return;let i={clientX:t.position.x,clientY:t.position.y};e.display(i);let n=this.viewer.scene.pick(t.position);if(this.viewer.scene.pickPositionSupported&&this.Cesium.defined(n)){const e=this.viewer.scene.pickPosition(t.position);this.Cesium.defined(e)&&(this.rightPosition=this.transformCnToCc(e))}else{let e=this.viewer.camera.pickEllipsoid(t.position,this.viewer.scene.globe.ellipsoid);this.Cesium.defined(e)&&(this.rightPosition=this.transformCnToCc(e))}}),this.Cesium.ScreenSpaceEventType.RIGHT_CLICK)}getLocalPos(){const e=`经度：${this.rightPosition[0]};\n纬度：${this.rightPosition[1]};\n高度：${this.rightPosition[2].toFixed(3)}米`;alert(e)}getCameraInfo(){let e=this.transformCnToCc(this.viewer.camera.position),t=180*this.viewer.camera.heading/Math.PI,i=180*this.viewer.camera.pitch/Math.PI,n=180*this.viewer.camera.roll/Math.PI;const s=`视点位置：[${e[0].toFixed(5)}，${e[1].toFixed(5)}]  视点高度：${e[2].toFixed(3)}\n航偏角：${t.toFixed(2)}度，俯仰角：${i.toFixed(2)}度，翻滚角：${n.toFixed(2)}度`;alert(s)}moveToRightClick(){let e=this.viewer.scene.camera.heading,t=this.viewer.scene.camera.pitch,i=.1*this.Cesium.Cartesian3.distance(this.Cesium.Cartesian3.fromDegrees(...this.rightPosition),this.viewer.scene.camera.position),n=new this.Cesium.HeadingPitchRange(this.Cesium.Math.toRadians(e),t,i);const s=new this.Cesium.BoundingSphere(this.Cesium.Cartesian3.fromDegrees(...this.rightPosition),0);this.viewer.camera.flyToBoundingSphere(s,{duration:0,offset:n})}standRightClick(){let e=this.viewer.scene.camera.heading,t=-this.Cesium.Math.toRadians(5),i=new this.Cesium.HeadingPitchRange(this.Cesium.Math.toRadians(e),t,5);const n=new this.Cesium.BoundingSphere(this.Cesium.Cartesian3.fromDegrees(...this.rightPosition),0);this.viewer.camera.flyToBoundingSphere(n,{duration:0,offset:i})}printscreen(){let e=this.domID.length?document.getElementById(this.domID):this.viewer.canvas;Ee(e).then((e=>{let t=e.toDataURL("image/png");const i=document.createElement("a");i.href=t,i.download="Cesium截屏",i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}))}openSun(e){this.viewer.scene.globe.enableLighting=e;try{et().setEnableLighting(e)}catch(t){}}openSkyAtmosphere(e){this.viewer.scene.skyAtmosphere.show=e}openDepthTestAgainstTerrain(e){this.viewer.scene.globe.depthTestAgainstTerrain=e}openEarthOpt(e){e?(this.viewer.scene.globe.translucency.enabled=!0,this.viewer.scene.globe.translucency.frontFaceAlpha=.2,this.viewer.scene.globe.translucency.backFaceAlpha=.2):this.viewer.scene.globe.translucency.enabled=!1}openEarthTriangle(e){this.viewer.scene.globe._surface.tileProvider._debug.wireframe=e,this.viewer.scene.requestRender()}arroundFly(){this.rotatePitch=this.viewer.scene.camera.pitch,this.rotateRange=this.Cesium.Cartesian3.distance(this.Cesium.Cartesian3.fromDegrees(...this.rightPosition),this.viewer.scene.camera.position),this.viewer.scene.screenSpaceCameraController.enableInputs=!1,this.viewer.clock.onTick.addEventListener(this.rotateFun)}stopArround(){this.viewer.clock.onTick.removeEventListener(this.rotateFun),this.viewer.scene.screenSpaceCameraController.enableInputs=!0,this.viewer.camera.lookAtTransform(this.Cesium.Matrix4.IDENTITY)}rotate(){this.rotateHeading+=.1;const e=new this.Cesium.HeadingPitchRange(this.Cesium.Math.toRadians(this.rotateHeading),this.rotatePitch,this.rotateRange);this.viewer.camera.lookAt(this.Cesium.Cartesian3.fromDegrees(...this.rightPosition),e)}transformCnToCc(e){const t=this.Cesium.Cartographic.fromCartesian(e);return[this.Cesium.Math.toDegrees(t.longitude),this.Cesium.Math.toDegrees(t.latitude),t.height]}setPickPosition(e){this.Cesium.defined(e)&&(this.rightPosition=this.transformCnToCc(e))}openNightVision(e){e?(this.curStage&&this.stages.remove(this.curStage),this.curStage=this.stages.add(this.Cesium.PostProcessStageLibrary.createNightVisionStage())):this.stages.remove(this.curStage)}openBlackAndWhite(e){e?(this.curStage&&this.stages.remove(this.curStage),this.curStage=this.stages.add(this.Cesium.PostProcessStageLibrary.createBlackAndWhiteStage())):this.stages.remove(this.curStage)}openMosaic(e){if(e){this.curStage&&this.stages.remove(this.curStage);const e="#version 300 es\nprecision highp float;\nuniform sampler2D colorTexture;\nin vec2 v_textureCoordinates;\nout vec4 fragColor;\nconst int KERNEL_WIDTH = 16;\nvoid main(void)\n{\n    vec2 step = czm_pixelRatio / czm_viewport.zw;\n    vec2 integralPos = v_textureCoordinates - mod(v_textureCoordinates, 8.0 * step);\n    vec3 averageValue = vec3(0.0);\n    for (int i = 0; i < KERNEL_WIDTH; i++)\n    {\n        for (int j = 0; j < KERNEL_WIDTH; j++)\n        {\n            averageValue += texture(colorTexture, integralPos + step * vec2(i, j)).rgb;\n        }\n    }\n    averageValue /= float(KERNEL_WIDTH * KERNEL_WIDTH);\n    fragColor = vec4(averageValue, 1.0);\n}\n";this.curStage=this.stages.add(new this.Cesium.PostProcessStage({fragmentShader:e}))}else this.stages.remove(this.curStage)}openDepthOfField(e){e?(this.curStage&&this.stages.remove(this.curStage),this.curStage=this.stages.add(this.Cesium.PostProcessStageLibrary.createDepthOfFieldStage())):this.stages.remove(this.curStage)}openBloom(e){this.curStage&&this.stages.remove(this.curStage),this.viewer.scene.postProcessStages.bloom&&(this.viewer.scene.postProcessStages.bloom.enabled=e)}}class Zo{constructor(e,i="",n={}){t(this,"catCesium"),t(this,"handleToggleTerrain",null),t(this,"handleToggleTerrainTriangle",null),t(this,"handleToggleTerrainOpacity",null),t(this,"handleToggleAtmosphere",null),this.catCesium=new Jo(e,i),this.handleToggleTerrain=n.handleToggleTerrain||null,this.handleToggleTerrainTriangle=n.handleToggleTerrainTriangle||null,this.handleToggleTerrainOpacity=n.handleToggleTerrainOpacity||null,this.handleToggleAtmosphere=n.handleToggleAtmosphere||null,this.initMenu(e)}initMenu(e){let t=new Ko([{text:"查看此处坐标",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAWZJREFUOE+F0z9IVmEUx/GPODhLkxI0SNCeBEqIFf2HQMxEIRdBHWpocBACi4pqKCjIoUFzEkMnERchFQmCmpwE07XWpLk4cV64PL2+PnC53Oec8z2/8+c2qX9GcA1n0YZv+UzjdzWkqYg/gZe4g2fYxy+cwnmcw3Uc1OJKwBracQU/64i7j7ep6kfYq4CQ/SSzhW0AITlKmMVkAl+jEz0lYAtvsIzI9DTL+I5+NGMQJ7GHPqxVFURdl9M4l5mjkTU1H3EGuwhoJJirAv5USjoO8AmbeFQFfMZ7fMCDMGYJIfd2KrqQimIyF/G1CniHVgyn0wTuZeASonkhvxvzOF02sSuagnEsHrFgcR0+63hVAuJ7FI9xKbOVnOc5wmj2v1MuUty9yK27WqztGB7iJnYaAcK2kA5D+b6BVdzCSqN/oWZrwQa+5FRiZFOYKWuqV0LNpwPbOMztDMB/pxEgnHuzsXePmspfSh1HEUyY2wUAAAAASUVORK5CYII="/>',events:{click:()=>{this.catCesium.getLocalPos()}}},{text:"查看当前视角",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQVJREFUOE+d078uRUEQx/HPjUJE5wUkXoGEDsntREeiVdJJJIgC1VXpJOIpJKjRaCjUKoUH4AnInOyy2Rz3YKozO7/9zp8z28OHb7vFYuG3fd5gIQd6CXBUKA87AGX8oAR0Xay5oW8AUVKUXlbRUUQTDsB8AH6yPqYwiteU6K0WtwFmsY9lXGM8De0pVXlRQmrAKs4wgTmM4D4BotWwjaRpnBKwhZMkesEKHrGO8DcRCcL2cFwDdjFoAcTRDHa6ACGMLKcJEi2MFf12tpC1a9jGdDXES5zjatgQy9gSJvGOBzy3/e+8SHdpMX6zQFnztUjxmGIL/73KGVCSh1XS+pjyhT8/5099HzeJvxy+sQAAAABJRU5ErkJggg=="/>',events:{click:()=>{this.catCesium.getCameraInfo()}}},{text:"视角切换",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAMRJREFUOE+l0z1qgkEQh/GfN8g5tPACKfQGtgrGIifwAip4AO9gI9iIBIJWSRns9Bgp0trKFIK87m78mGrZmX3+s/NR86TVnnwvBZhheCu4ClihQxKcZJ4BL/jAa0a5je+ULwB1LNEopB2AA/6qMfdk0MIndpeQXA1CsWoBGKOHxdlZ6sJXBhLXI0zjUJqDAIRqzuYYPAo4oot1CTBJSEcNfvGG7X9fqL4PYB/vlzNxzy4EYIOfUhtLK9DEPjdIt+7OVdwJg18dESRWE5AAAAAASUVORK5CYII="/>',sub:[{text:"环绕此处飞行",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAARpJREFUOE+l070rhmEUBvDfu0hZDCaDLEqJEhEJo0lCklJKGGwmk4+/gEkxs7xlkIVJNoOPklgtTP4CC526n3p6PV5ezvLUfV/neq7rus8p+WeV/tDfi+usrxaCPsziHeu1EHRjDdu4wwhuf0PQgQ0MoAUvaERD3naRhTZsYQ6nGMcT2nGI+e8IWrGJhQQIybs4Q386m8DJTwqCqBMP6Y+DuYYviuNgEl1Jdp78ApdYQjPOMZYDhM37IDjGVME87GMFPVjGDQ4qcOUgCKZpjOItB4g8IoesmiruP+I+8xSJHyVkfB9Rh8gjCzVyGcJiUrUT81H0jAGYwTDqk4py8v+KZ1z9ZpBC4h5Wq+1LtV2IkY1XqFq1LFMh0ScNhy6NeddftgAAAABJRU5ErkJggg=="/>',events:{click:()=>{"环绕此处飞行"===n.innerHTML?(n.innerHTML="停止环绕",this.catCesium.arroundFly()):(n.innerHTML="环绕此处飞行",this.catCesium.stopArround())}}},{text:"移动到此处",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAN1JREFUOE+Vk+ERATEQRt9VQAk6QAWohBLoQAlK0AkqcDpQAhUw7yaZiZsk5/Znsvv222+ThnrMwvWzlNZU6hfAJdxvgDaXWwLE4mkoegFZSAlwAoSkgCtw7KuojWCuRcb6Hw/suAUOSXIOcAZU2HkSFcSZH71uOYBn8+iJAFd1D/NK1bAYgo10A/riuXnLCDBhAqjgH4AK3oLSEZSmEtcVozSCCjS2Tbfg4Q7YDwA0UCN/TCxtadQaU4hdVsmWPsCtp67Lrz1lu2usoWHdzGNeop6kI4z6TLHR4Hf+AmxvMFFs2Zg+AAAAAElFTkSuQmCC" />',events:{click:()=>{this.catCesium.moveToRightClick()}}},{text:"第一视角站到此处",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAANFJREFUOE+lkz0SAUEQhb8NpYQSHMAl5AJVBCQ4hBJKXQIJgZ9U6A4cAImQxAGoVq1qdmxP7ZSOpnrf+/btq9mEPycJ+OvATJ8PgVOWNgS4A0U1PYBSDKACXDxDFbj6kFCCOdBXwwIYxCT4ast6uFldWQkmjuGlZ9G6+886CyDfejbeWPO7sRJIgVKkO1KgwFNjAZZA19OugF5eQBtYe+IOsMkLEN0ImKphCwj0Z0L3oAXs1DF2YLk6EJH8C0dVN4BDbIICsFdTE3jGAqzLl9q/AfG7GxGuIQRzAAAAAElFTkSuQmCC"/>',events:{click:()=>{this.catCesium.standRightClick()}}}]},{text:"地形服务",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAR9JREFUOE+l07ErRlEcxvHPayADSjGJxS6LshkMdoMMRinZsFGvpCT+AmUWpYySDEqZpDBRIoNSBgai6NS5b6fbfXtf/Op2zz3nPN/nOfecU/LPKtWh78d5tXm1ANMIgMm/Ai7whQlcF0FqJdjFPZow8xvADm7wiAfsoxe3eUi1BN94RzM68YQNzNUDGMJ4/HENUXCGAXTFVBVOUYLgHvo/4trD5DXMYwULaYo8oA+b0W0LbRjFGLajsAPPGSQPCO7teMEwDqP4CpdRtIRyEaAbJ+hJIt7F72B0isE41orX0E4THGMVBwlgHbM4its6lU+RAVriusKBSSs4BudQi1hOBhvxmQH2MBJjvSE8IWL6ztphd7L05VpHudodqvT/AJYaOhEr2SIRAAAAAElFTkSuQmCC"/>',sub:[{text:"开启地形",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAR9JREFUOE+l07ErRlEcxvHPayADSjGJxS6LshkMdoMMRinZsFGvpCT+AmUWpYySDEqZpDBRIoNSBgai6NS5b6fbfXtf/Op2zz3nPN/nOfecU/LPKtWh78d5tXm1ANMIgMm/Ai7whQlcF0FqJdjFPZow8xvADm7wiAfsoxe3eUi1BN94RzM68YQNzNUDGMJ4/HENUXCGAXTFVBVOUYLgHvo/4trD5DXMYwULaYo8oA+b0W0LbRjFGLajsAPPGSQPCO7teMEwDqP4CpdRtIRyEaAbJ+hJIt7F72B0isE41orX0E4THGMVBwlgHbM4its6lU+RAVriusKBSSs4BudQi1hOBhvxmQH2MBJjvSE8IWL6ztphd7L05VpHudodqvT/AJYaOhEr2SIRAAAAAElFTkSuQmCC" />',events:{click:()=>{"关闭地形"===s.innerHTML?(s.innerHTML="开启地形",this.handleToggleTerrain?this.handleToggleTerrain(!1):e.terrainProvider=new Cesium.EllipsoidTerrainProvider):(s.innerHTML="关闭地形",this.handleToggleTerrain?this.handleToggleTerrain(!0):e.terrainProvider=Cesium.createWorldTerrainAsync())}}},{text:"显示三角网",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAASxJREFUOE+lkw1tAkEQRt8poA4KDqiDVgFFAZWAA6iC1kHrAOoAFIADqAPqoHmXGbLscQkJk0yyOz/ffDM723CnND35z8AEGId/D/wAmzq+BngAVsATMAD+gBPwGOcdMA1bi1UCmHwA3gEZmHiMip5lJIslMEyQEkB6Vv0MfQXeAuAbSNUu4EvJwIoZMI/KBllJkYkMvVtAYIH2yUCjCdIzuHXGXQDtAiRQ3ucJIH37N0CnqshMyemnTyYj/SWAyeoiBnkNIH0CqGeAW1owwbZspdNCDvELcIj5hGUL9RDdh/MQs89E90UEchMFs7ILZpLVtbXg9SI5g4/YuhmwjWBfZR0DFfjqIumXgYGurmdVsaL6G0/subPK5T+RustSfibbspUL6fuNdVzv/R+G8lQRIdDXsQAAAABJRU5ErkJggg==" />',events:{click:()=>{"显示三角网"===a.innerHTML?(a.innerHTML="关闭三角网",this.handleToggleTerrainTriangle?this.handleToggleTerrainTriangle(!0):this.catCesium.openEarthTriangle(!0)):(a.innerHTML="显示三角网",this.handleToggleTerrainTriangle?this.handleToggleTerrainTriangle(!1):this.catCesium.openEarthTriangle(!1))}}},{text:"开启地表透明",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAItJREFUOE9jZKAQMEL1p6GZMwuJb4zEfsbAwPAcWS2yATBDzjIwMKQjKUI2fDNNDYA5lZ+BgaEOyQVqSOybDAwML5D4n2FeQPYWSEMxkgCyd0ByvFA5cHgMHgNAIT3wsUCRC5BTmxwDA4MSUiwsQ2KDxF9D+Z8HVyygJyTk1LcFSVISLdNhTUgkZXAAHOUwEcdYxdcAAAAASUVORK5CYII=" />',events:{click:()=>{"开启地表透明"===o.innerHTML?(o.innerHTML="关闭地表透明",this.handleToggleTerrainOpacity?this.handleToggleTerrainOpacity(!0):this.catCesium.openEarthOpt(!0)):(o.innerHTML="开启地表透明",this.handleToggleTerrainOpacity?this.handleToggleTerrainOpacity(!1):this.catCesium.openEarthOpt(!1))}}}]},{text:"场景设置",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAATpJREFUOE+l078rr2EYBvDPd1esZ5fFqDhZ9E0G4QyGswkTwkAMMqDIQAyHnDM5Mpr8yiDJokP5D4zKYDnq/AF6dL/1Pa/3jfIsd93PfV/Pfd3X9VR88lRK+lvwjPu4b0Q97vL1eYA6rGE0Cs8idkf8iVn8y4DyAIvowBL+YjAK99CABVwh1b2ePMAubrFTQm0MrRguAmjDb8zgFN/QF4XHOEIP1jGEm9oJJrGCOWyjF6lpMwCmAuwE41jFPH5kFC5z3H7hsYZr4vwFIwGY7ar6UYAmLON7GUBCTBueKKBwGNNle0sUtkKpxVoVuuJiOrfEZKJqdKclbsRD50Uy7uP6HRnbMVDmg7Tdr+8Y6U+oVWik5PckXWaUi3ipM+JByPhUNkGW78dDuDLlkvuakZz63yn7jSVOfpt+AT3QQxF/2bCZAAAAAElFTkSuQmCC"/>',sub:[{text:"开启深度检测",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAAAXNSR0IArs4c6QAAAM9JREFUOE/t0zFOQlEQheGPRVDY0bMBSm3cAa0BCkzsYAPCArQzxoJATU8PiY02NMaOLbgFyST3JYLx5oKUTPXefef8mZlzX01ZjXCPJj5zlloZz3fSLXF1Bu5sILfDC9wmdQQSFTtcpecI6lflgI8YZALoYrb/PQfs4yUDjLSj4+KRQzjEw57nCzdYHDpype9hkl426OD1r85LL3Ybl3jGxykuduEPxc8On3BX7NwVvqEVRxUwRpofCatsY4wCWMc7Gv8Ehv06gNOU3Al41lszvyAkHmA4KQAAAABJRU5ErkJggg==" />',events:{click:()=>{"开启深度检测"===r.innerHTML?(r.innerHTML="关闭深度检测",this.catCesium.openDepthTestAgainstTerrain(!0)):(r.innerHTML="开启深度检测",this.catCesium.openDepthTestAgainstTerrain(!1))}}},{text:"关闭大气渲染",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAQCAYAAAAS7Y8mAAAAAXNSR0IArs4c6QAAAPBJREFUOE+t1LEuREEUANCztWyjofQFGgSlSkOisZX4BolaENERLVttsoXEqhEJ2Y4QJcV+AHo+QG6yL3l5eW+tNVPOvffcO8nM1AxeK1jDAqbwhiuc4WNQaa0iOI4WVivi7zjAaRVeBbex8ctpIryEblleGbyMmyHQSOnhEve4y9eUwXvYHRLOp71gB9exWYRncIiYetTVQCcPX2B9VK1QN5nBKdHocRzwFk4STZox3YCfMJcY/gr4G2OJ4V7Aj5hPDJ8HfITtxPBmwBP4TAh30Miu2zRu+03+0yNe32zx5dWx3/8iF/+gv+IZD2hmdT+/piVBa7DUQQAAAABJRU5ErkJggg==" />',events:{click:()=>{"关闭大气渲染"===l.innerHTML?(l.innerHTML="开启大气渲染",this.handleToggleAtmosphere?this.handleToggleAtmosphere(!1):this.catCesium.openSkyAtmosphere(!1)):(l.innerHTML="关闭大气渲染",this.handleToggleAtmosphere?this.handleToggleAtmosphere(!0):this.catCesium.openSkyAtmosphere(!0))}}},{text:"开启光照效果",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAALlJREFUOE+tkw0NwjAQhb85wcGQgAOQsDmYBHAACgYOkIAEJEzK8pYrOS5dmlGWLE3au/fXa0Pl11T2UwI4GcFzjSgHsAMmaziH1Z8tRxFABS9AzO/Augek5OAIshZUKAUDcHQWboAIvoDXMpB0qegM4G7sydJHnAdQQwtcjEXNiU2qBKJVINpfgo0AvmAzgM9MLPLf2+YIPIBrvM5cBj7ENAeSr78Y4l+usWqQosWfRnnT+yo9piLYDKfsKhFJRhyXAAAAAElFTkSuQmCC" />',events:{click:()=>{"开启光照效果"===c.innerHTML?(c.innerHTML="关闭光照效果",this.catCesium.openSun(!0)):(c.innerHTML="开启光照效果",this.catCesium.openSun(!1))}}},{text:"场景截图",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAGBJREFUOE9jZEAF/6FcRjRxnFx0hWQZANNErKUgdQcYGBgcQQyQC8gxAKYXbAAyIMYLKGrwGYDNZcguBusd5gbgilaiApHoNIEeiPsZGBgciNaNJRaI0YvXC0PDABRXAgD0CxoPOCDlxQAAAABJRU5ErkJggg=="/>',events:{click:()=>{this.catCesium.printscreen()}}}]},{text:"视觉特效",icon:'<img src= "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAN1JREFUOE+t06FOwzEQx/HPNA9CMgQCHGYKFDimUBsKPzQGwxsQwoJAIRcEycQwiCUgWTZ4AzyKEMgl908aMrXSpGna633vd9drS+VoVfpbBuhhB+s5f/CKN0wxLIOWgHA6xQHG6fSCL2xiC7sY4QJPAWoAe3jANW7xmFHa+MYi9x0coZ+wcQCCHNQrnBXy7nCY+1CyXdji3jH2A3CJtSQ3d55xn0o+0EWoibUZEeAzAO84x01aonhzbGBWSJ/8OTvB4F8A1SlUFzHSrHrGpqpVjVR258qtvNK/qv6Nv4S3S2/sRinfAAAAAElFTkSuQmCC"/>',sub:[{text:"开启夜视效果",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAANxJREFUOE+l0i9Lw0EYB/DPqmX4BiwG+4IoOJjBP2UvYEXWBN+CghvMZLGYTCaDTWRgWtYiDEwWkwbBINjHjd8PDt3mHnblyn0/dzz3rYitG7TySCWWd4k2tvGUslGggUFx6Ti7CHCGk0WA9ID9KHDEeA7l6kaBOzQz4CECrGCIagZ8R4BrHPz69rd5gQ5OJ3Sm/x+whivUpxTuPAGpnl+4zQ6tYge7WJ4SfsFW+YIfLAVrXcNzCazjMQB0kebyp8o9HM+A3nGI+/LMpCHuYRMbxf5Z/P8rLvCRXzACr28hr2v0o20AAAAASUVORK5CYII=" />',events:{click:()=>{"开启夜视效果"===u.innerHTML?(u.innerHTML="关闭夜视效果",this.catCesium.openNightVision(!0)):(u.innerHTML="开启夜视效果",this.catCesium.openNightVision(!1))}}},{text:"开启黑白效果",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAN5JREFUOE+l0z9KQ0EQx/FPbhLBxiYWgp2lRzBVLJLCP6ew8Q4ai1jESo+Q0i5goRZaJKAnUTbsg83wjHm8hYVlmfn+ZnZ+29FydVrm+wswxCGOs8AMc9xHwTrAI05y4Cv2i6Qn9EtIBFTJKfAab/gJqmuQEnCGMaJKBCTeOe7SoQRMMUAP74VqHeABpxHwlcvdCSXXAb7RjYBFTtzdArDEKq5s4QYX2MPnPy3c4jIC0uwnWz7iqPLEpjFe4aPJGKuqSyO94KCJkarY5ImjvNPdc96r2W9yYuO/1fo3/gJ90S0RrD3WIQAAAABJRU5ErkJggg==" />',events:{click:()=>{"开启黑白效果"===d.innerHTML?(d.innerHTML="关闭黑白效果",this.catCesium.openBlackAndWhite(!0)):(d.innerHTML="开启黑白效果",this.catCesium.openBlackAndWhite(!1))}}},{text:"开启马赛克效果",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAKFJREFUOE/t0yEOwkAQRuGvSDQWhQAcCRdAcAI0J8FzEjRnaBUKgSLBNcFiQQJZUlHRaUUtfzLJJvP2ZbO7kyHHSpwiaI0xyfBp2ZxaiYlS9hUUf4G87x38BCesMa/VrLZufeUkuGARUNdKFEqS4IZpQByxaTtCEtyRvmVT9th1CR4YBdAWhy7BC8MAWuLcJXhjEEBJ/OwSpGksq2piW0f9C8soICZeXuC2AAAAAElFTkSuQmCC" />',events:{click:()=>{"开启马赛克效果"===h.innerHTML?(h.innerHTML="关闭马赛克效果",this.catCesium.openMosaic(!0)):(h.innerHTML="开启马赛克效果",this.catCesium.openMosaic(!1))}}},{text:"开启景深效果",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAMRJREFUOE/tkzEOgyAUhv/nkTTuegQ3uQaxe127eAz0FNDZaOgZnJ2cCU2blGoDqU07lukFHl9+/vdD+HJR6P4wDCcAh9A5Eak4jvMgYBxHaYw5A1A+SBRFMkkSegtI0/T4Cuj7PvstgDEmAWQ7/VSc83qjgDFmrbX5GlAURbMsy2WeZ73e11o3nPPcC2jb1hnmm8I0Tei6DlVVYTOFh4I1wPecsiwzIpJCCGf+vfgDnh7syUHIxI+CJIRwmQn+hT1qbj1XEyScEeXC0rwAAAAASUVORK5CYII=" />',events:{click:()=>{"开启景深效果"===m.innerHTML?(m.innerHTML="关闭景深效果",this.catCesium.openDepthOfField(!0)):(m.innerHTML="开启景深效果",this.catCesium.openDepthOfField(!1))}}},{text:"开启辉光效果",icon:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAOhJREFUOE+lk40NAUEQhd91oANKoAMl6AAVoIKjAjpAB0q4DiiBDpQgn8zIZnfnSEwyuVx25+X9zDbqr4Ek+h5da74ATO28+xVgIeki6WkDY/ve7AubmaSTA+YMGFhLAojKARg8SHJARRIcCAlD82ApqZBSAxhJ2tpQm2hH1iQ3tAbgw8eKcTsD/xw5AFRpKGLSKnD9bAb63a7GABP3AcDGTCwYpPeJCpcxL62HpeIRv89qDJDA5l0zAAzEYPYkZOAZkzc9t5toZzdojzhk4Oikka4y/0X1vYW/AdI0ivyjt5BTzN9CIeEFd78tEQqEpnoAAAAASUVORK5CYII=" />',events:{click:()=>{"开启辉光效果"===p.innerHTML?(p.innerHTML="关闭辉光效果",this.catCesium.openBloom(!0)):(p.innerHTML="开启辉光效果",this.catCesium.openBloom(!1))}}}]}],{}),i=document.getElementById("cm_0");this.catCesium.init(t);let n=i.children[0].children[2].children[3].children[0].children[1],s=i.children[0].children[3].children[3].children[0].children[1],a=i.children[0].children[3].children[3].children[1].children[1],o=i.children[0].children[3].children[3].children[2].children[1],r=i.children[0].children[4].children[3].children[0].children[1];!e.scene||!e.scene.terrainProvider||e.scene.terrainProvider instanceof Cesium.EllipsoidTerrainProvider?s.innerHTML="开启地形":s.innerHTML="关闭地形",e.scene&&e.scene.globe&&e.scene.globe._surface&&e.scene.globe._surface.tileProvider&&e.scene.globe._surface.tileProvider._debug.wireframe?a.innerHTML="关闭三角网":a.innerHTML="显示三角网";let l=i.children[0].children[4].children[3].children[1].children[1],c=i.children[0].children[4].children[3].children[2].children[1],u=i.children[0].children[5].children[3].children[0].children[1],d=i.children[0].children[5].children[3].children[1].children[1],h=i.children[0].children[5].children[3].children[2].children[1],m=i.children[0].children[5].children[3].children[3].children[1],p=i.children[0].children[5].children[3].children[4].children[1];e.scene&&e.scene.globe&&e.scene.globe.enableLighting?c.innerHTML="关闭光照效果":c.innerHTML="开启光照效果"}destroy(){}}const er=n("tencent"),tr=n(2),ir=n(!0),nr=(e,t,i)=>{if(!e)return;ir.value=!0;const n=t.isRoadNetworkLayerExists(),s=t.isTdtLabelLayerExists(),a=t.isTdtBoundaryLayerExists(),o=t.isGridLayerExists(),r=!!t.isOceanLayerExists&&t.isOceanLayerExists();try{o&&t.gridLayerRef&&t.removeGridLayer&&t.removeGridLayer()}catch(h){}const l=t=>{if(t)try{const i=e.imageryLayers.indexOf(t);-1!==i&&e.imageryLayers.remove(e.imageryLayers.get(i),!0)}catch(h){}};l(t.roadNetworkLayerRef),l(t.tdtLabelLayerRef),l(t.tdtBoundaryLayerRef),e.imageryLayers.removeAll(),t.roadNetworkLayerRef=null,t.tdtLabelLayerRef=null,t.tdtBoundaryLayerRef=null,t.gridLayerRef=null;const c=t.getUserDisabledRoadNetworkState(),u=!i||!i.showGrid,d=!t.getUserDisabledOceanState||t.getUserDisabledOceanState();t.emitRoadNetworkLayerStateChange(!1),t.emitTdtLabelLayerStateChange(!1),t.emitTdtBoundaryLayerStateChange(!1),t.emitGridLayerStateChange(!1),t.emitOceanLayerStateChange&&t.emitOceanLayerStateChange(!1);try{const i=((e,t)=>{try{switch(e){case"none":return null;case"amap":return new Ie({style:t});case"google":return new De({style:t});case"tencent":return new Me({style:t});case"tdt":return new Re({style:t});case"nasa":return new Ne({style:t});case"nasa_planetary":return new je({body:t.body,layer:t.layer});default:return new Me({style:2})}}catch(i){return new Me({style:2})}})(er.value,tr.value);if(i){const t=e.imageryLayers.addImageryProvider(i);"tencent"===er.value&&4===tr.value&&(t.brightness=2,t.contrast=1.5,t.gamma=.5,t.saturation=1.8)}o&&!u&&(t.addGridLayer(),t.emitGridLayerStateChange(!0)),s&&t.getUserShowTdtLabelLayerState()&&(t.addTdtLabelLayer(),t.emitTdtLabelLayerStateChange(!0)),a&&t.getUserShowTdtBoundaryLayerState()&&(t.addTdtBoundaryLayer(),t.emitTdtBoundaryLayerStateChange(!0)),n&&!c&&(t.addRoadNetworkLayer(),t.emitRoadNetworkLayerStateChange(!0)),r&&!d&&t.addOceanLayer&&(t.addOceanLayer(),t.emitOceanLayerStateChange&&t.emitOceanLayerStateChange(!0)),ir.value=!1}catch(m){ir.value=!1,er.value="tencent",tr.value=2}},sr=(e,t,i,n,s,a)=>{e&&(er.value=t.provider||"tencent",tr.value=t.style||2,n(e,s,a))},ar=25e6;let or=null,rr=[],lr=!1;window.addEventListener("error",(e=>!(!e.message||!e.message.includes("Cannot read properties of undefined"))&&(or&&(clearInterval(or),or=null),!0)));const cr=(e,t,i)=>{e&&e[t]&&"function"==typeof e[t].addEventListener&&(e[t].addEventListener(i),rr.push({element:e,event:t,handler:i}))},ur=()=>{try{lr=!0,or&&(clearInterval(or),or=null);try{const e=window;for(let t=1;t<2e3;t++)e.clearInterval(t)}catch(e){}}catch(t){}},dr=e=>{lr=!1;let t=!0;if(e)try{if(!e.scene)return;const i=window.Cesium;if(e.scene.mode!==i.SceneMode.SCENE3D)return;or&&(clearInterval(or),or=null);const n=()=>{if(lr)return!1;try{return e&&e.scene&&e.scene.camera}catch(t){return!1}};or=setInterval((()=>{var s;if(t&&!lr)try{if(!n())return t=!1,void(or&&(clearInterval(or),or=null));const a=(null==(s=window.Cesium)?void 0:s.viewer)||e;if(!a||!a.scene||!a.scene.camera)return t=!1,void(or&&(clearInterval(or),or=null));a.scene.mode===i.SceneMode.SCENE3D?a.scene.camera.rotate(i.Cartesian3.UNIT_Z,-.0021):(t=!1,or&&(clearInterval(or),or=null))}catch(a){t=!1,or&&(clearInterval(or),or=null)}else or&&(clearInterval(or),or=null)}),20)}catch(i){or&&(clearInterval(or),or=null)}},hr=()=>{try{or&&(clearInterval(or),or=null)}catch(e){ur()}},mr=(e,t,i,n,s,a)=>{if(!e)return;const o=window.Cesium,r=100,l=25e6;if(t===qe.SCENE2D&&e.scene){const t=e.scene.screenSpaceCameraController;t&&(t.enableTranslate=!0,t.zoomFactor=5,o&&o.CameraEventType&&(t.zoomEventTypes=[o.CameraEventType.WHEEL,o.CameraEventType.PINCH,o.CameraEventType.RIGHT_DRAG]));try{if(e.scene.canvas){new o.ScreenSpaceEventHandler(e.scene.canvas).setInputAction((t=>{if(!e||!e.scene||e.scene.mode!==o.SceneMode.SCENE2D)return;const n=o.Cartographic.fromCartesian(e.camera.position),s=n.height;s>2375e4?(e.camera.setView({destination:o.Cartesian3.fromRadians(n.longitude,n.latitude,l)}),i.setHeight(l)):s<105&&(e.camera.setView({destination:o.Cartesian3.fromRadians(n.longitude,n.latitude,r)}),i.setHeight(r))}),o.ScreenSpaceEventType.WHEEL)}}catch(g){}t&&(t.minimumZoomDistance=r,t.maximumZoomDistance=l)}const c=function(e,t,i,n,s,a){const o=window.Cesium;return function(){if(n)return;let r=t;if(e&&e.scene&&(r=e.scene.mode===o.SceneMode.SCENE2D?qe.SCENE2D:e.scene.mode===o.SceneMode.COLUMBUS_VIEW?qe.COLUMBUS_VIEW:qe.SCENE3D),r===qe.SCENE2D)return;if(r===qe.COLUMBUS_VIEW)return;const l=o.Cartographic.fromCartesian(e.camera.position),c=o.Math.toDegrees(l.longitude),u=o.Math.toDegrees(l.latitude),d=Math.round(l.height);r===qe.SCENE3D&&d>=s&&d<=a&&i.setHeight(d),i.setPosition(c,u)}}(e,t,i,n,r,l),u=function(e,t,i,n){const s=window.Cesium;return function(){if(n)return;let a=t;if(e&&e.scene&&(a=e.scene.mode===s.SceneMode.SCENE2D?qe.SCENE2D:e.scene.mode===s.SceneMode.COLUMBUS_VIEW?qe.COLUMBUS_VIEW:qe.SCENE3D),a===qe.SCENE2D)return;if(a===qe.COLUMBUS_VIEW)return;const o=s.Cartographic.fromCartesian(e.camera.position),r=Math.round(o.height),l=s.Math.toDegrees(o.longitude),c=s.Math.toDegrees(o.latitude);if(a===qe.SCENE3D){if(i.setHeight(Math.round(r)),e.camera.pitch&&i.setPitch(Math.round(s.Math.toDegrees(e.camera.pitch))),e.camera.heading){let t=s.Math.toDegrees(e.camera.heading);t=(t%360+360)%360,t=Math.round(t),0===t&&Math.abs(i.heading-360)<.5?t=360:360===t&&Math.abs(i.heading)<.5&&(t=0),i.setHeading(t)}i.setPosition(l,c)}}}(e,t,i,n);e.camera&&(cr(e.camera,"changed",c),cr(e.camera,"moveEnd",u)),t===qe.SCENE3D&&function(e,t,i){if(!e||!e.scene)return;const n=window.Cesium,s=e.scene.screenSpaceCameraController;if(!s)return;s.minimumPitch=n.Math.toRadians(-90),s.maximumPitch=n.Math.toRadians(90);try{e.camera.setView({destination:e.camera.position,orientation:{heading:e.camera.heading,pitch:n.Math.toRadians(-90),roll:e.camera.roll}}),t.setPitch(-90)}catch(g){}s.maximumZoomDistance=ar,s.zoomEventTypes=[n.CameraEventType.WHEEL,n.CameraEventType.PINCH,n.CameraEventType.RIGHT_DRAG],s.zoomFactor=.05;try{e.scene.morphComplete&&cr(e.scene,"morphComplete",(()=>{if(e&&e.scene)if(e.scene.mode!==n.SceneMode.SCENE3D&&i.value)i.value=!1,hr();else if(e.scene.mode===n.SceneMode.SCENE3D){const t=e.camera.position;n.Cartographic.fromCartesian(t).height/ar>.97&&(i.value=!0,dr(e))}}))}catch(g){}try{if(e.scene.canvas){const i=new n.ScreenSpaceEventHandler(e.scene.canvas);i.setInputAction((i=>{if(!e||!e.scene||e.scene.mode!==n.SceneMode.SCENE3D)return;const s=e.camera.position,a=n.Cartographic.fromCartesian(s).height;Math.min(a/ar,1)>.98&&i>0&&(e.camera.setView({destination:n.Cartesian3.fromRadians(n.Cartographic.fromCartesian(s).longitude,n.Cartographic.fromCartesian(s).latitude,245e5),orientation:{heading:e.camera.heading,pitch:n.Math.toRadians(-90),roll:e.camera.roll}}),t.setPitch(-90)),pr(e,t)}),n.ScreenSpaceEventType.WHEEL),i.setInputAction((i=>{if(!e||!e.scene||e.scene.mode!==n.SceneMode.SCENE3D)return;pr(e,t);const s=e.camera.position,a=n.Cartographic.fromCartesian(s).height;Math.min(a/ar,1)>.98&&(e.camera.setView({destination:e.camera.position,orientation:{heading:e.camera.heading,pitch:n.Math.toRadians(-90),roll:e.camera.roll}}),t.setPitch(-90))}),n.ScreenSpaceEventType.PINCH)}}catch(g){}}(e,i,a),t===qe.COLUMBUS_VIEW&&function(e,t){if(!e||!e.scene)return;const i=window.Cesium,n=e.scene.screenSpaceCameraController;if(!n)return;n.maximumZoomDistance=ar,n.zoomEventTypes=[i.CameraEventType.WHEEL,i.CameraEventType.PINCH,i.CameraEventType.RIGHT_DRAG],n.zoomFactor=.05,n.minimumPitch=i.Math.toRadians(-60),n.maximumPitch=i.Math.toRadians(-20);try{const n=t.longitude||106.613794,s=t.latitude||29.541216,a=t.height||2e3,o=Math.min(-20,Math.max(-60,t.pitch||-45));e.camera.setView({destination:i.Cartesian3.fromDegrees(n,s,a),orientation:{heading:0,pitch:i.Math.toRadians(o),roll:0}}),t.setPosition(n,s),t.setHeight(a),t.setPitch(o),t.setHeading(0)}catch(g){}e.scene.mode=i.SceneMode.COLUMBUS_VIEW;try{e.camera&&cr(e.camera,"changed",(()=>{if(!e||!e.camera)return;const t=i.Math.toDegrees(e.camera.pitch);if(t<-60||t>-20){const n=Math.max(-60,Math.min(-20,t));e.camera.setView({destination:e.camera.position,orientation:{heading:e.camera.heading,pitch:i.Math.toRadians(n),roll:0}})}e.scene&&e.scene.mode!==i.SceneMode.COLUMBUS_VIEW&&e.scene.morphToColumbusView(.5)}))}catch(g){}}(e,i),e&&e.beforeDestroy&&cr(e,"beforeDestroy",(()=>{hr(),rr.length>0&&(rr.forEach((({element:e,event:t,handler:i})=>{try{e&&e[t]&&"function"==typeof e[t].removeEventListener&&e[t].removeEventListener(i)}catch(g){}})),rr=[])}));let d=null,h=null,m=0,p=!1;try{e&&e.scene&&e.scene.canvas&&(d=new o.ScreenSpaceEventHandler(e.scene.canvas),d.setInputAction((()=>{p=!0,h&&(clearTimeout(h),h=null),e&&e.scene&&e.scene.mode===o.SceneMode.SCENE3D&&a.value&&hr()}),o.ScreenSpaceEventType.LEFT_DOWN),d.setInputAction((()=>{if(p&&(m=Date.now(),p=!1,h&&(clearTimeout(h),h=null),e&&e.scene&&e.scene.mode===o.SceneMode.SCENE3D)){const t=e.camera.position;o.Cartographic.fromCartesian(t).height;h=setTimeout((()=>{if(Date.now()-m>=500&&!p&&e&&e.scene&&e.scene.mode===o.SceneMode.SCENE3D){const t=e.camera.position,i=o.Cartographic.fromCartesian(t).height;or||i/ar>.97&&(a.value=!0,dr(e))}else!e||!e.scene||(e.scene.mode,o.SceneMode.SCENE3D)}),500)}}),o.ScreenSpaceEventType.LEFT_UP))}catch(g){}try{e&&e.camera&&cr(e.camera,"changed",(()=>{if(!e||!e.scene||e.scene.mode!==o.SceneMode.SCENE3D)return void(a.value&&(a.value=!1,hr()));const t=e.camera.position,i=o.Cartographic.fromCartesian(t).height/ar;i>.97&&!a.value?(a.value=!0,dr(e)):i<.95&&a.value&&(a.value=!1,hr())}))}catch(g){}try{if(e&&e.scene&&e.scene.mode===o.SceneMode.SCENE3D){const t=e.camera.position,i=o.Cartographic.fromCartesian(t).height;i/ar>.97?(a.value=!0,dr(e)):a.value=!1}else a.value=!1}catch(g){}try{e&&e.camera&&cr(e.camera,"moveEnd",(()=>{if(!e||!e.scene||e.scene.mode!==o.SceneMode.SCENE3D)return void(a.value&&(a.value=!1,hr()));const t=e.camera.position,i=o.Cartographic.fromCartesian(t).height/ar;a.value?i<.95&&(a.value=!1,hr()):i>.97&&(a.value=!0,dr(e))}))}catch(g){}try{e&&e.scene&&e.scene.morphComplete&&cr(e.scene,"morphComplete",(()=>{if(e&&e.scene)if(e.scene.mode!==o.SceneMode.SCENE3D&&a.value)a.value=!1,hr();else if(e.scene.mode===o.SceneMode.SCENE3D){const t=e.camera.position;o.Cartographic.fromCartesian(t).height/ar>.97&&(a.value=!0,dr(e))}}))}catch(g){}try{if(e.scene.canvas){const t=new o.ScreenSpaceEventHandler(e.scene.canvas);t.setInputAction((t=>{if(!e||!e.scene||e.scene.mode!==o.SceneMode.SCENE3D)return;const n=e.camera.position,s=o.Cartographic.fromCartesian(n).height;Math.min(s/ar,1)>.98&&t>0&&(e.camera.setView({destination:o.Cartesian3.fromRadians(o.Cartographic.fromCartesian(n).longitude,o.Cartographic.fromCartesian(n).latitude,245e5),orientation:{heading:e.camera.heading,pitch:o.Math.toRadians(-90),roll:e.camera.roll}}),i.setPitch(-90)),pr(e,i)}),o.ScreenSpaceEventType.WHEEL),t.setInputAction((t=>{if(!e||!e.scene||e.scene.mode!==o.SceneMode.SCENE3D)return;pr(e,i);const n=e.camera.position,s=o.Cartographic.fromCartesian(n).height;Math.min(s/ar,1)>.98&&(e.camera.setView({destination:e.camera.position,orientation:{heading:e.camera.heading,pitch:o.Math.toRadians(-90),roll:e.camera.roll}}),i.setPitch(-90))}),o.ScreenSpaceEventType.PINCH)}}catch(g){}return{onCameraChanged:c,onCameraMoveEnd:u}};const pr=(e,t)=>{if(!e)return;const i=window.Cesium,n=e.scene.mode===i.SceneMode.SCENE2D?qe.SCENE2D:e.scene.mode===i.SceneMode.COLUMBUS_VIEW?qe.COLUMBUS_VIEW:qe.SCENE3D;if(n===qe.SCENE2D)return;const s=i.Cartographic.fromCartesian(e.camera.position).height,a=i.Math.toDegrees(e.camera.pitch),o=e.scene.screenSpaceCameraController;if(o&&o.maximumZoomDistance){const r=s/o.maximumZoomDistance;if(n===qe.COLUMBUS_VIEW){const n=30*r-60;Math.abs(n-a)>1&&(e.camera.setView({destination:e.camera.position,orientation:{heading:e.camera.heading,pitch:i.Math.toRadians(n),roll:e.camera.roll}}),t.setPitch(Math.round(n)))}else{const n=.3;let s=a;if(r>n){const o=(r-n)/(1-n),l=Math.sqrt(o);s=a*(1-l)+-90*l,Math.abs(s-a)>.005&&(e.camera.setView({destination:e.camera.position,orientation:{heading:e.camera.heading,pitch:i.Math.toRadians(s),roll:e.camera.roll}}),t.setPitch(Math.round(s)))}}}},gr=n(null),vr=n([]),yr=e=>{if(!e)return!1;if(gr.value)try{if(-1!==e.imageryLayers.indexOf(gr.value))return!0}catch(t){}if(vr.value&&vr.value.length>0)for(const i of vr.value)if(i&&e.entities.contains(i))return!0;return!1},fr=e=>{if(e)try{vr.value.forEach((t=>{if(t)try{const i=t.position.getValue(Cesium.JulianDate.now());i&&(t.label.show=((e,t)=>{if(!t)return!1;const i=t.camera.position,n=Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(e,i,new Cesium.Cartesian3),new Cesium.Cartesian3);if(Cesium.Cartesian3.dot(n,t.camera.direction)>0){const i=Cesium.SceneTransforms.wgs84ToWindowCoordinates(t.scene,e);if(i){const e=t.scene.canvas;return i.x>=0&&i.x<=e.clientWidth&&i.y>=0&&i.y<=e.clientHeight}}return!1})(i,e))}catch(i){}}))}catch(t){}},Cr=e=>{if(e)try{gr.value&&wr(e),gr.value=new Cesium.ImageryLayer(new Cesium.GridImageryProvider({cells:6,color:new Cesium.Color(1,1,0,.3),glowColor:new Cesium.Color(1,1,0,.1),glowWidth:1,backgroundColor:new Cesium.Color(0,0,0,0)})),e.imageryLayers.add(gr.value),(e=>{if(e){for(let t=-180;t<=180;t+=30){const i=Cesium.Cartesian3.fromDegrees(t,0,1e5),n=e.entities.add({position:i,label:{text:`${Math.abs(t)}°${t<0?"W":"E"}`,font:"14px sans-serif",fillColor:Cesium.Color.YELLOW,outlineColor:Cesium.Color.BLACK,outlineWidth:2,style:Cesium.LabelStyle.FILL_AND_OUTLINE,showBackground:!0,backgroundColor:new Cesium.Color(0,0,0,.5),backgroundPadding:new Cesium.Cartesian2(7,5),horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.CENTER,pixelOffset:new Cesium.Cartesian2(0,0),show:!1}});vr.value.push(n)}for(let t=-75;t<=75;t+=15){const i=Cesium.Cartesian3.fromDegrees(0,t,1e5),n=e.entities.add({position:i,label:{text:`${Math.abs(t)}°${t<0?"S":"N"}`,font:"14px sans-serif",fillColor:Cesium.Color.YELLOW,outlineColor:Cesium.Color.BLACK,outlineWidth:2,style:Cesium.LabelStyle.FILL_AND_OUTLINE,showBackground:!0,backgroundColor:new Cesium.Color(0,0,0,.5),backgroundPadding:new Cesium.Cartesian2(7,5),horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.CENTER,pixelOffset:new Cesium.Cartesian2(0,0),show:!1}});vr.value.push(n)}fr(e)}})(e);const t=()=>fr(e);e.camera.changed.addEventListener(t),fr(e)}catch(t){if(e)try{wr(e)}catch(i){}}},wr=e=>{if(e)try{if(e&&e.camera)try{e.camera.changed.removeEventListener(fr);const t=()=>fr(e);e.camera.changed.removeEventListener(t)}catch(t){}if((e=>{if(!e)return;vr.value.forEach(((t,i)=>{if(t)try{t.label&&(t.label.show=!1),e.entities.contains(t)&&e.entities.remove(t)}catch(n){}})),vr.value=[],e.scene&&e.scene.requestRender()})(e),gr.value){try{gr.value.show=!1}catch(i){}try{-1!==e.imageryLayers.indexOf(gr.value)&&e.imageryLayers.remove(gr.value,!0)}catch(i){}}let n=0;for(let t=e.imageryLayers.length-1;t>=0;t--)try{const s=e.imageryLayers.get(t);if(s&&s._imageryProvider){if("GridImageryProvider"===(s._imageryProvider.constructor?s._imageryProvider.constructor.name:"Unknown")){n++;try{s.show=!1}catch(i){}try{e.imageryLayers.remove(s,!0)}catch(i){}}}}catch(i){}gr.value=null,e.scene&&e.scene.requestRender()}catch(t){gr.value=null,vr.value=[]}},br=n(null),_r="roadNetworkLayerState",Sr=e=>{if(!e)return!1;if(br.value&&e.imageryLayers&&e.imageryLayers.contains(br.value))return!0;if(!e.imageryLayers||!e.imageryLayers.length)return!1;const t=e.imageryLayers.length;for(let n=0;n<t;n++){const t=e.imageryLayers.get(n);try{if(t&&t._imageryProvider){let i="";t._imageryProvider._url?i=t._imageryProvider._url:t._imageryProvider.url?i=t._imageryProvider.url:t._imageryProvider._resource&&t._imageryProvider._resource.url?i=t._imageryProvider._resource.url:t._imageryProvider._tileUrlTemplates&&t._imageryProvider._tileUrlTemplates.length>0&&(i=t._imageryProvider._tileUrlTemplates[0]);const n=i&&(i.includes("amap")||i.includes("autonavi.com"))&&(i.includes("style=8")||i.includes("cva")),s=void 0!==t.alpha&&Math.abs(t.alpha-.8)<.1;if(n&&s&&e.imageryLayers.contains(t))return br.value=t,!0}}catch(i){}}return br.value=null,!1},Ar=(e,t)=>{if(!e)return t&&t(!1),{success:!1,reason:"NO_VIEWER"};if(Sr(e))return t&&t(!0),{success:!0,reason:"ALREADY_EXISTS"};try{const i=e.imageryLayers;if(!i)return t&&t(!1),{success:!1,reason:"FAILED_TO_ADD"};const n=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(navigator.userAgent.toLowerCase())||window.innerWidth<768?20:18,s=new ke({ellipsoid:Cesium.Ellipsoid.WGS84,numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1}),a=new Cesium.UrlTemplateImageryProvider({url:"https://webst02.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scale=1&style=8",minimumLevel:3,maximumLevel:n,tilingScheme:s}),o=i.addImageryProvider(a);return o.alpha=.8,br.value=o,Pr(!1),t&&t(!0),{success:!0,reason:"SUCCESS"}}catch(i){return t&&t(!1),{success:!1,reason:"FAILED_TO_ADD"}}},Er=(e,t)=>{if(!e||!e.imageryLayers)return br.value=null,t&&t(!1),!1;try{const n=e.imageryLayers;let s=!1;if(br.value&&n.contains(br.value))n.remove(br.value,!0),s=!0;else for(let e=n.length-1;e>=0;e--)try{const t=n.get(e);if(!t||!t._imageryProvider)continue;let i="";if(t._imageryProvider._url?i=t._imageryProvider._url:t._imageryProvider.url?i=t._imageryProvider.url:t._imageryProvider._resource&&t._imageryProvider._resource.url?i=t._imageryProvider._resource.url:t._imageryProvider._tileUrlTemplates&&t._imageryProvider._tileUrlTemplates.length>0&&(i=t._imageryProvider._tileUrlTemplates[0]),i&&(i.includes("amap")||i.includes("autonavi.com"))&&(i.includes("style=8")||i.includes("cva"))){n.remove(t,!0),s=!0;break}}catch(i){}return br.value=null,s&&Pr(!0),t&&t(!1),!0}catch(n){return br.value=null,t&&t(!1),!1}},xr=()=>br,Tr=()=>{const e=et();try{const t=localStorage.getItem(_r);if(null!==t){const i="false"===t;return e.setShowRoadNetworkLayer(!i),i}}catch(t){}return!e.showRoadNetworkLayer},Pr=e=>{et().setShowRoadNetworkLayer(!e);try{localStorage.setItem(_r,(!e).toString())}catch(t){}},Lr=n(null),kr="tdtLabelLayerState",Mr=e=>{if(!e)return!1;if(Lr.value)try{if(-1!==e.imageryLayers.indexOf(Lr.value))return!0}catch(i){}const t=e.imageryLayers.length;for(let n=0;n<t;n++){const t=e.imageryLayers.get(n);try{if(t&&t._imageryProvider){t._imageryProvider.constructor&&t._imageryProvider.constructor.name;let e="";if(t._imageryProvider._url?e=t._imageryProvider._url:t._imageryProvider.url?e=t._imageryProvider.url:t._imageryProvider._resource&&t._imageryProvider._resource.url?e=t._imageryProvider._resource.url:t._imageryProvider._tileUrlTemplates&&t._imageryProvider._tileUrlTemplates.length>0&&(e=t._imageryProvider._tileUrlTemplates[0]),e&&(e.includes("cva_w")||e.includes("cva_c")||e.includes("T=cva"))&&e.includes("tianditu"))return Lr.value=t,!0;let n="";try{if(t._imageryProvider.credit&&("string"==typeof t._imageryProvider.credit?n=t._imageryProvider.credit:t._imageryProvider.credit.text&&(n=t._imageryProvider.credit.text)),n&&n.includes("天地图")&&(n.includes("注记")||n.includes("标注")))return Lr.value=t,!0}catch(i){}}}catch(i){}}return null!==Lr.value&&x((()=>{Lr.value=null})),!1},Ir=e=>{et().setShowTdtLabelLayer(!e);try{localStorage.setItem(kr,(!e).toString())}catch(t){}},Dr=(e,t,i)=>{if(e)if(Mr(e))t&&t(!0);else try{const i="2cafc3c616f0dc8ed8d97f7c979bf556",n=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(navigator.userAgent.toLowerCase())||window.innerWidth<768?20:18,s=(qe.SCENE3D,`https://t{s}.tianditu.gov.cn/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=${i}`),a=new Cesium.UrlTemplateImageryProvider({url:s,subdomains:"01234567",tilingScheme:new Cesium.WebMercatorTilingScheme,minimumLevel:0,maximumLevel:n,credit:"天地图注记",customTags:{s:(e,t,i,n)=>Math.abs(t+i)%8},tileWidth:256,tileHeight:256,hasAlphaChannel:!0,enablePickFeatures:!1,headers:{Accept:"image/webp,image/*,*/*;q=0.8","Accept-Language":"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2","Cache-Control":"max-age=0"}}),o=e.imageryLayers.addImageryProvider(a);o.alpha=1,Lr.value=o,e.scene.requestRender(),setTimeout((()=>{Mr(e);t&&t(!0)}),100)}catch(n){Lr.value=null,t&&t(!1)}},Or=(e,t)=>{if(e){Ir(!0);try{if(!Mr(e))return Lr.value=null,void(t&&t(!1));let n=!1;if(Lr.value)try{-1!==e.imageryLayers.indexOf(Lr.value)&&(e.imageryLayers.remove(Lr.value,!0),n=!0)}catch(i){}if(!n)try{for(let t=e.imageryLayers.length-1;t>=0;t--){const s=e.imageryLayers.get(t);if(s&&s._imageryProvider){s._imageryProvider.constructor&&s._imageryProvider.constructor.name;let t="";try{s._imageryProvider._url?t=s._imageryProvider._url:s._imageryProvider.url?t=s._imageryProvider.url:s._imageryProvider._resource&&s._imageryProvider._resource.url?t=s._imageryProvider._resource.url:s._imageryProvider._tileUrlTemplates&&s._imageryProvider._tileUrlTemplates.length>0&&(t=s._imageryProvider._tileUrlTemplates[0])}catch(i){}if(t&&(t.includes("cva_w")||t.includes("cva_c")||t.includes("T=cva"))&&t.includes("tianditu")){e.imageryLayers.remove(s,!0),n=!0;break}let a="";try{if(s._imageryProvider.credit&&("string"==typeof s._imageryProvider.credit?a=s._imageryProvider.credit:s._imageryProvider.credit.text&&(a=s._imageryProvider.credit.text)),a&&a.includes("天地图")&&(a.includes("注记")||a.includes("标注"))){e.imageryLayers.remove(s,!0),n=!0;break}}catch(i){}}}}catch(i){}Lr.value=null,e.scene.requestRender(),t&&t(!1)}catch(n){Lr.value=null,t&&t(!1)}}},Rr=(e,t,i,n)=>{if(!t)return;e&&Ir(!1);const s=Mr(t);e?!e||s?e&&s&&i&&i(!0):Dr(t,i,n):Or(t,i)},Nr=n(null),Br="tdtBoundaryLayerState",Ur=e=>{if(!e)return!1;if(Nr.value)try{if(-1!==e.imageryLayers.indexOf(Nr.value))return!0}catch(i){}const t=e.imageryLayers.length;for(let n=0;n<t;n++){const t=e.imageryLayers.get(n);try{if(t&&t._imageryProvider){t._imageryProvider.constructor&&t._imageryProvider.constructor.name;let e="";if(t._imageryProvider._url?e=t._imageryProvider._url:t._imageryProvider.url?e=t._imageryProvider.url:t._imageryProvider._resource&&t._imageryProvider._resource.url?e=t._imageryProvider._resource.url:t._imageryProvider._tileUrlTemplates&&t._imageryProvider._tileUrlTemplates.length>0&&(e=t._imageryProvider._tileUrlTemplates[0]),e&&(e.includes("ibo_w")||e.includes("ibo_c")||e.includes("T=ibo"))&&e.includes("tianditu"))return Nr.value=t,!0;let n="";try{if(t._imageryProvider.credit&&("string"==typeof t._imageryProvider.credit?n=t._imageryProvider.credit:t._imageryProvider.credit.text&&(n=t._imageryProvider.credit.text)),n&&n.includes("天地图")&&(n.includes("全球境界")||n.includes("边界")))return Nr.value=t,!0}catch(i){}}}catch(i){}}return null!==Nr.value&&x((()=>{Nr.value=null})),!1},Vr=e=>{et().setShowTdtBoundaryLayer(!e);try{localStorage.setItem(Br,(!e).toString())}catch(t){}},zr=(e,t,i)=>{if(e)if(Ur(e))t&&t(!0);else try{const i="2cafc3c616f0dc8ed8d97f7c979bf556",s=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(navigator.userAgent.toLowerCase())||window.innerWidth<768?20:18,a=(qe.SCENE3D,`https://t{s}.tianditu.gov.cn/DataServer?T=ibo_w&x={x}&y={y}&l={z}&tk=${i}`),o=new Cesium.UrlTemplateImageryProvider({url:a,subdomains:"01234567",tilingScheme:new Cesium.WebMercatorTilingScheme,minimumLevel:0,maximumLevel:s,credit:"天地图全球境界",customTags:{s:(e,t,i,n)=>Math.abs(t+i)%8},tileWidth:256,tileHeight:256,hasAlphaChannel:!0,enablePickFeatures:!1}),r=e.imageryLayers.addImageryProvider(o);r.alpha=1,Nr.value=r;for(let t=0;t<e.imageryLayers.length;t++)try{const i=e.imageryLayers.get(t);if(i&&i._imageryProvider){i._imageryProvider.constructor&&i._imageryProvider.constructor.name,i._imageryProvider._url}}catch(n){}e.scene.requestRender(),setTimeout((()=>{Ur(e);t&&t(!0)}),100)}catch(s){Nr.value=null,t&&t(!1)}},Hr=(e,t)=>{if(e){Vr(!0);try{if(!Ur(e))return Nr.value=null,void(t&&t(!1));let n=!1;if(Nr.value)try{-1!==e.imageryLayers.indexOf(Nr.value)&&(e.imageryLayers.remove(Nr.value,!0),n=!0)}catch(i){}if(!n)try{for(let t=e.imageryLayers.length-1;t>=0;t--){const s=e.imageryLayers.get(t);if(s&&s._imageryProvider){s._imageryProvider.constructor&&s._imageryProvider.constructor.name;let t="";try{s._imageryProvider._url?t=s._imageryProvider._url:s._imageryProvider.url?t=s._imageryProvider.url:s._imageryProvider._resource&&s._imageryProvider._resource.url?t=s._imageryProvider._resource.url:s._imageryProvider._tileUrlTemplates&&s._imageryProvider._tileUrlTemplates.length>0&&(t=s._imageryProvider._tileUrlTemplates[0])}catch(i){}if(t&&(t.includes("ibo_w")||t.includes("ibo_c")||t.includes("T=ibo"))&&t.includes("tianditu")){e.imageryLayers.remove(s,!0),n=!0;break}let a="";try{if(s._imageryProvider.credit&&("string"==typeof s._imageryProvider.credit?a=s._imageryProvider.credit:s._imageryProvider.credit.text&&(a=s._imageryProvider.credit.text)),a&&a.includes("天地图")&&(a.includes("全球境界")||a.includes("边界"))){e.imageryLayers.remove(s,!0),n=!0;break}}catch(i){}}}}catch(i){}Nr.value=null,e.scene.requestRender(),t&&t(!1)}catch(n){Nr.value=null,t&&t(!1)}}},Fr=(e,t,i,n)=>{if(!t)return;e&&Vr(!1);const s=Ur(t);e?!e||s?e&&s&&i&&i(!0):zr(t,i,n):Hr(t,i)},Wr=n(null),Gr="oceanLayerState",Yr=e=>{if(!e)return!1;if(!e.imageryLayers||!e.imageryLayers.length)return!1;const t=e.imageryLayers.length;for(let n=0;n<t;n++){const t=e.imageryLayers.get(n);try{if(t&&t._imageryProvider){t._imageryProvider.constructor&&t._imageryProvider.constructor.name;let i="";t._imageryProvider._url?i=t._imageryProvider._url:t._imageryProvider.url?i=t._imageryProvider.url:t._imageryProvider._resource&&t._imageryProvider._resource.url?i=t._imageryProvider._resource.url:t._imageryProvider._tileUrlTemplates&&t._imageryProvider._tileUrlTemplates.length>0&&(i=t._imageryProvider._tileUrlTemplates[0]);const n=i&&(i.includes("Ocean")||i.includes("ocean"))&&i.includes("arcgis")&&i.includes("World_Ocean_Reference");let s="";t._imageryProvider.credit&&t._imageryProvider.credit.html?s=t._imageryProvider.credit.html:t._imageryProvider._credit&&t._imageryProvider._credit.html&&(s=t._imageryProvider._credit.html);const a=s&&(s.includes("Ocean")||s.includes("Esri"));if((n||a)&&!0&&e.imageryLayers.contains(t))return t!==Wr.value&&x((()=>{Wr.value=t})),!0}}catch(i){}}return Wr.value&&x((()=>{Wr.value=null})),!1},jr=e=>{et().setShowOceanLayer(!e);try{localStorage.setItem(Gr,(!e).toString())}catch(t){}},$r=(e,t)=>{if(e){jr(!0);try{if(!Yr(e))return void(t&&t(!1));if(Wr.value){const i=e.imageryLayers.indexOf(Wr.value);if(-1!==i)return e.imageryLayers.remove(e.imageryLayers.get(i),!0),Wr.value=null,void(t&&t(!1))}const n=e.imageryLayers.length;for(let s=0;s<n;s++){const n=e.imageryLayers.get(s);try{if(n&&n._imageryProvider){let i="";if(n._imageryProvider._url?i=n._imageryProvider._url:n._imageryProvider.url?i=n._imageryProvider.url:n._imageryProvider._resource&&n._imageryProvider._resource.url?i=n._imageryProvider._resource.url:n._imageryProvider._tileUrlTemplates&&n._imageryProvider._tileUrlTemplates.length>0&&(i=n._imageryProvider._tileUrlTemplates[0]),i&&(i.includes("Ocean")||i.includes("ocean"))&&i.includes("arcgis")&&i.includes("World_Ocean_Reference"))return e.imageryLayers.remove(n,!0),Wr.value=null,void(t&&t(!1))}}catch(i){}}Wr.value=null,t&&t(!1)}catch(n){t&&t(!1)}}},Xr=(e,t,i)=>{if(e)if(Yr(e))t&&t(!0);else try{const i=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(navigator.userAgent.toLowerCase())||window.innerWidth<768?18:16,n=(qe.SCENE3D,new Cesium.UrlTemplateImageryProvider({url:"https://services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}",enablePickFeatures:!1,maximumLevel:i,credit:"Esri World Ocean Reference"})),s=e.imageryLayers.addImageryProvider(n,1);s.alpha=1,Wr.value=s,e.scene.requestRender(),setTimeout((()=>{Yr(e);t&&t(!0)}),100)}catch(n){Wr.value=null,t&&t(!1)}},Qr=e=>{jr(!e)},Kr=()=>!(()=>{const e=et();try{const t=localStorage.getItem(Gr);if(null!==t){const i="false"===t;return e.setShowOceanLayer(!i),i}}catch(t){}return!e.showOceanLayer})(),qr=n(!1),Jr=e=>{try{return!!(e&&e.scene&&e.scene.globe&&e.scene.globe._surface&&e.scene.globe._surface.tileProvider)&&!0===e.scene.globe._surface.tileProvider._debug.wireframe}catch(t){return!1}},Zr=(e,t,i)=>t?((e,t)=>{try{return e&&e.scene&&e.scene.globe&&e.scene.globe._surface&&e.scene.globe._surface.tileProvider?(e.scene.globe._surface.tileProvider._debug.wireframe=!0,e.scene.requestRender(),qr.value=!0,t&&t(!0),!0):(t&&t(!1),!1)}catch(i){return t&&t(!1),!1}})(e,i):((e,t)=>{try{return e&&e.scene&&e.scene.globe&&e.scene.globe._surface&&e.scene.globe._surface.tileProvider?(e.scene.globe._surface.tileProvider._debug.wireframe=!1,e.scene.requestRender(),qr.value=!1,t&&t(!1),!0):(t&&t(!1),!1)}catch(i){return t&&t(!1),!1}})(e,i),el=n(null),tl="cloudLayerVisible",il=1e5,nl=4e4;let sl=null;const al=e=>{if(!e)return!1;if(el.value){if(e.entities&&e.entities.contains(el.value))return!0;el.value=null}if(e.entities){const t=e.entities.getById("GlobalCloudLayer");if(t)return el.value=t,!0}if(e.entities&&e.entities.values)for(let t=0;t<e.entities.values.length;t++){const i=e.entities.values[t];if("GlobalCloudLayer"===i.name)return el.value=i,!0}return!1},ol=(e,t)=>{if(!e)return t&&t(!1),!1;try{ul();let i=el.value;return i&&e.entities.contains(i)||(i=e.entities.getById("GlobalCloudLayer")),i?(e.entities.remove(i),el.value=null,ll(!1),t&&t(!0),!0):(el.value=null,ll(!1),t&&t(!1),!1)}catch(i){return t&&t(!1),!1}},rl=(e,t,i,n)=>{const s=et();n&&n!==qe.SCENE3D?i&&i(!1):t?al(e)?(s.setShowCloudLayer(!0),ll(!0),i&&i(!0)):((e,t)=>{if(!e)return t&&t(!1),null;el.value&&ol(e);try{const i=e.entities.add({id:"GlobalCloudLayer",name:"GlobalCloudLayer",rectangle:{coordinates:Cesium.Rectangle.fromDegrees(-180,-90,180,90),material:new Cesium.ImageMaterialProperty({image:"/assets/clouds/australia_clouds_8k.jpg",transparent:!0,color:new Cesium.Color(5,5,5,.1)}),height:il,heightReference:Cesium.HeightReference.RELATIVE_TO_GROUND}});return el.value=i,cl(e),ll(!0),t&&t(!0),i}catch(i){return t&&t(!1),null}})(e,(e=>{e&&(s.setShowCloudLayer(!0),ll(!0)),i&&i(e)})):al(e)?ol(e,(e=>{e&&(s.setShowCloudLayer(!1),ll(!1)),i&&i(!e)})):(s.setShowCloudLayer(!1),ll(!1),i&&i(!1))},ll=e=>{localStorage.setItem(tl,e?"true":"false")},cl=e=>{if(!e||!el.value)return;ul();let t=0,i=-1;const n=()=>{const n=Date.now(),s=e.camera.positionCartographic.height,a=Math.abs(s-i);(n-t>100&&a>500||-1===i)&&(dl(e,s),t=n,i=s)};e.camera.changed.addEventListener(n),sl=()=>{e.camera.changed.removeEventListener(n)},dl(e)},ul=()=>{sl&&(sl(),sl=null)},dl=(e,t)=>{if(!e||!el.value)return;const i=void 0!==t?t:e.camera.positionCartographic.height;let n,s=.1;try{el.value.rectangle&&el.value.rectangle.material&&(n=el.value.rectangle.material.color.getValue())}catch(a){return}if(n){if(i>11e4){if(Math.abs(n.alpha-.1)<.01)return;s=.1}else if(i<nl){if(0===n.alpha)return;s=0}else if(i<7e4){if(s=.1*((i-nl)/3e4),Math.abs(n.alpha-s)<.01)return}else if(Math.abs(n.alpha-.1)<.01)return;try{el.value.rectangle.material.color=new Cesium.Color(5,5,5,s)}catch(a){}}};let hl=null,ml=!1;const pl=(e,t,i={},n)=>{if(e)try{t?hl?(hl.show=!0,e.scene&&e.scene.globe&&(e.scene.globe.show=!1),i.previousMapProvider&&!hl.userData&&(hl.userData={previousMapProvider:i.previousMapProvider}),n&&n(!0)):(async(e,t={})=>{try{const i=et();if(ml="Cesium全球地形"===i.terrainProvider,hl=await Cesium.createGooglePhotorealistic3DTileset(),t.previousMapProvider&&(hl.userData||(hl.userData={}),hl.userData.previousMapProvider=t.previousMapProvider,hl.userData.terrainWasEnabled=ml),ml&&(i.setTerrainProvider("无地形"),e.scene&&e.scene.terrainProvider)){const t=new Cesium.Terrain(Promise.resolve(new Cesium.EllipsoidTerrainProvider));e.scene.setTerrain(t),e.scene.globe.depthTestAgainstTerrain=!1}return e.scene.primitives.add(hl),t.initialPosition?e.camera.flyTo({destination:t.initialPosition,orientation:t.initialOrientation||{heading:0,pitch:-Math.PI/4,roll:0},duration:t.flyToDuration||3}):e.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(-122.4175,37.655,400),orientation:{heading:0,pitch:-Math.PI/4,roll:0},duration:3}),!0}catch(i){const t=String(i);return(429===i.statusCode||i.message&&i.message.includes("429")||i.statusMessage&&i.statusMessage.includes("Too Many Requests")||i.response&&429===i.response.status||t.includes("429")||t.includes("Too Many Requests"))&&J({message:"Cesium共享GooglePhotorealistic3DTiles服务面临请求大量请求，请稍后再尝试使用。",type:"warning",duration:5e3,showClose:!0}),e.scene&&e.scene.globe&&(e.scene.globe.show=!0),ml&&et().setTerrainProvider("Cesium全球地形"),!1}})(e,i).then((e=>{n&&n(e)})):((e,t)=>{if(e)if(hl)try{e.scene.primitives.remove(hl);let i=!1;if(i=hl.userData&&hl.userData.terrainWasEnabled?hl.userData.terrainWasEnabled:ml,i&&(et().setTerrainProvider("Cesium全球地形"),e.scene)){const t=Cesium.Terrain.fromWorldTerrain({requestVertexNormals:!0,requestWaterMask:!0});e.scene.setTerrain(t),e.scene.globe.depthTestAgainstTerrain=!0}hl=null,ml=!1,t&&t(!0)}catch(i){t&&t(!1)}else t&&t(!0);else t&&t(!1)})(e,(t=>{t||e.scene&&e.scene.globe&&(e.scene.globe.show=!0),n&&n(t)}))}catch(s){try{if(!t&&ml){et().setTerrainProvider("Cesium全球地形")}}catch(a){}n&&n(!1)}else n&&n(!1)};let gl=null;const vl=(e,t,i={},n)=>{if(e)try{t?gl?(gl.show=!0,n&&n(!0)):(async(e,t={})=>{try{return gl=await Cesium.createOsmBuildingsAsync(),e.scene.primitives.add(gl),t.color&&(gl.style=new Cesium.Cesium3DTileStyle({color:{conditions:[["true",t.color]]}})),t.initialPosition?e.camera.flyTo({destination:t.initialPosition,orientation:t.initialOrientation||{heading:0,pitch:-Math.PI/4,roll:0},duration:t.flyToDuration||3}):e.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(116.3912,39.9056,500),orientation:{heading:0,pitch:-Math.PI/4,roll:0},duration:3}),!0}catch(i){return!1}})(e,i).then((e=>{n&&n(e)})):(gl&&(gl.show=!1),n&&n(!0))}catch(s){n&&n(!1)}else n&&n(!1)},yl={class:"campus-map-container"},fl={key:0,class:"loading-overlay"},Cl={class:"loading-content"},wl={class:"loading-text"},bl={class:"location-search-container"},_l=qi(o({__name:"CampusMap",props:{initialHeight:{type:Number,default:null},initialPitch:{type:Number,default:null},initialHeading:{type:Number,default:null}},emits:["roadNetworkLayerStateChange","tdtLabelLayerStateChange","tdtBoundaryLayerStateChange","gridLayerStateChange","oceanLayerStateChange","terrainWireframeLayerStateChange","cloudLayerStateChange","sceneModeChangeError","loading","viewerReady","layerLoading","toggleEffect","disableContextMenu","enableContextMenu"],setup(e,{expose:t,emit:i}){const s=e,a=i,o=n(qe.SCENE3D),p=et(),{mapProvider:g,height:v,pitch:y,heading:f,longitude:C,latitude:S,selectedLocation:P,terrainProvider:L,showGrid:M,enableLocationAnimation:I}=_(p);let D=null;const O=n(null),R=ir,N=n(!1),B=n(!1),U=n(null);n(!1);const V=E({buildingLayer:!1,imageLayer:!1,modelLayer:!1,terrainLayer:!1,tdtLabel:!1,tdtBoundary:!1,grid:!1,roadNetwork:!1,ocean:!1,terrainWireframe:!1,cloud:!1}),z=n(!1),H=n(!1),F=n(!1),W=n(!1),G=n(!1),Y=n(!1),j=n(!1),$=(e,t)=>{V.hasOwnProperty(e)&&(V[e]=t)};let X=null;const Q=n("正在加载地图..."),K=()=>{if(!D)return;const e=L.value,t=Ze[e];if("none"===t.type)try{const e=new Cesium.Terrain(Promise.resolve(new Cesium.EllipsoidTerrainProvider));D.scene.setTerrain(e),D.scene.globe.depthTestAgainstTerrain=!1}catch(i){}else if("cesium"===t.type)try{const e=Cesium.Terrain.fromWorldTerrain({requestWaterMask:!0,requestVertexNormals:!0});D.scene.setTerrain(e),D.scene.globe.depthTestAgainstTerrain=!0}catch(i){try{const e=new Cesium.Terrain(Promise.resolve(new Cesium.EllipsoidTerrainProvider));D.scene.setTerrain(e),D.scene.globe.depthTestAgainstTerrain=!1,p.setTerrainProvider("无地形")}catch(n){}}D.scene.requestRender()},q=(e,t)=>{if(!D)return;const i="tdtLabel"===e,n=i?Rr:Fr,s=i?Mr:Ur,r=i?p.setShowTdtLabelLayer:p.setShowTdtBoundaryLayer,l=i?H:F;try{$(e,!0),r(t),l.value=t,a(i?"tdtLabelLayerStateChange":"tdtBoundaryLayerStateChange",t);const c=n=>{a(i?"tdtLabelLayerStateChange":"tdtBoundaryLayerStateChange",n),l.value=n,$(e,!1),n!==t&&r(n)};if(!D||!D.imageryLayers)return void $(e,!1);n(t,D,c,o.value),setTimeout((()=>{$(e,!1);const t=s(D);t!==l.value&&(l.value=t,r(t),a(i?"tdtLabelLayerStateChange":"tdtBoundaryLayerStateChange",t))}),1e3)}catch(c){$(e,!1);const t=s(D);l.value=t,r(t),a(i?"tdtLabelLayerStateChange":"tdtBoundaryLayerStateChange",t)}},J=e=>{q("tdtLabel",e)},Z=e=>{q("tdtBoundary",e)},ee=e=>{if(!D)return;$("grid",!0),p.setShowGrid(e);if(yr(D)===e)return $("grid",!1),void a("gridLayerStateChange",e);((e,t,i)=>{i&&i.setShowGrid(e),e?(wr(t),Cr(t)):wr(t)})(e,D,p),a("gridLayerStateChange",e),setTimeout((()=>{$("grid",!1)}),800)},te=e=>{if(!D)return;$("roadNetwork",!0),p.setShowRoadNetworkLayer(e),Pr(!e),a("roadNetworkLayerStateChange",e),z.value=e;((e,t,i=!1,n)=>{new Promise((s=>{if(!e)return n&&n(!1),void s(!1);if(t){if(i&&Tr())return n&&n(!1),void s(!1);const t=Ar(e,(e=>{n&&n(e),s(e)}));if(!t.success&&"ALREADY_EXISTS"!==t.reason)return void s(!1)}else Er(e,(e=>{n&&n(!1),s(!1)}))}))})(D,e,!1,(t=>{a("roadNetworkLayerStateChange",t),$("roadNetwork",!1),e?(z.value=t,t!==e&&Pr(!t)):(z.value=!1,Pr(!0))})),setTimeout((()=>{if($("roadNetwork",!1),!e){z.value=!1,a("roadNetworkLayerStateChange",!1),p.setShowRoadNetworkLayer(!1);const e=xr();e&&e.value&&(e.value=null)}}),500)},ie=e=>{$("ocean",!0),Qr(e),p.setShowOceanLayer(e),W.value=e,a("oceanLayerStateChange",e),((e,t,i,n)=>{if(!e)return;const s=Yr(e);(void 0!==t?t:!s)?s?i&&i(!0):Xr(e,i,n):s?$r(e,i):i&&i(!1)})(D,e,(t=>{W.value=t,p.setShowOceanLayer(t),$("ocean",!1),a("oceanLayerStateChange",t),t!==e&&Qr(t)}),o.value),setTimeout((()=>{$("ocean",!1);const e=Yr(D);e!==W.value&&(W.value=e,p.setShowOceanLayer(e),a("oceanLayerStateChange",e),Qr(e))}),1e3)},ne=e=>{if(!D)return;$("terrain",!0);const t=e?"Cesium全球地形":"无地形";p.setTerrainProvider(t);if("none"===Ze[t].type)try{const e=new Cesium.Terrain(Promise.resolve(new Cesium.EllipsoidTerrainProvider));D.scene.setTerrain(e),D.scene.globe.depthTestAgainstTerrain=!1}catch(i){}else try{const e=Cesium.Terrain.fromWorldTerrain({requestWaterMask:!0,requestVertexNormals:!0});D.scene.setTerrain(e),D.scene.globe.depthTestAgainstTerrain=!0}catch(i){}setTimeout((()=>{$("terrain",!1)}),1e3)},se=(e,t)=>{if(!t||!t.imageryLayers)return!1;try{return e(t)}catch(i){return!1}},ae=()=>{if(!D){const e=()=>!1;return{isRoadNetworkLayerExists:e,addRoadNetworkLayer:e,removeRoadNetworkLayer:e,isTdtLabelLayerExists:e,addTdtLabelLayer:e,removeTdtLabelLayer:e,isTdtBoundaryLayerExists:e,addTdtBoundaryLayer:e,removeTdtBoundaryLayer:e,isGridLayerExists:e,addGridLayer:e,removeGridLayer:e,isOceanLayerExists:e,addOceanLayer:e,removeOceanLayer:e,getUserDisabledRoadNetworkState:e,setUserDisabledRoadNetworkState:e,getUserShowTdtLabelLayerState:e,getUserShowTdtBoundaryLayerState:e,roadNetworkLayerRef:null,tdtLabelLayerRef:null,tdtBoundaryLayerRef:null,gridLayerRef:null,emitRoadNetworkLayerStateChange:e,emitTdtLabelLayerStateChange:e,emitTdtBoundaryLayerStateChange:e,emitGridLayerStateChange:e,emitOceanLayerStateChange:e}}return{isRoadNetworkLayerExists:()=>se(Sr,D),addRoadNetworkLayer:()=>Ar(D),removeRoadNetworkLayer:()=>Er(D),isTdtLabelLayerExists:()=>se(Mr,D),addTdtLabelLayer:()=>Dr(D),removeTdtLabelLayer:()=>Or(D),isTdtBoundaryLayerExists:()=>se(Ur,D),addTdtBoundaryLayer:()=>zr(D),removeTdtBoundaryLayer:()=>Hr(D),isGridLayerExists:()=>se(yr,D),addGridLayer:()=>Cr(D),removeGridLayer:()=>wr(D),isOceanLayerExists:()=>se(Yr,D),addOceanLayer:()=>Xr(D,(()=>{})),removeOceanLayer:()=>$r(D,(()=>{})),getUserDisabledRoadNetworkState:Tr,setUserDisabledRoadNetworkState:Pr,getUserShowTdtLabelLayerState:()=>p.showTdtLabelLayer,getUserShowTdtBoundaryLayerState:()=>p.showTdtBoundaryLayer,roadNetworkLayerRef:xr(),tdtLabelLayerRef:Lr,tdtBoundaryLayerRef:Nr,gridLayerRef:gr,emitRoadNetworkLayerStateChange:e=>a("roadNetworkLayerStateChange",e),emitTdtLabelLayerStateChange:e=>a("tdtLabelLayerStateChange",e),emitTdtBoundaryLayerStateChange:e=>a("tdtBoundaryLayerStateChange",e),emitGridLayerStateChange:e=>a("gridLayerStateChange",e),emitOceanLayerStateChange:e=>a("oceanLayerStateChange",e)}};let oe=!1;const re=e=>{if(!D)return;const t=Cesium.Cartographic.fromCartesian(D.camera.position).height;p.setHeight(t)},le=e=>{D&&(e.tdtLabel.storeValue?J(!0):Mr(D)&&Or(D,(e=>{a("tdtLabelLayerStateChange",e),H.value=e})),e.tdtBoundary.storeValue?Z(!0):Ur(D)&&Hr(D,(e=>{a("tdtBoundaryLayerStateChange",e),F.value=e})),e.roadNetwork.visible||p.showRoadNetworkLayer?te(!0):Sr(D)&&(Er(D),z.value=!1,a("roadNetworkLayerStateChange",!1)),e.grid.storeValue?ee(!0):yr(D)&&(wr(D),G.value=!1,a("gridLayerStateChange",!1)),e.ocean.visible||p.showOceanLayer?ie(!0):Yr(D)&&$r(D,(e=>{a("oceanLayerStateChange",e),W.value=e})),setTimeout((()=>{me()}),500))};r((()=>{if("无底图"===g.value&&p.setMapProvider("腾讯卫星"),R.value=!0,((e,t,i,n)=>{if(null!==e){const t=Math.max(100,Math.min(25e6,e));n.setHeight(t)}else n.setHeight(2e3);null!==t&&n.setPitch(t),null!==i&&n.setHeading(i)})(s.initialHeight,s.initialPitch,s.initialHeading,p,o.value),o.value===qe.COLUMBUS_VIEW){const e=null!==s.initialPitch?Math.max(-60,Math.min(-20,s.initialPitch)):-45;p.setPitch(e)}Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiODU4MzQxNC0wNmQ3LTRiMjUtYjIwMy1lNDAxODkxOTY1YjAiLCJpZCI6MjkyMDc1LCJpYXQiOjE3NDQxMjIyNzh9.pQuhqLOFa4gp8mCbgIHMOx7hvPSFnL6a6L0XPwIEJsI",Cesium.RequestScheduler.maximumRequestsPerServer=18;const e=Cesium.Resource._DefaultImplementations.fetchImage;Cesium.Resource._DefaultImplementations.fetchImage=function(t){return t.preferBlob=!0,e(t)};if((e=>{try{const i={animation:!1,baseLayerPicker:!1,fullscreenButton:!0,vrButton:!1,geocoder:!1,homeButton:!0,infoBox:!1,sceneModePicker:!0,selectionIndicator:!1,timeline:!0,navigationHelpButton:!0,navigationInstructionsInitiallyVisible:!1,scene3DOnly:!1,sceneMode:e,contextOptions:{webgl:{alpha:!1,depth:!0,stencil:!1,antialias:!0,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,failIfMajorPerformanceCaveat:!1}},shouldAnimate:!0};o.value===qe.SCENE2D&&(i.mapMode2D=Cesium.MapMode2D.INFINITE_SCROLL,i.mapProjection=new Cesium.WebMercatorProjection),D=new Cesium.Viewer("cesiumContainer",i),window.viewer=D,D.scene.morphComplete.addEventListener((()=>{if(oe)return;let e;switch(D.scene.mode){case Cesium.SceneMode.SCENE2D:e=qe.SCENE2D;break;case Cesium.SceneMode.COLUMBUS_VIEW:e=qe.COLUMBUS_VIEW;break;default:e=qe.SCENE3D}o.value=e,setTimeout((()=>{oe=!1}),2e3)})),D.cesiumWidget&&(D.cesiumWidget.creditContainer.style.display="none",setTimeout((()=>{const e=document.querySelector(".cesium-viewer-toolbar");e&&(e.style.right="",e.style.left="",e.style.top="")}),100)),D.terrainProvider.errorEvent.addEventListener((e=>{})),D.scene.rethrowRenderErrors=!1,D.scene.renderError.addEventListener(((e,t)=>{})),bt()?(D.resolutionScale=Math.min(window.devicePixelRatio,2),D.scene.msaaSamples=2,D.scene.globe&&(D.scene.globe.maximumScreenSpaceError=1.5)):(D.resolutionScale=1,D.scene.msaaSamples=4,window.devicePixelRatio>1.5&&(D.resolutionScale=1.2)),D.scene.postProcessStages.fxaa.enabled=!0;const n=Ze[L.value];if(D.scene.globe.depthTestAgainstTerrain="cesium"===n.type,D.scene.debugShowFramesPerSecond=!0,D.clock.shouldAnimate=!0,D.scene.preRender.addEventListener((()=>{D.scene.debugShowFramesPerSecond=!0})),O.value=Dt(D),!O.value)try{O.value=Dt(D),O.value}catch(t){}sr(D,Je[g.value],0,nr,ae(),p),K();const s=25e6;let a=s;switch(o.value){case qe.SCENE3D:case qe.COLUMBUS_VIEW:case qe.SCENE2D:}a=v.value>1e4?v.value:s,D.camera.setView({destination:Cesium.Cartesian3.fromDegrees(C.value,S.value,a),orientation:{heading:Cesium.Math.toRadians(f.value),pitch:Cesium.Math.toRadians(y.value||-90),roll:0}});const r=D.scene;return r.globe.enableLighting=p.enableLighting,r.fog.enabled=!1,r.globe.showGroundAtmosphere=!0,r.backgroundColor=Cesium.Color.BLACK,r.globe.baseColor=Cesium.Color.BLACK,D.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),mr(D,o.value,p,B.value,U.value,{value:N.value}),setTimeout((()=>{R.value=!1,x((()=>{he()}))}),1500),!0}catch(t){return R.value=!1,!1}})(o.value===qe.SCENE2D?Cesium.SceneMode.SCENE2D:o.value===qe.COLUMBUS_VIEW?Cesium.SceneMode.COLUMBUS_VIEW:Cesium.SceneMode.SCENE3D),setTimeout((()=>{me(),D&&(X=new Zo(D,"",{handleToggleTerrain:ne,handleToggleTerrainTriangle:e=>{ge(e)},handleToggleTerrainOpacity:e=>{D&&D.scene&&D.scene.globe&&(D.scene.globe.translucency.enabled=e,e&&(D.scene.globe.translucency.frontFaceAlpha=.2,D.scene.globe.translucency.backFaceAlpha=.2))},handleToggleAtmosphere:e=>{ye(e)}}))}),2e3),X){const e=document.getElementById("cesiumContainer");e&&(e.removeEventListener("touchstart",Te),e.addEventListener("touchstart",Te,{passive:!1}),e.addEventListener("touchend",ke,{passive:!1}),e.addEventListener("touchmove",Le,{passive:!1}))}})),k((()=>{if(window.viewer&&(window.viewer=void 0),D){try{D.destroy()}catch(t){}D=null}N.value&&((e,i)=>{try{if(!e)return;i.value&&(ur(),i.value=!1)}catch(t){ur(),i.value=!1}})(D,{value:N.value}),O.value&&(O.value.disableEffect(Mt.SKYBOX),O.value=null),X&&(X.destroy(),X=null);const e=document.getElementById("cesiumContainer");e&&e.removeEventListener("touchstart",Te)})),l((()=>{D&&(D.destroy(),D=null)})),A(L,(()=>{D&&K()})),A(M,(e=>{D&&ee(e)})),A((()=>p.showTerrainWireframeLayer),(e=>{D&&e!==Y.value&&ge(e)})),A(g,(()=>{D&&sr(D,Je[g.value],0,nr,ae(),p)}));const ce=(e,t)=>{((e,t,i,n,s,a,o,r,l)=>{if(!e)return;r.value=!0,l.value&&clearTimeout(l.value),l.value=setTimeout((()=>{r.value=!1}),3e3);const c=window.Cesium;if("preset"===t){const t=i,n=t.useAnimation,r=2e3,l=t.pitch||-45,u=t.heading||0,d=c.Cartesian3.fromDegrees(a,o,r),h={heading:c.Math.toRadians(u),pitch:c.Math.toRadians(l),roll:0};return n?e.camera.flyTo({destination:d,orientation:h,duration:1.5}):e.camera.setView({destination:d,orientation:h}),s.setHeight(r),s.setPitch(l),void s.setHeading(u)}(()=>{let r;const l=e.camera.heading,u=e.camera.pitch,d=e.camera.roll;let h=l,m=u,p=s.height;if("heading"===t?(h=c.Math.toRadians(i),s.setHeading(i)):"pitch"===t?(m=c.Math.toRadians(i),s.setPitch(i)):"height"===t&&(p=i,s.setHeight(i)),n===qe.SCENE2D)if("height"===t){const e=a,t=o;r=c.Cartesian3.fromDegrees(e,t,p)}else r=e.camera.position;else if(n===qe.COLUMBUS_VIEW)r=c.Cartesian3.fromDegrees(a,o,p);else if("height"===t){const t=c.Cartographic.fromCartesian(e.camera.position);r=c.Cartesian3.fromRadians(t.longitude,t.latitude,p)}else r=e.camera.position;e.camera.setView({destination:r,orientation:{heading:h,pitch:m,roll:d}})})()})(D,e,t,o.value,p,C.value,S.value,{value:B.value},{value:U.value})},ue=(e,t,i=!1)=>{((e,t,i,n=!1,s,a,o,r,l,c=!1)=>{if(!e)return;const u=window.Cesium;if(n&&(r.value=!0,l.value&&clearTimeout(l.value),l.value=setTimeout((()=>{r.value=!1}),3e3)),o.value&&s===qe.SCENE3D&&(o.value=!1,e.scene.canvas)){const t=new CustomEvent("resetShouldRotate",{detail:{shouldRotate:!1}});e.scene.canvas.dispatchEvent(t)}const d=a.height,h=s===qe.SCENE2D?0:u.Math.toRadians(a.heading),m=s===qe.SCENE2D?0:u.Math.toRadians(a.pitch);switch(s){case qe.SCENE2D:c&&n?e.camera.flyTo({destination:u.Cartesian3.fromDegrees(t,i,d),duration:1.5}):e.camera.setView({destination:u.Cartesian3.fromDegrees(t,i,d)}),a.setPosition(t,i);break;case qe.COLUMBUS_VIEW:const s=Math.max(-60,Math.min(-20,a.pitch)),o={destination:u.Cartesian3.fromDegrees(t,i,d),orientation:{heading:h,pitch:u.Math.toRadians(s),roll:0}};c&&n?e.camera.flyTo({...o,duration:1.5}):e.camera.setView(o),a.setPitch(s);break;default:const r={destination:u.Cartesian3.fromDegrees(t,i,d),orientation:{heading:h,pitch:m,roll:0}};c&&n?e.camera.flyTo({...r,duration:1.5}):e.camera.setView(r),a.setPosition(t,i),a.setHeight(Math.round(d)),a.setPitch(Math.round(u.Math.toDegrees(m)));let l=u.Math.toDegrees(h);l=(l%360+360)%360,l=Math.round(l),0===l&&Math.abs(a.heading-360)<.5?l=360:360===l&&Math.abs(a.heading)<.5&&(l=0),a.setHeading(l)}})(D,e,t,Boolean(i),o.value,p,{value:N.value},{value:B.value},{value:U.value},I.value)},de=(e,t)=>{((e,t,i)=>{er.value=e,tr.value=t,i()})(e,t,(()=>{D&&nr(D,ae())}))};t({handleToggleRoadNetworkLayer:te,handleToggleTdtLabelLayer:J,handleToggleTdtBoundaryLayer:Z,handleToggleGridLayer:ee,handleToggleOceanLayer:ie,handleToggleTerrain:ne,changeSceneMode:e=>{if(e===o.value||oe)return;oe=!0,R.value=!0;const t={tdtLabel:{visible:H.value,storeValue:p.showTdtLabelLayer},tdtBoundary:{visible:F.value,storeValue:p.showTdtBoundaryLayer},roadNetwork:{visible:z.value,storeValue:p.showRoadNetworkLayer},grid:{visible:G.value,storeValue:p.showGrid},ocean:{visible:W.value,storeValue:p.showOceanLayer},currentProvider:{provider:g.value,style:tr.value}};switch(o.value=e,re(),e){case qe.SCENE2D:Cesium.SceneMode.SCENE2D;break;case qe.COLUMBUS_VIEW:Cesium.SceneMode.COLUMBUS_VIEW;break;default:Cesium.SceneMode.SCENE3D}switch(e){case qe.SCENE2D:D.scene.morphTo2D();break;case qe.COLUMBUS_VIEW:D.scene.morphToColumbusView();break;default:D.scene.morphTo3D()}setTimeout((()=>{R.value=!1,le(t),setTimeout((()=>{oe=!1}),800)}),1e3)},adjustCamera:ce,updatePosition:ue,changeMapProvider:de});const he=()=>{if(O.value&&D){const e=D.camera.positionCartographic.height>=24e4,t=e?"default":"epic_bluesunset",i=e?"space":"ground";pe(Mt.SKYBOX,!0,{type:t,skyboxType:i,skipInitIfInitialized:!0})}M.value&&ee(!0);!Tr()&&te(!0);const e=!(()=>{const e=et();try{const t=localStorage.getItem(kr);if(null!==t){const i="false"===t;return e.setShowTdtLabelLayer(!i),i}}catch(t){}return!e.showTdtLabelLayer})();e&&J(!0);const t=!(()=>{const e=et();try{const t=localStorage.getItem(Br);if(null!==t){const i="false"===t;return e.setShowTdtBoundaryLayer(!i),i}}catch(t){}return!e.showTdtBoundaryLayer})();t&&Z(!0);Kr()&&ie(!0);("true"===localStorage.getItem(tl)||p.showCloudLayer)&&ve(!0),p.showTerrainWireframeLayer&&et().showTerrainWireframeLayer&&ge(!0),fe(),me()},me=()=>{D&&(Tr()?z.value=!1:z.value=Sr(D),H.value=Mr(D),F.value=Ur(D),W.value=Yr(D),G.value=yr(D),Y.value=Jr(D),j.value=al(D),p.setShowRoadNetworkLayer(z.value),p.setShowTdtLabelLayer(H.value),p.setShowTdtBoundaryLayer(F.value),p.setShowOceanLayer(W.value),p.setShowGrid(G.value),p.setShowTerrainWireframeLayer(Y.value),p.setShowCloudLayer(j.value),ll(j.value))};A(o,(()=>{oe||setTimeout((()=>{me()}),1200)}));const pe=(e,t,i)=>{if(!O.value){if(!D)return;try{if(O.value=Dt(D),!O.value)return}catch(n){return}}if("skybox"===e)t?O.value.enableEffect(Mt.SKYBOX,i):O.value.disableEffect(Mt.SKYBOX);else if("weather"===e)t?O.value.enableEffect(Mt.WEATHER,i):O.value.disableEffect(Mt.WEATHER,null==i?void 0:i.weatherType);else if("atmosphere"===e)if(t)try{if(!O.value.getAtmosphereController())return;const e={...i,intensity:(null==i?void 0:i.intensity)||3,rayleighCoefficient:(null==i?void 0:i.rayleighCoefficient)||3,mieCoefficient:(null==i?void 0:i.mieCoefficient)||3};O.value.enableEffect(Mt.ATMOSPHERE,e)}catch(n){}else O.value.disableEffect(Mt.ATMOSPHERE);else if("googleTileset"===e)if(t){i&&i.apiKey&&i.apiKey;const e=p.mapProvider;p.setMapProvider("无底图"),setTimeout((()=>{pl(D,!0,{maximumScreenSpaceError:(null==i?void 0:i.screenSpaceError)||8,maximumMemoryUsage:(null==i?void 0:i.maxMemory)||1024,previousMapProvider:e},(t=>{t||p.setMapProvider(e),a("toggleEffect","googleTileset",t,{enabled:t})}))}),100)}else{const e=Ce();pl(D,!1,{},(t=>{p.setMapProvider(e),a("toggleEffect","googleTileset",!1,{enabled:!1})}))}else"osmBuildings"===e&&(t?("Cesium全球地形"!==L.value&&ne(!0),vl(D,!0,{color:null==i?void 0:i.color},(e=>{a("toggleEffect","osmBuildings",e,{enabled:e})}))):vl(D,!1,{},(e=>{a("toggleEffect","osmBuildings",!1,{enabled:!1})})))},ge=e=>{if(!D)return;$("terrainWireframe",!0),p.setShowTerrainWireframeLayer(e);if(Jr(D)===e)return $("terrainWireframe",!1),void a("terrainWireframeLayerStateChange",e);var t;t=!e,et().setShowTerrainWireframeLayer(!t),Zr(D,e,(e=>{a("terrainWireframeLayerStateChange",e),Y.value=e,$("terrainWireframe",!1)}))},ve=e=>{$("cloud",!0),p.setShowCloudLayer(e),j.value=e,a("cloudLayerStateChange",e),rl(D,e,(e=>{j.value=e,p.setShowCloudLayer(e),$("cloud",!1),a("cloudLayerStateChange",e)}),o.value),setTimeout((()=>{$("cloud",!1);const e=al(D);e!==j.value&&(j.value=e,p.setShowCloudLayer(e),a("cloudLayerStateChange",e))}),1e3)},ye=e=>{if(!D||!O.value)return;const t=O.value.getSkyboxController();t?(t.setAtmosphereEnabled(e),p.setAtmosphereEnabled(e)):D.scene&&D.scene.skyAtmosphere&&(D.scene.skyAtmosphere.show=e,p.setAtmosphereEnabled(e))},fe=()=>{if(!D||!O.value)return;const e=p.atmosphereEnabled,t=O.value.getSkyboxController();t?t.setAtmosphereEnabled(e):D.scene&&D.scene.skyAtmosphere&&(D.scene.skyAtmosphere.show=e)},Ce=()=>{var e;if(null===hl)return"腾讯卫星";try{return hl&&(null==(e=hl.userData)?void 0:e.previousMapProvider)||"腾讯卫星"}catch(t){return"腾讯卫星"}},we=e=>{},be=()=>{window.isContextMenuDisabled=!0},_e=()=>{window.isContextMenuDisabled=!1},Se=e=>{e&&e.location&&D&&D.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(e.location.lng,e.location.lat,3e3),orientation:{heading:Cesium.Math.toRadians(0),pitch:Cesium.Math.toRadians(-60),roll:0},duration:3})};let Ae={x:0,y:0},Ee=null,xe=!1;const Te=e=>{1===e.touches.length?(Ae={x:e.touches[0].clientX,y:e.touches[0].clientY},xe=!1,Ee=window.setTimeout((()=>{xe||Ie(Ae.x,Ae.y)}),400)):Me()},Le=e=>{if(!Ae||1!==e.touches.length)return void Me();const t=Math.abs(e.touches[0].clientX-Ae.x),i=Math.abs(e.touches[0].clientY-Ae.y);(t>10||i>10)&&(xe=!0,Me())},ke=e=>{Me()},Me=()=>{Ee&&(clearTimeout(Ee),Ee=null)},Ie=(e,t)=>{var i;try{if(window.isContextMenuDisabled)return;const n=new Cesium.Cartesian2(e,t);let s,a=null==D?void 0:D.scene.pick(n);if((null==D?void 0:D.scene.pickPositionSupported)&&Cesium.defined(a)?s=D.scene.pickPosition(n):D&&(s=D.camera.pickEllipsoid(n,D.scene.globe.ellipsoid)),Cesium.defined(s)){const n=window.isContextMenuDisabled;n&&(window.isContextMenuDisabled=!1),X&&X.catCesium&&X.catCesium.setPickPosition(s);const a=new MouseEvent("contextmenu",{clientX:e,clientY:t,bubbles:!0,cancelable:!0,view:window});null==(i=document.elementFromPoint(e,t))||i.dispatchEvent(a),n&&setTimeout((()=>{window.isContextMenuDisabled=!0}),100)}}catch(n){}};return(e,t)=>(u(),c("div",yl,[t[1]||(t[1]=d("div",{id:"cesiumContainer"},null,-1)),t[2]||(t[2]=d("div",{class:"logo-container"},[d("img",{src:Pe,alt:"FlyAnti Logo",class:"logo-image"}),d("div",{class:"logo-text"},[d("h1",null,"FlyAnti"),d("p",null,"心向蓝天，翱翔世界")])],-1)),b(R)?(u(),c("div",fl,[d("div",Cl,[t[0]||(t[0]=d("div",{class:"loading-spinner"},null,-1)),d("div",wl,w(Q.value),1)])])):h("",!0),d("div",bl,[m(Ji,{onSelectResult:Se,city:"全国"})]),m(ro,{roadNetworkLayerState:z.value,tdtLabelLayerState:H.value,tdtBoundaryLayerState:F.value,oceanLayerState:W.value,cloudLayerState:j.value,layerLoadingStates:V,sceneMode:o.value,onToggleGridLayer:ee,onToggleTerrain:ne,onToggleRoadNetworkLayer:te,onToggleTdtLabelLayer:J,onToggleTdtBoundaryLayer:Z,onToggleOceanLayer:ie,onToggleTerrainWireframeLayer:ge,onToggleCloudLayer:ve,onToggleEffect:pe,onAdjustCamera:ce,onUpdatePosition:ue,onChangeMapProvider:de},null,8,["roadNetworkLayerState","tdtLabelLayerState","tdtBoundaryLayerState","oceanLayerState","cloudLayerState","layerLoadingStates","sceneMode"]),b(D)?(u(),T(lo,{key:1,viewer:b(D)},null,8,["viewer"])):h("",!0),b(D)?(u(),T(ho,{key:2,viewer:b(D)},null,8,["viewer"])):h("",!0),b(D)?(u(),T(Uo,{key:3,viewer:b(D),onToolChanged:we,onDisableContextMenu:be,onEnableContextMenu:_e},null,8,["viewer"])):h("",!0),m(Qo)]))}}),[["__scopeId","data-v-c9b3a29a"]]),Sl=o({__name:"App",setup(e){const t=n(!1),i=n(!1),s=n(!1),a=n(!1),o=n(!1),r=n(!1),l=n(null),c=e=>{i.value=e},d=e=>{s.value=e},h=e=>{t.value=e},m=e=>{a.value=e},p=e=>{o.value=e},g=e=>{r.value=e};return(e,t)=>(u(),T(_l,{onRoadNetworkLayerStateChange:h,onTdtLabelLayerStateChange:c,onTdtBoundaryLayerStateChange:d,onGridLayerStateChange:m,onOceanLayerStateChange:p,onTerrainWireframeLayerStateChange:g,ref_key:"campusMapRef",ref:l},null,512))}});!function(e={}){const{immediate:t=!1,onNeedRefresh:i,onOfflineReady:n,onRegistered:s,onRegisteredSW:a,onRegisterError:o}=e;let r,l;l=async function(){if("serviceWorker"in navigator){if(r=await Qt((async()=>{const{Workbox:e}=await import("./vendor.BUlUsozX.js").then((e=>e.W));return{Workbox:e}}),[]).then((({Workbox:e})=>new e("/sw.js",{scope:"/",type:"classic"}))).catch((e=>{null==o||o(e)})),!r)return;r.addEventListener("activated",(e=>{(e.isUpdate||e.isExternal)&&window.location.reload()})),r.addEventListener("installed",(e=>{e.isUpdate||null==n||n()})),r.register({immediate:t}).then((e=>{a?a("/sw.js",e):null==s||s(e)})).catch((e=>{null==o||o(e)}))}}()}({onNeedRefresh(){},onOfflineReady(){}});const Al=I(Sl),El=D();El.use(O),Al.use(El),Al.use(we),gt(),xe(),Al.mount("#app");
